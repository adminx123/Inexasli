<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Post - INEXASLI</title>
    <link rel="stylesheet" href="salesflow.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
    <style>
        /* Manual Post Form Styles */
        .auth-status {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .auth-status.authenticated {
            border-left-color: #10b981;
            color: #10b981;
        }

        .auth-status.not-authenticated {
            border-left-color: #f59e0b;
            color: #f59e0b;
        }

        /* OAuth Button Styling - matching oauth-connect.html */
        .oauth-button {
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            min-width: 280px;
            justify-content: center;
            letter-spacing: 0.5px;
            border: none;
            cursor: pointer;
            margin: 10px 0;
        }

        .oauth-button.instagram-button {
            background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
            color: white;
            box-shadow: 0 10px 30px rgba(64, 93, 230, 0.3);
        }
        
        .oauth-button.instagram-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(64, 93, 230, 0.4);
        }

        .platform-icon-x {
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            font-style: normal;
        }

        .manual-post-form {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            color: white;
        }

        .text-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 1em;
            line-height: 1.5;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #10b981;
            background: rgba(255,255,255,0.15);
        }

        .image-upload-section {
            margin-bottom: 25px;
        }

        .image-previews {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 10px;
        }

        .image-preview {
            margin-top: 15px;
            max-width: 100%;
            border-radius: 8px;
            display: block;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 10px;
        }

        .preview-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 120px;
        }

        .preview-img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            object-fit: cover;
        }

        .preview-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.8);
        }

        .preview-controls {
            position: absolute;
            top: 5px;
            right: 5px;
        }

        .remove-btn {
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: rgba(255, 0, 0, 1);
        }

        .platform-selection {
            margin-bottom: 25px;
        }

        .platform-checkboxes {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .platform-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .platform-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #10b981;
        }

        .platform-checkbox label {
            color: white;
            font-size: 1em;
            cursor: pointer;
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .status-message.success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            color: #10b981;
        }

        .status-message.error {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            color: #ff4444;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #10b981;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="splash-container" id="splashContainer" style="padding-top: 40px; position: absolute; top: 0; left: 0; width: 100%; z-index: 2;">
        <img src="../images/favicon.svg" alt="INEXASLI Logo" class="splash-logo" style="margin-top: 20px;">
    </div>

    <div class="device-container" id="mainContent" style="opacity: 0; display: block; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; z-index: 1;">

        <!-- Page Title -->
        <h1 class="page-title">Manual Social Media Post</h1>
        <p class="page-subtitle">Create and post content manually to your connected Instagram, Facebook, and X accounts. Perfect for time-sensitive updates and special announcements.</p>

        <!-- Manual Post Form -->
        <div class="manual-post-form">
            <!-- Platform Selection -->
            <div class="form-group platform-selection">
                <label class="form-label">Select Platforms *</label>
                <div class="platform-checkboxes">
                    <div class="platform-checkbox">
                        <input type="checkbox" id="platform-instagram" name="platforms" value="instagram">
                        <label for="platform-instagram">
                            <i class="fab fa-instagram"></i>
                        </label>
                    </div>
                    <div class="platform-checkbox">
                        <input type="checkbox" id="platform-facebook" name="platforms" value="facebook">
                        <label for="platform-facebook">
                            <i class="fab fa-facebook"></i>
                        </label>
                    </div>
                    <div class="platform-checkbox">
                        <input type="checkbox" id="platform-twitter" name="platforms" value="twitter">
                        <label for="platform-twitter">
                            <i class="platform-icon-x">ùïè</i>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Image Upload -->
            <div class="form-group image-upload-section">
                <label class="form-label">Upload Image (Optional)</label>
                <p style="font-size: 0.9em; color: #ccc; margin-bottom: 10px;">Supported formats: JPEG, PNG, WebP (max 5MB for cross-platform compatibility)</p>
                <div id="image-upload-container"></div>
            </div>

            <!-- Text Input -->
            <div class="form-group">
                <label class="form-label">Post Text *</label>
                <textarea
                    id="post-text"
                    class="text-input"
                    placeholder="What's on your mind? Share your thoughts, updates, or announcements..."
                    maxlength="280"
                ></textarea>
            </div>

            <!-- OAuth Button -->
            <div style="text-align: center; margin: 20px 0;">
                <button id="instagramOauthButton" class="oauth-button instagram-button">
                    <i class="fab fa-instagram"></i> Verify & Post
                </button>
            </div>

            <!-- Status Message -->
            <div id="status-message" class="status-message"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../utility/piexif.js"></script>
    <script src="../utility/imageUpload.js"></script>
    <script>
        // Check authentication status - simplified since we verify every time
        function checkAuthenticationStatus() {
            const instagramBtn = document.getElementById('instagramOauthButton');

            // Button is already visible in HTML, just ensure proper state
            instagramBtn.innerHTML = '<i class="fab fa-instagram"></i> Verify & Post';
            instagramBtn.disabled = false;

            // Set up OAuth button with token checking
            setupOAuthButton();
        }

        function setupOAuthButton() {
            const instagramBtn = document.getElementById('instagramOauthButton');
            const OAUTH_WORKER_URL = 'https://oauth.4hm7q4q75z.workers.dev';
            const instagramOauthUrl = `${OAUTH_WORKER_URL}/oauth/instagram/start?redirect=${encodeURIComponent(window.location.href)}`;
            
            instagramBtn.onclick = async function() {
                // Store form data before OAuth redirect
                const text = document.getElementById('post-text').value.trim();
                const selectedPlatforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(cb => cb.value);
                const uploadedImages = window.manualPostImageUpload ? window.manualPostImageUpload.getImages() : [];
                const imageBase64 = uploadedImages.length > 0 ? uploadedImages[0].dataUrl : null;
                
                // Validate form before storing
                if (!text || selectedPlatforms.length === 0) {
                    const statusMessage = document.getElementById('status-message');
                    statusMessage.className = 'status-message error';
                    statusMessage.textContent = '‚ùå Please fill in the post text and select at least one platform.';
                    statusMessage.style.display = 'block';
                    return;
                }
                
                // Check for existing valid tokens server-side (secure, no localStorage)
                const tokenCheck = await checkExistingTokensSecurely();
                if (tokenCheck.hasToken) {
                    console.log('Found existing valid token, skipping OAuth');
                    // Use existing token for posting
                    const formData = {
                        content: text,
                        platforms: selectedPlatforms,
                        imageBase64: imageBase64,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('pending_post_data', JSON.stringify(formData));
                    // Use the session ID from server validation
                    autoPostAfterVerification(formData, tokenCheck.sessionId, tokenCheck.username);
                    return;
                }
                
                // No valid tokens found, go through OAuth to get new ones
                const formData = {
                    content: text,
                    platforms: selectedPlatforms,
                    imageBase64: imageBase64,
                    timestamp: Date.now()
                };
                localStorage.setItem('pending_post_data', JSON.stringify(formData));
                
                // Redirect to OAuth
                window.location.href = instagramOauthUrl;
            };
            
            // Reset button to non-connected state
            instagramBtn.innerHTML = '<i class="fab fa-instagram"></i> Verify & Post';
            instagramBtn.disabled = false;
        }

        // Secure server-side token validation (no localStorage)
        async function checkExistingTokensSecurely() {
            try {
                const OAUTH_WORKER_URL = 'https://oauth.4hm7q4q75z.workers.dev';
                
                // Ask server to check for any valid tokens (secure, no client-side storage)
                const response = await fetch(`${OAUTH_WORKER_URL}/oauth/check-any-tokens`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        // Could include session info, IP, or other identifying data if needed
                        timestamp: Date.now()
                    })
                });
                
                if (!response.ok) {
                    return { hasToken: false };
                }
                
                const result = await response.json();
                
                if (result.hasValidTokens && result.sessionId) {
                    console.log('Server validated existing tokens for user:', result.username);
                    return {
                        hasToken: true,
                        sessionId: result.sessionId,
                        username: result.username || 'inexasli'
                    };
                }
                
                return { hasToken: false };
            } catch (error) {
                console.error('Error checking tokens securely:', error);
                return { hasToken: false };
            }
        }

        // Auto-post function after verification
        async function autoPostAfterVerification(postData, sessionId, username = 'inexasli') {
            const statusMessage = document.getElementById('status-message');
            
            // Show posting in progress
            statusMessage.className = 'status-message';
            statusMessage.textContent = 'üîÑ Auto-posting to selected platforms...';
            statusMessage.style.display = 'block';
            
            try {
                // Determine worker URL based on verified account
                const clientWorkerUrl = window.location.hostname.includes('localhost') 
                    ? 'http://localhost:8787' // Local development
                    : `https://prompt-${username.toLowerCase()}.4hm7q4q75z.workers.dev`; // Production worker based on username
                
                // Prepare post data for masterSocial API
                const apiPostData = {
                    action: 'manual_post',
                    content: postData.content,
                    platforms: postData.platforms,
                    sessionId: sessionId
                };

                // Add image data if available
                if (postData.imageBase64) {
                    apiPostData.imageBase64 = postData.imageBase64;
                }

                console.log('Auto-posting to worker:', clientWorkerUrl, apiPostData);

                // Send to masterSocial API
                const response = await fetch(clientWorkerUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Poster-Secret': 'YOUR_POSTER_SECRET' // Note: This should be retrieved securely
                    },
                    body: JSON.stringify(apiPostData)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Network error' }));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('Auto-post result:', result);

                if (result.success) {
                    // Show success message
                    const successPlatforms = result.results.filter(r => r.success).map(r => r.platform);
                    const failedPlatforms = result.results.filter(r => !r.success).map(r => r.platform);
                    
                    let message = `‚úÖ Auto-posted to ${successPlatforms.join(' and ')} successfully!`;
                    if (failedPlatforms.length > 0) {
                        message += ` ‚ö†Ô∏è Failed on: ${failedPlatforms.join(', ')}`;
                    }
                    
                    statusMessage.className = 'status-message success';
                    statusMessage.textContent = message;
                    
                    // Clear the form
                    document.getElementById('post-text').value = '';
                    document.querySelectorAll('input[name="platforms"]').forEach(cb => cb.checked = false);
                    if (window.manualPostImageUpload) {
                        window.manualPostImageUpload.clearImages();
                    }
                    
                } else {
                    throw new Error(result.error || 'Unknown error occurred');
                }

            } catch (error) {
                console.error('Auto-post error:', error);
                statusMessage.className = 'status-message error';
                statusMessage.textContent = `‚ùå Auto-post failed: ${error.message}`;
            } finally {
                // No button to reset since we removed the post button
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Handle OAuth redirect with session data
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check Instagram verification callback
            if (urlParams.get('instagram') === 'verified' && urlParams.get('ready_to_post') === 'true') {
                // Get session data from OAuth flow
                const sessionId = urlParams.get('session_id');
                const username = decodeURIComponent(urlParams.get('username') || 'inexasli');
                
                // Check for pending post data and auto-post
                const pendingPostData = localStorage.getItem('pending_post_data');
                if (pendingPostData) {
                    const postData = JSON.parse(pendingPostData);
                    
                    // Clear pending data
                    localStorage.removeItem('pending_post_data');
                    
                    // Auto-post the stored data
                    autoPostAfterVerification(postData, sessionId, username);
                } else {
                    // Show success message for verification only
                    const statusMessage = document.getElementById('status-message');
                    statusMessage.className = 'status-message success';
                    statusMessage.textContent = '‚úÖ Instagram verified! You can now post content.';
                    statusMessage.style.display = 'block';
                }
                
                // Clean up URL parameters
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }

            // Check authentication status
            checkAuthenticationStatus();

            // Hide splash after animation
            setTimeout(() => {
                const splash = document.getElementById('splashContainer');
                const main = document.getElementById('mainContent');
                if (splash && main) {
                    splash.style.display = 'none';
                    main.style.opacity = '1';
                }
            }, 2500);

            // Initialize image upload with cross-platform compatibility
            console.log('Initializing image upload...');
            const imageUpload = new ImageUploadUtility({
                maxFiles: 1,
                maxFileSize: 5 * 1024 * 1024, // 5MB (Twitter limit - most restrictive)
                acceptedTypes: ['image/jpeg', 'image/png', 'image/webp'], // Compatible with all platforms
                enableCamera: true,
                enableDragDrop: true,
                showPreview: true,
                quality: 0.85, // Good balance for file size and quality
                maxWidth: 1920, // Instagram/Facebook optimal
                maxHeight: 1080
            });
            console.log('Created ImageUploadUtility instance:', imageUpload);
            
            const container = document.getElementById('image-upload-container');
            console.log('Container element:', container);
            
            if (container) {
                imageUpload.render(container);
                console.log('Image upload rendered');
                
                // Check if the HTML was actually rendered
                setTimeout(() => {
                    const uploadUtility = container.querySelector('.image-upload-utility');
                    const previewContainer = container.querySelector('.image-previews');
                    console.log('Upload utility element:', uploadUtility);
                    console.log('Preview container element:', previewContainer);
                    console.log('Container HTML after render:', container.innerHTML.substring(0, 200) + '...');
                }, 100);
            } else {
                console.error('Could not find image-upload-container element!');
            }
            
            // Store reference globally for form submission
            window.manualPostImageUpload = imageUpload;
            
            // Override updatePreview method to add debugging
            const originalUpdatePreview = imageUpload.updatePreview.bind(imageUpload);
            imageUpload.updatePreview = function() {
                console.log('[DEBUG] updatePreview called, images array:', this.images);
                console.log('[DEBUG] showPreview option:', this.options.showPreview);
                
                const previewContainer = this.container?.querySelector('.image-previews');
                console.log('[DEBUG] Preview container found:', previewContainer);
                
                if (previewContainer) {
                    console.log('[DEBUG] Preview container innerHTML before update:', previewContainer.innerHTML);
                }
                
                // Call original method
                originalUpdatePreview();
                
                if (previewContainer) {
                    console.log('[DEBUG] Preview container innerHTML after update:', previewContainer.innerHTML);
                    console.log('[DEBUG] Preview container children count:', previewContainer.children.length);
                }
            };
            
            // Add event listener to track file uploads
            setTimeout(() => {
                if (imageUpload.container) {
                    const fileInput = imageUpload.container.querySelector('.file-input');
                    if (fileInput) {
                        fileInput.addEventListener('change', (e) => {
                            console.log('[DEBUG] File input changed, files:', e.target.files);
                            setTimeout(() => {
                                console.log('[DEBUG] Images in utility after file selection:', imageUpload.getImages());
                                console.log('[DEBUG] Manually calling updatePreview...');
                                imageUpload.updatePreview();
                            }, 1000);
                        });
                        console.log('[DEBUG] File input event listener added');
                    } else {
                        console.error('[DEBUG] Could not find file input element');
                    }
                } else {
                    console.error('[DEBUG] Image upload container not found for event listener');
                }
            }, 500);
        });
    </script>
</body>
</html>