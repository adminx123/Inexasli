<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - INEXASLI Social Media Automation</title>
    <link rel="stylesheet" href="salesflow.css">
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="splash-container" id="splashContainer" style="padding-top: 40px; position: absolute; top: 0; left: 0; width: 100%; z-index: 2;">
        <img src="../images/favicon.svg" alt="INEXASLI Logo" class="splash-logo" style="margin-top: 20px;">
        <div class="splash-inexasli">INEXASLI<span class="tm">™</span></div>
        <div class="splash-empowering">Empowering Thee<span class="tm">™</span></div>
    </div>

    <div class="device-container" id="mainContent" style="opacity: 0; display: block; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; z-index: 1;">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step completed">
                    <div class="step-number">1</div>
                    <span>Choose Package</span>
                </div>
                <div class="step completed">
                    <div class="step-number">2</div>
                    <span>Add-ons</span>
                </div>
                <div class="step completed">
                    <div class="step-number">3</div>
                    <span>Review Quote</span>
                </div>
                <div class="step active">
                    <div class="step-number">4</div>
                    <span>Payment</span>
                </div>
            </div>

            <!-- Payment Section -->
            <div class="quote-results-container" id="paymentSection">
                <div class="quote-header">
                    <h1 class="quote-title">Complete Your Order</h1>
                    <p class="quote-subtitle">Secure payment processing powered by Stripe</p>
                </div>
                
                <!-- Order Summary -->
                <div class="quote-box" id="orderSummary">
                    <h3 class="quote-box-title">Order Summary</h3>
                    <!-- Order details will be populated by JavaScript -->
                </div>

                <!-- Customer Information -->
                <div class="form-section" style="max-width: 500px; margin: 30px auto;">
                    <h3>Billing Information</h3>
                    <div class="form-fields">
                        <input type="email" id="email" placeholder="Email Address" required>
                        <input type="text" id="fullName" placeholder="Full Name" required>
                        <input type="text" id="company" placeholder="Company Name (Optional)">
                    </div>
                </div>
                
                <!-- Buttons -->
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin: 30px 0;">
                    <button onclick="goBack()" class="btn-back">
                        ← Back to Quote
                    </button>
                    <button id="submit-payment" class="proceed-button">
                        Complete Payment
                    </button>
                </div>
                
                <div class="payment-disclaimer">
                    <strong>Secure payment by Stripe</strong> • SSL encrypted • 30-day satisfaction guarantee<br>
                    You will receive an email confirmation with your order details and Stripe receipt
                </div>
                
                <!-- Legal Footer -->
                <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <p style="color: #ccc; font-size: 12px; margin: 0;">
                        By completing this purchase, you agree to our 
                        <a href="#" onclick="showSocialTerms(); return false;" style="color: #4CAF50; text-decoration: none;">Terms of Service</a>
                        and 
                        <a href="#" onclick="showSocialPrivacy(); return false;" style="color: #4CAF50; text-decoration: none;">Privacy Policy</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Splash screen transition
        const splash = document.getElementById('splashContainer');
        const main = document.getElementById('mainContent');
        
        // Start main content fade-in immediately
        main.style.transition = 'opacity 1.2s ease-in';
        
        setTimeout(() => {
            // Start crossfade
            main.style.opacity = '1';
            splash.style.opacity = '0';
            splash.style.transition = 'opacity 1.2s ease-out';
            
            setTimeout(() => {
                splash.style.display = 'none';
                main.style.position = 'static';
            }, 1200);
        }, 1500);

        // Load order data from localStorage
        function loadOrderData() {
            const orderData = localStorage.getItem('orderData');
            if (!orderData) {
                // Redirect back to packages if no order data
                window.location.href = 'packages.html';
                return null;
            }
            return JSON.parse(orderData);
        }

        // Display order summary
        function displayOrderSummary(orderData) {
            const summaryContainer = document.getElementById('orderSummary');
            const { package: selectedPackage, addons: selectedAddons = [], total } = orderData;
            
            let summaryHTML = `
                <h3 class="quote-box-title">${selectedPackage.name}</h3>
                <div style="margin-bottom: 20px; text-align: left; color: white;">
                    <strong>Base Package:</strong><br>
                    • ${selectedPackage.features.join('<br>• ')}<br><br>
                    <strong>Selected Platforms:</strong><br>
                    • ${selectedPackage.platforms.join('<br>• ')}
                </div>
                
                <div class="quote-line">
                    <span class="quote-line-label">${selectedPackage.name}</span>
                    <span class="quote-line-amount">$${selectedPackage.price}</span>
                </div>
            `;
            
            // Add selected addons
            selectedAddons.forEach(addon => {
                summaryHTML += `
                    <div class="quote-line">
                        <span class="quote-line-label">${addon.name}</span>
                        <span class="quote-line-amount">+$${addon.price}</span>
                    </div>
                `;
            });
            
            summaryHTML += `
                <div class="quote-total">
                    <span class="quote-total-label">Total</span>
                    <span class="quote-total-amount">$${total}</span>
                </div>
            `;
            
            summaryContainer.innerHTML = summaryHTML;
        }

        // Create Stripe checkout session via backend
        async function createCheckoutSession(orderData) {
            const { package: selectedPackage, addons: selectedAddons = [] } = orderData;
            
            try {
                // Call backend to create checkout session
                const response = await fetch('https://stripeintegration.4hm7q4q75z.workers.dev/package-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        packageType: selectedPackage.type,
                        platforms: selectedPackage.platforms,
                        addons: selectedAddons.map(a => a.id),
                        customerEmail: document.getElementById('email').value
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create checkout session');
                }
                
                const result = await response.json();
                
                if (result.success && result.url) {
                    // Redirect to Stripe checkout
                    window.location.href = result.url;
                } else {
                    throw new Error('Invalid response from server');
                }
                
            } catch (err) {
                console.error('Checkout error:', err);
                alert('Unable to process payment. Please try again.');
            }
        }

        // Handle payment submission
        document.getElementById('submit-payment').addEventListener('click', function() {
            const email = document.getElementById('email').value;
            const fullName = document.getElementById('fullName').value;
            
            if (!email || !fullName) {
                alert('Please fill in all required fields.');
                return;
            }
            
            const orderData = loadOrderData();
            if (orderData) {
                createCheckoutSession(orderData);
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const orderData = loadOrderData();
            if (orderData) {
                displayOrderSummary(orderData);
                
                // Pre-fill customer info if available
                if (orderData.customerInfo) {
                    document.getElementById('email').value = orderData.customerInfo.email || '';
                    document.getElementById('fullName').value = orderData.customerInfo.name || '';
                    document.getElementById('company').value = orderData.customerInfo.company || '';
                }
            }
        });
        
        function goBack() {
            window.location.href = 'quote.html';
        }
    </script>
    
    <!-- Splash Screen Transition Script -->
    <script>
        // Splash screen transition
        document.addEventListener('DOMContentLoaded', function() {
            const splash = document.getElementById('splashContainer');
            const main = document.getElementById('mainContent');
            
            // Start main content fade-in immediately
            main.style.transition = 'opacity 1.2s ease-in';
            
            setTimeout(() => {
                // Start crossfade
                main.style.opacity = '1';
                splash.style.opacity = '0';
                splash.style.transition = 'opacity 1.2s ease-out';
                
                setTimeout(() => {
                    splash.style.display = 'none';
                    main.style.position = 'static';
                    main.style.left = 'auto';
                    main.style.transform = 'none';
                }, 1200);
            }, 1500); // Show splash for 1.5 seconds
        });
    </script>
    
    <script src="/utility/modal.js"></script>
    <script src="/business/legalSocial.js"></script>
    <script src="step-navigation.js"></script>
</body>
</html>
