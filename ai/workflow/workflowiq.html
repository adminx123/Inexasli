<!--
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
-->

        <div class="row1">
            <label class="category-label">Task Description</label>
            <textarea id="workflowiq-task" rows="2" placeholder="Enter task (e.g., Invoice processing)"></textarea>
        </div>
        <div class="row1">
            <label class="category-label">Task Steps</label>
            <textarea id="workflowiq-steps" rows="2" placeholder="Task steps: (1 per line)\ne.g., Data entry, Approval, Archiving"></textarea>
        </div>
        <div class="row1">
            <label class="category-label">Tools Used</label>
            <textarea id="workflowiq-tools" rows="2" placeholder="Tools used: (1 per line)\ne.g., Excel, ERP, Email"></textarea>
        </div>
        <div class="row1">
            <label class="category-label">Automation Type</label>
            <select id="workflowiq-automation-type">
                <option value="scripting">Scripting</option>
                <option value="rpa">RPA</option>
                <option value="api">API Integration</option>
                <option value="low-code">Low-Code Platform</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="row1">
            <label class="category-label">Priority Focus</label>
            <select id="workflowiq-priority">
                <option value="efficiency">Efficiency</option>
                <option value="cost">Cost</option>
                <option value="accuracy">Accuracy</option>
                <option value="scalability">Scalability</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="row1">
            <label class="category-label">Goals</label>
            <textarea id="workflowiq-goals" rows="2" placeholder="Goals: (1 per line)\ne.g., Reduce time, Minimize errors"></textarea>
        </div>
        <div class="row1">
            <label class="category-label">Constraints</label>
            <textarea id="workflowiq-constraints" rows="2" placeholder="Constraints: (1 per line)\ne.g., Budget, Legacy systems"></textarea>
        </div>
        <div class="row1">
            <label class="category-label">Additional Instructions</label>
            <textarea id="workflowiq-instructions" rows="3" placeholder="Additional instructions: (1 per line)\ne.g., Prefer open-source tools, Ensure audit trail"></textarea>
        </div>
        <button class="generate-btn" id="generate-workflow-btn">Generate Workflow Plan Now!</button>
        <button class="clear-btn" id="clear-workflow-btn">Clear All</button>


    <script>
    /*
     * Copyright (c) 2025 INEXASLI. All rights reserved.
     * This code is protected under Canadian and international copyright laws.
     * Unauthorized use, reproduction, distribution, or modification of this code 
     * without explicit written permission via email from info@inexasli.com 
     * is strictly prohibited.
    */
    (function() {
        console.log("[WorkflowIQ] script initializing");

        const setJSON = window.setJSON || function(name, value) {
            try {
                return true;
            } catch (e) {
                console.error(e);
                return false;
            }
        };
        const getJSON = window.getJSON || function(name, defaultValue) {
            try {
                const item = localStorage.getItem(name);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) { console.error(e); return defaultValue; }
        };

        // Handler for grid-item-toggled event from datain.js
        function handleGridItemToggled(event) {
            console.log('[WorkflowIQ] Grid item toggled event received');
            const item = event.detail.item;
            
            // Save grid item selection
            saveGridItem(item);
        }
        
        // Save grid item selection
        function saveGridItem(item) {
            console.log('[WorkflowIQ] Saving all form data to JSON');
            const formData = collectFormData();
            setJSON('workflowIqInput', formData);
        }

        function saveInput(input) {
            if (!input || !input.id) return;
            const formData = collectFormData();
            setJSON('workflowIqInput', formData);
        }

        function collectFormData() {
            return {
                task: document.getElementById('workflowiq-task')?.value.trim() || '',
                steps: document.getElementById('workflowiq-steps')?.value.trim() || '',
                tools: document.getElementById('workflowiq-tools')?.value.trim() || '',
                automationType: document.getElementById('workflowiq-automation-type')?.value || '',
                priority: document.getElementById('workflowiq-priority')?.value || '',
                goals: document.getElementById('workflowiq-goals')?.value.trim() || '',
                constraints: document.getElementById('workflowiq-constraints')?.value.trim() || '',
                instructions: document.getElementById('workflowiq-instructions')?.value.trim() || ''
            };
        }

        function repopulateForm() {
            const data = getJSON('workflowIqInput', null);
            if (!data) return;
            document.getElementById('workflowiq-task').value = data.task;
            document.getElementById('workflowiq-steps').value = data.steps;
            document.getElementById('workflowiq-tools').value = data.tools;
            document.getElementById('workflowiq-automation-type').value = data.automationType;
            document.getElementById('workflowiq-priority').value = data.priority;
            document.getElementById('workflowiq-goals').value = data.goals;
            document.getElementById('workflowiq-constraints').value = data.constraints;
            document.getElementById('workflowiq-instructions').value = data.instructions;
        }

        function clearLocalStorage() {
            if (!confirm("Are you sure you want to clear all saved data? This action cannot be undone.")) return;
            localStorage.removeItem('workflowIqInput');
            localStorage.removeItem('workflowIqResponse');
            document.querySelectorAll('input, textarea, select').forEach(el => el.value = '');
            alert("All workflow data has been cleared successfully.");
        }

        async function handleGenerateWorkflowIq() {
            const btn = document.getElementById('generate-workflow-btn');
            const initialText = btn.innerText;
            btn.innerText = 'Loading...';
            btn.disabled = true;
            try {
                const formData = getJSON('workflowIqInput');
                if (!formData || !formData.task) {
                    alert('Please complete the form before generating a workflow plan.');
                    btn.innerText = initialText;
                    btn.disabled = false;
                    return;
                }
                const response = await fetch('https://workflow.4hm7q4q75z.workers.dev/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                setJSON('workflowIqResponse', data);
                btn.innerText = 'Success!';
                setTimeout(() => { btn.disabled = false; btn.innerText = initialText; }, 1000);
                document.dispatchEvent(new CustomEvent('api-response-received', { detail: { module: 'workflowiq', type: 'worker-response', timestamp: Date.now() } }));
            } catch (error) {
                console.error(error);
                alert('An error occurred while generating.');
                btn.innerText = 'Error';
                setTimeout(() => { btn.innerText = initialText; btn.disabled = false; }, 2000);
            }
        }

        function setupHandlers() {
            // Set up input handlers
            document.querySelectorAll('input, textarea, select').forEach(input => {
                input.addEventListener('change', function() {
                    saveInput(this);
                });
            });
            
            // Button handlers
            const generateBtn = document.getElementById('generate-workflow-btn');
            if (generateBtn) {
                generateBtn.addEventListener('click', handleGenerateWorkflowIq);
            }
            
            const clearBtn = document.getElementById('clear-workflow-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearLocalStorage);
            }
            
            // Set up grid-item-toggled event listener
            document.removeEventListener('grid-item-toggled', handleGridItemToggled); // Remove any existing to prevent duplicates
            document.addEventListener('grid-item-toggled', handleGridItemToggled);
        }
        
        // Initialize with a function that can be called again when loaded through datain.js
        function initialize() {
            console.log("[WorkflowIQ] Initializing...");
            setupHandlers();
            repopulateForm();
        }
        
        // Initialize immediately
        initialize();
        
        // Special handler for when this page is loaded through datain.js
        document.addEventListener('data-in-loaded', function(e) {
            console.log("[WorkflowIQ] Detected load through datain.js, reinitializing");
            setTimeout(initialize, 100); // Small delay to ensure DOM is updated
        });
        
        // For external access if needed
        window.workflowIq = {
            initialize,
            saveGridItem,
            saveInput,
            clearLocalStorage,
            getFormData: collectFormData
        };
    })();
    </script>
