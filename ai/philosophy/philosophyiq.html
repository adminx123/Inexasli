<!--
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide. -->

<div class="device-container">

<div class="row1 product-description-container">
    <h2 class="product-description-heading">Explore Philosophical Ideas, Deepen Your Understanding!</h2>
    <p class="product-description-text">
        Intrigued by life's big questions or seeking new perspectives on complex concepts? PhilosophyIQâ„¢ offers a space for exploration. By posing your questions or outlining areas of interest, you enable our AI to draw upon a vast range of philosophical thought, providing you with summaries, different viewpoints, and thought-provoking insights to enrich your understanding.
    </p>
    <p class="product-description-final">
        Let's ponder together!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a professional.</em>
    </p>
</div>

  <!-- Simple Form for Philosophical Wisdom -->
  <div class="row1">
    <h3 class="tooltip1" data-tooltip="Share the philosophical questions, dilemmas, or life challenges you'd like to explore and receive wisdom on.">
        Seeking Wisdom On<span class="tooltip1-content"></span>
    </h3>
    <textarea id="philosophy-question" rows="5" placeholder="How to find meaning in difficult work
Balancing family obligations with personal goals
Making ethical decisions when options seem equally wrong
Finding inner peace during times of uncertainty
Accepting things I cannot change"></textarea>
 

  <button class="generate-btn" id="generate-philosophy-btn">Find Philosophical Wisdom</button>
 </div>

 
  <script type="module">
  /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

  // Import fingerprint utilities
  import { getFingerprintForWorker, incrementRequestCount, isRateLimited } from '/utility/rateLimiter.js';
  import { handleRateLimitResponse } from '/ai/rate-limiter/rateLimiter.js';

  (function() {
    console.log("PhilosophyIQ script initializing");

    // FormPersistence is initialized by datain.js and available as window.philosophyFormPersistence
    // No need to create it here - just ensure it's available when we need it

    // Listen for grid-item-toggled event from datain.js
    function handleGridItemToggled(event) {
        console.log('[PhilosophyIQ] Grid item toggled event received');
        // UI behavior only - persistence handled centrally
    }

    // Handle the generate button click
    async function handleGeneratePhilosophyIq() {
        console.log('[PhilosophyIQ] Generate button clicked.');
        
        const formData = window.philosophyFormPersistence.getSavedFormData();
        if (!formData) {
            console.error('[PhilosophyIQ] No input data found in localStorage.');
            alert('Please enter what you\'re seeking wisdom on before proceeding.');
            return;
        }

        // Check rate limiting before proceeding
        if (isRateLimited('philosophy', 6, 60 * 60 * 1000)) { // 6 requests per hour (as per rate-limiter config)
            alert('You have exceeded the request limit for philosophy analysis. Please try again later.');
            return;
        }

        // Get fingerprint data for rate limiting
        const fingerprintData = getFingerprintForWorker();
        
        // Create combined payload with both form data and fingerprint
        const workerPayload = {
            formData: formData,
            fingerprint: fingerprintData
        };
        
        const dataContainer = document.querySelector('.data-container-in');
        let backendResponse = null;
        try {
            backendResponse = await window.enhancedLoading(
                'generate-philosophy-btn',
                'philosophy',
                async () => {
                    // Send data to worker
                    const apiUrl = 'https://philosophy.4hm7q4q75z.workers.dev/';
                    
                    console.log('[PhilosophyIQ] Sending philosophyIqInput to worker');
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(workerPayload)
                    });
                    let responseData;
                    try {
                        responseData = await response.json();
                    } catch (e) {
                        responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
                    }
                    // Always call handleRateLimitResponse with backend response
                    handleRateLimitResponse(dataContainer, responseData, !response.ok);
                    if (!response.ok) {
                        throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
                    }
                    if (responseData.message !== 'Success') {
                        throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
                    }
                    
                    // Store the response
                    window.philosophyFormPersistence.saveResponseData(responseData);
                    
                    // Dispatch an event to notify dataout.js that a response was received
                    const event = new CustomEvent('api-response-received', {
                        detail: {
                            module: 'philosophyiq',
                            type: 'worker-response',
                            timestamp: Date.now()
                        }
                    });
                    document.dispatchEvent(event);
                    console.log('[PhilosophyIQ] Dispatched api-response-received event');
                    
                    return responseData;
                }
            );
            incrementRequestCount('philosophy');
            console.log('[PhilosophyIQ] Philosophical wisdom generated successfully');
        } catch (error) {
            // If backendResponse is available, update rate limit display and show error
            if (backendResponse && dataContainer) {
                handleRateLimitResponse(dataContainer, backendResponse, true);
            }
            // Optionally, show a toast/modal here for generic errors
            console.error('[PhilosophyIQ] Error:', error);
        }
    }

    // Initialization
    document.addEventListener('grid-item-toggled', handleGridItemToggled);
    document.getElementById('generate-philosophy-btn').addEventListener('click', handleGeneratePhilosophyIq);

    // Guided forms integration
    if (typeof GuidedForms !== 'undefined' && GuidedForms.philosophyiq) {
        new GuidedForms.philosophyiq();
    }
  })();
  </script>
</div> <!-- Close mobile-container -->