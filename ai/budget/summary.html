<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

 <!DOCTYPE html>
 <html lang="en">
 <head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta name="description" content="Educational financial tool to estimate, learn, and simulate—not financial advice.">
   <title> IncomeIQ™ Summary</title>
   <link rel="icon" type="image/x-icon" href="/images/newLogo.jpg">
   <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
   <link rel="stylesheet" href="/style/styles.css">
   <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.js"></script>
   <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
   <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
   <link rel="shortcut icon" href="/images/favicon.ico" />
   <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />

 </head>

 <style>/* Premium Section Styling */
  
  
  /* Premium Section Summary */
  .premium-section summary {
      cursor: pointer;
      padding: 8px;
      font-weight: bold;
      color: #000000; /* Blue text for premium feel */
      background-color: #f5f5f5; /* Slightly darker premium background */
      border-radius: 4px;
      transition: background-color 0.3s ease;
  }
  
  .premium-section summary:hover {
      background-color: #d3bc0f; /* Hover effect */
  }
  
  /* Premium Content (Locked State) */
  .premium-blur {
      filter: blur(3px); /* Blur effect for locked content */
      color: #888; /* Grayed out text */
      pointer-events: none; /* Disable interaction */
      transition: filter 0.3s ease, color 0.3s ease; /* Smooth unlock transition */
  }
  
  /* Premium Notice */
  .premium-notice {
      display: inline-block;
      margin-left: 10px;
      padding: 4px 8px;
      background-color: #000000; /* Yellow notice background */
      color: #ffffff; /* Dark text for readability */
      font-size: 0.85em;
      border-radius: 4px;
      font-weight: bold;
  }
  
  /* Unlocked Premium Content */
  .premium-section:not(.premium-blur) span[id="DISPOSABLEINCOME"],
  .premium-section:not(.premium-blur) span[id="DEBTTOINCOME"],
  .premium-section:not(.premium-blur) span[id="FIRERATIO"],
  .premium-section:not(.premium-blur) span[id="HOUSINGTOINCOME"],
  .premium-section:not(.premium-blur) span[id="SAVINGSTODEBT"] {
      color: #caa81f; /* Dark blue for unlocked premium values */
      font-weight: 600;
      margin-left: 5px;
  }
  
  /* Specific Premium Elements */
  #DISPOSABLEINCOME {
      font-size: 1.1em; /* Slightly larger for emphasis */
      display: inline-block;
      padding: 2px 6px;
      background-color: #e6f0ff; /* Light blue background */
      border-radius: 4px;
  }
  
  #DEBTTOINCOME, #FIRERATIO, #HOUSINGTOINCOME, #SAVINGSTODEBT {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background-color: #edf2f7; /* Subtle gray-blue background */
  }
  
  /* Premium Ratios List */
  .premium-section details ul {
      list-style-type: none; /* Remove default bullets */
      padding-left: 0;
      margin: 5px 0;
  }
  
  .premium-section details li {
      padding: 4px 0;
      color: #4a5568; /* Darker gray for readability */
  }
  
  .premium-section details li strong {
      color: #2d3748; /* Even darker for emphasis */
  }
  
  /* Responsive Adjustments */
  @media (max-width: 768px) {
      .premium-section {
          padding: 8px;
      }
      .premium-section summary {
          font-size: 0.95em;
      }
      #DISPOSABLEINCOME {
          font-size: 1em;
      }
      .premium-notice {
          font-size: 0.8em;
      }
  }
  
 
 
  
  </style>
  
 <body style="display: none;"> 
  
 



   
   <!-- Main Content -->

    <h3 style="text-align: center; font-size: 20px; color: rgb(0, 0, 0); margin-bottom: 10px; font-weight: bold;">Summary</h4>


     <!-- Disclaimer Banner -->
     <div style="text-align: center; font-size: 0.9em; color: #fff; background: #333; padding: 10px; margin-bottom: 15px;">
       Not financial advice. All calculations are educational estimates based on your inputs. Consult a professional before making financial decisions.
     </div>

     
 
     <!-- Frequency Selector (Free) -->
     <div style="text-align:center;">
       <select id="frequency">
         <option value="annual">Annual Frequency</option>
         <option value="monthly">Monthly Frequency</option>
         <option value="weekly">Weekly Frequency</option>
       </select>
     </div>
 
     

     
    
 
     <div class="summary-container">

      <!-- Premium: Taxes & Obligations -->
      <details style="margin-top:10px;">
        <summary>
          <span class="tooltip1" data-tooltip="Detailed tax and obligation breakdowns based on your inputs.">
            <h2>TAXES & OBLIGATIONS<span class="tooltip1-content"></span></h2>
          </span>
        </summary>

  


          
            <details style="margin-top:10px;">
              <summary>
                <p style="margin-left:21px;">
                  <span class="tooltip1" data-tooltip="Total taxes owed, calculated from taxable income (gross minus deductions like SD in USA or BPA in Canada) using regional rates (e.g., USA federal/state, Canada federal/provincial). Includes income tax and full (USA) or 50% (Canada) capital gains tax; excludes obligations like CPP/Social Security. Use: Estimate tax burden.">
                    <u>Total Tax Payable:</u><span class="tooltip1-content"></span><span id="TOTALTAXANNUAL"></span>
                  </span>
                </p>
              </summary>
          
              <p style="margin-left:34px;">
                <span class="tooltip1" data-tooltip="Regional taxes based on your data.">
                  <u>Regional Tax Payable:</u><span class="tooltip1-content"></span>
                  <span id="REGIONALTAXANNUAL"></span>
                </span>
              </p>
              
              <p style="margin-left:34px;">
                <span class="tooltip1" data-tooltip="Subregion taxes from your inputs.">
                  <u>Subregion Tax Payable:</u><span class="tooltip1-content"></span>
                  <span id="SUBREGIONTAXANNUAL"></span>
                </span>
              </p>
          
            
            
             
            </details>
          
            <details style="margin-top:10px;">
              <summary>
                <p style="margin-left:21px;">
                  <span class="tooltip1" data-tooltip="Other government obligations from your inputs.">
                    <u>Total Other Obligations:</u><span class="tooltip1-content"></span>
                  </span>
                </p>
              </summary>
           
              <p style="margin-left:34px;">
                <span class="tooltip1" data-tooltip="input collective amout of all othe robligations payable">
                  <u>Other Obligations Payable:</u><span class="tooltip1-content"></span>
                  <span id="OTHEROBLIGATIONANNUAL"></span>
                </span>
              </p>
          

<!--

         <div class="can-hide">

            <details style="margin-top:10px;">
<summary>
            <p style="margin-left:34px;">
              <span class="tooltip1" data-tooltip="Total CPP based on your income and status.">
                <u>Total CPP Payable:</u><span class="tooltip1-content"></span><span id="cpp_sum" ></span>
              </span>
            </p>
</summary>

            <p style="margin-left:34px;">
              <span class="tooltip1" data-tooltip="CPP for self-employed, based on your income.">
                <u>Self Employed CPP Payable:</u><span class="tooltip1-content"></span><span id="annual_cpp_seresult"></span>
              </span>
            </p>

            <p style="margin-left:34px;">
              <span class="tooltip1" data-tooltip="CPP for employed, from your data.">
                <u>Employed CPP Payable:</u><span class="tooltip1-content"></span><span id="annual_cpp_eresult" ></span>
              </span>
            </p>
</details>
           

            <p style="margin-left:34px;">
              <span class="tooltip1" data-tooltip="Employment Insurance (EI) contribution, calculated from your income inputs (e.g., 1.63% up to ~$63,200 in 2025, per CRA) if employed. Self-employed individuals aren’t required to pay EI but can opt in for benefits like parental leave. Excludes non-wage income. Use: Estimate job-related costs.">         
                       <u>Total Employment Insurance Payable:</u><span class="tooltip1-content"></span><span id="ANNUALEI" ></span>
              </span>
            </p>

          </div>



          <div class="usa-hide">

            <details style="margin-top:10px;">
<summary>
            <p style="margin-left:34px;">
              <span class="tooltip1" data-tooltip="Social Security total from your U.S. income data.">
                <u>Social Security Total US:</u><span class="tooltip1-content"></span><span id="TOTALSOCIALSECURITY" ></span>
              </span>
            </p>
</summary>


            <p style="margin-left:34px;">
              <span class="tooltip1" data-tooltip="Social Security for employed, based on your inputs.">
                <u>Social Security Employed US:</u><span class="tooltip1-content"></span><span id="TOTALSOCIALSECURITYE" ></span>
              </span>
            </p>
            <p style="margin-left:34px;">
              <span class="tooltip1" data-tooltip="Social Security for self-employed, from your data.">
                <u>Social Security Self Employed US:</u><span class="tooltip1-content"></span><span id="TOTALSOCIALSECURITYSE" ></span>
              </span>
            </p>
            </details>


            <p style="margin-left:34px;">
              <span class="tooltip1" data-tooltip="Medicare tax calculated from your income.">
                <u>Medicare:</u><span class="tooltip1-content"></span><span id="TOTALMEDICARE" ></span>
              </span>
            </p>
          </div>
        -->

        </details>

      </details>

    </div>

<div class="summary-container1">



    
     <!-- Free: Income & Expenses -->
     <details style="margin-top:10px;">
       <summary>
         <span class="tooltip1" data-tooltip="Your total earnings and spending based on your inputs.">
           <h2>INCOME & EXPENSES<span class="tooltip1-content"></span></h2>
         </span>
       </summary>

<!-- Premium: Disposable Income -->

<p style="margin-left:21px;" class="premium-section">
   <span class="tooltip1" data-tooltip="Income left after subtracting expenses, taxes, and obligations from gross income. Calculated as: gross income - (taxes like income/capital gains + obligations like CPP/Social Security + all expenses). Includes only your spendable remainder; excludes locked savings. Use: Gauge financial flexibility.">
               </style>DISPOSABLE INCOME:<span class="premium-notice">Premium</span><span class="tooltip1-content"></span><span id="DISPOSABLEINCOME" class="premium-blur">[Locked]</span>
    </span>
  </p>
 
 

       <p style="margin-left:21px;">
        <span class="tooltip1" data-tooltip="Total gross earnings you’ve entered (e.g., wages, freelance, interest). Calculated by summing all income sources before taxes or deductions. Includes taxable amounts (e.g., 100% capital gains in USA, 50% in Canada); excludes tax-free gains (e.g., Canada’s TFSA). Use: Base for tax and budget planning.">          
           <u>Income:</u><span class="tooltip1-content"></span><span id="annual_income_sum"></span>
         </span>
       </p>
       <details style="margin-top:10px;">
         <summary>
           <p style="margin-left:21px;">
            <span class="tooltip1" data-tooltip="Total spending you’ve entered, calculated by summing all expense categories (essential, discretionary, etc.). Includes costs like housing and debt payments; excludes taxes or obligations unless specified. Use: Track cash outflow and budget.">            
                 <u>Expense:</u><span class="tooltip1-content"></span><span id="ANNUALEXPENSESUM"></span>
             </span>
           </p>
         </summary>
         <p style="margin-left:34px;">
           <span class="tooltip1" data-tooltip="Essential spending categories you’ve entered.">
             <u>Essential Expense:</u><span class="tooltip1-content"></span><span id="ESSENTIAL"></span>
           </span>
         </p>
         <p style="margin-left:34px;">
           <span class="tooltip1" data-tooltip="Non-essential spending you’ve tracked.">
             <u>Discretionary Expense:</u><span class="tooltip1-content"></span><span id="DISCRETIONARY"></span>
           </span>
         </p>
         <p style="margin-left:34px;">
           <span class="tooltip1" data-tooltip="Housing costs from your data.">
             <u>Housing Expense:</u><span class="tooltip1-content"></span><span id="HOUSING"></span>
           </span>
         </p>
         <p style="margin-left:34px;">
           <span class="tooltip1" data-tooltip="Transportation costs you’ve logged.">
             <u>Transportation Expense:</u><span class="tooltip1-content"></span><span id="TRANSPORTATION"></span>
           </span>
         </p>
         <p style="margin-left:34px;">
           <span class="tooltip1" data-tooltip="Dependant-related spending from your inputs.">
             <u>Dependant Expense:</u><span class="tooltip1-content"></span><span id="DEPENDANT"></span>
           </span>
         </p>
         <p style="margin-left:34px;">
           <span class="tooltip1" data-tooltip="Debt payments you’ve entered.">
             <u>Debt Expense:</u><span class="tooltip1-content"></span><span id="DEBT"></span>
           </span>
         </p>
       </details>

  

     </details>


 
  <details style="margin-top:10px;" >
    <summary>
      <span class="tooltip1" data-tooltip="Wealth tracking">
        <h2>WEALTH<span class="tooltip1-content"></span></h2>
      </span>
    </summary>

    <p style="margin-left:21px;">
      <span class="tooltip1" data-tooltip="Total value of resources you’ve entered.">
        <u>Assets:</u><span class="tooltip1-content"></span><span id="ASSETS"></span>
      </span>
    </p>
    <p style="margin-left:21px;">
      <span class="tooltip1" data-tooltip="Total debts or obligations you’ve logged.">
        <u>Liabilities:</u><span class="tooltip1-content"></span><span id="LIABILITIES"></span>
      </span>
    </p>

    <p style="margin-left:45px;">
      <span class="tooltip1" data-tooltip="Assets minus liabilities. A snapshot of wealth based on your inputs.">
        <u>Net Worth:</u><span class="tooltip1-content"></span><span id="NETWORTH"></span>
      </span>
    </p>
  </details>

    
 
    
 
          <!-- Premium: Premium Ratios -->
        <!-- Premium: Premium Ratios -->
<details style="margin-top:10px;">
  <summary>
    <span class="tooltip1" data-tooltip="Advanced ratios to explore financial relationships.">
      <h2 style="justify-content: center;">RATIOS<span class="tooltip1-content"></span></h2>
    </span>
  </summary>



  <details style="margin-top:10px;">
    <summary>
      <p style="margin-left:21px;" class="premium-section">
        <span class="tooltip1" data-tooltip="Debt divided by income. A common metric from your inputs.">
          <u>Debt to Income:<span class="premium-notice">Premium</span></u><span class="tooltip1-content"></span><span id="DEBTTOINCOME" class="premium-blur">[Locked]</span>
        </span>
      </p>
    </summary>
    <ul style="margin-left:34px;">
      <li><strong>Above 0.36:</strong> Common threshold for concern, per Investopedia</li>
      <li><strong>0.20 to 0.36:</strong> Typical range, per Investopedia</li>
      <li><strong>Below 0.20:</strong> Often considered healthy, per Investopedia</li>
    </ul>
  </details>

  <details style="margin-top:10px;">
    <summary>
      <p style="margin-left:21px;" class="premium-section">
        <span class="tooltip1" data-tooltip="Passive income vs. expenses. A FIRE concept calculated from your data.">
          <u>FIRE:<span class="premium-notice">Premium</span></u><span class="tooltip1-content"></span><span id="FIRERATIO" class="premium-blur">[Locked]</span>
        </span>
      </p>
    </summary>
    <ul style="margin-left:34px;">
      <li><strong>Below 0.25:</strong> Early stage of financial independence, per Financial Planning Association</li>
      <li><strong>0.25 to 0.99:</strong> Progress toward independence, per Financial Planning Association</li>
      <li><strong>1.0 or higher:</strong> Common benchmark for financial independence, per Financial Planning Association</li>
    </ul>
  </details>

  <details style="margin-top:10px;">
    <summary>
      <p style="margin-left:21px;" class="premium-section">
        <span class="tooltip1" data-tooltip="Housing costs divided by income, calculated from your data.">
          <u>Housing to Income:<span class="premium-notice">Premium</span></u><span class="tooltip1-content"></span><span id="HOUSINGTOINCOME" class="premium-blur">[Locked]</span>
        </span>
      </p>
    </summary>
    <ul style="margin-left:34px;">
      <li><strong>Above 0.35:</strong> Common threshold for concern, per Investopedia</li>
      <li><strong>0.28 to 0.35:</strong> Typical range, per Investopedia</li>
      <li><strong>Below 0.28:</strong> Often considered affordable, per Investopedia</li>
    </ul>
  </details>

  <details style="margin-top:10px;">
    <summary>
      <p style="margin-left:21px;" class="premium-section">
        <span class="tooltip1" data-tooltip="Savings divided by debt, based on your inputs.">
          <u>Savings to Debt:<span class="premium-notice">Premium</span></u><span class="tooltip1-content"></span><span id="SAVINGSTODEBT" class="premium-blur">[Locked]</span>
        </span>
      </p>
    </summary>
    <ul style="margin-left:34px;">
      <li><strong>Below 1.0:</strong> Common threshold for concern, per Consumer Financial Protection Bureau</li>
      <li><strong>1.0 to 2.0:</strong> Typical range, per Consumer Financial Protection Bureau</li>
      <li><strong>2.0 or higher:</strong> Often considered a sign of stability, per Consumer Financial Protection Bureau</li>
    </ul>
  </details>
</details>

          <details style="margin-top:10px;" >
            <summary>
              <span class="tooltip1" data-tooltip="Hypothetical calculations based on your current data, for learning purposes only.">
                <h2>FINANCIAL PROJECTIONS<span class="tooltip1-content"></span></h2>
              </span>
             
            </summary>
            <p style="margin-left:21px;" class="premium-section">
              <span class="tooltip1" data-tooltip="Hypothetical time to pay revolving debt using your disposable income, no interest assumed.">
                  <u>Revolving Debt - Time to Pay:<span class="premium-notice">Premium</span></u><span class="tooltip1-content"></span><span id="TIMETOPAYDEBT" class="premium-blur">[Locked]</span>
              </span>
          </p>
            <p style="margin-left:21px;" class="premium-section">
              <span class="tooltip1" data-tooltip="Enter a savings goal to see a hypothetical timeline based on your disposable income.">
                <u>Savings Goal:<span class="premium-notice">Premium</span></u><input id="goalAmount" type="number" disabled style="margin-left: 15px;"><span class="tooltip1-content"></span><span id="goalResult"></span>
              </span>
            </p>
          </details>

          <details style="margin-top:10px;">
            <summary>
              <span class="tooltip1" data-tooltip="Relevant Data.">
                <h2>CONTRIBUTING FACTORS<span class="tooltip1-content"></span></h2>
              </span>
            </summary>
            
            <p style="margin-left:34px;">
              <span class="tooltip1" data-tooltip="Taxable income is what’s taxed after adjusting gross income (wages, interest, etc.). In Canada, only 50% of capital gains (profit from sold assets) is included; in the USA, 100% of capital gains is included, with rates varying by holding period (short-term at income rates, long-term at 0%-20%). It’s calculated by subtracting deductions—like Standard Deduction (USA) or Basic Personal Amount (Canada)—and exemptions from gross income. Excludes tax-free items (e.g., Canada’s TFSA gains). Use: Calculate tax owed and plan filings.">
              <u>Taxable Income:</u><span class="tooltip1-content"></span><span id="ANNUALTAXABLEINCOME"></span>
              </span>
            </p>
            
            <div class="usa-hide" style="margin-left:34px;">
              <p>
                <span class="tooltip1" data-tooltip="Fixed amount subtracted from gross income to lower taxable income (e.g., ~$15,000 for singles in 2025, per IRS). Calculated automatically based on filing status (single, married, etc.); reduces tax owed instead of itemizing deductions like mortgage interest. Excludes additional deductions. Use: Estimate tax savings.">            <u>Standard Deduction:</u><span class="tooltip1-content"></span><span id="SD"></span>
                </span>
              </p>
            </div>
          
            <div class="can-hide" style="margin-left:34px;">
              <p>
                <span class="tooltip1" data-tooltip="Non-refundable credit subtracted from income to reduce taxable amount (e.g., ~$15,000-$16,000 in 2025, per CRA, inflation-adjusted). Calculated for all taxpayers; lowers federal tax owed. Excludes extra credits (e.g., disability). Use: Estimate tax reduction.">            <u>Basic Personal Amount:</u><span class="tooltip1-content"></span><span id="BPA"></span>
                </span>
              </p>
            </div>   
          
            <p style="margin-left:34px;">
              <span class="tooltip1" data-tooltip="For regional tax and obligatory purposes">
                <u>Residence:</u><span class="tooltip1-content"></span><span id="RegionDropdown"></span>
              </span>
            </p>
            
            <p style="margin-left:34px;">
              <span class="tooltip1" data-tooltip="For subregion tax purposes">
                <u>Residence:</u><span class="tooltip1-content"></span><span id="SubregionDropdown"></span>
              </span>
            </p>
             
            <p style="margin-left:34px;">
              <span class="tooltip1" data-tooltip="Tax rates applied to income.">
                <u>Tax Rates:</u> 2024 Rates inflation adjusted for 2025<span class="tooltip1-content"></span>
              </span>
            </p>
          </details>
          
    
 
     <!-- Free: Expense Pie Chart -->
     <canvas id="myPieChart" width="250" height="250"></canvas>
     <!-- Premium: Income Erosion Pie Chart -->
     <canvas id="myPieChartTax" width="250" height="250"></canvas>
 


</div>

      
        

 
<!-- summary.html (relevant part) -->
<!-- Scripts -->
<script src="https://js.stripe.com/v3/" async></script>
<script src="/index.js"></script>
<script src="/utility/hideShow.js" type="module"></script>
<script src="/utility/modal.js" type="module"></script>

<script src="/payment/paymentform.js" type="module"></script> <!-- Load as module -->
<script src="/utility/toolTip.js"></script>
<script src="/utility/tray.js"></script>

<!-- Inline script from summary.js -->
<script type="module">
/* 
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */

import { getLocal } from '/utility/getlocal.js';
import { setCookie } from '/utility/setcookie.js';
import { setLocal } from '/utility/setlocal.js';

// Tab highlighting
const tabs = document.querySelectorAll('.tab');
tabs.forEach(tab => {
    const dataL = tab.getAttribute('data-location');
    const location = document.location.pathname;
    if (location.includes(dataL)) {
        tab.removeAttribute('href');
        tab.classList.add('active');
    }
});

// Core DOMContentLoaded listener
document.addEventListener('DOMContentLoaded', function () {
    setCookie("summary", Date.now(), 32);

    const paid = getLocal("authenticated");
    const isPaid = paid === "paid";
    const currentPath = window.location.pathname;

    if (isPaid && currentPath !== "/ai/budget/summary.html") {
        window.location.href = "/ai/budget/summary.html";
        return;
    } else {
        document.body.style.display = 'block';
    }

    updateFreeContent();
    if (isPaid) {
        unlockPremiumContent();
        updatePremiumContent();
    }

    const frequencyDropdown = document.getElementById('frequency');
    frequencyDropdown.addEventListener('change', () => {
        updateFreeContent();
        if (isPaid) {
            updatePremiumContent();
            timeToPay(true);
        } else {
            timeToPay(false);
        }
        calculateGoal(isPaid);
    });

    const goalAmountInput = document.getElementById('goalAmount');
    if (goalAmountInput) {
        goalAmountInput.addEventListener('input', () => calculateGoal(isPaid));
    }

    // Add input event listeners for Taxes & Obligations
    const inputs = ['REGIONALTAXANNUAL', 'SUBREGIONTAXANNUAL', 'OTHEROBLIGATIONANNUAL'];
    inputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', () => {
                const value = input.value || '0';
                setLocal(id, value); // Store in local storage
                updateFreeContent(); // Update calculated fields
                if (isPaid) {
                    updatePremiumContent(); // Update premium features
                }
                updateIncomeErosionPieChart(); // Update chart
            });
        }
    });

    document.getElementById('close-sidebar')?.addEventListener('click', function() {
        document.getElementById('subscribe-sidebar').style.display = 'none';
    });
});

// New function to calculate taxes via xAI API
function calculateTaxes() {
    // Core required fields - these must exist
    const coreRequiredFields = [
        'ANNUALINCOME', 'ANNUALEMPLOYMENTINCOME', 'fillingStatus', 'residency'
    ];
    
    // Optional fields from intro - only include if they exist in localStorage
    const optionalIntroFields = [
        'selectedCountry', 'selectedSubregion', 'ageSelf', 'ageSpouse',
        'employmentStatus', 'employmentStatusSpouse', 'RegionDropdown', 
        'SubregionDropdown', 'birthYearDisabledDependants', 'income_sole_prop',
        'RETIREMENTCONTRIBUTION'
    ];
    
    // Collect required fields data
    let missingFields = [];
    let data = {};
    
    // Check core required fields - these must exist
    coreRequiredFields.forEach(field => {
        const value = getLocal(field);
        if (value === null || value === '') {
            missingFields.push(field);
        } else {
            data[field] = value;
        }
    });
    
    // Check optional fields - only include if they exist
    optionalIntroFields.forEach(field => {
        const value = getLocal(field);
        if (value !== null && value !== '') {
            data[field] = value;
        }
    });

    // Display error if core fields are missing
    let errorDiv = document.getElementById('error');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'error';
        errorDiv.style.color = 'red';
        document.querySelector('.summary-container').prepend(errorDiv);
    }

    if (missingFields.length > 0) {
        errorDiv.textContent = `Missing required fields: ${missingFields.join(', ')}`;
        console.error('Missing required fields:', missingFields);
        return;
    }

    // Clear previous error
    errorDiv.textContent = '';

    // TEMPORARY: Use placeholder values instead of API call
    console.log('Using placeholder tax values for development (API call commented out)');
    
    // Calculate placeholder values based on income for realistic testing
    const annualIncome = parseFloat(getLocal('ANNUALINCOME')) || 0;
    const regionalTax = annualIncome * 0.15; // Placeholder: 15% of income
    const subregionalTax = annualIncome * 0.05; // Placeholder: 5% of income
    const otherObligations = annualIncome * 0.07; // Placeholder: 7% of income
    
    // Store placeholder values in localStorage
    setLocal('REGIONALTAXANNUAL', regionalTax.toString());
    setLocal('SUBREGIONTAXANNUAL', subregionalTax.toString());
    setLocal('OTHEROBLIGATIONANNUAL', otherObligations.toString());
    
    // Update UI with placeholder values
    updateFreeContent();
    updateIncomeErosionPieChart();
    if (getLocal('authenticated') === 'paid') updatePremiumContent();
    
    /* 
    // COMMENTED OUT: Original API call code
    // Add loading state
    const generateBtn = document.querySelector('.generate-btn');
    const originalText = generateBtn.textContent;
    generateBtn.disabled = true;
    generateBtn.textContent = 'Calculating...';

    // Check cache
    const cacheKey = JSON.stringify(data);
    const cached = getLocal('taxCache');
    if (cached && cached.key === cacheKey) {
        const taxResults = JSON.parse(cached.results);
        setLocal('REGIONALTAXANNUAL', taxResults.regionalTax.toString());
        setLocal('SUBREGIONTAXANNUAL', taxResults.subregionalTax.toString());
        setLocal('OTHEROBLIGATIONANNUAL', taxResults.otherObligations.toString());
        updateFreeContent();
        updateIncomeErosionPieChart();
        if (getLocal('authenticated') === 'paid') updatePremiumContent();
        generateBtn.disabled = false;
        generateBtn.textContent = originalText;
        return;
    }

    // Send data to Lambda via API Gateway
    fetch('https://j5w0hp8nw5.execute-api.us-east-1.amazonaws.com/prod', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
        .then(res => {
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            return res.json();
        })
        .then(data => {
            console.log('xAI Tax Response:', data);
            // Validate response
            if (!data.regionalTax || !data.subregionalTax || !data.otherObligations) {
                throw new Error('Invalid response format');
            }

            // Update localStorage
            setLocal('REGIONALTAXANNUAL', data.regionalTax.toString());
            setLocal('SUBREGIONTAXANNUAL', data.subregionalTax.toString());
            setLocal('OTHEROBLIGATIONANNUAL', data.otherObligations.toString());

            // Cache results
            setLocal('taxCache', JSON.stringify({ key: cacheKey, results: JSON.stringify(data) }));

            // Update UI
            updateFreeContent(); // Updates TOTALTAXANNUAL, etc.
            updateIncomeErosionPieChart(); // Update chart
            if (getLocal('authenticated') === 'paid') {
                updatePremiumContent(); // Update DISPOSABLEINCOME
            }
        })
        .catch(err => {
            console.error('Error:', err);
            errorDiv.textContent = `Error: ${err.message}`;
        })
        .finally(() => {
            // Restore button state
            generateBtn.disabled = false;
            generateBtn.textContent = originalText;
        });
    */
}

// Free content update function
function updateFreeContent() {
    const frequency = document.getElementById('frequency').value;
    const multiplier = getFrequencyMultiplier(frequency);

    // Income & Expenses (free)
    updateElement('annual_income_sum', 'ANNUALINCOME', multiplier);
    updateElement('ANNUALEXPENSESUM', 'ANNUALEXPENSESUM', multiplier);
    updateElement('ESSENTIAL', 'ESSENTIAL', multiplier);
    updateElement('DISCRETIONARY', 'DISCRETIONARY', multiplier);
    updateElement('HOUSING', 'HOUSING', multiplier);
    updateElement('TRANSPORTATION', 'TRANSPORTATION', multiplier);
    updateElement('DEPENDANT', 'DEPENDANT', multiplier);
    updateElement('DEBT', 'DEBT', multiplier);

    // Update calculated fields
    updateElement('TOTALTAXANNUAL', null, multiplier, calculateAnnualTax);

    // Net Worth (free) - No frequency adjustment
    updateElement('NETWORTH', null, 1, () => (parseFloat(getLocal('ASSETS')) || 0) - (parseFloat(getLocal('LIABILITIES')) || 0));
    updateElement('ASSETS', 'ASSETS', multiplier);
    updateElement('LIABILITIES', 'LIABILITIES', multiplier);

    // Other fields
    updateElement('ANNUALTAXABLEINCOME', 'ANNUALTAXABLEINCOME', multiplier);
    updateElement('SD', 'SD', multiplier, null, 'usa-hide');
    updateElement('BPA', 'BPA', multiplier, null, 'can-hide');
    const regionElement = document.getElementById('RegionDropdown');
    if (regionElement) {
        regionElement.textContent = getLocal('RegionDropdown').trim() !== "" ? getLocal('RegionDropdown') : "NONE";
    }
    const subregionElement = document.getElementById('SubregionDropdown');
    if (subregionElement) {
        subregionElement.textContent = getLocal('SubregionDropdown').trim() !== "" ? getLocal('SubregionDropdown') : "";
    }

    // Financial Projections (free)
    timeToPay(false);
    calculateGoal(false);

    // Charts
    updateExpensePieChart();
    updateIncomeErosionPieChart();
}

function unlockPremiumContent() {
    document.querySelectorAll('.premium-blur').forEach(el => {
        el.classList.remove('premium-blur');
        if (el.textContent === '[Locked]') {
            el.textContent = '';
        }
    });
    document.querySelectorAll('.premium-notice').forEach(el => el.style.display = 'none');
    const goalAmount = document.getElementById('goalAmount');
    if (goalAmount) goalAmount.disabled = false;
}

// Premium content update function
function updatePremiumContent() {
    const frequency = document.getElementById('frequency').value;
    const multiplier = getFrequencyMultiplier(frequency);

    updateElement('DISPOSABLEINCOME', null, multiplier, calculateDisposableIncome);

    const debtToIncome = (parseFloat(getLocal('LIABILITIES')) / parseFloat(getLocal('ANNUALINCOME')) || 0);
    document.getElementById('DEBTTOINCOME').textContent = isNaN(debtToIncome) || !isFinite(debtToIncome) ? 'Not Applicable' : debtToIncome.toFixed(2);
    colorChangeDTI();

    const housingToIncome = (parseFloat(getLocal('HOUSING')) / parseFloat(getLocal('ANNUALINCOME')) || 0);
    document.getElementById('HOUSINGTOINCOME').textContent = isNaN(housingToIncome) ? 'Not Applicable' : housingToIncome.toFixed(2);
    colorChangeHTI();

    const savingsToDebt = (parseFloat(getLocal('ASSETS')) / parseFloat(getLocal('LIABILITIES')) || 0);
    document.getElementById('SAVINGSTODEBT').textContent = isNaN(savingsToDebt) || !isFinite(savingsToDebt) ? 'Not Applicable' : savingsToDebt.toFixed(2);
    colorChangeSavingsToDebt(savingsToDebt);

    const fireRatio = (parseFloat(getLocal('PASSIVEINCOME')) / parseFloat(getLocal('ANNUALEXPENSESUM')) || 0);
    document.getElementById('FIRERATIO').textContent = isNaN(fireRatio) ? 'Not Applicable' : fireRatio.toFixed(2);
    colorChangeFIRE();

    timeToPay(true);
    calculateGoal(true);
}

// Helper function to update elements
function updateElement(elementId, cookieName, multiplier, calcFunction = null, regionClass = null) {
    const element = document.getElementById(elementId);
    if (element && (!regionClass || element.closest(`.${regionClass}`))) {
        const value = calcFunction ? calcFunction() : (parseFloat(getLocal(cookieName)) || 0);
        element.textContent = '$' + (value * multiplier).toFixed(2);
    }
}

// Frequency multiplier
function getFrequencyMultiplier(frequency) {
    switch (frequency) {
        case 'monthly': return 1 / 12;
        case 'weekly': return 1 / 52;
        default: return 1; // annual
    }
}

// Calculate Disposable Income (premium)
function calculateDisposableIncome() {
    const income = parseFloat(getLocal('ANNUALINCOME')) || 0;
    const expenses = parseFloat(getLocal('ANNUALEXPENSESUM')) || 0;
    const regionalTax = parseFloat(getLocal('REGIONALTAXANNUAL')) || 0;
    const subregionalTax = parseFloat(getLocal('SUBREGIONTAXANNUAL')) || 0;
    const obligations = parseFloat(getLocal('OTHEROBLIGATIONANNUAL')) || 0;

    return income - expenses - regionalTax - subregionalTax - obligations;
}

// Calculate Annual Tax (free)
function calculateAnnualTax() {
    const regionalTax = parseFloat(getLocal('REGIONALTAXANNUAL')) || 0;
    const subregionalTax = parseFloat(getLocal('SUBREGIONTAXANNUAL')) || 0;
    return regionalTax + subregionalTax;
}

// Calculate Government Obligations (free)
function calculateGovernmentObligations() {
    return parseFloat(getLocal('OTHEROBLIGATIONANNUAL')) || 0;
}

// Expense Pie Chart (free)
function updateExpensePieChart() {
    const cookieNames = ['ESSENTIAL', 'DEBT', 'DEPENDANT', 'DISCRETIONARY', 'HOUSING', 'TRANSPORTATION'];
    const data = cookieNames.map(name => parseFloat(getLocal(name)) || 0);
    const config = {
        type: 'pie',
        data: {
            labels: cookieNames,
            datasets: [{
                label: 'Expense Distribution',
                data: data,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 
                    'rgba(255, 206, 86, 0.2)', 'rgba(75, 192, 192, 0.2)', 
                    'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)'
                ],
                borderColor: [
                    'rgb(194, 194, 194)', 'rgb(165, 165, 165)', 
                    'rgb(118, 118, 118)', 'rgb(101, 101, 101)', 
                    'rgb(76, 76, 76)', 'rgb(63, 63, 63)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Expense Distribution' }
            }
        }
    };
    if (window.myPieChart && typeof window.myPieChart.destroy === 'function') {
        window.myPieChart.destroy();
    }
    window.myPieChart = new Chart(document.getElementById('myPieChart'), config);
}

// Income Erosion Pie Chart (premium)
function updateIncomeErosionPieChart() {
    const income = parseFloat(getLocal('ANNUALINCOME')) || 0;
    const expenses = parseFloat(getLocal('ANNUALEXPENSESUM')) || 0;
    const tax = calculateAnnualTax();
    const obligations = calculateGovernmentObligations();
    const disposable = calculateDisposableIncome();

    const data = [disposable, expenses, tax, obligations];
    const labels = ['Income After Deductions', 'Annual Expenses', 'Taxes', 'Obligations'];

    const config = {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: 'Income Erosion Chart',
                data: data,
                backgroundColor: [
                    'rgba(143, 18, 45, 0.2)', 'rgba(17, 47, 128, 0.2)', 
                    'rgba(14, 14, 14, 0.2)', 'rgba(14, 14, 14, 0.2)'
                ],
                borderColor: [
                    'rgb(194, 194, 194)', 'rgb(165, 165, 165)', 
                    'rgb(118, 118, 118)', 'rgb(101, 101, 101)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Income Erosion Chart' }
            }
        }
    };
    if (window.myPieChartTax && typeof window.myPieChartTax.destroy === 'function') {
        window.myPieChartTax.destroy();
    }
    window.myPieChartTax = new Chart(document.getElementById('myPieChartTax'), config);
}

// Color change functions (premium)
function colorChangeFIRE() {
    const fire = parseFloat(document.getElementById("FIRERATIO").textContent);
    if (isNaN(fire)) return;
    document.getElementById("FIRERATIO").style.color = 
        fire >= 1.0 ? "green" : fire >= 0.25 ? "orange" : "red";
}

function colorChangeSavingsToDebt(savingsToDebt) {
    if (isNaN(savingsToDebt)) return;
    document.getElementById("SAVINGSTODEBT").style.color = 
        savingsToDebt >= 2 ? "green" : savingsToDebt >= 1 ? "orange" : "red";
}

function colorChangeHTI() {
    const hti = parseFloat(document.getElementById("HOUSINGTOINCOME").textContent);
    if (isNaN(hti)) return;
    document.getElementById("HOUSINGTOINCOME").style.color = 
        hti < 0.28 ? "green" : hti <= 0.35 ? "orange" : "red";
}

function colorChangeDTI() {
    const dti = parseFloat(document.getElementById("DEBTTOINCOME").textContent);
    if (isNaN(dti)) return;
    document.getElementById("DEBTTOINCOME").style.color = 
        dti < 0.20 ? "green" : dti <= 0.36 ? "orange" : "red";
}

// Financial Projections (free with premium enhancement)
function timeToPay(isPaid) {
    const frequency = document.getElementById('frequency').value;
    const disposableIncome = isPaid ? calculateDisposableIncome() : (parseFloat(getLocal('ANNUALINCOME')) || 0) - (parseFloat(getLocal('ANNUALEXPENSESUM')) || 0);
    const revolvingDebt = parseFloat(getLocal('LIABILITIESNA')) || 0;

    let timeToPayDebt = document.getElementById('TIMETOPAYDEBT');
    if (!revolvingDebt || disposableIncome <= 0) {
        timeToPayDebt.textContent = disposableIncome <= 0 ? "RISK OF INSOLVENCY" : "Not Applicable";
    } else {
        let time = revolvingDebt / disposableIncome;
        let unit = 'Years';
        if (frequency === 'monthly') { time *= 12; unit = 'Months'; }
        else if (frequency === 'weekly') { time *= 52; unit = 'Weeks'; }
        timeToPayDebt.textContent = `${time.toFixed(2)} ${unit}`;
    }
}

function calculateGoal(isPaid) {
    const disposableIncome = isPaid ? calculateDisposableIncome() : (parseFloat(getLocal('ANNUALINCOME')) || 0) - (parseFloat(getLocal('ANNUALEXPENSESUM')) || 0);
    const goalAmount = parseFloat(document.getElementById('goalAmount').value) || 0;
    const frequency = document.getElementById('frequency').value;

    if (disposableIncome <= 0 || goalAmount <= 0) {
        document.getElementById('goalResult').textContent = '';
        return;
    }

    let time = goalAmount / disposableIncome;
    let unit = 'Years';
    if (frequency === 'monthly') { time *= 12; unit = 'Months'; }
    else if (frequency === 'weekly') { time *= 52; unit = 'Weeks'; }
    document.getElementById('goalResult').textContent = `${unit} needed: ${time.toFixed(2)}`;
}
</script>

</body>
</html>