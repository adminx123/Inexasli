<head>
  <script src="../../ai/datain.js" type="module"></script>
  <!-- inputstyles.css will be loaded dynamically by datain.js -->
</head>
<!--
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
-->

<div class="device-container">
  <div class="row1 product-description-container">
    <h2 class="product-description-heading">Get AI-Powered Research Instantly!</h2>
    <p class="product-description-text">
      Enter your research question or topic, add any extra details, and our AI will research and generate a comprehensive, actionable report for youâ€”charts included if possible!
    </p>
    <p class="product-description-final">Let's get started!</p>
    <p class="product-description-disclaimer">
      <em>AI can make mistakes, consult a professional.</em>
    </p>
  </div>

  <div class="row1">
    <h3 class="tooltip1" data-tooltip="What do you want the AI to research for you?">
      Research Topic or Question<span class="tooltip1-content"></span>
    </h3>
    <textarea id="research-topic" rows="3" placeholder="e.g. The impact of remote work on productivity in tech companies"></textarea>
  </div>

  <div class="row1">
    <h3 class="tooltip1" data-tooltip="Add any extra details or context to help the AI with your research.">
      Additional Details (optional)<span class="tooltip1-content"></span>
    </h3>
    <textarea id="additional-details" rows="3" placeholder="e.g. Focus on studies from 2020 onward, include both US and Europe, summarize key findings"></textarea>
  
    <button class="generate-btn" id="generate-research-btn">Generate Research Report</button>

</div>

  

</div>

<script src="../../utility/toolTip.js" type="module"></script>
<script src="../../payment/paymentform.js"></script>
<script type="module">
// Import fingerprint utilities
import { getFingerprintForWorker, incrementRequestCount, isRateLimited } from '/utility/rateLimiter.js';
async function handleGenerateResearchIq() {
    try {
        const formData = window.researchFormPersistence.getSavedFormData();
        if (!formData) { 
            alert('Please complete the form before generating a research report.'); 
            return;
        }

        // Check rate limits before proceeding
        if (isRateLimited()) {
            alert('Rate limit exceeded. Please wait before making another request.');
            return;
        }

        // Get fingerprint for the request
        const fingerprint = getFingerprintForWorker();

        // Create combined payload with both form data and fingerprint
        const workerPayload = {
            module: 'research',
            formData: formData,
            fingerprint: fingerprint
        };

        // Use enhanced loading with educational facts
        const result = await window.enhancedLoading(
            'generate-research-btn',
            'research',
            async () => {
                const apiUrl = 'https://master.4hm7q4q75z.workers.dev/';
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json'}, 
                    body: JSON.stringify(workerPayload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const responseData = await response.json();
                if (responseData.message !== 'Success') {
                    throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
                }
                
                return responseData;
            }
        );

        // Increment request count after successful response
        incrementRequestCount();
        
        // Store the response using centralized system
        window.researchFormPersistence.saveResponseData(result);
        
        // Dispatch an event to notify dataout.js that a response was received
        const event = new CustomEvent('api-response-received', {
            detail: {
                module: 'researchiq',
                type: 'worker-response',
                timestamp: Date.now()
            }
        });
        document.dispatchEvent(event);
        console.log('[ResearchIQ] Dispatched api-response-received event');
        
    } catch (error) {
        console.error('[ResearchIQ] Error generating research report:', error);
        alert('An error occurred while generating your research report. Please try again later.');
    }
}

function runResearchInitialization() {
    console.log("[ResearchIQ] Initializing...");
    
    // Set up event listeners
    const generateBtn = document.getElementById('generate-research-btn');
    if (generateBtn) {
        generateBtn.removeEventListener('click', handleGenerateResearchIq);
        generateBtn.addEventListener('click', handleGenerateResearchIq);
    }
}

// Initialize with multiple triggers to ensure reliability
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runResearchInitialization);
} else {
    runResearchInitialization();
}
(function() {
    let tooltipInitAttempts = 0;
    const maxAttempts = 20;
    function initTooltips() {
        tooltipInitAttempts++;
        if (typeof window.initializeTooltips === 'function') {
            try {
                window.initializeTooltips(document);
            } catch (error) {
                console.error('[ResearchIQ] Error initializing tooltips:', error);
            }
        } else if (tooltipInitAttempts < maxAttempts) {
            setTimeout(initTooltips, 100);
        } else {
            console.error('[ResearchIQ] Failed to initialize tooltips after maximum attempts');
        }
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initTooltips, 50);
        });
    } else {
        setTimeout(initTooltips, 100);
    }
})();
</script>
