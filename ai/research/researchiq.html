<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

<div class="device-container">
  <div class="row1 product-description-container">
    <h2 class="product-description-heading">Get AI-Powered Research Instantly!</h2>
    <p class="product-description-text">
      Enter your research question or topic, add any extra details, and our AI will research and generate a comprehensive, actionable report for youâ€”charts included if possible!
    </p>
    <p class="product-description-final">Let's get started!</p>
    <p class="product-description-disclaimer">
      <em>AI can make mistakes, consult a professional.</em>
    </p>
  </div>

  <div class="row1" data-step-label="Research Topic">
    <h3 class="tooltip1" data-tooltip="What do you want the AI to research for you?">
      Research Topic or Question<span class="tooltip1-content"></span>
    </h3>
    <textarea id="research-topic" rows="3" placeholder="e.g. The impact of remote work on productivity in tech companies"></textarea>
  </div>

  <div class="row1" data-step-label="Additional Details">
    <h3 class="tooltip1" data-tooltip="Add any extra details or context to help the AI with your research.">
      Additional Details (optional)<span class="tooltip1-content"></span>
    </h3>
    <textarea id="additional-details" rows="3" placeholder="e.g. Focus on studies from 2020 onward, include both US and Europe, summarize key findings"></textarea>
  </div>

  <div class="row1" data-step-label="Generate Report">
    <button class="generate-btn" id="generate-research-btn">Generate Research Report</button>
  </div>
</div>

<script type="module">
import { initAutoExpandTextareas } from '../styles/inputFunctionality.js';
import { getFingerprintForWorker, incrementRequestCount, isRateLimited, handleRateLimitResponse } from '/utility/rateLimiter.js';

(function() {
  console.log("ResearchIQ script initializing");

  // Initialize textarea auto-expand
  initAutoExpandTextareas();
  document.addEventListener('textarea:changed', function(e) {
    if (window.researchFormPersistence) {
      window.researchFormPersistence.saveFormData();
    }
  });

  async function handleGenerateResearchIq() {
    try {
      const formData = window.researchFormPersistence.getSavedFormData();
      if (!formData) { 
        alert('Please complete the form before generating a research report.'); 
        return;
      }

      // Check rate limiting before proceeding
      if (isRateLimited('research', 8, 60 * 60 * 1000)) { // 8 requests per hour
        alert('You have exceeded the request limit for research analysis. Please try again later.');
        return;
      }

      // Get fingerprint data for rate limiting
      const fingerprintData = getFingerprintForWorker();
      
      // Create combined payload with both form data and fingerprint
      const workerPayload = {
        module: "research",
        formData: formData,
        fingerprint: fingerprintData
      };

      const dataContainer = document.querySelector('.device-container');
      let backendResponse = null;
      try {
        backendResponse = await window.enhancedLoading(
          'generate-research-btn',
          'research',
          async () => {
            const apiUrl = 'https://master.4hm7q4q75z.workers.dev/';
            const response = await fetch(apiUrl, { 
              method: 'POST', 
              headers: {'Content-Type':'application/json'}, 
              body: JSON.stringify(workerPayload)
            });
            let responseData;
            try {
              responseData = await response.json();
            } catch (e) {
              responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
            }
            // Always call handleRateLimitResponse with backend response
            handleRateLimitResponse(dataContainer, responseData, !response.ok, 'ResearchIQ');
            if (!response.ok) {
              throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
            }
            if (responseData.message !== 'Success') {
              throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
            }
            return responseData;
          }
        );
        incrementRequestCount('research');
        window.researchFormPersistence.saveResponseData(backendResponse);
        const event = new CustomEvent('api-response-received', {
          detail: {
            module: 'researchiq',
            type: 'worker-response',
            timestamp: Date.now()
          }
        });
        document.dispatchEvent(event);
        console.log('[ResearchIQ] Dispatched api-response-received event');
      } catch (error) {
        if (backendResponse && dataContainer) {
          handleRateLimitResponse(dataContainer, backendResponse, true, 'ResearchIQ');
        }
        console.error('[ResearchIQ] Error generating research report:', error);
      }
    } catch (error) {
      console.error('[ResearchIQ] Error generating research report:', error);
      alert('An error occurred while generating your research report. Please try again later.');
    }
  }

  function initialize() {
    console.log("[ResearchIQ] Initializing...");
    const generateBtn = document.getElementById('generate-research-btn');
    if (generateBtn) {
      generateBtn.removeEventListener('click', handleGenerateResearchIq);
      generateBtn.addEventListener('click', handleGenerateResearchIq);
    }
  }

  function runInitialization() {
    setTimeout(initialize, 50);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runInitialization);
  } else {
    runInitialization();
  }

  document.addEventListener('data-in-loaded', function(e) {
    const moduleType = e.detail?.moduleType;
    if (moduleType === 'research') {
      console.log("[ResearchIQ] Research module loaded through datain.js, reinitializing");
      runInitialization();
    }
  });

  setTimeout(() => {
    const generateBtn = document.getElementById('generate-research-btn');
    if (generateBtn && !generateBtn.onclick) {
      console.log("[ResearchIQ] Generate button not initialized, trying again");
      initialize();
    }
  }, 200);

  // Export functions for external access
  window.researchIq = { 
    getFormData: () => window.researchFormPersistence.getSavedFormData(),
    saveFormData: () => window.researchFormPersistence.saveFormData()
  };
})();
</script>
