<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Research Output</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles/outputstyles.css">
  <style>
    body { background: #f7faf9; font-family: 'Inter', sans-serif; }
    .output-container { max-width: 700px; margin: 32px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px rgba(44, 90, 61, 0.07); padding: 32px 24px; }
    .output-section { margin-bottom: 32px; }
    .output-title { color: #2d5a3d; font-size: 22px; font-weight: 700; margin-bottom: 12px; border-bottom: 1px solid #e9ecef; padding-bottom: 6px; }
    .output-list { margin: 0 0 0 18px; padding: 0; }
    .output-list li { margin-bottom: 8px; font-size: 16px; }
    .output-chart { margin-bottom: 32px; }
    .chart-canvas { max-width: 100%; margin: 0 auto 24px auto; display: block; background: #f2f9f3; border-radius: 8px; padding: 16px; }
    .no-data { color: #a67c7c; font-style: italic; }
  </style>
</head>
<body>
  <div id="main-content" class="device-container research-container">
    <div class="output-container">
      <div id="summary-section" class="output-section">
        <h2 class="output-title">Summary</h2>
        <div id="summary-content"></div>
      </div>
      <div id="findings-section" class="output-section">
        <h2 class="output-title">Key Findings</h2>
        <ul id="findings-list" class="output-list"></ul>
      </div>
      <div id="charts-section" class="output-section output-chart" style="display:none;">
        <h2 class="output-title">Charts</h2>
        <div id="charts-content"></div>
      </div>
      <div id="sources-section" class="output-section">
        <h2 class="output-title">Sources</h2>
        <ul id="sources-list" class="output-list"></ul>
      </div>
    </div>
  </div>
  <script src="../../utility/enhancedUI.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    console.log("üìä [RESEARCH-OUTPUT] ResearchOutput script initializing");
    console.log("üìä [RESEARCH-OUTPUT] Timestamp:", Date.now());
    console.log("üìä [RESEARCH-OUTPUT] Document readyState:", document.readyState);
    console.log("üìä [RESEARCH-OUTPUT] Window location:", window.location.href);
    
    function getJSON(key) {
      console.log("üîç [RESEARCH-OUTPUT-JSON] Getting JSON data for key:", key);
      try {
        const item = localStorage.getItem(key);
        console.log("üîç [RESEARCH-OUTPUT-JSON] Raw localStorage item:", item ? "found" : "null");
        console.log("üîç [RESEARCH-OUTPUT-JSON] Item length:", item?.length || 0);
        const parsed = item ? JSON.parse(item) : null;
        console.log("üîç [RESEARCH-OUTPUT-JSON] Parsed successfully:", !!parsed);
        console.log("üîç [RESEARCH-OUTPUT-JSON] Parsed keys:", parsed ? Object.keys(parsed) : "none");
        return parsed;
      } catch (e) { 
        console.error("‚ùå [RESEARCH-OUTPUT-JSON] Error parsing JSON:", e);
        console.error("‚ùå [RESEARCH-OUTPUT-JSON] Error message:", e.message);
        return null; 
      }
    }
    function updateOutput() {
      console.log("üîÑ [RESEARCH-OUTPUT-UPDATE] Starting output update");
      console.log("üîÑ [RESEARCH-OUTPUT-UPDATE] Timestamp:", Date.now());
      
      console.log("üì° [RESEARCH-OUTPUT-DATA] Getting researchIqResponse from localStorage");
      let d = getJSON('researchIqResponse');
      console.log("üì° [RESEARCH-OUTPUT-DATA] Initial data:", d);
      console.log("üì° [RESEARCH-OUTPUT-DATA] Data type:", typeof d);
      
      if (d && d.message === 'Success' && d.data) {
        console.log("‚úÖ [RESEARCH-OUTPUT-DATA] Found success response, extracting data");
        console.log("‚úÖ [RESEARCH-OUTPUT-DATA] Original data keys:", Object.keys(d));
        d = d.data;
        console.log("‚úÖ [RESEARCH-OUTPUT-DATA] Extracted data keys:", Object.keys(d || {}));
      }
      
      // If no data at all, show blank screen
      console.log("üîç [RESEARCH-OUTPUT-CHECK] Checking data availability");
      console.log("üîç [RESEARCH-OUTPUT-CHECK] Has summary:", !!d?.summary);
      console.log("üîç [RESEARCH-OUTPUT-CHECK] Has keyFindings:", Array.isArray(d?.keyFindings) && d.keyFindings.length > 0);
      console.log("üîç [RESEARCH-OUTPUT-CHECK] Has sources:", Array.isArray(d?.sources) && d.sources.length > 0);
      console.log("üîç [RESEARCH-OUTPUT-CHECK] Has charts:", Array.isArray(d?.charts) && d.charts.length > 0);
      
      const hasAnyData = d && (d.summary || (d.keyFindings && d.keyFindings.length) || (d.sources && d.sources.length) || (d.charts && d.charts.length));
      console.log("üîç [RESEARCH-OUTPUT-CHECK] Has any data:", hasAnyData);
      
      if (!hasAnyData) {
        console.warn("‚ö†Ô∏è [RESEARCH-OUTPUT-BLANK] No data found");
        document.querySelector('.output-container').style.display = 'none';
        return;
      }
      
      // Summary
      console.log("üìù [RESEARCH-OUTPUT-SUMMARY] Processing summary section");
      const summaryText = d?.summary || 'No summary available.';
      console.log("üìù [RESEARCH-OUTPUT-SUMMARY] Summary text length:", summaryText.length);
      document.getElementById('summary-content').innerText = summaryText;
      console.log("üìù [RESEARCH-OUTPUT-SUMMARY] Summary content updated");
      
      // Key Findings
      console.log("üîë [RESEARCH-OUTPUT-FINDINGS] Processing key findings section");
      const findingsList = document.getElementById('findings-list');
      console.log("üîë [RESEARCH-OUTPUT-FINDINGS] Findings list element:", !!findingsList);
      findingsList.innerHTML = '';
      
      console.log("üîë [RESEARCH-OUTPUT-FINDINGS] Key findings data:", d?.keyFindings);
      console.log("üîë [RESEARCH-OUTPUT-FINDINGS] Is array:", Array.isArray(d?.keyFindings));
      console.log("üîë [RESEARCH-OUTPUT-FINDINGS] Array length:", d?.keyFindings?.length || 0);
      
      if (Array.isArray(d?.keyFindings) && d.keyFindings.length) {
        console.log("‚úÖ [RESEARCH-OUTPUT-FINDINGS] Adding findings to list");
        d.keyFindings.forEach((f, index) => {
          console.log(`üîë [RESEARCH-OUTPUT-FINDINGS] Adding finding ${index + 1}:`, f.substring(0, 50) + "...");
          const li = document.createElement('li');
          li.innerText = f;
          findingsList.appendChild(li);
        });
        console.log("‚úÖ [RESEARCH-OUTPUT-FINDINGS] All findings added successfully");
      } else {
        console.log("‚ÑπÔ∏è [RESEARCH-OUTPUT-FINDINGS] No findings available, showing placeholder");
        findingsList.innerHTML = '<li class="no-data">No key findings available.</li>';
      }
      
      // Charts
      console.log("üìä [RESEARCH-OUTPUT-CHARTS] Processing charts section");
      const chartsSection = document.getElementById('charts-section');
      const chartsContent = document.getElementById('charts-content');
      console.log("üìä [RESEARCH-OUTPUT-CHARTS] Charts section element:", !!chartsSection);
      console.log("üìä [RESEARCH-OUTPUT-CHARTS] Charts content element:", !!chartsContent);
      chartsContent.innerHTML = '';
      
      console.log("üìä [RESEARCH-OUTPUT-CHARTS] Charts data:", d?.charts);
      console.log("üìä [RESEARCH-OUTPUT-CHARTS] Is array:", Array.isArray(d?.charts));
      console.log("üìä [RESEARCH-OUTPUT-CHARTS] Array length:", d?.charts?.length || 0);
      
      if (Array.isArray(d?.charts) && d.charts.length) {
        console.log("‚úÖ [RESEARCH-OUTPUT-CHARTS] Found charts, showing section");
        chartsSection.style.display = '';
        d.charts.forEach((chart, idx) => {
          console.log(`üìä [RESEARCH-OUTPUT-CHARTS] Creating chart ${idx + 1}:`, chart.title || "untitled");
          console.log(`üìä [RESEARCH-OUTPUT-CHARTS] Chart type:`, chart.chartType || 'bar');
          console.log(`üìä [RESEARCH-OUTPUT-CHARTS] Chart labels:`, chart.labels?.length || 0);
          console.log(`üìä [RESEARCH-OUTPUT-CHARTS] Chart values:`, chart.values?.length || 0);
          
          const canvas = document.createElement('canvas');
          canvas.className = 'chart-canvas';
          canvas.id = 'chart-' + idx;
          chartsContent.appendChild(canvas);
          
          console.log(`üìä [RESEARCH-OUTPUT-CHARTS] Canvas created with ID: chart-${idx}`);
          
          try {
            const chartInstance = new Chart(canvas.getContext('2d'), {
              type: chart.chartType || 'bar',
              data: {
                labels: chart.labels || [],
                datasets: [{
                  label: chart.title || 'Chart',
                  data: chart.values || [],
                  backgroundColor: '#7a9b8a',
                  borderColor: '#2d5a3d',
                  borderWidth: 1
                }]
              },
              options: { responsive: true, plugins: { legend: { display: false } } }
            });
            console.log(`‚úÖ [RESEARCH-OUTPUT-CHARTS] Chart ${idx + 1} created successfully`);
          } catch (error) {
            console.error(`‚ùå [RESEARCH-OUTPUT-CHARTS] Error creating chart ${idx + 1}:`, error);
          }
        });
        console.log("‚úÖ [RESEARCH-OUTPUT-CHARTS] All charts processed");
      } else {
        console.log("‚ÑπÔ∏è [RESEARCH-OUTPUT-CHARTS] No charts available, hiding section");
        chartsSection.style.display = 'none';
      }
      
      // Sources
      console.log("üìö [RESEARCH-OUTPUT-SOURCES] Processing sources section");
      const sourcesList = document.getElementById('sources-list');
      console.log("üìö [RESEARCH-OUTPUT-SOURCES] Sources list element:", !!sourcesList);
      sourcesList.innerHTML = '';
      
      console.log("üìö [RESEARCH-OUTPUT-SOURCES] Sources data:", d?.sources);
      console.log("üìö [RESEARCH-OUTPUT-SOURCES] Is array:", Array.isArray(d?.sources));
      console.log("üìö [RESEARCH-OUTPUT-SOURCES] Array length:", d?.sources?.length || 0);
      
      if (Array.isArray(d?.sources) && d.sources.length) {
        console.log("‚úÖ [RESEARCH-OUTPUT-SOURCES] Adding sources to list");
        d.sources.forEach((src, index) => {
          console.log(`üìö [RESEARCH-OUTPUT-SOURCES] Adding source ${index + 1}:`, src.substring(0, 50) + "...");
          const li = document.createElement('li');
          const isUrl = /https?:\/\//.test(src);
          console.log(`üìö [RESEARCH-OUTPUT-SOURCES] Source ${index + 1} is URL:`, isUrl);
          
          if (isUrl) {
            li.innerHTML = `<a href="${src}" target="_blank" rel="noopener">${src}</a>`;
          } else {
            li.innerText = src;
          }
          sourcesList.appendChild(li);
        });
        console.log("‚úÖ [RESEARCH-OUTPUT-SOURCES] All sources added successfully");
      } else {
        console.log("‚ÑπÔ∏è [RESEARCH-OUTPUT-SOURCES] No sources available, showing placeholder");
        sourcesList.innerHTML = '<li class="no-data">No sources available.</li>';
      }
      
      console.log("üéâ [RESEARCH-OUTPUT-UPDATE] Output update completed successfully");
    }
    console.log("üé¨ [RESEARCH-OUTPUT-STARTUP] Running initial updateOutput");
    updateOutput();
    
    console.log("üëÇ [RESEARCH-OUTPUT-EVENTS] Adding storage event listener");
    window.addEventListener('storage', function(e) {
      console.log("üîÑ [RESEARCH-OUTPUT-STORAGE] Storage event received");
      console.log("üîÑ [RESEARCH-OUTPUT-STORAGE] Changed key:", e.key);
      console.log("üîÑ [RESEARCH-OUTPUT-STORAGE] New value length:", e.newValue?.length || 0);
      console.log("üîÑ [RESEARCH-OUTPUT-STORAGE] Triggering updateOutput");
      updateOutput();
    });
    
    console.log("üëÇ [RESEARCH-OUTPUT-EVENTS] Adding DOMContentLoaded event listener");
    window.addEventListener('DOMContentLoaded', function() {
      console.log("üìã [RESEARCH-OUTPUT-DOM] DOMContentLoaded event received");
      console.log("üìã [RESEARCH-OUTPUT-DOM] Triggering updateOutput");
      updateOutput();
    });

    // Initialize enhanced UI system
    function initEnhancedUISystem() {
      console.log("üé® [RESEARCH-OUTPUT-UI] Initializing enhanced UI system");
      console.log("üé® [RESEARCH-OUTPUT-UI] Timestamp:", Date.now());
      
      setTimeout(() => {
        console.log("üé® [RESEARCH-OUTPUT-UI] Enhanced UI timeout triggered");
        console.log("üé® [RESEARCH-OUTPUT-UI] Enhanced UI available:", !!window.enhancedUI);
        
        if (window.enhancedUI) {
          console.log("‚úÖ [RESEARCH-OUTPUT-UI] Initializing enhanced UI");
          console.log("‚úÖ [RESEARCH-OUTPUT-UI] Container ID: main-content");
          console.log("‚úÖ [RESEARCH-OUTPUT-UI] Options: scrollToTop=true, embedEnforcement=true, accessibility=true");
          
          window.enhancedUI.init({
            containerId: 'main-content',
            scrollToTop: true,
            embedEnforcement: true,
            accessibility: true
          });
          console.log("‚úÖ [RESEARCH-OUTPUT-UI] Enhanced UI initialized successfully");
        } else {
          console.warn('‚ö†Ô∏è [RESEARCH-OUTPUT-UI] Enhanced UI system not loaded');
        }
      }, 100);
    }
    
    console.log("üé® [RESEARCH-OUTPUT-UI] Starting enhanced UI initialization");
    initEnhancedUISystem();
    
    console.log("üéâ [RESEARCH-OUTPUT] ResearchOutput script initialization completed");
  </script>
</body>
</html>
