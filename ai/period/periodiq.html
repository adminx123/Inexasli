<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

<div class="device-container">
  <div class="row1 product-description-container">
    <h2 class="product-description-heading">Unlock Personalized Period Insights!</h2>
    <p class="product-description-text">
        Track your menstrual cycle like never before with PeriodIQâ„¢. Instead of rigid forms and preset categories, simply log what happens when it happens. Our adaptive AI learns from your natural language entries to provide personalized insights about your cycle patterns, symptoms, and health trends.
    </p>
    <p class="product-description-final">
        Start your adaptive period tracking journey!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a healthcare professional for medical advice.</em>
    </p>
  </div>

  <div class="row1" data-step-label="Basic Information">

    <h3 class="tooltip1" data-tooltip="Basic information to help personalize your period tracking experience.">
      Basic Information<span class="tooltip1-content"></span>
    </h3>

 <select id="period-birth-control-type">
      <option value="" disabled selected>Birth control type</option>
      <option value="pill">Birth Control Pill</option>
      <option value="iud">IUD</option>
      <option value="implant">Implant</option>
      <option value="injectable">Injectable</option>
      <option value="patch">Patch</option>
      <option value="ring">Ring</option>
      <option value="condoms">Condoms</option>
      <option value="diaphragm">Diaphragm</option>
      <option value="spermicide">Spermicide</option>
      <option value="none">None</option>
    </select>
    <input id="period-birth-control-detail" type="text" placeholder="Specify brand/type" style="display: none;">

    <input id="period-age" type="text" placeholder="Age">
    <input id="period-weight" type="text" placeholder="Weight (e.g. 140 lbs, 64 kg)">
    <input id="period-cycle-length" type="text" placeholder="Typical cycle length (e.g. 28 days, varies 25-30)">
   
  </div>

  <div class="row1" data-step-label="Period Events Log">
    <h3 class="tooltip1" data-tooltip="Log period events as they happen using natural language. Add new entries anytime.">
      Period Events Log<span class="tooltip1-content"></span>
    </h3>
    <div id="period-entries-container">
      <!-- Split calendar-text entries will be added here dynamically -->
    </div>
    <!-- Add entry button created directly by periodiq.html -->
    <button class="generate-btn" id="generate-period-btn">Analyze My Patterns!</button>
  </div>
</div>

<script type="module">
// Rate limiting utilities are now available globally via window.rateLimiter

(function() {
  console.log("Period IQ script initializing");

  // Initialize textarea auto-expand
  window.initAutoExpandTextareas();
  
  // Listen for textarea changes to save data
  document.addEventListener('textarea:changed', function(e) {
    if (window.periodFormPersistence) {
      window.periodFormPersistence.saveFormData();
    }
  });

  // Listen for form data restoration to trigger conditional logic
  document.addEventListener('formpersistence:repopulated', function(e) {
    console.log('[PeriodIQ] Form repopulated, triggering conditional logic');
    setTimeout(() => {
      triggerConditionalLogic();
    }, 50);
  });

  // Handle generate button click
  async function handleGeneratePeriodIq() {
    try {
      const formData = window.periodFormPersistence ? window.periodFormPersistence.getSavedFormData() : {};
      
      // Check if we have any period entries
      const hasEntries = Object.keys(formData).some(key => key.includes('entry') && key.includes('what') && formData[key]);
      
      if (!hasEntries) { 
        alert('Please add at least one period event before generating analysis.'); 
        return;
      }

      // Check rate limiting
      if (window.rateLimiter.isRateLimited('period', 8, 60 * 60 * 1000)) {
        alert('You have exceeded the request limit for period analysis. Please try again later.');
        return;
      }

      const fingerprintData = window.rateLimiter.getFingerprintForWorker();
      
      const workerPayload = {
        module: "period",
        formData: formData,
        fingerprint: fingerprintData
      };

      const dataContainer = document.querySelector('.device-container');
      let backendResponse = null;
      
      try {
        backendResponse = await window.enhancedLoading(
          'generate-period-btn',
          'period',
          async () => {
            const apiUrl = 'https://inexasli.com/api/generate';
            const response = await fetch(apiUrl, { 
              method: 'POST', 
              headers: {'Content-Type':'application/json'}, 
              body: JSON.stringify(workerPayload)
            });
            
            let responseData;
            try {
              responseData = await response.json();
            } catch (e) {
              responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
            }
            
            window.rateLimiter.handleRateLimitResponse(dataContainer, responseData, !response.ok, 'PeriodIQ');
            
            if (!response.ok) {
              throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
            }
            if (responseData.message !== 'Success') {
              throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
            }
            return responseData;
          }
        );
        
        window.rateLimiter.incrementRequestCount('period');
        window.periodFormPersistence.saveResponseData(backendResponse);
        
        const event = new CustomEvent('api-response-received', {
          detail: {
            module: 'periodiq',
            type: 'worker-response',
            timestamp: Date.now()
          }
        });
        document.dispatchEvent(event);
        console.log('[PeriodIQ] Dispatched api-response-received event');
        
      } catch (error) {
        if (backendResponse && dataContainer) {
          window.rateLimiter.handleRateLimitResponse(dataContainer, backendResponse, true, 'PeriodIQ');
        }
        console.error('[PeriodIQ] Error generating period analysis:', error);
      }
    } catch (error) {
      console.error('[PeriodIQ] Error generating period analysis:', error);
      alert('An error occurred while generating your period analysis. Please try again later.');
    }
  }

  // Handle birth control type change
  const placeholderMap = {
    'pill': 'Brand name (e.g. Yasmin, Ortho Tri-Cyclen, Alesse)',
    'iud': 'IUD type (e.g. Mirena, Paragard, Skyla, Kyleena)',
    'implant': 'Implant type (e.g. Nexplanon, Implanon)',
    'injectable': 'Injectable type (e.g. Depo-Provera)',
    'patch': 'Patch brand (e.g. Ortho Evra)',
    'ring': 'Ring type (e.g. NuvaRing)',
    'condoms': 'Brand/type (e.g. Trojan, Durex, latex-free)',
    'diaphragm': 'Brand/type (e.g. Milex, Ortho)',
    'spermicide': 'Brand/type (e.g. VCF, Conceptrol)'
  };

  const handleBirthControlChange = window.handleConditionalInput(
    'period-birth-control-type',
    'period-birth-control-detail',
    placeholderMap,
    'none',
    () => {
      if (window.periodFormPersistence) {
        window.periodFormPersistence.saveFormData();
      }
    }
  );

  // Function to trigger conditional logic manually (for form repopulation)
  function triggerConditionalLogic() {
    if (handleBirthControlChange && typeof handleBirthControlChange === 'function') {
      handleBirthControlChange();
    }
  }

  function initialize() {
    console.log("[PeriodIQ] Initializing...");
    
    // Set up event listeners
    const generateBtn = document.getElementById('generate-period-btn');
    if (generateBtn) {
      generateBtn.removeEventListener('click', handleGeneratePeriodIq);
      generateBtn.addEventListener('click', handleGeneratePeriodIq);
    }

    // Create and add the "Add Entry" button directly
    const container = document.getElementById('period-entries-container');
    if (container && !document.getElementById('add-period-entry-btn')) {
      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.id = 'add-period-entry-btn';
      addBtn.textContent = '+ Add New Entry';
      addBtn.style.cssText = [
        'padding: 10px 20px',
        'margin: 10px auto',
        'display: block',
        'border: 1px solid #4a7c59',
        'background: #f2f9f3',
        'color: #2d5a3d',
        'border-radius: 5px',
        'font-size: 14px',
        'cursor: pointer',
        'font-family: inherit',
        'box-sizing: border-box'
      ].join(';');
      
      addBtn.onclick = () => addEntry();
      container.parentNode.insertBefore(addBtn, container.nextSibling);
    }

    // Direct addEntry function implementation
    function addEntry(whenValue = '', whatValue = '', entryNumber = null) {
      const container = document.getElementById('period-entries-container');
      if (!container) return null;

      // Determine entry number: use provided number, or find next available
      let actualEntryNumber = entryNumber;
      if (!actualEntryNumber) {
        const existingEntries = container.querySelectorAll('[data-entry-id^="entry-"]');
        actualEntryNumber = existingEntries.length + 1;
      }

      // Default "when" value to today's date if not provided
      if (!whenValue) {
        const now = new Date();
        whenValue = now.toISOString().split('T')[0]; // YYYY-MM-DD format
      }

      // Create the entry using the existing createSplitCalendarText function
      const entryDiv = window.createSplitCalendarText({
        id: `entry-${actualEntryNumber}`,
        whatPlaceholder: 'What happened? (e.g., spotting started, heavy flow, cramps, mood changes)',
        whenValue: whenValue,
        whatValue: whatValue,
        entryNumber: actualEntryNumber
      });

      if (!entryDiv) {
        console.error('[PeriodIQ] Failed to create entry div');
        return null;
      }

      container.appendChild(entryDiv);
      
      // Initialize auto-expand for textareas
      const textareas = entryDiv.querySelectorAll('textarea');
      textareas.forEach(textarea => {
        if (window.autoExpandTextarea) {
          window.autoExpandTextarea(textarea);
          textarea.addEventListener('input', () => window.autoExpandTextarea(textarea));
          textarea.addEventListener('paste', () => {
            setTimeout(() => window.autoExpandTextarea(textarea), 0);
          });
        }
      });
      
      // Refresh FormPersistence input handlers to pick up the new fields
      if (window.periodFormPersistence) {
        window.periodFormPersistence.refreshInputHandlers();
        window.periodFormPersistence.saveFormData();
      }
      
      // Focus on the "what" field of the new entry
      const whatField = entryDiv.querySelector('.what-field');
      if (whatField) {
        whatField.focus();
      }

      return entryDiv;
    }

    // Expose addEntry globally for FormPersistence recreation
    window.addEntry = addEntry;

    const birthControlTypeSelect = document.getElementById('period-birth-control-type');
    if (birthControlTypeSelect && handleBirthControlChange) {
      // The event listener is already set up by handleConditionalInput
      console.log('[PeriodIQ] Birth control conditional logic initialized');
      
      // Trigger conditional logic to handle any pre-existing values
      setTimeout(() => {
        triggerConditionalLogic();
      }, 100);
    }

    // Add initial entry only if no entries exist and no saved data
    setTimeout(() => {
      const container = document.getElementById('period-entries-container');
      const hasExistingEntries = container && container.querySelectorAll('textarea').length > 0;
      const hasSavedData = window.periodFormPersistence && 
        Object.keys(window.periodFormPersistence.getSavedFormData() || {}).some(key => key.includes('entry'));
      
      if (!hasExistingEntries && !hasSavedData) {
        console.log("[PeriodIQ] Adding initial entry");
        // Use our direct addEntry function
        if (window.addEntry) {
          window.addEntry();
        }
      }
    }, 300); // Delay to let FormPersistence finish recreation
  }

  function runInitialization() {
    setTimeout(initialize, 50);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runInitialization);
  } else {
    runInitialization();
  }

  // Handle loading through datain.js
  document.addEventListener('data-in-loaded', function(e) {
    const moduleType = e.detail?.moduleType;
    if (moduleType === 'period') {
      console.log("[PeriodIQ] Period module loaded through datain.js, reinitializing");
      runInitialization();
      
      // Also trigger conditional logic after data loads
      setTimeout(() => {
        triggerConditionalLogic();
      }, 200);
    }
  });
  
  // Export functions for external access
  window.periodIq = { 
    getFormData: () => window.periodFormPersistence ? window.periodFormPersistence.getSavedFormData() : {},
    saveFormData: () => window.periodFormPersistence ? window.periodFormPersistence.saveFormData() : false,
    addEntry: window.addEntry,
    deleteEntry: window.deleteEntry
  };
  
  // addEntry function exposed globally for FormPersistence recreation
})();
</script>
