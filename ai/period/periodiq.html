<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

<div class="device-container">
  <div class="row1 product-description-container">
    <h2 class="product-description-heading">Unlock Personalized Period Insights!</h2>
    <p class="product-description-text">
        Track your menstrual cycle like never before with PeriodIQâ„¢. Instead of rigid forms and preset categories, simply log what happens when it happens. Our adaptive AI learns from your natural language entries to provide personalized insights about your cycle patterns, symptoms, and health trends.
    </p>
    <p class="product-description-final">
        Start your adaptive period tracking journey!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a healthcare professional for medical advice.</em>
    </p>
  </div>

  <div class="row1" data-step-label="Basic Information">
    <h3 class="tooltip1" data-tooltip="Basic information to help personalize your period tracking experience.">
      Basic Information<span class="tooltip1-content"></span>
    </h3>
    <input id="period-age" type="text" placeholder="Age">
    <select id="period-tracking-reason">
      <option value="" disabled selected>Why are you tracking?</option>
      <option value="General Health">General Health</option>
      <option value="Trying to Conceive">Trying to Conceive</option>
      <option value="Birth Control">Birth Control</option>
      <option value="Health Issues">Health Issues</option>
      <option value="Just Curious">Just Curious</option>
    </select>
  </div>

  <div class="row1" data-step-label="Cycle History">
    <h3 class="tooltip1" data-tooltip="Tell us about your typical cycle if you know it, or leave blank if unsure.">
      Cycle History (Optional)<span class="tooltip1-content"></span>
    </h3>
    <input id="period-last-period" type="text" placeholder="When did your last period start? (e.g. June 15th)">
    <input id="period-cycle-length" type="text" placeholder="Typical cycle length (e.g. 28 days, varies 25-30)">
    <input id="period-period-length" type="text" placeholder="Period duration (e.g. 5 days, 3-7 days)">
  </div>

  <div class="row1" data-step-label="Period Events Log">
    <h3 class="tooltip1" data-tooltip="Log period events as they happen using natural language. Add new entries anytime.">
      Period Events Log<span class="tooltip1-content"></span>
    </h3>
    <div id="period-entries-container">
      <!-- Split textarea entries will be added here dynamically -->
    </div>
    <button id="add-period-entry-btn" class="add-entry-btn">+ Add New Entry</button>
    <button class="generate-btn" id="generate-period-btn">Analyze My Patterns!</button>
  </div>
</div>

<script type="module">
import { initAutoExpandTextareas, createSplitTextarea } from '../styles/inputFunctionality.js';
import { getFingerprintForWorker, incrementRequestCount, isRateLimited, handleRateLimitResponse } from '/ai/rate-limiter/rateLimiter.js';

(function() {
  console.log("Period IQ script initializing");

  let entryCounter = 0;

  // Initialize textarea auto-expand
  initAutoExpandTextareas();
  
  // Listen for textarea changes to save data
  document.addEventListener('textarea:changed', function(e) {
    if (window.periodFormPersistence) {
      window.periodFormPersistence.saveFormData();
    }
  });

  // Function to add a new period entry
  function addPeriodEntry(whenValue = '', whatValue = '') {
    entryCounter++;
    const container = document.getElementById('period-entries-container');
    
    // Default "when" value to current time if empty
    if (!whenValue) {
      const now = new Date();
      whenValue = `Today ${now.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      })}`;
    }

    const entryDiv = createSplitTextarea({
      id: `period-entry-${entryCounter}`,
      whenPlaceholder: 'When?',
      whatPlaceholder: 'What happened? (e.g., spotting started, heavy flow, cramps, mood changes)',
      whenValue: whenValue,
      whatValue: whatValue,
      entryNumber: entryCounter
    });

    container.appendChild(entryDiv);
    
    // Initialize auto-expand for the new textarea
    initAutoExpandTextareas();
    
    // Save form data after adding entry
    if (window.periodFormPersistence) {
      window.periodFormPersistence.saveFormData();
    }

    // Focus on the "what" field of the new entry
    const whatField = entryDiv.querySelector('.what-field');
    if (whatField) {
      whatField.focus();
    }
  }

  // Handle generate button click
  async function handleGeneratePeriodIq() {
    try {
      const formData = window.periodFormPersistence.getSavedFormData();
      if (!formData || !formData.entries || formData.entries.length === 0) { 
        alert('Please add at least one period event before generating analysis.'); 
        return;
      }

      // Check rate limiting
      if (isRateLimited('period', 8, 60 * 60 * 1000)) {
        alert('You have exceeded the request limit for period analysis. Please try again later.');
        return;
      }

      const fingerprintData = getFingerprintForWorker();
      
      const workerPayload = {
        module: "period",
        formData: formData,
        fingerprint: fingerprintData
      };

      const dataContainer = document.querySelector('.device-container');
      let backendResponse = null;
      
      try {
        backendResponse = await window.enhancedLoading(
          'generate-period-btn',
          'period',
          async () => {
            const apiUrl = 'https://inexasli.com/api/generate';
            const response = await fetch(apiUrl, { 
              method: 'POST', 
              headers: {'Content-Type':'application/json'}, 
              body: JSON.stringify(workerPayload)
            });
            
            let responseData;
            try {
              responseData = await response.json();
            } catch (e) {
              responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
            }
            
            handleRateLimitResponse(dataContainer, responseData, !response.ok, 'PeriodIQ');
            
            if (!response.ok) {
              throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
            }
            if (responseData.message !== 'Success') {
              throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
            }
            return responseData;
          }
        );
        
        incrementRequestCount('period');
        window.periodFormPersistence.saveResponseData(backendResponse);
        
        const event = new CustomEvent('api-response-received', {
          detail: {
            module: 'periodiq',
            type: 'worker-response',
            timestamp: Date.now()
          }
        });
        document.dispatchEvent(event);
        console.log('[PeriodIQ] Dispatched api-response-received event');
        
      } catch (error) {
        if (backendResponse && dataContainer) {
          handleRateLimitResponse(dataContainer, backendResponse, true, 'PeriodIQ');
        }
        console.error('[PeriodIQ] Error generating period analysis:', error);
      }
    } catch (error) {
      console.error('[PeriodIQ] Error generating period analysis:', error);
      alert('An error occurred while generating your period analysis. Please try again later.');
    }
  }

  function initialize() {
    console.log("[PeriodIQ] Initializing...");
    
    // Set up event listeners
    const generateBtn = document.getElementById('generate-period-btn');
    if (generateBtn) {
      generateBtn.removeEventListener('click', handleGeneratePeriodIq);
      generateBtn.addEventListener('click', handleGeneratePeriodIq);
    }

    const addEntryBtn = document.getElementById('add-period-entry-btn');
    if (addEntryBtn) {
      addEntryBtn.removeEventListener('click', addPeriodEntry);
      addEntryBtn.addEventListener('click', addPeriodEntry);
    }

    // Add initial entry
    addPeriodEntry();
  }

  function runInitialization() {
    setTimeout(initialize, 50);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runInitialization);
  } else {
    runInitialization();
  }

  // Handle loading through datain.js
  document.addEventListener('data-in-loaded', function(e) {
    const moduleType = e.detail?.moduleType;
    if (moduleType === 'period') {
      console.log("[PeriodIQ] Period module loaded through datain.js, reinitializing");
      runInitialization();
    }
  });
  
  // Export functions for external access
  window.periodIq = { 
    getFormData: () => window.periodFormPersistence.getSavedFormData(),
    saveFormData: () => window.periodFormPersistence.saveFormData(),
    addEntry: addPeriodEntry
  };
})();
</script>
