<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

<div class="device-container">
  <div class="row1 product-description-container">
    <h2 class="product-description-heading">Unlock Personalized Period Insights!</h2>
    <p class="product-description-text">
        Track your menstrual cycle like never before with PeriodIQ™. Instead of rigid forms and preset categories, simply log what happens when it happens. Our adaptive AI learns from your natural language entries to provide personalized insights about your cycle patterns, symptoms, and health trends.
    </p>
    <p class="product-description-final">
        Start your adaptive period tracking journey!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a healthcare professional for medical advice.</em>
    </p>
  </div>

  <div class="row1" data-step-label="Basic Information">
    <h3 class="tooltip1" data-tooltip="Basic information to help personalize your period tracking experience.">
      Basic Information<span class="tooltip1-content"></span>
    </h3>

    <select id="period-birth-control-type">
      <option value="" disabled selected>Birth control type</option>
      <option value="pill">Birth Control Pill</option>
      <option value="iud">IUD</option>
      <option value="implant">Implant</option>
      <option value="injectable">Injectable</option>
      <option value="patch">Patch</option>
      <option value="ring">Ring</option>
      <option value="condoms">Condoms</option>
      <option value="diaphragm">Diaphragm</option>
      <option value="spermicide">Spermicide</option>
      <option value="none">None</option>
    </select>
    <input id="period-birth-control-detail" type="text" placeholder="Specify brand/type" style="display: none;">

    <!-- Natural Cycle Specific Fields -->
    <div id="period-natural-cycle-container" style="display: none;">
      <input id="period-cycle-length-input" type="text" placeholder="Typical cycle length (e.g. 28 days, varies 25-30)">
    </div>

    <!-- Birth Control Pill Specific Fields -->
    <div id="period-pill-container" style="display: none;">
      <label for="period-pill-start-date">Hormone pill restart date (after your last period):</label>
      <input id="period-pill-start-date" type="date">
    </div>

    <!-- IUD Specific Fields -->
    <div id="period-iud-container" style="display: none;">
      <label for="period-iud-insertion-date">IUD insertion date:</label>
      <input id="period-iud-insertion-date" type="date">
    </div>

    <!-- Other Hormonal Methods Container -->
    <div id="period-other-hormonal-container" style="display: none;">
      <label for="period-method-start-date">Method start date:</label>
      <input id="period-method-start-date" type="date">
    </div>

    <label for="period-start-date">Last Period Start Date:</label>
    <input id="period-start-date" type="date" name="period-start-date">
    
    <label for="period-end-date">Last Period End Date:</label>
    <input id="period-end-date" type="date" name="period-end-date">

    <input id="period-age" type="text" placeholder="Age">
  </div>

  <div class="row1" data-step-label="Medical Information">
    <h3 class="tooltip1" data-tooltip="Medical conditions and medications that may affect your cycle.">
      Medical Information<span class="tooltip1-content"></span>
    </h3>
    
    <textarea id="period-medical-conditions" placeholder="Medical conditions
    
    (PCOS, endometriosis, thyroid issues, diabetes, etc.)"></textarea>
    
    <textarea id="period-current-medications" placeholder="Other Medication & Supplements & Dosage
• Zoloft 50mg daily
• Vitamin D
• Iron supplement"></textarea>
  </div>

  <div class="row1" data-step-label="Cycle Information">
    <h3 class="tooltip1" data-tooltip="Basic cycle pattern information for predictions.">
      Cycle Information<span class="tooltip1-content"></span>
    </h3>
    
    <label>How regular are your cycles?</label>
    <div class="grid-items2" id="period-cycle-regularity-container">
      <div class="grid-item" data-value="very-regular">Very Regular (±1 day)</div>
      <div class="grid-item" data-value="mostly-regular">Mostly Regular (±2-3 days)</div>
      <div class="grid-item" data-value="irregular">Irregular (±4+ days)</div>
      <div class="grid-item" data-value="unpredictable">Unpredictable</div>
    </div>

    <label>Average cycle length</label>
    <textarea id="period-cycle-length" placeholder="Average cycle length
• 28 days (most common)
• Varies 26-32 days
• 25 days on birth control

"></textarea>

    <label>Flow intensity</label>
    <div class="grid-items2" id="period-flow-intensity-container">
      <div class="grid-item" data-value="light">Light</div>
      <div class="grid-item" data-value="medium">Medium</div>
      <div class="grid-item" data-value="heavy">Heavy</div>
      <div class="grid-item" data-value="varies">Varies</div>
    </div>
  </div>

  <div class="row1" data-step-label="Period Events Log">
    <h3 class="tooltip1" data-tooltip="Optional: Log additional period events, symptoms, or circumstances that may need AI analysis.">
      Additional Period Events (Optional)<span class="tooltip1-content"></span>
    </h3>
    <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
      Use the date fields above for basic tracking. Add entries below only for symptoms, irregularities, or notes requiring analysis.
    </p>
    <div id="period-entries-container">
      <!-- Split calendar-text entries will be added here dynamically -->
    </div>
    <button type="button" id="add-period-entry-btn" class="add-entry-btn">Add Entry</button>
    <!-- View tracker button -->
    <button class="generate-btn" id="generate-period-btn">View My Period Tracker</button>
  </div>
</div>

<script type="module">
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

// Rate limiting utilities are now available globally via window.rateLimiter

(function() {
  // FormPersistence is initialized by datain.js and available as window.periodFormPersistence
  // No need to create it here - just ensure it's available when we need it

  // Initialize grid functionality for period-specific grids
  function initCycleGrids() {
    const gridContainers = document.querySelectorAll('.grid-items2');
    
    gridContainers.forEach(grid => {
      const cards = grid.querySelectorAll('.grid-item');
      
      cards.forEach(card => {
        card.addEventListener('click', function() {
          // Single selection logic
          cards.forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');
          
          // FormPersistence will handle saving automatically via its event listeners
        });
      });
    });
  }

  // Initialize birth control conditional logic
  function initBirthControlLogic() {
    const select = document.getElementById('period-birth-control-type');
    const detailInput = document.getElementById('period-birth-control-detail');
    
    const containerMap = {
      'none': '#period-natural-cycle-container',
      'condoms': '#period-natural-cycle-container',
      'diaphragm': '#period-natural-cycle-container', 
      'spermicide': '#period-natural-cycle-container',
      'pill': '#period-pill-container',
      'patch': '#period-other-hormonal-container',
      'ring': '#period-other-hormonal-container',
      'injectable': '#period-other-hormonal-container',
      'implant': '#period-other-hormonal-container',
      'iud': '#period-iud-container'
    };

    const placeholderMap = {
      'pill': 'Brand name (e.g. Yasmin, Ortho Tri-Cyclen, Alesse)',
      'iud': 'IUD type (e.g. Mirena, Paragard, Skyla, Kyleena)',
      'implant': 'Implant type (e.g. Nexplanon, Implanon)',
      'injectable': 'Injectable type (e.g. Depo-Provera)',
      'patch': 'Patch brand (e.g. Ortho Evra)',
      'ring': 'Ring type (e.g. NuvaRing)',
      'condoms': 'Brand/type (e.g. Trojan, Durex, latex-free)',
      'diaphragm': 'Brand/type (e.g. Milex, Ortho)',
      'spermicide': 'Brand/type (e.g. VCF, Conceptrol)'
    };

    function handleBirthControlChange() {
      const value = select.value;
      
      // Hide all containers
      Object.values(containerMap).forEach(selector => {
        const container = document.querySelector(selector);
        if (container) container.style.display = 'none';
      });
      
      // Show relevant container
      if (containerMap[value]) {
        const container = document.querySelector(containerMap[value]);
        if (container) container.style.display = 'block';
      }
      
      // Handle detail input
      if (value && value !== 'none' && placeholderMap[value]) {
        detailInput.style.display = 'block';
        detailInput.placeholder = placeholderMap[value];
      } else {
        detailInput.style.display = 'none';
      }
      
      // Save form data
      if (window.periodFormPersistence) {
        window.periodFormPersistence.saveFormData();
      }
    }
    
    if (select) {
      select.addEventListener('change', handleBirthControlChange);
      // Trigger on page load to restore state
      setTimeout(handleBirthControlChange, 100);
    }
  }

  // Initialize add entry functionality
  function initAddEntryButton() {
    const addBtn = document.getElementById('add-period-entry-btn');
    const container = document.getElementById('period-entries-container');
    
    if (addBtn && container) {
      addBtn.addEventListener('click', function() {
        const entryCount = container.querySelectorAll('[data-entry-id^="period-entry"]').length + 1;
        const now = new Date();
        const defaultWhen = `Today ${now.toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        })}`;
        
        if (window.createSplitTextarea) {
          const entryDiv = window.createSplitTextarea({
            id: `period-entry-${entryCount}`,
            whenPlaceholder: 'When did this happen? (e.g., "June 17th", "Today 3pm")',
            whatPlaceholder: 'What happened? (e.g., "Period started", "Heavy cramping", "Period ended")',
            whenValue: defaultWhen,
            whatValue: '',
            entryNumber: entryCount
          });
          
          container.appendChild(entryDiv);
          
          // Initialize auto-expand for new textareas
          const textareas = entryDiv.querySelectorAll('textarea');
          textareas.forEach(textarea => {
            if (window.autoExpandTextarea) {
              window.autoExpandTextarea(textarea);
              textarea.addEventListener('input', () => window.autoExpandTextarea(textarea));
            }
          });
          
          // Save form data
          if (window.periodFormPersistence) {
            setTimeout(() => window.periodFormPersistence.saveFormData(), 100);
          }
        }
      });
    }
  }

  // Initialize all period-specific functionality
  setTimeout(() => {
    initCycleGrids();
    initBirthControlLogic();
    initAddEntryButton();
  }, 200);

  // Handle the generate button click
  async function handleGeneratePeriodIq() {
    const formData = window.periodFormPersistence.getSavedFormData();
    if (!formData) {
      console.error('[PeriodIQ] No input data found in localStorage.');
      alert('Please complete the form before generating a period analysis.');
      return;
    }

    // Check rate limiting before proceeding
    if (window.rateLimiter.isRateLimited('period', 8, 60 * 60 * 1000)) { // 8 requests per hour (as per rate-limiter config)
      alert('You have exceeded the request limit for period analysis. Please try again later.');
      return;
    }

    // Create worker payload with email for paid users (DRY function)
    const workerPayload = window.rateLimiter.createWorkerPayload('period', formData);
    
    const dataContainer = document.querySelector('.data-container-in');
    let backendResponse = null;
    try {
      backendResponse = await window.enhancedLoading(
        'generate-period-btn',
        'period',
        async () => {
          // Send data to worker
          const apiUrl = 'https://inexasli.com/api/generate';
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(workerPayload)
          });
          let responseData;
          try {
            responseData = await response.json();
          } catch (e) {
            responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
          }
          // Always call handleRateLimitResponse with backend response
          window.rateLimiter.handleRateLimitResponse(dataContainer, responseData, !response.ok);
          if (!response.ok) {
            throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
          }
          if (responseData.message !== 'Success') {
            throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
          }
          
          // Store the response
          window.periodFormPersistence.saveResponseData(responseData);
          
          // Dispatch an event to notify dataout.js that a response was received
          const event = new CustomEvent('api-response-received', {
            detail: {
              module: 'period',
              type: 'worker-response',
              timestamp: Date.now()
            }
          });
          document.dispatchEvent(event);
          
          return responseData;
        }
      );
      window.rateLimiter.incrementRequestCount('period');
    } catch (error) {
      // If backendResponse is available, update rate limit display and show error
      if (backendResponse && dataContainer) {
        window.rateLimiter.handleRateLimitResponse(dataContainer, backendResponse, true);
      }
      // Optionally, show a toast/modal here for generic errors
      console.error('[PeriodIQ] Error:', error);
    }
  }

  // Initialization
  const generatePeriodBtn = document.getElementById('generate-period-btn');
  if (generatePeriodBtn) {
    generatePeriodBtn.addEventListener('click', handleGeneratePeriodIq);
    // Set flag to prevent duplicate handler attachment
    generatePeriodBtn.dataset.handlerAttached = 'true';
  }

})();
</script>
