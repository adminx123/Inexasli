<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

<div class="device-container">
  <div class="row1 product-description-container">
    <h2 class="product-description-heading">Unlock Personalized Period Insights!</h2>
    <p class="product-description-text">
        Track your menstrual cycle like never before with PeriodIQâ„¢. Instead of rigid forms and preset categories, simply log what happens when it happens. Our adaptive AI learns from your natural language entries to provide personalized insights about your cycle patterns, symptoms, and health trends.
    </p>
    <p class="product-description-final">
        Start your adaptive period tracking journey!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a healthcare professional for medical advice.</em>
    </p>
  </div>

  <div class="row1" data-step-label="Basic Information">

    <h3 class="tooltip1" data-tooltip="Basic information to help personalize your period tracking experience.">
      Basic Information<span class="tooltip1-content"></span>
    </h3>

 <select id="period-birth-control-type">
      <option value="" disabled selected>Birth control type</option>
      <option value="pill">Birth Control Pill</option>
      <option value="iud">IUD</option>
      <option value="implant">Implant</option>
      <option value="injectable">Injectable</option>
      <option value="patch">Patch</option>
      <option value="ring">Ring</option>
      <option value="condoms">Condoms</option>
      <option value="diaphragm">Diaphragm</option>
      <option value="spermicide">Spermicide</option>
      <option value="none">None</option>
    </select>
    <input id="period-birth-control-detail" type="text" placeholder="Specify brand/type" style="display: none;">

    <!-- Natural Cycle Specific Fields -->
    <div id="natural-cycle-container" style="display: none;">
      <input id="period-cycle-length" type="text" placeholder="Typical cycle length (e.g. 28 days, varies 25-30)">
    </div>

    <!-- Birth Control Pill Specific Fields -->
    <div id="pill-container" style="display: none;">
      <label for="period-pill-start-date">Hormone pill restart date (after your last period):</label>
      <input id="period-pill-start-date" type="date">
    </div>

    <!-- IUD Specific Fields -->
    <div id="iud-container" style="display: none;">
      <label for="period-iud-insertion-date">IUD insertion date:</label>
      <input id="period-iud-insertion-date" type="date">
    </div>

    <!-- Other Hormonal Methods Container -->
    <div id="other-hormonal-container" style="display: none;">
      <label for="period-method-start-date">Method start date:</label>
      <input id="period-method-start-date" type="date">
    </div>

    <label for="start-date">Last Period Start Date:</label>
    <input id="start-date" type="date" name="start-date">
    
    <label for="end-date">Last Period End Date:</label>
    <input id="end-date" type="date" name="end-date">

    <input id="period-age" type="text" placeholder="Age">
   
  </div>

  <div class="row1" data-step-label="Period Events Log">
    <h3 class="tooltip1" data-tooltip="Optional: Log additional period events, symptoms, or circumstances that may need AI analysis.">
      Additional Period Events (Optional)<span class="tooltip1-content"></span>
    </h3>
    <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
      Use the date fields above for basic tracking. Add entries below only for symptoms, irregularities, or notes requiring analysis.
    </p>
    <div id="period-entries-container">
      <!-- Split calendar-text entries will be added here dynamically -->
    </div>
    <!-- View tracker button -->
    <button class="generate-btn" id="generate-period-btn">View My Period Tracker</button>
    
    <!-- Enhanced analysis button (only shows if additional entries exist) -->
    <button class="generate-btn" id="enhanced-analysis-btn" style="display: none; background: #9C27B0; margin-top: 10px;">Get Enhanced AI Analysis</button>
  </div>
</div>

<script type="module">
// Rate limiting utilities are now available globally via window.rateLimiter

(function() {
  console.log("Period IQ script initializing");

  // Initialize textarea auto-expand
  window.initAutoExpandTextareas();
  
  // Listen for textarea changes to save data
  document.addEventListener('textarea:changed', function(e) {
    if (window.periodFormPersistence) {
      window.periodFormPersistence.saveFormData();
    }
  });

  // Listen for form data restoration to trigger conditional logic
  document.addEventListener('formpersistence:repopulated', function(e) {
    console.log('[PeriodIQ] Form repopulated, triggering conditional logic');
    setTimeout(() => {
      triggerConditionalLogic();
    }, 50);
  });

  // Handle generate button click
  async function handleGeneratePeriodIq() {
    try {
      // Force save current form data first
      if (window.periodFormPersistence) {
        window.periodFormPersistence.saveFormData();
      }
      
      const formData = window.periodFormPersistence ? window.periodFormPersistence.getSavedFormData() : {};
      console.log('[PeriodIQ] Form data for validation:', formData);
      
      // Check if we have basic period dates
      const hasBasicData = formData['start-date'] || formData['end-date'];
      console.log('[PeriodIQ] Has basic data:', hasBasicData);
      
      if (!hasBasicData) { 
        alert('Please enter your last period dates to view your tracker.'); 
        return;
      }
      
      // Trigger dataout.js navigation like other modules
      const event = new CustomEvent('api-response-received', {
        detail: {
          module: 'period',
          type: 'frontend-response',
          timestamp: Date.now()
        }
      });
      document.dispatchEvent(event);
      console.log('[PeriodIQ] Dispatched api-response-received event for dataout.js');
      
    } catch (error) {
      console.error('[PeriodIQ] Error:', error);
      alert('An error occurred. Please try again.');
    }
  }

  // Handle enhanced analysis (AI generation)
  async function handleEnhancedAnalysis() {
    try {
      const formData = window.periodFormPersistence ? window.periodFormPersistence.getSavedFormData() : {};
      
      // Check if we have additional entries for analysis
      const hasEntries = Object.keys(formData).some(key => key.includes('entry') && key.includes('what') && formData[key]);
      
      if (!hasEntries) { 
        alert('Please add period events/symptoms for enhanced AI analysis.'); 
        return;
      }

      // Check rate limiting
      if (window.rateLimiter.isRateLimited('period', 8, 60 * 60 * 1000)) {
        alert('You have exceeded the request limit for period analysis. Please try again later.');
        return;
      }

      // Create worker payload with email for paid users (DRY function)
      const workerPayload = window.rateLimiter.createWorkerPayload('period', formData);

      const dataContainer = document.querySelector('.device-container');
      let backendResponse = null;
      
      try {
        backendResponse = await window.enhancedLoading(
          'generate-period-btn',
          'period',
          async () => {
            const apiUrl = 'https://inexasli.com/api/generate';
            const response = await fetch(apiUrl, { 
              method: 'POST', 
              headers: {'Content-Type':'application/json'}, 
              body: JSON.stringify(workerPayload)
            });
            
            let responseData;
            try {
              responseData = await response.json();
            } catch (e) {
              responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
            }
            
            window.rateLimiter.handleRateLimitResponse(dataContainer, responseData, !response.ok, 'PeriodIQ');
            
            if (!response.ok) {
              throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
            }
            if (responseData.message !== 'Success') {
              throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
            }
            return responseData;
          }
        );
        
        window.rateLimiter.incrementRequestCount('period');
        window.periodFormPersistence.saveResponseData(backendResponse);
        
        const event = new CustomEvent('api-response-received', {
          detail: {
            module: 'period',
            type: 'worker-response',
            timestamp: Date.now()
          }
        });
        document.dispatchEvent(event);
        console.log('[PeriodIQ] Dispatched api-response-received event');
        
      } catch (error) {
        if (backendResponse && dataContainer) {
          window.rateLimiter.handleRateLimitResponse(dataContainer, backendResponse, true, 'PeriodIQ');
        }
        console.error('[PeriodIQ] Error generating enhanced analysis:', error);
      }
    } catch (error) {
      console.error('[PeriodIQ] Error generating enhanced analysis:', error);
      alert('An error occurred while generating your enhanced analysis. Please try again later.');
    }
  }

  // Show/hide enhanced analysis button based on entries
  function updateEnhancedAnalysisButton() {
    const formData = window.periodFormPersistence ? window.periodFormPersistence.getSavedFormData() : {};
    const hasEntries = Object.keys(formData).some(key => key.includes('entry') && key.includes('what') && formData[key]);
    const enhancedBtn = document.getElementById('enhanced-analysis-btn');
    
    if (enhancedBtn) {
      enhancedBtn.style.display = hasEntries ? 'block' : 'none';
    }
  }

  // Save input data to localStorage for periodoutput.html to read
  function saveInputToLocalStorage() {
    const formData = window.periodFormPersistence ? window.periodFormPersistence.getSavedFormData() : {};
    
    // Save to localStorage as periodIqInput for output page to read
    localStorage.setItem('periodIqInput', JSON.stringify(formData));
    console.log('[PeriodIQ] Saved input data to localStorage');
    
    // Trigger dataout.js navigation like other modules
    const event = new CustomEvent('api-response-received', {
      detail: {
        module: 'period',
        type: 'frontend-response',
        timestamp: Date.now()
      }
    });
    document.dispatchEvent(event);
    console.log('[PeriodIQ] Dispatched api-response-received event for dataout.js');
  }

  // Handle birth control type change
  const placeholderMap = {
    'pill': 'Brand name (e.g. Yasmin, Ortho Tri-Cyclen, Alesse)',
    'iud': 'IUD type (e.g. Mirena, Paragard, Skyla, Kyleena)',
    'implant': 'Implant type (e.g. Nexplanon, Implanon)',
    'injectable': 'Injectable type (e.g. Depo-Provera)',
    'patch': 'Patch brand (e.g. Ortho Evra)',
    'ring': 'Ring type (e.g. NuvaRing)',
    'condoms': 'Brand/type (e.g. Trojan, Durex, latex-free)',
    'diaphragm': 'Brand/type (e.g. Milex, Ortho)',
    'spermicide': 'Brand/type (e.g. VCF, Conceptrol)'
  };

  const handleBirthControlChange = window.handleConditionalInput(
    'period-birth-control-type',
    'period-birth-control-detail',
    placeholderMap,
    'none',
    () => {
      if (window.periodFormPersistence) {
        window.periodFormPersistence.saveFormData();
      }
    }
  );

  // Handle contraceptive-specific container visibility
  const contraceptiveContainerMap = {
    'none': '#natural-cycle-container',
    'condoms': '#natural-cycle-container',
    'diaphragm': '#natural-cycle-container', 
    'spermicide': '#natural-cycle-container',
    'pill': '#pill-container',
    'patch': '#other-hormonal-container',
    'ring': '#other-hormonal-container',
    'injectable': '#other-hormonal-container',
    'implant': '#other-hormonal-container',
    'iud': '#iud-container'
  };

  const handleContainerVisibility = window.handleConditionalContainers(
    'period-birth-control-type',
    contraceptiveContainerMap,
    [''], // Empty selection hides all containers
    () => {
      if (window.periodFormPersistence) {
        window.periodFormPersistence.saveFormData();
      }
    }
  );

  // Handle method-specific timing fields for other hormonal methods
  function updateMethodSpecificFields() {
    // Removed - no longer needed
  }

  // Add listener for birth control type changes to update method-specific fields
  document.getElementById('period-birth-control-type').addEventListener('change', updateMethodSpecificFields);

  // Function to trigger conditional logic manually (for form repopulation)
  function triggerConditionalLogic() {
    if (handleBirthControlChange && typeof handleBirthControlChange === 'function') {
      handleBirthControlChange();
    }
    if (handleContainerVisibility && typeof handleContainerVisibility === 'function') {
      handleContainerVisibility();
    }
    updateMethodSpecificFields();
  }

  // Initialize period entries functionality
  if (window.addEntryButton) {
    window.addEntryButton({
      containerSelector: '#period-entries-container',
      buttonId: 'add-period-entry-btn',
      buttonText: 'Add Entry',
      entryIdPrefix: 'period-entry',
      whenPlaceholder: 'When did this happen? (e.g., "June 17th", "Today 3pm")',
      whatPlaceholder: 'What happened? (e.g., "Period started", "Heavy cramping", "Period ended")',
      useCalendar: false,
      onAdd: () => {
        if (window.periodFormPersistence) {
          window.periodFormPersistence.saveFormData();
        }
      }
    });
    
    // Expose addPeriodEntry globally for FormPersistence recreation
    window.addPeriodEntry = function(whenValue = '', whatValue = '') {
      // Get the container
      const container = document.querySelector('#period-entries-container');
      if (!container) return;
      
      // Find existing entries to determine counter
      const existingEntries = container.querySelectorAll('[data-entry-id^="period-entry"]');
      const entryCounter = existingEntries.length + 1;
      
      // Default "when" value if not provided
      if (!whenValue) {
        const now = new Date();
        whenValue = `Today ${now.toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        })}`;
      }
      
      // Create the entry using inputFunctionality's createSplitTextarea
      if (window.createSplitTextarea) {
        const entryDiv = window.createSplitTextarea({
          id: `period-entry-${entryCounter}`,
          whenPlaceholder: 'When did this happen? (e.g., "June 17th", "Today 3pm")',
          whatPlaceholder: 'What happened? (e.g., "Period started", "Heavy cramping", "Period ended")',
          whenValue: whenValue,
          whatValue: whatValue,
          entryNumber: entryCounter
        });

        container.appendChild(entryDiv);
        
        // Initialize auto-expand for textareas
        const textareas = entryDiv.querySelectorAll('textarea');
        textareas.forEach(textarea => {
          if (window.autoExpandTextarea) {
            window.autoExpandTextarea(textarea);
            textarea.addEventListener('input', () => window.autoExpandTextarea(textarea));
            textarea.addEventListener('paste', () => {
              setTimeout(() => window.autoExpandTextarea(textarea), 0);
            });
          }
        });
        
        // Trigger save immediately after creation
        if (window.periodFormPersistence) {
          setTimeout(() => {
            window.periodFormPersistence.saveFormData();
          }, 100); // Small delay to ensure DOM is ready
        }
      }
    };
    
    console.log('[PeriodIQ] addPeriodEntry function exposed globally');
  }

  // Initialize form persistence for period module
  if (window.FormPersistence) {
    window.periodFormPersistence = window.FormPersistence.getInstance('period');
    if (!window.periodFormPersistence.initialized) {
      window.periodFormPersistence.init({
        moduleName: 'period'
      });
    }
  }

  // Initialization - simplified to match calorie module pattern
  const generatePeriodBtn = document.getElementById('generate-period-btn');
  if (generatePeriodBtn) {
    generatePeriodBtn.addEventListener('click', handleGeneratePeriodIq);
    // Set flag to prevent duplicate handler attachment
    generatePeriodBtn.dataset.handlerAttached = 'true';
  }

  const enhancedAnalysisBtn = document.getElementById('enhanced-analysis-btn');
  if (enhancedAnalysisBtn) {
    enhancedAnalysisBtn.addEventListener('click', handleEnhancedAnalysis);
  }

  // Update enhanced analysis button visibility on form changes
  document.addEventListener('textarea:changed', updateEnhancedAnalysisButton);
  
  // Initial button state check
  setTimeout(updateEnhancedAnalysisButton, 100);

})();
</script>
