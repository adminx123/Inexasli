<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Output</title>
  
  <!-- Preconnect and font links -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles/outputstyles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="../../utility/enhancedUI.js"></script>
  
  <style>
    /* Using device-container, output-wrapper and api-output styles from outputstyles.css */
    
    .quiz-display {
      font-family: "Inter", sans-serif;
      font-size: 16px;
      line-height: 1.6;
      white-space: normal;
    }
    
    .quiz-header {
      text-align: center;
      margin-bottom: 25px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
    }
    
    .quiz-title {
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 10px 0;
    }
    
    .quiz-meta {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      font-size: 14px;
      opacity: 0.9;
    }
    
    .quiz-meta span {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .quiz-instructions {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 0 8px 8px 0;
    }
    
    .quiz-instructions h3 {
      margin: 0 0 12px 0;
      color: #1976d2;
      font-weight: 600;
    }
    
    .quiz-instructions p {
      margin: 0;
      color: #424242;
      line-height: 1.6;
    }
    
    .progress-bar {
      height: 4px;
      background: #e9ecef;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .answer-feedback {
      font-size: 14px;
      padding: 12px;
      border-radius: 6px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .answer-feedback.correct {
      background: #e8f5e8;
      border-left: 4px solid #4caf50;
      color: #2e7d32;
    }
    
    .answer-feedback.incorrect {
      background: #ffebee;
      border-left: 4px solid #f44336;
      color: #c62828;
    }
    
    .quiz-results-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    
    .results-card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }
    
    .results-card h3 {
      margin: 0 0 8px 0;
      font-size: 24px;
      font-weight: 600;
    }
    
    .results-card p {
      margin: 0;
      font-size: 14px;
      color: #6c757d;
    }
    
    @media print {
      .quiz-display button {
        display: none !important;
      }
      
      .device-container {
        max-width: none !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      .quiz-header {
        background: #667eea !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }
    
    .question-card.answered {
      border-color: #28a745;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
    }
    
    .question-card.incorrect {
      border-color: #dc3545;
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2);
    }
    
    .question-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    
    .question-header {
      background: #f8f9fa;
      padding: 16px 20px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .question-number {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }
    
    .question-type {
      font-weight: 600;
      color: #495057;
      text-transform: capitalize;
    }
    
    .question-content {
      padding: 20px;
    }
    
    .question-text {
      font-size: 16px;
      line-height: 1.6;
      color: #2c3e50;
      font-weight: 500;
      margin-bottom: 20px;
    }
    
    /* Multiple Choice & True/False Options */
    .option {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .option:hover {
      background: #e3f2fd;
      border-color: #2196f3;
    }
    
    .option.selected {
      background: #e3f2fd;
      border-color: #2196f3;
      color: #1976d2;
    }
    
    .option-letter {
      background: #6c757d;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .option.selected .option-letter {
      background: #2196f3;
    }
    
    .option-text {
      flex: 1;
      line-height: 1.5;
    }
    
    /* Short Answer */
    .short-answer-input {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.2s ease;
    }
    
    .short-answer-input:focus {
      outline: none;
      border-color: #2196f3;
    }
    
    /* Fill in the Blank */
    .blank-input {
      border: none;
      border-bottom: 2px solid #6c757d;
      background: transparent;
      padding: 4px 8px;
      margin: 0 4px;
      min-width: 100px;
      font-size: inherit;
      transition: border-color 0.2s ease;
    }
    
    .blank-input:focus {
      outline: none;
      border-bottom-color: #2196f3;
    }
    
    /* Matching */
    .matching-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 16px 0;
    }
    
    .matching-column h4 {
      margin: 0 0 12px 0;
      color: #495057;
      font-weight: 600;
    }
    
    .match-item, .match-target {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .match-item:hover, .match-target:hover {
      background: #e3f2fd;
    }
    
    .match-item.selected {
      background: #e3f2fd;
      border-color: #2196f3;
    }
    
    .match-item.matched {
      background: #d4edda;
      border-color: #28a745;
      opacity: 0.7;
    }
    
    .match-target.filled {
      background: #d4edda;
      border-color: #28a745;
    }
    
    /* Action Buttons */
    .quiz-actions {
      background: #f8f9fa;
      padding: 24px;
      border-top: 1px solid #e9ecef;
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 30px;
      border-radius: 0 0 12px 12px;
    }
    
    .quiz-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .quiz-btn.reset {
      background: #6c757d;
      color: white;
    }
    
    .quiz-btn.reset:hover {
      background: #5a6268;
    }
    
    .quiz-btn.submit {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .quiz-btn.submit:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    /* Loading and Empty States */
  </style>
</head>
<body>
  <div id="main-content" class="device-container">
    <div class="output-wrapper">
      <div id="output-span" class="api-output"></div>
    </div>
  </div>
  
  <script>
    (function() {
      // Utility functions following calorieiq pattern
      const getLocal = window.getLocal || function(key) {
        try {
          const value = localStorage.getItem(key);
          return value ? decodeURIComponent(value) : null;
        } catch (e) {
          console.error('Error getting local storage:', e);
          return null;
        }
      };
      
      const getJSON = window.getJSON || function(key) {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : null;
        } catch (e) {
          console.error('Error parsing JSON:', e);
          return null;
        }
      };

      // Quiz interaction state
      let selectedAnswers = {};
      let matchingAnswers = {};
      let currentQuizData = null;
      function cleanMarkdownText(text) {
        if (!text) return text;
        
        return text
          // Remove all markdown formatting
          .replace(/\*\*([^*]+)\*\*/g, '$1')  // Remove **bold**
          .replace(/\*([^*]+)\*/g, '$1')      // Remove *italic*
          .replace(/##\s*([^\n]+)/g, '$1')    // Remove ## headers
          .replace(/#\s*([^\n]+)/g, '$1')     // Remove # headers
          .replace(/`([^`]+)`/g, '$1')        // Remove `code`
          .replace(/_{2,}([^_]+)_{2,}/g, '$1') // Remove __underline__
          .replace(/~{2,}([^~]+)~{2,}/g, '$1') // Remove ~~strikethrough~~
          .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Remove [links](url)
          .replace(/>\s*/g, '')               // Remove > blockquotes
          .replace(/^\s*[-*+]\s*/gm, '')      // Remove bullet points
          .replace(/^\s*\d+\.\s*/gm, '')      // Remove numbered lists (but keep question numbers)
          .trim();
      }

      function parseQuizContent(content) {
        console.log('Parsing quiz content, type:', typeof content);
        
        // First try to parse as JSON (structured data from quiz.js)
        try {
          let jsonData;
          
          // Handle both direct object and stringified JSON
          if (typeof content === 'object' && content !== null) {
            console.log('Content is already an object');
            jsonData = content;
          } else if (typeof content === 'string') {
            console.log('Content is string, length:', content.length);
            console.log('Content preview:', content.substring(0, 200) + '...');
            jsonData = JSON.parse(content);
          } else {
            throw new Error('Unsupported content type: ' + typeof content);
          }
          
          // Check if it's the expected quiz structure
          if (jsonData.quizTitle && jsonData.questions && Array.isArray(jsonData.questions)) {
            console.log('Successfully parsed structured JSON quiz data');
            return jsonData;
          } else {
            console.log('Object does not have expected quiz structure. Keys:', Object.keys(jsonData));
          }
        } catch (e) {
          console.log('Content is not valid JSON, trying text parsing...', e.message);
        }
        
        // If we get here, it's either not JSON or doesn't have the expected structure
        // Try text parsing for unstructured content if it's a string
        if (typeof content !== 'string') {
          console.error('Cannot parse non-string content as text');
          return null;
        }
        
        const lines = content.split('\n');
        const quiz = {
          quizTitle: 'Generated Quiz',
          introduction: '',
          instructions: 'Select the best answer for each question.',
          questionFormat: 'multiple-choice',
          questions: []
        };

        let currentSection = '';
        let currentQuestion = null;
        let questionCounter = 0;
        let collectingQuestion = false;

        for (let i = 0; i < lines.length; i++) {
          let line = lines[i].trim();
          
          // Skip empty lines
          if (!line) continue;
          
          console.log(`Line ${i}: "${line}"`);
          
          // Check for quiz title - more flexible matching
          if (line.includes('Quiz Title') || line.includes('quiz') && line.includes('title')) {
            quiz.quizTitle = line.replace(/\*\*Quiz Title:\*\*/, '').replace('Quiz Title:', '').replace(/\*\*/g, '').trim();
            console.log('Found title:', quiz.quizTitle);
            continue;
          }
          
          // Check for sections
          if (line.includes('Introduction') && !line.includes('**Questions')) {
            currentSection = 'introduction';
            console.log('Switched to introduction section');
            continue;
          } else if (line.includes('Instructions')) {
            currentSection = 'instructions';
            console.log('Switched to instructions section');
            continue;
          } else if (line.includes('Questions') && !line.includes('Instructions')) {
            currentSection = 'questions';
            console.log('Switched to questions section');
            continue;
          }
          
          // Parse questions - look for numbered questions more flexibly
          const questionMatch = line.match(/^(\d+)[\.\)]\s*(.+)/) || line.match(/Question\s*(\d+)[:\.]?\s*(.+)/i);
          if (questionMatch && (currentSection === 'questions' || line.includes('Question'))) {
            // Save previous question
            if (currentQuestion) {
              console.log('Saving previous question:', currentQuestion);
              quiz.questions.push(currentQuestion);
            }
            
            questionCounter++;
            currentQuestion = {
              questionNumber: parseInt(questionMatch[1]),
              questionText: questionMatch[2],
              type: 'multiple-choice',
              options: []
            };
            collectingQuestion = true;
            console.log('Started new question:', currentQuestion.questionNumber, currentQuestion.questionText.substring(0, 50));
            continue;
          }
          
          // Parse options - more flexible matching
          const optionMatch = line.match(/^\s*([A-D])\)\s*(.+)/) || line.match(/^\s*([A-D])[\.\:]?\s*(.+)/);
          if (optionMatch && currentQuestion && collectingQuestion) {
            currentQuestion.options.push({
              letter: optionMatch[1],
              text: optionMatch[2]
            });
            console.log('Added option:', optionMatch[1], optionMatch[2].substring(0, 30));
            continue;
          }
          
          // Collect other content
          if (currentSection === 'introduction' && !line.includes('**') && !line.includes('Quiz Title')) {
            quiz.introduction += line + ' ';
          } else if (currentSection === 'instructions' && !line.includes('**')) {
            if (line.startsWith('-')) {
              quiz.instructions += '\n• ' + line.substring(1).trim();
            } else {
              quiz.instructions += line + ' ';
            }
          } else if (collectingQuestion && currentQuestion && !optionMatch && !questionMatch) {
            // Continue collecting question text if it spans multiple lines
            if (!line.includes('A)') && !line.includes('B)') && !line.includes('C)') && !line.includes('D)')) {
              currentQuestion.questionText += ' ' + line;
              console.log('Extended question text:', currentQuestion.questionText.substring(0, 50));
            }
          }
        }

        // Add the last question
        if (currentQuestion) {
          console.log('Saving final question:', currentQuestion);
          quiz.questions.push(currentQuestion);
        }

        console.log('Final parsed quiz:', quiz);
        console.log('Questions found:', quiz.questions.length);
        
        return quiz;
      }

      function cleanText(text) {
        if (!text) return '';
        // Remove markdown formatting
        return text
          .replace(/\*\*(.*?)\*\*/g, '$1') // Remove **bold**
          .replace(/\*(.*?)\*/g, '$1')     // Remove *italic*
          .replace(/#{1,6}\s*/g, '')       // Remove headers
          .replace(/`(.*?)`/g, '$1')       // Remove code blocks
          .trim();
      }

      function renderQuestion(question, index) {
        const questionType = question.type || 'multiple-choice';
        const cleanQuestionText = cleanText(question.questionText);
        
        let optionsHTML = '';
        
        switch (questionType) {
          case 'multiple-choice':
            if (question.options && question.options.length > 0) {
              optionsHTML = question.options.map(option => `
                <div class="option" data-option="${option.letter}" onclick="selectOption(this)" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: flex-start; gap: 12px;">
                  <div class="option-letter" style="background: #6c757d; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; flex-shrink: 0; margin-top: 2px;">${option.letter}</div>
                  <div style="flex: 1; line-height: 1.5;">${cleanText(option.text)}</div>
                </div>
              `).join('');
            }
            break;
            
          case 'true-false':
            optionsHTML = `
              <div class="option" data-option="true" onclick="selectOption(this)" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 12px;">
                <div class="option-letter" style="background: #6c757d; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">T</div>
                <div style="flex: 1; line-height: 1.5;">True</div>
              </div>
              <div class="option" data-option="false" onclick="selectOption(this)" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 12px;">
                <div class="option-letter" style="background: #6c757d; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">F</div>
                <div style="flex: 1; line-height: 1.5;">False</div>
              </div>
            `;
            break;
            
          case 'short-answer':
            optionsHTML = `
              <div style="margin: 16px 0;">
                <textarea class="short-answer-input" data-question="${index}" onchange="updateShortAnswer(this)" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #e9ecef; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical; outline: none; transition: border-color 0.2s ease;" onfocus="this.style.borderColor='#2196f3'" onblur="this.style.borderColor='#e9ecef'"></textarea>
              </div>
              <div style="margin-top: 12px; padding: 12px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #4caf50;">
                <small style="color: #2e7d32; font-weight: 500;">
                  <i class="fas fa-pencil-alt"></i> Provide a detailed answer in your own words
                </small>
              </div>
            `;
            break;
            
          case 'matching':
            if (question.columnA && question.columnB) {
              optionsHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 16px 0;">
                  <div>
                    <h4 style="margin: 0 0 12px 0; color: #495057;">Column A</h4>
                    ${question.columnA.map(item => `
                      <div class="match-item" data-question="${index}" data-id="${item.id}" onclick="selectMatchItem(this)" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s ease; user-select: none;">
                        ${cleanText(item.text)}
                      </div>
                    `).join('')}
                  </div>
                  <div>
                    <h4 style="margin: 0 0 12px 0; color: #495057;">Column B</h4>
                    ${question.columnB.map(item => `
                      <div class="match-target" data-question="${index}" data-id="${item.id}" onclick="selectMatchTarget(this)" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 8px; min-height: 44px; cursor: pointer; transition: all 0.2s ease; user-select: none; position: relative;">
                        <div class="match-content">${cleanText(item.text)}</div>
                        <div class="match-selection" style="display: none; position: absolute; top: 4px; right: 8px; background: #28a745; color: white; border-radius: 12px; padding: 2px 8px; font-size: 12px; font-weight: 600;"></div>
                      </div>
                    `).join('')}
                  </div>
                </div>
                <div style="margin-top: 16px; padding: 12px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                  <small style="color: #1976d2; font-weight: 500;">
                    <i class="fas fa-info-circle"></i> Click an item in Column A, then click its match in Column B
                  </small>
                </div>
              `;
            }
            break;
            
          case 'fill-in-the-blank':
            // Replace blanks with input fields
            let questionWithBlanks = cleanQuestionText;
            if (question.blanks) {
              question.blanks.forEach((blank, blankIndex) => {
                const inputId = `blank-${index}-${blankIndex}`;
                questionWithBlanks = questionWithBlanks.replace('_____', 
                  `<input type="text" id="${inputId}" class="blank-input" data-question="${index}" data-blank="${blankIndex}" onchange="updateBlankAnswer(this)" style="border: none; border-bottom: 2px solid #6c757d; background: transparent; padding: 4px 8px; margin: 0 4px; min-width: 100px; font-size: inherit; font-family: inherit; outline: none; transition: border-color 0.2s ease;" placeholder="...">`
                );
              });
            } else {
              // Fallback: replace all _____ with inputs
              let blankIndex = 0;
              questionWithBlanks = questionWithBlanks.replace(/_____/g, () => {
                const inputId = `blank-${index}-${blankIndex}`;
                const input = `<input type="text" id="${inputId}" class="blank-input" data-question="${index}" data-blank="${blankIndex}" onchange="updateBlankAnswer(this)" style="border: none; border-bottom: 2px solid #6c757d; background: transparent; padding: 4px 8px; margin: 0 4px; min-width: 100px; font-size: inherit; font-family: inherit; outline: none; transition: border-color 0.2s ease;" placeholder="...">`;
                blankIndex++;
                return input;
              });
            }
            optionsHTML = `
              <div style="margin: 16px 0; font-size: 16px; line-height: 1.8;">${questionWithBlanks}</div>
              <div style="margin-top: 16px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                <small style="color: #856404; font-weight: 500;">
                  <i class="fas fa-edit"></i> Fill in the blanks with appropriate words or phrases
                </small>
              </div>
            `;
            break;
            
          default:
            // Default to multiple choice format
            optionsHTML = question.options ? question.options.map(option => `
              <div class="option" data-option="${option.letter}" onclick="selectOption(this)" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: flex-start; gap: 12px;">
                <div class="option-letter" style="background: #6c757d; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; flex-shrink: 0; margin-top: 2px;">${option.letter}</div>
                <div style="flex: 1; line-height: 1.5;">${cleanText(option.text)}</div>
              </div>
            `).join('') : '';
        }
        
        return `
          <div class="question-card" data-question="${index}" data-type="${questionType}" style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; margin-bottom: 24px; overflow: hidden; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="background: #f8f9fa; padding: 16px 20px; border-bottom: 1px solid #e9ecef; display: flex; align-items: center; gap: 12px;">
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">${question.questionNumber}</div>
              <span style="font-weight: 600; color: #495057;">Question ${question.questionNumber} (${questionType.replace('-', ' ')})</span>
            </div>
            <div style="padding: 20px; font-size: 16px; line-height: 1.6; color: #2c3e50; font-weight: 500;">
              ${questionType === 'fill-in-the-blank' ? optionsHTML : cleanQuestionText}
            </div>
            ${questionType !== 'fill-in-the-blank' ? `<div style="padding: 0 20px 20px 20px;">${optionsHTML}</div>` : ''}
          </div>
        `;
      }
      
      function parseQuizContentFallback(content) {
        console.log('Using fallback parsing method...');
        const quiz = {
          title: 'Technical Analysis Quiz',
          introduction: 'Advanced quiz on stock market technical analysis focusing on chart patterns.',
          instructions: 'Select the best answer for each question.',
          questions: []
        };
        
        // Split by numbers followed by period to find questions
        const sections = content.split(/\n\s*(\d+)\.\s*/);
        
        for (let i = 1; i < sections.length; i += 2) {
          if (i + 1 < sections.length) {
            const questionNum = parseInt(sections[i]);
            const questionContent = sections[i + 1];
            
            // Split the content to separate question from options
            const lines = questionContent.split('\n').filter(line => line.trim());
            
            if (lines.length > 0) {
              const question = {
                number: questionNum,
                text: '',
                options: []
              };
              
              let questionText = '';
              let foundOptions = false;
              
              for (const line of lines) {
                const optionMatch = line.trim().match(/^\s*([A-D])\)\s*(.+)/);
                if (optionMatch) {
                  foundOptions = true;
                  question.options.push({
                    letter: optionMatch[1],
                    text: optionMatch[2]
                  });
                } else if (!foundOptions) {
                  questionText += line.trim() + ' ';
                }
              }
              
              question.text = questionText.trim();
              
              if (question.text && question.options.length > 0) {
                quiz.questions.push(question);
                console.log('Fallback found question:', questionNum, question.text.substring(0, 50));
              }
            }
          }
        }
        
        console.log('Fallback parsing result:', quiz.questions.length, 'questions found');
        return quiz;
      }

      function createQuizHTML(quizData) {
        console.log('Creating quiz HTML from data:', quizData);
        const quiz = parseQuizContent(quizData.quizContent);
        
        const cleanTitle = cleanText(quiz.quizTitle || quiz.title);
        const cleanIntroduction = cleanText(quiz.introduction);
        const cleanInstructions = cleanText(quiz.instructions);
        
        let html = `
          <div style="max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; text-align: center;">
              <h1 style="margin: 0; font-size: 24px; font-weight: 600;"><i class="fas fa-brain"></i> ${cleanTitle}</h1>
            </div>
            
            <div style="background: #f8f9fa; padding: 16px 24px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
              <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 8px; color: #6c757d; font-size: 14px; font-weight: 500;">
                  <i class="fas fa-calendar"></i>
                  <span>${new Date(quizData.generatedDate).toLocaleDateString()}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; color: #6c757d; font-size: 14px; font-weight: 500;">
                  <i class="fas fa-question-circle"></i>
                  <span>${quiz.questions.length} Questions</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; color: #6c757d; font-size: 14px; font-weight: 500;">
                  <i class="fas fa-clock"></i>
                  <span>15-20 minutes</span>
                </div>
                ${quiz.questionFormat ? `
                <div style="display: flex; align-items: center; gap: 8px; color: #6c757d; font-size: 14px; font-weight: 500;">
                  <i class="fas fa-list"></i>
                  <span>${quiz.questionFormat.replace('-', ' ')}</span>
                </div>
                ` : ''}
              </div>
            </div>
            
            <div style="height: 4px; background: #e9ecef; position: relative; overflow: hidden;">
              <div id="progress-fill" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s ease;"></div>
            </div>
            
            <div style="padding: 32px 24px;">
        `;

        if (cleanIntroduction || cleanInstructions) {
          html += `
            <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 20px; margin-bottom: 32px; border-radius: 0 8px 8px 0;">
              <h3 style="margin: 0 0 12px 0; color: #1976d2; font-weight: 600;"><i class="fas fa-info-circle"></i> Instructions</h3>
              ${cleanIntroduction ? `<p style="margin: 0 0 12px 0; color: #424242; line-height: 1.6;"><strong>About:</strong> ${cleanIntroduction}</p>` : ''}
              ${cleanInstructions ? `<p style="margin: 0; color: #424242; line-height: 1.6;"><strong>Instructions:</strong> ${cleanInstructions}</p>` : ''}
            </div>
          `;
        }

        // Add questions using the new rendering system
        quiz.questions.forEach((question, index) => {
          html += renderQuestion(question, index);
        });

        html += `
            </div>
            
            <div style="background: #f8f9fa; padding: 24px; border-top: 1px solid #e9ecef; display: flex; justify-content: center; gap: 16px;">
              <button onclick="resetQuiz()" style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 14px; background: #6c757d; color: white;">
                <i class="fas fa-redo"></i> Reset Quiz
              </button>
              <button onclick="submitQuiz()" style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <i class="fas fa-check"></i> Submit Answers
              </button>
            </div>
          </div>
        `;        return html;
      }

      function updateOutput() {
        const outputSpan = document.getElementById('output-span');
        if (!outputSpan) {
          setTimeout(updateOutput, 100);
          return;
        }
        const responseKey = 'quizIqResponse';
        console.log('Looking for data with key:', responseKey);
        
        // First, let's check what's actually in localStorage
        const rawItem = localStorage.getItem(responseKey);
        console.log('Raw localStorage item:', rawItem);
        console.log('Raw item length:', rawItem ? rawItem.length : 'null');
        
        let data;
        try {
          data = getJSON(responseKey);
          console.log('Parsed data:', data);
          
          if (data) {
            console.log('Data structure check:');
            console.log('- Has data property:', !!data.data);
            console.log('- Has message:', data.message);
            console.log('- Has quizContent:', !!(data.data && data.data.quizContent));
            
            if (data.data && data.data.quizContent) {
              const contentType = typeof data.data.quizContent;
              console.log('Quiz content type:', contentType);
              if (contentType === 'string') {
                console.log('Quiz content length:', data.data.quizContent.length);
                console.log('Quiz content preview:', data.data.quizContent.substring(0, 500));
                console.log('Quiz content ends with:', data.data.quizContent.slice(-200));
              } else if (contentType === 'object') {
                console.log('Quiz content is object with keys:', Object.keys(data.data.quizContent));
                console.log('Quiz content preview:', JSON.stringify(data.data.quizContent).substring(0, 500));
              }
            }
          }
        } catch (err) {
          console.error('Error parsing JSON:', err);
          console.log('Attempting to display raw content...');
          
          // If JSON parsing fails, show the raw content for debugging
          outputSpan.innerHTML = `
            <div style="padding: 20px; font-family: monospace; background: #f8f9fa; border-radius: 8px; margin: 20px;">
              <h3 style="color: #dc3545;">JSON Parse Error</h3>
              <p><strong>Error:</strong> ${err.message}</p>
              <p><strong>Raw Content (first 1000 chars):</strong></p>
              <pre style="background: white; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px;">${rawItem ? rawItem.substring(0, 1000) : 'No data found'}</pre>
              ${rawItem && rawItem.length > 1000 ? `<p><em>...and ${rawItem.length - 1000} more characters</em></p>` : ''}
            </div>
          `;
          return;
        }
        
        if (data && data.data && data.data.quizContent) {
          console.log('Quiz data found, creating HTML...');
          try {
            // Check if content appears to be truncated
            const content = data.data.quizContent;
            let contentLength, seemsTruncated;
            
            if (typeof content === 'string') {
              contentLength = content.length;
              seemsTruncated = contentLength < 1000 || !content.includes('1.') || content.includes('Difficulty Tier"') || content.endsWith('Tier');
            } else if (typeof content === 'object') {
              // If it's already parsed, check if it has the expected structure
              const hasQuestions = content.questions && Array.isArray(content.questions) && content.questions.length > 0;
              seemsTruncated = !hasQuestions;
              contentLength = hasQuestions ? content.questions.length + ' questions' : 'object without questions';
            } else {
              seemsTruncated = true;
              contentLength = 'unknown type: ' + typeof content;
            }
            
            if (seemsTruncated) {
              console.warn('Quiz content is definitively truncated!');
              outputSpan.innerHTML = `
                <div style="max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-top: 20px;">
                  <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 24px; text-align: center;">
                    <h1 style="margin: 0; font-size: 24px; font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> Response Truncated</h1>
                  </div>
                  
                  <div style="padding: 32px 24px;">
                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; margin-bottom: 24px; border-radius: 0 8px 8px 0;">
                      <h3 style="margin: 0 0 12px 0; color: #856404; font-weight: 600;"><i class="fas fa-info-circle"></i> Issue Detected</h3>
                      <p style="margin: 0 0 12px 0; color: #856404; line-height: 1.6;">The quiz response has been truncated to only <strong>${contentLength} characters</strong>. A complete quiz typically contains 2000+ characters with multiple questions and options.</p>
                      <p style="margin: 0; color: #856404; line-height: 1.6;">This is likely due to response size limits from the worker or XAI API.</p>
                    </div>
                    
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                      <h4 style="margin: 0 0 16px 0; color: #495057; font-weight: 600;"><i class="fas fa-eye"></i> Partial Content Received:</h4>
                      <pre style="background: white; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; line-height: 1.4; margin: 0; white-space: pre-wrap; color: #495057;">${typeof content === 'string' ? content : JSON.stringify(content, null, 2)}</pre>
                    </div>
                    
                    <div style="background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 20px; border-radius: 0 8px 8px 0;">
                      <h4 style="margin: 0 0 12px 0; color: #0c5460; font-weight: 600;"><i class="fas fa-lightbulb"></i> Suggested Solutions:</h4>
                      <ul style="margin: 0; padding-left: 20px; color: #0c5460; line-height: 1.6;">
                        <li>Try requesting a shorter quiz (e.g., 5 questions instead of 10)</li>
                        <li>Use simpler question formats (True/False instead of Multiple Choice)</li>
                        <li>Reduce the difficulty level to "beginner" or "intermediate"</li>
                        <li>Check if there are response size limits in your worker configuration</li>
                        <li>Consider splitting the request into multiple smaller quizzes</li>
                      </ul>
                    </div>
                  </div>
                  
                  <div style="background: #f8f9fa; padding: 24px; border-top: 1px solid #e9ecef; display: flex; justify-content: center; gap: 16px;">
                    <button onclick="window.location.reload()" style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 14px; background: #6c757d; color: white;">
                      <i class="fas fa-redo"></i> Retry
                    </button>
                    <button onclick="window.history.back()" style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                      <i class="fas fa-arrow-left"></i> Back to Form
                    </button>
                  </div>
                </div>
              `;
              return;
            }
            
            const quizHTML = createQuizHTML(data.data);
            outputSpan.innerHTML = quizHTML;
            setupQuizInteractivity();
            console.log('Quiz displayed successfully');
          } catch (error) {
            console.error('Error creating quiz HTML:', error);
            outputSpan.innerHTML = '';
          }
        } else {
          console.log('No quiz data found in expected format');
          outputSpan.innerHTML = '';
        }
      }

      function evaluateQuiz(submittedAnswers) {
        const results = {
          totalQuestions: submittedAnswers.totalQuestions,
          correctAnswers: 0,
          incorrectAnswers: 0,
          score: 0,
          percentage: 0,
          questionResults: [],
          submittedAt: submittedAnswers.submittedAt
        };

        // Get the original quiz data to compare answers
        const responseKey = "quizIqResponse";
        const originalData = getJSON(responseKey);
        if (!originalData || !originalData.data || !originalData.data.quizContent) {
          console.error('Cannot evaluate quiz: original quiz data not found');
          return results;
        }

        let quizContent;
        if (typeof originalData.data.quizContent === 'string') {
          try {
            quizContent = JSON.parse(originalData.data.quizContent);
          } catch (e) {
            console.error('Cannot parse quiz content for evaluation');
            return results;
          }
        } else {
          quizContent = originalData.data.quizContent;
        }

        if (!quizContent.questions) {
          console.error('Quiz content has no questions array');
          return results;
        }

        // Evaluate each question
        quizContent.questions.forEach((question, index) => {
          const questionIndex = index.toString();
          const questionResult = {
            questionNumber: question.questionNumber || (index + 1),
            questionText: question.questionText,
            type: question.type,
            userAnswer: null,
            correctAnswer: null,
            isCorrect: false,
            explanation: question.explanation || 'No explanation provided.',
            points: 1
          };

          // Evaluate based on question type
          switch (question.type) {
            case 'multiple-choice':
            case 'true-false':
              questionResult.userAnswer = submittedAnswers.selectedAnswers[questionIndex];
              questionResult.correctAnswer = question.correctAnswer;
              questionResult.isCorrect = questionResult.userAnswer === questionResult.correctAnswer;
              
              // For display purposes, get the full text of selected option
              if (question.options && questionResult.userAnswer) {
                const selectedOption = question.options.find(opt => opt.letter === questionResult.userAnswer);
                questionResult.userAnswerText = selectedOption ? selectedOption.text : questionResult.userAnswer;
              }
              if (question.options && questionResult.correctAnswer) {
                const correctOption = question.options.find(opt => opt.letter === questionResult.correctAnswer);
                questionResult.correctAnswerText = correctOption ? correctOption.text : questionResult.correctAnswer;
              }
              break;

            case 'short-answer':
              questionResult.userAnswer = submittedAnswers.shortAnswers[questionIndex];
              questionResult.correctAnswer = question.expectedAnswer || question.keyPoints || 'See explanation for details.';
              // For short answers, we'll mark as correct if user provided an answer (manual grading needed)
              questionResult.isCorrect = questionResult.userAnswer && questionResult.userAnswer.length > 10;
              questionResult.requiresManualGrading = true;
              break;

            case 'matching':
              questionResult.userAnswer = submittedAnswers.matchingAnswers[questionIndex];
              questionResult.correctAnswer = question.correctMatches;
              
              // Check if all matches are correct
              let correctMatches = 0;
              let totalMatches = question.correctMatches ? question.correctMatches.length : 0;
              
              if (question.correctMatches && questionResult.userAnswer) {
                question.correctMatches.forEach(correctMatch => {
                  if (questionResult.userAnswer[correctMatch.from] === correctMatch.to) {
                    correctMatches++;
                  }
                });
              }
              
              questionResult.isCorrect = correctMatches === totalMatches && totalMatches > 0;
              questionResult.partialCredit = totalMatches > 0 ? correctMatches / totalMatches : 0;
              break;

            case 'fill-in-the-blank':
              questionResult.userAnswer = submittedAnswers.blankAnswers[questionIndex];
              questionResult.correctAnswer = {};
              
              // Check each blank
              let correctBlanks = 0;
              let totalBlanks = question.blanks ? question.blanks.length : 0;
              
              if (question.blanks) {
                question.blanks.forEach(blank => {
                  const blankPos = blank.position.toString();
                  questionResult.correctAnswer[blankPos] = blank.correctAnswer;
                  
                  if (questionResult.userAnswer && questionResult.userAnswer[blankPos]) {
                    const userBlank = questionResult.userAnswer[blankPos].toLowerCase().trim();
                    const correctBlank = blank.correctAnswer.toLowerCase().trim();
                    const alternatives = blank.alternatives ? blank.alternatives.map(alt => alt.toLowerCase().trim()) : [];
                    
                    if (userBlank === correctBlank || alternatives.includes(userBlank)) {
                      correctBlanks++;
                    }
                  }
                });
              }
              
              questionResult.isCorrect = correctBlanks === totalBlanks && totalBlanks > 0;
              questionResult.partialCredit = totalBlanks > 0 ? correctBlanks / totalBlanks : 0;
              break;
          }

          // Add to results
          results.questionResults.push(questionResult);
          
          if (questionResult.isCorrect) {
            results.correctAnswers++;
          } else {
            results.incorrectAnswers++;
          }
        });

        // Calculate overall score
        results.score = results.correctAnswers;
        results.percentage = results.totalQuestions > 0 ? Math.round((results.correctAnswers / results.totalQuestions) * 100) : 0;

        return results;
      }

      function createResultsHTML(results, submittedAnswers) {
        const scoreClass = results.percentage >= 80 ? 'excellent' : results.percentage >= 70 ? 'good' : results.percentage >= 60 ? 'average' : 'needs-improvement';
        const scoreColor = results.percentage >= 80 ? '#4caf50' : results.percentage >= 70 ? '#ff9800' : results.percentage >= 60 ? '#2196f3' : '#f44336';
        const scoreIcon = results.percentage >= 80 ? 'fa-trophy' : results.percentage >= 70 ? 'fa-thumbs-up' : results.percentage >= 60 ? 'fa-check-circle' : 'fa-times-circle';

        let resultsHTML = `
          <div style="max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-top: 20px;">
            <!-- Results Header -->
            <div style="background: linear-gradient(135deg, ${scoreColor} 0%, ${scoreColor}dd 100%); color: white; padding: 32px 24px; text-align: center;">
              <h1 style="margin: 0 0 16px 0; font-size: 28px; font-weight: 600;">
                <i class="fas ${scoreIcon}"></i> Quiz Results
              </h1>
              <div style="display: flex; justify-content: center; align-items: center; gap: 24px; flex-wrap: wrap;">
                <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 16px 24px; backdrop-filter: blur(10px);">
                  <div style="font-size: 32px; font-weight: 700; margin-bottom: 4px;">${results.percentage}%</div>
                  <div style="font-size: 14px; opacity: 0.9;">Overall Score</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 16px 24px; backdrop-filter: blur(10px);">
                  <div style="font-size: 24px; font-weight: 600; margin-bottom: 4px;">${results.correctAnswers}/${results.totalQuestions}</div>
                  <div style="font-size: 14px; opacity: 0.9;">Correct Answers</div>
                </div>
              </div>
            </div>

            <!-- Performance Summary -->
            <div style="padding: 24px;">
              <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <h3 style="margin: 0 0 16px 0; color: #495057; font-weight: 600;">
                  <i class="fas fa-chart-line"></i> Performance Summary
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                  <div style="text-align: center; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
                    <div style="font-size: 24px; font-weight: 600; color: #4caf50; margin-bottom: 4px;">
                      <i class="fas fa-check-circle"></i> ${results.correctAnswers}
                    </div>
                    <div style="font-size: 14px; color: #6c757d;">Correct</div>
                  </div>
                  <div style="text-align: center; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
                    <div style="font-size: 24px; font-weight: 600; color: #f44336; margin-bottom: 4px;">
                      <i class="fas fa-times-circle"></i> ${results.incorrectAnswers}
                    </div>
                    <div style="font-size: 14px; color: #6c757d;">Incorrect</div>
                  </div>
                  <div style="text-align: center; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
                    <div style="font-size: 24px; font-weight: 600; color: #2196f3; margin-bottom: 4px;">
                      <i class="fas fa-clock"></i> ${new Date(results.submittedAt).toLocaleTimeString()}
                    </div>
                    <div style="font-size: 14px; color: #6c757d;">Completed</div>
                  </div>
                </div>
              </div>

              <!-- Question-by-Question Results -->
              <div style="margin-bottom: 24px;">
                <h3 style="margin: 0 0 16px 0; color: #495057; font-weight: 600;">
                  <i class="fas fa-list-check"></i> Detailed Results
                </h3>
        `;

        // Add each question result
        results.questionResults.forEach((questionResult, index) => {
          const isCorrect = questionResult.isCorrect;
          const statusColor = isCorrect ? '#4caf50' : '#f44336';
          const statusIcon = isCorrect ? 'fa-check-circle' : 'fa-times-circle';
          const statusText = isCorrect ? 'Correct' : 'Incorrect';

          resultsHTML += `
            <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; margin-bottom: 16px; overflow: hidden;">
              <!-- Question Header -->
              <div style="background: ${isCorrect ? '#e8f5e8' : '#ffebee'}; padding: 16px; border-bottom: 1px solid #e0e0e0;">
                <div style="display: flex; justify-content: between; align-items: center; gap: 16px;">
                  <div style="flex: 1;">
                    <h4 style="margin: 0; color: #495057; font-weight: 600; font-size: 16px;">
                      Question ${questionResult.questionNumber}
                    </h4>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px; color: ${statusColor}; font-weight: 600;">
                    <i class="fas ${statusIcon}"></i>
                    <span>${statusText}</span>
                  </div>
                </div>
              </div>

              <!-- Question Content -->
              <div style="padding: 20px;">
                <div style="margin-bottom: 16px;">
                  <p style="margin: 0; font-weight: 500; color: #495057; line-height: 1.6;">
                    ${questionResult.questionText}
                  </p>
                </div>

                <!-- Answer Comparison -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                  <div>
                    <h5 style="margin: 0 0 8px 0; color: #6c757d; font-size: 14px; font-weight: 600;">YOUR ANSWER:</h5>
                    <div style="background: #f8f9fa; border-radius: 6px; padding: 12px; border-left: 4px solid ${isCorrect ? '#4caf50' : '#f44336'};">
                      ${formatAnswer(questionResult.userAnswer, questionResult.type, questionResult.userAnswerText)}
                    </div>
                  </div>
                  <div>
                    <h5 style="margin: 0 0 8px 0; color: #6c757d; font-size: 14px; font-weight: 600;">CORRECT ANSWER:</h5>
                    <div style="background: #e8f5e8; border-radius: 6px; padding: 12px; border-left: 4px solid #4caf50;">
                      ${formatAnswer(questionResult.correctAnswer, questionResult.type, questionResult.correctAnswerText)}
                    </div>
                  </div>
                </div>

                <!-- Explanation -->
                <div style="background: #e3f2fd; border-radius: 8px; padding: 16px; border-left: 4px solid #2196f3;">
                  <h5 style="margin: 0 0 8px 0; color: #1976d2; font-size: 14px; font-weight: 600;">
                    <i class="fas fa-lightbulb"></i> EXPLANATION:
                  </h5>
                  <p style="margin: 0; color: #424242; line-height: 1.6; font-size: 14px;">
                    ${questionResult.explanation}
                  </p>
                  ${questionResult.requiresManualGrading ? '<p style="margin: 8px 0 0 0; color: #ff9800; font-size: 12px; font-style: italic;"><i class="fas fa-info-circle"></i> Short answers require manual review for accuracy.</p>' : ''}
                </div>
              </div>
            </div>
          `;
        });

        resultsHTML += `
              </div>

              <!-- Action Buttons -->
              <div style="background: #f8f9fa; padding: 24px; border-top: 1px solid #e9ecef; display: flex; justify-content: center; gap: 16px; flex-wrap: wrap;">
                <button onclick="window.location.reload()" style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 14px; background: #6c757d; color: white;">
                  <i class="fas fa-redo"></i> Take Quiz Again
                </button>
                <button onclick="window.history.back()" style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                  <i class="fas fa-arrow-left"></i> Back to Quiz Form
                </button>
                <button onclick="window.print()" style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 14px; background: #28a745; color: white;">
                  <i class="fas fa-print"></i> Print Results
                </button>
              </div>
            </div>
          </div>
        `;

        return resultsHTML;
      }

      function formatAnswer(answer, type, answerText) {
        if (!answer) return '<em style="color: #999;">No answer provided</em>';

        switch (type) {
          case 'multiple-choice':
          case 'true-false':
            return answerText ? `<strong>${answer}:</strong> ${answerText}` : answer;
          
          case 'short-answer':
            return answer.length > 100 ? answer.substring(0, 100) + '...' : answer;
          
          case 'matching':
            if (typeof answer === 'object') {
              const matches = Object.entries(answer).map(([from, to]) => `${from} → ${to}`).join(', ');
              return matches || '<em style="color: #999;">No matches made</em>';
            }
            return answer;
          
          case 'fill-in-the-blank':
            if (typeof answer === 'object') {
              const blanks = Object.entries(answer).map(([pos, val]) => `Blank ${pos}: ${val}`).join(', ');
              return blanks || '<em style="color: #999;">No blanks filled</em>';
            }
            return answer;
          
          default:
            return answer;
        }
      }

      function setupQuizInteractivity() {
        let selectedAnswers = {};
        let matchingAnswers = {};
        let shortAnswers = {};
        let blankAnswers = {};
        let selectedMatchItem = null;
        
        const questions = document.querySelectorAll('.question-card');

        // Multiple choice and true/false option selection
        window.selectOption = function(optionElement) {
          const questionCard = optionElement.closest('.question-card');
          const questionIndex = questionCard.dataset.question;
          const optionValue = optionElement.dataset.option;
          
          // Remove selected class from other options in this question
          questionCard.querySelectorAll('.option').forEach(opt => {
            opt.style.background = '#f8f9fa';
            opt.style.borderColor = '#e9ecef';
            opt.style.color = 'inherit';
            opt.querySelector('.option-letter').style.background = '#6c757d';
          });
          
          // Add selected style to clicked option
          optionElement.style.background = '#e3f2fd';
          optionElement.style.borderColor = '#2196f3';
          optionElement.style.color = '#1976d2';
          optionElement.querySelector('.option-letter').style.background = '#2196f3';
          
          // Store the answer
          selectedAnswers[questionIndex] = optionValue;
          
          // Update progress
          updateProgress();
        };

        // Matching question interactions
        window.selectMatchItem = function(itemElement) {
          const questionIndex = itemElement.dataset.question;
          
          // Clear previous selections in this question
          const questionCard = itemElement.closest('.question-card');
          questionCard.querySelectorAll('.match-item').forEach(item => {
            item.style.background = '#f8f9fa';
            item.style.borderColor = '#e9ecef';
            item.style.transform = 'scale(1)';
          });
          
          // Highlight selected item
          itemElement.style.background = '#e3f2fd';
          itemElement.style.borderColor = '#2196f3';
          itemElement.style.transform = 'scale(1.02)';
          
          selectedMatchItem = {
            questionIndex: questionIndex,
            itemId: itemElement.dataset.id,
            element: itemElement
          };
        };

        window.selectMatchTarget = function(targetElement) {
          if (!selectedMatchItem) {
            // Show hint if no item selected
            targetElement.style.background = '#fff3cd';
            targetElement.style.borderColor = '#ffc107';
            setTimeout(() => {
              targetElement.style.background = '#f8f9fa';
              targetElement.style.borderColor = '#e9ecef';
            }, 1000);
            return;
          }
          
          const questionIndex = targetElement.dataset.question;
          const targetId = targetElement.dataset.id;
          
          // Ensure we're matching within the same question
          if (selectedMatchItem.questionIndex !== questionIndex) {
            return;
          }
          
          // Initialize matching answers for this question if needed
          if (!matchingAnswers[questionIndex]) {
            matchingAnswers[questionIndex] = {};
          }
          
          // Store the match
          matchingAnswers[questionIndex][selectedMatchItem.itemId] = targetId;
          
          // Visual feedback
          targetElement.style.background = '#d4edda';
          targetElement.style.borderColor = '#28a745';
          const selectionDiv = targetElement.querySelector('.match-selection');
          selectionDiv.style.display = 'block';
          selectionDiv.textContent = selectedMatchItem.element.textContent.substring(0, 20) + '...';
          
          // Reset selected item
          selectedMatchItem.element.style.background = '#d4edda';
          selectedMatchItem.element.style.borderColor = '#28a745';
          selectedMatchItem = null;
          
          updateProgress();
        };

        // Short answer updates
        window.updateShortAnswer = function(textareaElement) {
          const questionIndex = textareaElement.dataset.question;
          shortAnswers[questionIndex] = textareaElement.value.trim();
          updateProgress();
        };

        // Fill-in-the-blank updates
        window.updateBlankAnswer = function(inputElement) {
          const questionIndex = inputElement.dataset.question;
          const blankIndex = inputElement.dataset.blank;
          
          if (!blankAnswers[questionIndex]) {
            blankAnswers[questionIndex] = {};
          }
          
          blankAnswers[questionIndex][blankIndex] = inputElement.value.trim();
          
          // Visual feedback
          if (inputElement.value.trim()) {
            inputElement.style.borderColor = '#28a745';
            inputElement.style.background = '#f8fff8';
          } else {
            inputElement.style.borderColor = '#6c757d';
            inputElement.style.background = 'transparent';
          }
          
          updateProgress();
        };

        function updateProgress() {
          const totalQuestions = questions.length;
          let answeredQuestions = 0;
          
          // Count answered questions across all types
          questions.forEach((question, index) => {
            const questionType = question.dataset.type;
            const questionIndex = question.dataset.question;
            
            switch (questionType) {
              case 'multiple-choice':
              case 'true-false':
                if (selectedAnswers[questionIndex]) answeredQuestions++;
                break;
              case 'short-answer':
                if (shortAnswers[questionIndex] && shortAnswers[questionIndex].length > 0) {
                  answeredQuestions++;
                }
                break;
              case 'matching':
                const questionMatches = matchingAnswers[questionIndex];
                const itemsInQuestion = question.querySelectorAll('.match-item').length;
                if (questionMatches && Object.keys(questionMatches).length === itemsInQuestion) {
                  answeredQuestions++;
                }
                break;
              case 'fill-in-the-blank':
                const questionBlanks = blankAnswers[questionIndex];
                const blanksInQuestion = question.querySelectorAll('.blank-input').length;
                if (questionBlanks && Object.keys(questionBlanks).length === blanksInQuestion) {
                  // Check if all blanks are filled
                  const filledBlanks = Object.values(questionBlanks).filter(val => val && val.length > 0).length;
                  if (filledBlanks === blanksInQuestion) {
                    answeredQuestions++;
                  }
                }
                break;
            }
          });
          
          const progressPercent = (answeredQuestions / totalQuestions) * 100;
          
          const progressFill = document.getElementById('progress-fill');
          if (progressFill) {
            progressFill.style.width = progressPercent + '%';
          }
        }

        window.resetQuiz = function() {
          selectedAnswers = {};
          matchingAnswers = {};
          shortAnswers = {};
          blankAnswers = {};
          selectedMatchItem = null;
          
          // Reset visual states
          document.querySelectorAll('.option').forEach(option => {
            option.style.background = '#f8f9fa';
            option.style.borderColor = '#e9ecef';
            option.style.color = 'inherit';
            const letter = option.querySelector('.option-letter');
            if (letter) letter.style.background = '#6c757d';
          });
          
          document.querySelectorAll('.match-item, .match-target').forEach(item => {
            item.style.background = '#f8f9fa';
            item.style.borderColor = '#e9ecef';
            item.style.transform = 'scale(1)';
            const selection = item.querySelector('.match-selection');
            if (selection) {
              selection.style.display = 'none';
              selection.textContent = '';
            }
          });
          
          document.querySelectorAll('.short-answer-input').forEach(textarea => {
            textarea.value = '';
          });
          
          document.querySelectorAll('.blank-input').forEach(input => {
            input.value = '';
            input.style.borderColor = '#6c757d';
            input.style.background = 'transparent';
          });
          
          updateProgress();
        };

        window.submitQuiz = function() {
          const totalQuestions = questions.length;
          let answeredQuestions = 0;
          let incompleteQuestions = [];
          
          // Validate all question types
          questions.forEach((question, index) => {
            const questionType = question.dataset.type;
            const questionIndex = question.dataset.question;
            const questionNumber = parseInt(questionIndex) + 1;
            
            switch (questionType) {
              case 'multiple-choice':
              case 'true-false':
                if (selectedAnswers[questionIndex]) {
                  answeredQuestions++;
                } else {
                  incompleteQuestions.push(`Question ${questionNumber} (${questionType.replace('-', ' ')})`);
                }
                break;
              case 'short-answer':
                if (shortAnswers[questionIndex] && shortAnswers[questionIndex].length > 0) {
                  answeredQuestions++;
                } else {
                  incompleteQuestions.push(`Question ${questionNumber} (short answer)`);
                }
                break;
              case 'matching':
                const questionMatches = matchingAnswers[questionIndex];
                const itemsInQuestion = question.querySelectorAll('.match-item').length;
                if (questionMatches && Object.keys(questionMatches).length === itemsInQuestion) {
                  answeredQuestions++;
                } else {
                  incompleteQuestions.push(`Question ${questionNumber} (matching)`);
                }
                break;
              case 'fill-in-the-blank':
                const questionBlanks = blankAnswers[questionIndex];
                const blanksInQuestion = question.querySelectorAll('.blank-input').length;
                if (questionBlanks && Object.keys(questionBlanks).length === blanksInQuestion) {
                  const filledBlanks = Object.values(questionBlanks).filter(val => val && val.length > 0).length;
                  if (filledBlanks === blanksInQuestion) {
                    answeredQuestions++;
                  } else {
                    incompleteQuestions.push(`Question ${questionNumber} (fill-in-the-blank - ${blanksInQuestion - filledBlanks} blanks remaining)`);
                  }
                } else {
                  incompleteQuestions.push(`Question ${questionNumber} (fill-in-the-blank)`);
                }
                break;
            }
          });
          
          if (answeredQuestions < totalQuestions) {
            alert(`Please complete all questions before submitting.\n\nIncomplete questions:\n${incompleteQuestions.join('\n')}\n\nProgress: ${answeredQuestions}/${totalQuestions} questions completed.`);
            return;
          }
          
          // Show confirmation before submitting
          const confirmSubmit = confirm(`Are you sure you want to submit your quiz?\n\nYou have answered ${answeredQuestions} out of ${totalQuestions} questions.\n\nOnce submitted, you cannot change your answers.`);
          
          if (!confirmSubmit) {
            return;
          }
          
          // Compile all answers
          const allAnswers = {
            selectedAnswers,
            matchingAnswers,
            shortAnswers,
            blankAnswers,
            submittedAt: new Date().toISOString(),
            totalQuestions: totalQuestions
          };
          
          console.log('Quiz submitted successfully!');
          console.log('All answers:', allAnswers);
          
          // Evaluate quiz and show results
          const results = evaluateQuiz(allAnswers);
          const resultsHTML = createResultsHTML(results, allAnswers);
          
          document.getElementById('output-span').innerHTML = resultsHTML;
        };
      }
      
      setTimeout(updateOutput, 100);
      
      // Initialize Enhanced UI System
      function initEnhancedUISystem() {
        // Wait a bit to ensure DOM and containers are ready
        setTimeout(() => {
          // Initialize the enhanced UI with embed detection
          if (window.enhancedUI) {
            window.enhancedUI.init({
              containerId: 'main-content',
              scrollToTop: true,
              embedEnforcement: true,
              accessibility: true
            });
          } else {
            console.warn('Enhanced UI system not loaded');
          }
        }, 100);
      }
      
      // Initialize when content is ready
      setTimeout(initEnhancedUISystem, 200);
    })();
  </script>
  <script src="../../utility/copy.js"></script>
</body>
</html>
