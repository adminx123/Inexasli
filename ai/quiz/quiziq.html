<!--
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
-->

<div class="device-container">

<div class="row1 product-description-container">
    <h2 class="product-description-heading">Test Your Knowledge & Create Engaging Quizzes!</h2>
    <p class="product-description-text">
        Looking to challenge yourself or create fun quizzes for others? QuizIQâ„¢ is your go-to tool! Whether you want to test your knowledge on a specific topic or easily generate questions for educational or entertainment purposes, our AI can help you craft engaging and informative quizzes.
    </p>
    <p class="product-description-final">
        Let's start quizzing!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a professional.</em>
    </p>
</div>

        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Specify the main topic or subject area for your quiz questions.">
                Quiz Subject<span class="tooltip1-content"></span>
            </h3>
            <textarea id="quiz-subject" rows="2" placeholder="World War II
Python Programming"></textarea>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Choose the purpose for your quiz to get appropriately structured questions.">
                Quiz Objective<span class="tooltip1-content"></span>
            </h3>
            <select id="quiz-objective">
                <option value="" disabled selected>Select Quiz Objective</option>
                <option value="self-study">Self-Study</option>
                <option value="classroom-assessment">Classroom Assessment</option>
                <option value="exam-practice">Exam Practice</option>
                <option value="knowledge-review">Knowledge Review</option>
                <option value="certification-prep">Certification Prep</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Select the complexity level for your quiz questions.">
                Difficulty Level<span class="tooltip1-content"></span>
            </h3>
            <select id="quiz-difficulty-tier">
                <option value="" disabled selected>Select Difficulty Level</option>
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
            </select>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Choose the types of questions you want in your quiz.">
                Question Formats<span class="tooltip1-content"></span>
            </h3>
            <div class="grid-container" id="quiz-formats">
                <div class="grid-item" data-value="multiple-choice">Multiple Choice</div>
                <div class="grid-item" data-value="true-false">True/False</div>
            </div>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Specify how many questions you want in your quiz.">
                Question Count<span class="tooltip1-content"></span>
            </h3>
            <select id="quiz-question-count">
                <option value="" disabled selected>Select Question Count</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="20">20</option>
                <option value="25">25</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Specify particular areas or subtopics within your subject to focus the questions on.">
                Focus Areas<span class="tooltip1-content"></span>
            </h3>
            <textarea id="quiz-focus-areas" rows="2" placeholder="Causes of WWI
Key Battles"></textarea>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Identify who will be taking this quiz to tailor the language and difficulty appropriately.">
                Target Participants<span class="tooltip1-content"></span>
            </h3>
            <div class="grid-container" id="quiz-participants">
                <div class="grid-item" data-value="students">Students</div>
                <div class="grid-item" data-value="professionals">Professionals</div>
                <div class="grid-item" data-value="enthusiasts">Enthusiasts</div>
                <div class="grid-item" data-value="general-learners">General Learners</div>
                <div class="grid-item" data-value="kids">Kids</div>
                <div class="grid-item" data-value="certification-trainees">Certification Trainees</div>
                <div class="grid-item" data-value="other">Other</div>
            </div>
            
            <button class="generate-btn" id="generate-quiz-btn">Generate Quiz Now!</button>
        </div>

<script type="module">
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

// Import fingerprint utilities
import { getFingerprintForWorker, incrementRequestCount, isRateLimited } from '/utility/rateLimiter.js';

(function() {
    console.log("QuizIQ script initializing");

    // Initialize FormPersistence for quiziq module
    const fields = [
        { id: 'quiz-subject', type: 'textarea' },
        { id: 'quiz-objective', type: 'dropdown' },
        { id: 'quiz-difficulty-tier', type: 'dropdown' },
        { id: 'quiz-formats', type: 'grid' },
        { id: 'quiz-question-count', type: 'dropdown' },
        { id: 'quiz-focus-areas', type: 'textarea' },
        { id: 'quiz-participants', type: 'grid' }
    ];

    // FormPersistence will be initialized by datain.js as window.quizFormPersistence
    // No need to create a new instance here

    // Listen for grid-item-toggled event from datain.js
    function handleGridItemToggled(event) {
        console.log('[QuizIQ] Grid item toggled event received');
        // UI behavior only - persistence handled centrally
    }

    // Handle the generate button click
    async function handleGenerateQuizIq() {
        console.log('[QuizIQ] Generate button clicked.');
        
        const formData = window.quizFormPersistence.getSavedFormData();
        if (!formData) {
            console.error('[QuizIQ] No input data found in localStorage.');
            alert('Please complete the form before generating a quiz.');
            return;
        }

        // Check rate limiting before proceeding
        if (isRateLimited('quiz', 15, 60 * 60 * 1000)) { // 15 requests per hour (as per rate-limiter config)
            alert('You have exceeded the request limit for quiz generation. Please try again later.');
            return;
        }

        // Get fingerprint data for rate limiting
        const fingerprintData = getFingerprintForWorker();
        
        // Create combined payload with both form data and fingerprint
        const workerPayload = {
            formData: formData,
            fingerprint: fingerprintData
        };
        
        const result = await window.enhancedLoading(
            'generate-quiz-btn',
            'quiz',
            async () => {
                // Send data to worker
                const apiUrl = 'https://quiz.4hm7q4q75z.workers.dev/';
                
                console.log('[QuizIQ] Sending quizIqInput to worker');
                console.log('[QuizIQ] FormData being sent:', JSON.stringify(formData, null, 2));
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(workerPayload) // Use new payload structure
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const responseData = await response.json();
                console.log('[QuizIQ] Worker response:', responseData);
                
                if (responseData.message !== 'Success') {
                    throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
                }
                
                // Store the response
                window.quizFormPersistence.saveResponseData(responseData);
                
                // Dispatch an event to notify dataout.js that a response was received
                const event = new CustomEvent('api-response-received', {
                    detail: {
                        module: 'quiziq',
                        type: 'worker-response',
                        timestamp: Date.now()
                    }
                });
                document.dispatchEvent(event);
                console.log('[QuizIQ] Dispatched api-response-received event');
                
                return responseData;
            }
        );
        
        // Increment request count after successful response
        incrementRequestCount('quiz');
        
        // Enhanced loading either returns result or throws error - no need to check result.success
        console.log('[QuizIQ] Quiz generated successfully');
    }

    // Initialization
    document.addEventListener('grid-item-toggled', handleGridItemToggled);
    document.getElementById('generate-quiz-btn').addEventListener('click', handleGenerateQuizIq);

    // Guided forms integration
    if (typeof GuidedForms !== 'undefined' && GuidedForms.quiziq) {
        new GuidedForms.quiziq();
    }
})();
</script>
</div> <!-- Close mobile-container -->
