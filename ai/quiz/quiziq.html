<!--
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
-->

<div class="device-container" id="quiziq-device-container">

<div class="row1 product-description-container">
    <h2 class="product-description-heading">QuizIQ™</h2>
    <p class="product-description-text">
        QuizIQ™ is a learning quiz tool that helps you organize learning topics and quiz preferences for educational purposes. By specifying your subject and requirements, you'll help our system create queries for third-party AI providers to generate educational quiz content and learning materials. This content is designed to support your learning journey and help you prepare better questions for consultations with qualified educators.
    </p>
    <p class="product-description-final">
        Ready to create learning quizzes!
    </p>
    <p class="product-description-disclaimer">
        <em>This is a learning tool only. All content is generated by third-party AI systems and is for educational and informational purposes. This is not professional educational assessment or curriculum design. AI can make mistakes and generate inaccurate information. For formal education or testing, consult qualified educators, curriculum specialists, or educational assessment professionals.</em>
    </p>
</div>

        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Specify the main topic or subject area for your quiz questions.">
                Quiz Subject<span class="tooltip1-content"></span>
            </h3>
            <textarea id="subject" rows="2" placeholder="World War II
Python Programming"></textarea>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Choose the purpose for your quiz to get appropriately structured questions.">
                Quiz Objective<span class="tooltip1-content"></span>
            </h3>
            <select id="objective">
                <option value="" disabled selected>Select Quiz Objective</option>
                <option value="self-study">Self-Study</option>
                <option value="classroom-assessment">Classroom Assessment</option>
                <option value="exam-practice">Exam Practice</option>
                <option value="knowledge-review">Knowledge Review</option>
                <option value="certification-prep">Certification Prep</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Select the complexity level for your quiz questions.">
                Difficulty Level<span class="tooltip1-content"></span>
            </h3>
            <select id="difficulty-tier">
                <option value="" disabled selected>Select Difficulty Level</option>
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
            </select>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Choose the types of questions you want in your quiz.">
                Question Formats<span class="tooltip1-content"></span>
            </h3>
            <div class="grid-container" id="formats">
                <div class="grid-item" data-value="multiple-choice">Multiple Choice</div>
                <div class="grid-item" data-value="true-false">True/False</div>
            </div>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Specify how many questions you want in your quiz.">
                Question Count<span class="tooltip1-content"></span>
            </h3>
            <select id="question-count">
                <option value="" disabled selected>Select Question Count</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="20">20</option>
                <option value="25">25</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Specify particular areas or subtopics within your subject to focus the questions on.">
                Focus Areas<span class="tooltip1-content"></span>
            </h3>
            <textarea id="focus-areas" rows="2" placeholder="Causes of WWI
Key Battles"></textarea>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Identify who will be taking this quiz to tailor the language and difficulty appropriately.">
                Target Participants<span class="tooltip1-content"></span>
            </h3>
            <div class="grid-container" id="participants">
                <div class="grid-item" data-value="students">Students</div>
                <div class="grid-item" data-value="professionals">Professionals</div>
                <div class="grid-item" data-value="enthusiasts">Enthusiasts</div>
                <div class="grid-item" data-value="general-learners">General Learners</div>
                <div class="grid-item" data-value="kids">Kids</div>
                <div class="grid-item" data-value="certification-trainees">Certification Trainees</div>
                <div class="grid-item" data-value="other">Other</div>
            </div>
            
            <button class="generate-btn" id="generate-quiz-btn">Generate Analysis</button>
        </div>

<script type="module">
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

// Rate limiting utilities are now available globally via window.rateLimiter

(function() {
    // Initialize FormPersistence for quiziq module
    const fields = [
        { id: 'quiz-subject', type: 'textarea' },
        { id: 'quiz-objective', type: 'dropdown' },
        { id: 'quiz-difficulty-tier', type: 'dropdown' },
        { id: 'quiz-formats', type: 'grid' },
        { id: 'quiz-question-count', type: 'dropdown' },
        { id: 'quiz-focus-areas', type: 'textarea' },
        { id: 'quiz-participants', type: 'grid' }
    ];

    // FormPersistence will be initialized by datain.js as window.quizFormPersistence
    // No need to create a new instance here

    // Listen for grid-item-toggled event from datain.js
    function handleGridItemToggled(event) {
        // UI behavior only - persistence handled centrally
    }

    // Handle the generate button click
    async function handleGenerateQuizIq() {
        
        const formData = window.quizFormPersistence.getSavedFormData();
        if (!formData) {
            console.error('[QuizIQ] No input data found in localStorage.');
            alert('Please complete the form before generating a quiz.');
            return;
        }

        // Check rate limiting before proceeding
        if (window.rateLimiter.isRateLimited('quiz', 15, 60 * 60 * 1000)) { // 15 requests per hour (as per rate-limiter config)
            alert('You have exceeded the request limit for quiz generation. Please try again later.');
            return;
        }

        // Create worker payload with email for paid users (DRY function)
        const workerPayload = window.rateLimiter.createWorkerPayload('quiz', formData);
         const dataContainer = document.querySelector('.device-container') || document.body;
        let backendResponse = null;
        
        try {
            const result = await window.enhancedLoading(
                'generate-quiz-btn',
                'quiz',
                async () => {
                    // Send data to worker
                    const apiUrl = 'https://inexasli.com/api/generate';
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(workerPayload)
                    });
                    
                    let responseData;
                    try {
                        responseData = await response.json();
                    } catch (e) {
                        responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
                    }
                    
                    // Store backend response for error handling
                    backendResponse = responseData;
                    
                    // Always call handleRateLimitResponse with backend response
                    window.rateLimiter.handleRateLimitResponse(dataContainer, responseData, !response.ok, 'QuizIQ');
                    
                    if (!response.ok) {
                        throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
                    }
                    
                    if (responseData.message !== 'Success') {
                        throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
                    }
                    
                    // Store the response
                    window.quizFormPersistence.saveResponseData(responseData);
                    
                    // Dispatch an event to notify dataout.js that a response was received
                    const event = new CustomEvent('api-response-received', {
                        detail: {
                            module: 'quiziq',
                            type: 'worker-response',
                            timestamp: Date.now()
                        }
                    });
                    document.dispatchEvent(event);
                    
                    return responseData;
                }
            );
            
            // Increment request count after successful response
            window.rateLimiter.incrementRequestCount('quiz');
            
            // Enhanced loading either returns result or throws error - no need to check result.success
        } catch (error) {
            // If backendResponse is available, update rate limit display and show error
            if (backendResponse && dataContainer) {
                window.rateLimiter.handleRateLimitResponse(dataContainer, backendResponse, true, 'QuizIQ');
            }
            // Optionally, show a toast/modal here for generic errors
            console.error('[QuizIQ] Error:', error);
        }
    }

    // Initialization - simplified to match calorie module pattern
    const generateQuizBtn = document.getElementById('generate-quiz-btn');
    if (generateQuizBtn) {
        generateQuizBtn.addEventListener('click', handleGenerateQuizIq);
        // Set flag to prevent duplicate handler attachment
        generateQuizBtn.dataset.handlerAttached = 'true';
    }
})();
</script>
</div> <!-- Close mobile-container -->
