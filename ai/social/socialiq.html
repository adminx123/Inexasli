<!--
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
-->

<script src="../../payment/paymentform.js"></script>

<div class="device-container">

<div class="row1 product-description-container">
    <h2 class="product-description-heading">Craft Engaging Social Media Content, Faster!</h2>
    <p class="product-description-text">
        Struggling to come up with fresh ideas for your social media posts? SocialIQâ„¢ is here to help! By understanding your topic, target audience, and desired tone through a few simple questions, our AI can generate creative post ideas, captions, and content suggestions. This helps you save time, boost engagement, and maintain a vibrant online presence.
    </p>
    <p class="product-description-final">
        Let's create some buzz!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a professional.</em>
    </p>
</div>

<div class="premium-blur">

        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Choose whether this social situation occurred in your workplace or personal life.">
                Incident Area<span class="tooltip1-content"></span>
            </h3>
            <div class="grid-container" id="area-goal">
                <div class="grid-item" data-value="Workplace">Workplace</div>
                <div class="grid-item" data-value="Personal Life">Personal Life</div>
            </div>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Select what you want to understand or achieve from analyzing this social situation.">
                Analysis Goals<span class="tooltip1-content"></span>
            </h3>
            <div class="grid-container" id="incident-goal">
                <div class="grid-item" data-value="Root Cause Identification">Root Cause Identification</div>
                <div class="grid-item" data-value="Impact Evaluation">Impact Evaluation</div>
                <div class="grid-item" data-value="Preventing Recurrence">Preventing Recurrence</div>
                <div class="grid-item" data-value="Improving Response Time">Improving Response Time</div>
                <div class="grid-item" data-value="Enhancing Decision Making">Enhancing Decision Making</div>
                <div class="grid-item" data-value="Optimizing Resources">Optimizing Resources</div>
                <div class="grid-item" data-value="Accountability">Accountability</div>
                <div class="grid-item" data-value="Identifying Gaps in Process">Identifying Gaps in Process</div>
                <div class="grid-item" data-value="Effective Communication">Effective Communication</div>
                <div class="grid-item" data-value="Continuous Improvement">Continuous Improvement</div>
            </div>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Describe the social situation or incident in detail to help our AI understand the context.">
                Incident Details<span class="tooltip1-content"></span>
            </h3>
            <textarea id="incident-details" rows="4" placeholder="I argued with a coworker over a missed deadline
They said it was my fault
It was hard for me to accept any responsibility given their tone
The meeting ended with no resolution"></textarea>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Identify the most significant moments or turning points during the interaction.">
                Key Moments<span class="tooltip1-content"></span>
            </h3>
            <textarea id="incident-moments" rows="3" placeholder="They raised their voice
They smiled unexpectedly
My manager walked in during the argument"></textarea>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Share your immediate thoughts and concerns about the situation.">
                Initial Thoughts<span class="tooltip1-content"></span>
            </h3>
            <textarea id="incident-thoughts" rows="3" placeholder="Am I going to lose my job
Was I too harsh
Should I apologize first"></textarea>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Select personality traits that might have influenced your behavior in this situation.">
                My Personality Traits<span class="tooltip1-content"></span>
            </h3>
            <div class="grid-container" id="incident-warnings">
                <div class="grid-item" data-value="anti-social">I'm Anti-Social</div>
                <div class="grid-item" data-value="manipulative">I'm Manipulative</div>
                <div class="grid-item" data-value="naive">I'm Naive</div>
                <div class="grid-item" data-value="passive">I'm Passive</div>
                <div class="grid-item" data-value="aggressive">I'm Aggressive</div>
                <div class="grid-item" data-value="overly-emotional">I'm Overly Emotional</div>
                <div class="grid-item" data-value="impulsive">I'm Impulsive</div>
                <div class="grid-item" data-value="insecure">I'm Insecure</div>
                <div class="grid-item" data-value="stubborn">I'm Stubborn</div>
                <div class="grid-item" data-value="pessimistic">I'm Pessimistic</div>
                <div class="grid-item" data-value="jealous">I'm Jealous</div>
                <div class="grid-item" data-value="disorganized">I'm Disorganized</div>
                <div class="grid-item" data-value="procrastinator">I'm a Procrastinator</div>
                <div class="grid-item" data-value="self-centered">I'm Self-Centered</div>
            </div>
        </div>
        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Describe how you perceived the emotional state and tone of the other people involved.">
                Perceived Mood/Tone of Others<span class="tooltip1-content"></span>
            </h3>
            <div class="grid-container" id="incident-mood">
                <div class="grid-item" data-value="Anger">They Seemed Angry</div>
                <div class="grid-item" data-value="Sad">They Seemed Sad</div>
                <div class="grid-item" data-value="Honest">They Seemed Honest</div>
                <div class="grid-item" data-value="Indirect">They Seemed Indirect</div>
                <div class="grid-item" data-value="Manipulative">They Seemed Manipulative</div>
                <div class="grid-item" data-value="Indifferent">They Seemed Indifferent</div>
                <div class="grid-item" data-value="Cautious">They Seemed Cautious</div>
                <div class="grid-item" data-value="Surprised">They Seemed Surprised</div>
                <div class="grid-item" data-value="Confused">They Seemed Confused</div>
                <div class="grid-item" data-value="Annoyed">They Seemed Annoyed</div>
                <div class="grid-item" data-value="Relieved">They Seemed Relieved</div>
                <div class="grid-item" data-value="Excited">They Seemed Excited</div>
                <div class="grid-item" data-value="Frustrated">They Seemed Frustrated</div>
                <div class="grid-item" data-value="Calm">They Seemed Calm</div>
            </div>
     
            <button class="generate-btn" id="generate-social-btn">Generate Social Analysis Now!</button>
        </div>

<script type="module">
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

// Import fingerprint utilities
import { getFingerprintForWorker, incrementRequestCount, isRateLimited } from '/utility/rateLimiter.js';

(function() {
    console.log("SocialIQ script initializing");

    // Initialize FormPersistence for socialiq module
    const fields = [
        { id: 'area-goal', type: 'grid' },
        { id: 'incident-goal', type: 'grid' },
        { id: 'incident-details', type: 'textarea' },
        { id: 'incident-moments', type: 'textarea' },
        { id: 'incident-thoughts', type: 'textarea' },
        { id: 'incident-warnings', type: 'grid' },
        { id: 'incident-mood', type: 'grid' }
    ];

    // FormPersistence will be initialized by datain.js as window.socialFormPersistence
    // No need to create a new instance here

    // Listen for grid-item-toggled event from datain.js
    function handleGridItemToggled(event) {
        console.log('[SocialIQ] Grid item toggled event received');
        const item = event.detail.item;
        const container = item.closest('.grid-container');
        
        // Single selection for area-goal, multiple selection for others
        if (container.id === 'area-goal') {
            // Ensure only one item is selected in this container
            container.querySelectorAll('.grid-item').forEach(i => {
                if (i !== item) i.classList.remove('selected');
            });
        }
        
        console.log(`[SocialIQ] Handled toggle for ${item.dataset.value} in ${container.id}: ${item.classList.contains('selected') ? 'selected' : 'deselected'}`);
    }

    // Handle the generate button click
    async function handleGenerateSocialIq() {
        console.log('[SocialIQ] Generate button clicked.');
        
        const formData = window.socialFormPersistence.getSavedFormData();
        if (!formData) {
            console.error('[SocialIQ] No input data found in localStorage.');
            alert('Please complete the form before generating a social analysis.');
            return;
        }

        // Check rate limiting before proceeding
        if (isRateLimited('social', 10, 60 * 60 * 1000)) { // 10 requests per hour (as per rate-limiter config)
            alert('You have exceeded the request limit for social analysis. Please try again later.');
            return;
        }

        // Get fingerprint data for rate limiting
        const fingerprintData = getFingerprintForWorker();
        
        // Create combined payload with both form data and fingerprint
        const workerPayload = {
            module: 'social',
            formData: formData,
            fingerprint: fingerprintData
        };
        
        const result = await window.enhancedLoading(
            'generate-social-btn',
            'social',
            async () => {
                // Send data to worker
                const apiUrl = 'https://master.4hm7q4q75z.workers.dev/'; // Per x.txt: use master worker endpoint
                
                console.log('[SocialIQ] Sending socialIqInput to worker');
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(workerPayload) // Use consistent payload structure
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const responseData = await response.json();
                console.log('[SocialIQ] Worker response:', responseData);
                
                if (responseData.message !== 'Success') {
                    throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
                }
                
                // Store the response
                window.socialFormPersistence.saveResponseData(responseData);
                
                // Dispatch an event to notify dataout.js that a response was received
                const event = new CustomEvent('api-response-received', {
                    detail: {
                        module: 'socialiq',
                        type: 'worker-response',
                        timestamp: Date.now()
                    }
                });
                document.dispatchEvent(event);
                console.log('[SocialIQ] Dispatched api-response-received event');
                
                return responseData;
            }
        );
        
        // Increment request count after successful response
        incrementRequestCount('social');
        
        // Enhanced loading either returns result or throws error - no need to check result.success
        console.log('[SocialIQ] Social analysis generated successfully');
    }

    // Initialization
    document.addEventListener('grid-item-toggled', handleGridItemToggled);
    document.getElementById('generate-social-btn').addEventListener('click', handleGenerateSocialIq);

    // Guided forms integration
    if (typeof GuidedForms !== 'undefined' && GuidedForms.socialiq) {
        new GuidedForms.socialiq();
    }
})();
</script>
</div>
</div> <!-- Close mobile-container -->
