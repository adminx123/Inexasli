<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calorie API Output</title>
  
  <!-- Preconnect and font links -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles/outputstyles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Using device-container, output-wrapper and api-output styles from outputstyles.css */
    
    .calorie-display {
      font-family: "Inter", sans-serif;
      font-size: 16px;
      line-height: 1.6;
      white-space: normal;
    }
    
    .calorie-header {
      text-align: center;
      margin-bottom: 25px;
    }
    
    .bmi-section {
      background: white;
      color: #4a7c59;
      border: 1px solid #4a7c59;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
    }
    
    .nutrients-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .nutrient-card {
      background: #f2f9f3;
      border: 1px solid #4a7c59;
      border-radius: 5px;
      padding: 15px;
    }
    
    .nutrient-card:hover {
      background-color: #eef7f0;
    }
    
    .nutrient-name {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin-bottom: 8px;
    }
    
    .nutrient-progress {
      background: #e9ecef;
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .nutrient-progress-bar {
      height: 100%;
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    
    .nutrient-details {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #666;
    }
    
    .percentage-good { background: #7a9b8a; }
    .percentage-warning { background: #b8956d; }
    .percentage-low { background: #a67c7c; }
    
    .meals-section {
      margin-top: 25px;
    }
    
    .meal-card {
      background: #f2f9f3;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: 1px solid #4a7c59;
    }
    
    .meal-card:hover {
      background-color: #eef7f0;
    }
    
    
    .meal-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 16px;
      color: #2d5a3d;
    }
    
    .meal-content {
      color: #555;
      line-height: 1.6;
    }
   
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- include centralized copy utility -->
  <script src="../../utility/copy.js"></script>
  <script src="../../utility/enhancedUI.js"></script>
</head>
<body>
  <!-- Main content container with ID for accessibility -->
  <div id="main-content" class="device-container calorie-container">
    <div class="output-wrapper">
      <div id="output-span" class="api-output"></div>
    </div>
  </div>

  <script>
    (function() {
      console.log('Calorie API Output script running');
      
      // Reference the global utility functions
      const getLocal = window.getLocal || function(key) {
        try {
          const value = localStorage.getItem(key);
          return value ? decodeURIComponent(value) : null;
        } catch (e) {
          console.error('Error getting local value:', e);
          return null;
        }
      };

      const getJSON = window.getJSON || function(key) {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : null;
        } catch (e) {
          console.error('Error parsing JSON:', e);
          return null;
        }
      };

      // Try to get span element - might be delayed
      function updateOutput() {
        const outputSpan = document.getElementById('output-span');
        if (!outputSpan) {
          console.log('Output span not found, will retry');
          setTimeout(updateOutput, 100);
          return;
        }

        // Specifically look for calorieIqResponse data
        const responseKey = 'calorieIqResponse';
        console.log('Looking for data with key:', responseKey);
        
        // Try several approaches to get the data
        let data;
        try {
          data = getJSON(responseKey);
          if (!data) {
            // Fallback to direct localStorage access
            const rawData = localStorage.getItem(responseKey);
            if (rawData) {
              data = JSON.parse(rawData);
              console.log('Retrieved data directly from localStorage');
            }
          }
          
          // Handle nested response format if present
          if (data && data.message === 'Success' && data.data) {
            console.log('Found nested data structure, using the data property');
            data = data.data;
          }
        } catch (err) {
          console.error('Error getting data:', err);
        }
        
        if (data) {
          // Check if we have individual foods (new API format) or calorieAnalysis (legacy format)
          if (data.individualFoods || data.bmi || data.calorieAnalysis) {
            try {
              // Use data directly if it has the right structure, otherwise use calorieAnalysis
              let calorieAnalysis = data.individualFoods || data.bmi ? data : data.calorieAnalysis;
              
              // Handle both old (string) and new (object) formats for backward compatibility
              if (typeof calorieAnalysis === 'string') {
                console.log('Legacy format detected - parsing JSON string');
                console.log('Raw calorieAnalysis string length:', calorieAnalysis.length);
                console.log('Raw calorieAnalysis string (first 500 chars):', calorieAnalysis.substring(0, 500));
                
                // Check if the string appears to be truncated
                if (!calorieAnalysis.endsWith('}')) {
                  console.warn('JSON appears to be truncated - attempting to fix...');
                  
                  // Try to find the last complete object and truncate there
                  let lastCompleteObject = calorieAnalysis.lastIndexOf('}}');
                  if (lastCompleteObject > 0) {
                    calorieAnalysis = calorieAnalysis.substring(0, lastCompleteObject + 2);
                    console.log('Truncated to last complete object');
                  } else {
                    // If that doesn't work, try to close with a basic structure
                    if (calorieAnalysis.includes('"individualFoods"')) {
                      calorieAnalysis = calorieAnalysis.split('"individualFoods"')[0] + '"individualFoods": []}';
                    } else if (calorieAnalysis.includes('"mealTotals"')) {
                      calorieAnalysis = calorieAnalysis.split('"mealTotals"')[0] + '"mealTotals": []}';
                    } else {
                      calorieAnalysis += '}';
                    }
                    console.log('Applied basic JSON closure');
                  }
                }
                
                calorieAnalysis = JSON.parse(calorieAnalysis);
              } else if (typeof calorieAnalysis === 'object' && calorieAnalysis !== null) {
                console.log('New format detected - using parsed object directly');
              } else {
                throw new Error('Invalid calorieAnalysis format - expected object or JSON string');
              }
              
              console.log('Final calorie analysis object:', calorieAnalysis);
              displayEnhancedCalorieAnalysis(calorieAnalysis, outputSpan);
              
            } catch (parseError) {
              console.error('Error processing calorieAnalysis:', parseError);
              
              // Enhanced error display with better diagnostics
              const isString = typeof data.calorieAnalysis === 'string';
              const dataPreview = isString ? 
                data.calorieAnalysis.substring(0, 500) : 
                JSON.stringify(data.calorieAnalysis, null, 2).substring(0, 500);
              
              outputSpan.innerHTML = `<div style="color: red; padding: 20px;">
                <h3>Error processing nutrition data:</h3>
                <p><strong>Error:</strong> ${parseError.message}</p>
                <h4>Data Type:</h4>
                <p>${typeof data.calorieAnalysis} ${isString ? `(${data.calorieAnalysis.length} characters)` : ''}</p>
                <h4>Data Preview (first 500 characters):</h4>
                <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 200px;">${dataPreview}</pre>
                ${isString ? `<h4>Last 200 characters:</h4>
                <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 200px;">${data.calorieAnalysis.substring(data.calorieAnalysis.length - 200)}</pre>` : ''}
                <p style="margin-top: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                  <strong>ðŸ’¡ Status:</strong> The worker now returns parsed objects instead of JSON strings. 
                  ${isString ? 'This appears to be an old format response.' : 'This should be a parsed object but processing failed.'}
                </p>
              </div>`;
            }
          } else if (typeof data === 'object' && data !== null) {
            // Use pretty formatting for other complex objects
            outputSpan.textContent = JSON.stringify(data, null, 2);
          } else {
            outputSpan.textContent = data;
          }
          console.log('Data displayed successfully');
        } else {
          outputSpan.innerHTML = '';
          console.log('No data found for key:', responseKey);
        }
      }
      
      // Start the update process
      updateOutput();
      // Initialize copy button as image download
      copyUtil.init({ containerId: 'output-span', mode: 'image' });
      
      // Initialize enhanced UI system
      function initEnhancedUISystem() {
        // Wait a bit to ensure DOM and containers are ready
        setTimeout(() => {
          // Initialize the enhanced UI with embed detection
          if (window.enhancedUI) {
            window.enhancedUI.init({
              containerId: 'output-span',
              scrollToTop: true,
              embedEnforcement: true,
              accessibility: true
            });
          } else {
            console.warn('Enhanced UI system not loaded');
          }
        }, 100);
      }
      
      // Initialize enhanced UI system after content loads
      initEnhancedUISystem();
    })();

    function displayCalorieAnalysis(calorieData, outputElement) {
      outputElement.innerHTML = '';
      outputElement.classList.add('calorie-display');
      
      const container = document.createElement('div');
      
      // Header
      const header = document.createElement('div');
      header.className = 'calorie-header';
      header.innerHTML = '<h2 style="margin: 0; color: #333;">Nutrition Analysis</h2>';
      container.appendChild(header);
      
      // BMI Section
      if (calorieData.bmi) {
        const bmiSection = document.createElement('div');
        bmiSection.className = 'bmi-section';
        bmiSection.innerHTML = `Your BMI: ${calorieData.bmi}`;
        container.appendChild(bmiSection);
      }
      
      // Nutrients Grid
      if (calorieData.nutrients) {
        const nutrientsGrid = document.createElement('div');
        nutrientsGrid.className = 'nutrients-grid';
        
        calorieData.nutrients.forEach(nutrient => {
          const card = document.createElement('div');
          card.className = 'nutrient-card';
          
          const percentage = parseInt(nutrient.percentage);
          let progressClass = 'percentage-good';
          if (percentage < 85) progressClass = 'percentage-warning';
          if (percentage < 70) progressClass = 'percentage-low';
          
          card.innerHTML = `
            <div class="nutrient-name">${nutrient.name}</div>
            <div class="nutrient-progress">
              <div class="nutrient-progress-bar ${progressClass}" style="width: ${percentage}%"></div>
            </div>
            <div class="nutrient-details">
              <span>${nutrient.intake} / ${nutrient.target}</span>
              <span style="font-weight: bold; color: #000">${nutrient.percentage}</span>
            </div>
          `;
          
          nutrientsGrid.appendChild(card);
        });
        
        container.appendChild(nutrientsGrid);
      }
      
      // Deficit-Filling Recommendations
      const mealsSection = document.createElement('div');
      mealsSection.className = 'meals-section';
      mealsSection.innerHTML = '<h3 style="color: #333; margin-bottom: 15px;">Deficit-Filling Recommendations</h3>';
      
      if (calorieData.mealRecommendations1) {
        const meal1 = document.createElement('div');
        meal1.className = 'meal-card';
        meal1.innerHTML = `
          <div class="meal-title">Priority Deficit Foods</div>
          <div class="meal-content">${calorieData.mealRecommendations1}</div>
        `;
        mealsSection.appendChild(meal1);
      }
      
      if (calorieData.mealRecommendations2) {
        const meal2 = document.createElement('div');
        meal2.className = 'meal-card';
        meal2.innerHTML = `
          <div class="meal-title">Secondary Nutrient Needs</div>
          <div class="meal-content">${calorieData.mealRecommendations2}</div>
        `;
        mealsSection.appendChild(meal2);
      }
      
      if (calorieData.mealRecommendations3) {
        const meal3 = document.createElement('div');
        meal3.className = 'meal-card';
        meal3.innerHTML = `
          <div class="meal-title">Complete Your Daily Goals</div>
          <div class="meal-content">${calorieData.mealRecommendations3}</div>
        `;
        mealsSection.appendChild(meal3);
      }
      
      container.appendChild(mealsSection);
      outputElement.appendChild(container);
    }
    
    function displayEnhancedCalorieAnalysis(calorieData, outputElement) {
      outputElement.innerHTML = '';
      outputElement.classList.add('calorie-display');
      
      const container = document.createElement('div');
      
      // Header
      const header = document.createElement('div');
      header.className = 'calorie-header';
      
      // Add summary of processed foods if available
      let summaryText = '';
      if (calorieData.individualFoods && Array.isArray(calorieData.individualFoods)) {
        const totalFoods = calorieData.individualFoods.length;
        const mealsWithFood = [...new Set(calorieData.individualFoods.map(f => f.mealType))].length;
        summaryText = `<div style="color: #666; font-size: 14px; margin-top: 10px;">
          AI processed ${totalFoods} food items across ${mealsWithFood} meal categories
        </div>`;
      }
      
      header.innerHTML = `
        <h2 style="margin: 0; color: #333; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-brain" style="margin-right: 12px; color: #7a9b8a;"></i>
          CalorieIQ AI Analysis
        </h2>
        <div style="background: #4a7c59; color: white; padding: 15px; border-radius: 5px; border: 1px solid #4a7c59; margin: 15px 0 20px 0;">
          <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
            <i class="fas fa-calculator" style="margin-right: 8px; color: #f5f5dc;"></i>
            <strong>Consistent Nutrition Analysis</strong>
          </div>
          <div style="margin: 0; font-size: 14px; line-height: 1.5;">
            AI-powered food analysis with mathematically consistent totals:
            <div style="margin-top: 8px;">
              <strong><i class="fas fa-chart-pie" style="margin-right: 6px; color: #f5f5dc;"></i>daily totals</strong> calculated by summing individual foods
            </div>
            <div>
              <strong><i class="fas fa-utensils" style="margin-right: 6px; color: #f5f5dc;"></i>meal totals</strong> calculated by summing foods within each meal
            </div>
            <div>
              <strong><i class="fas fa-brain" style="margin-right: 6px; color: #f5f5dc;"></i>individual foods</strong> analyzed by AI for nutritional content
            </div>
          </div>
        </div>
        ${summaryText}
      `;
      container.appendChild(header);
      
      // BMI Section
      if (calorieData.bmi) {
        const bmiSection = document.createElement('div');
        bmiSection.className = 'bmi-section';
        bmiSection.innerHTML = `<i class="fas fa-weight"></i> Your BMI: ${calorieData.bmi}`;
        container.appendChild(bmiSection);
      }
      
      // Daily Totals Section (Calculated from individual foods for accuracy)
      if (calorieData.individualFoods && Array.isArray(calorieData.individualFoods)) {
        const dailySection = document.createElement('div');
        dailySection.innerHTML = '<h3 style="color: #333; margin: 20px 0 15px 0; display: flex; align-items: center;"><i class="fas fa-chart-pie" style="margin-right: 10px; color: #7a9b8a;"></i>Daily Nutrition Summary</h3>';
        
        // Calculate total daily nutrition from individual foods
        let totalCalories = 0;
        let totalProtein = 0;
        let totalCarbs = 0;
        let totalFat = 0;
        
        calorieData.individualFoods.forEach(food => {
          const calories = parseFloat(String(food.calories || food.caloriesPerServing || food.cal || '0').replace(/[^\d.]/g, '')) || 0;
          const protein = parseFloat(String(food.protein || food.proteinPerServing || '0').replace(/[^\d.]/g, '')) || 0;
          const carbs = parseFloat(String(food.carbs || food.carbsPerServing || food.carbohydrates || '0').replace(/[^\d.]/g, '')) || 0;
          const fat = parseFloat(String(food.fat || food.fatPerServing || '0').replace(/[^\d.]/g, '')) || 0;
          
          totalCalories += calories;
          totalProtein += protein;
          totalCarbs += carbs;
          totalFat += fat;
        });
        
        // Create calculated daily totals with approximate targets (these could be enhanced with user-specific targets)
        const calculatedDailyTotals = [
          {
            name: "Calories",
            target: "2000 kcal",
            intake: `${Math.round(totalCalories)} kcal`,
            percentage: `${Math.round((totalCalories / 2000) * 100)}%`,
            calculated: true
          },
          {
            name: "Protein", 
            target: "150g",
            intake: `${Math.round(totalProtein * 10) / 10}g`,
            percentage: `${Math.round((totalProtein / 150) * 100)}%`,
            calculated: true
          },
          {
            name: "Carbohydrates",
            target: "225g", 
            intake: `${Math.round(totalCarbs * 10) / 10}g`,
            percentage: `${Math.round((totalCarbs / 225) * 100)}%`,
            calculated: true
          },
          {
            name: "Fat",
            target: "65g",
            intake: `${Math.round(totalFat * 10) / 10}g`, 
            percentage: `${Math.round((totalFat / 65) * 100)}%`,
            calculated: true
          }
        ];
        
        const nutrientsGrid = document.createElement('div');
        nutrientsGrid.className = 'nutrients-grid';
        
        calculatedDailyTotals.forEach(nutrient => {
          const card = document.createElement('div');
          card.className = 'nutrient-card';
          
          const percentage = parseInt(nutrient.percentage);
          let progressClass = 'percentage-good';
          if (percentage < 85) progressClass = 'percentage-warning';
          if (percentage < 70) progressClass = 'percentage-low';
          
          card.innerHTML = `
            <div class="nutrient-name">${nutrient.name}</div>
            <div class="nutrient-progress">
              <div class="nutrient-progress-bar ${progressClass}" style="width: ${Math.min(percentage, 100)}%"></div>
            </div>
            <div class="nutrient-details">
              <span>${nutrient.intake} / ${nutrient.target}</span>
              <span style="font-weight: bold; color: #000">${nutrient.percentage}</span>
            </div>
          `;
          
          nutrientsGrid.appendChild(card);
        });
        
        dailySection.appendChild(nutrientsGrid);
        container.appendChild(dailySection);
      } else if (calorieData.dailyTotals && Array.isArray(calorieData.dailyTotals)) {
        // Fallback to AI daily totals if no individual foods available
        const dailySection = document.createElement('div');
        dailySection.innerHTML = '<h3 style="color: #333; margin: 20px 0 15px 0; display: flex; align-items: center;"><i class="fas fa-chart-pie" style="margin-right: 10px; color: #7a9b8a;"></i>Daily Nutrition Summary (AI)</h3>';
        
        const nutrientsGrid = document.createElement('div');
        nutrientsGrid.className = 'nutrients-grid';
        
        calorieData.dailyTotals.forEach(nutrient => {
          const card = document.createElement('div');
          card.className = 'nutrient-card';
          
          const percentage = parseInt(nutrient.percentage);
          let progressClass = 'percentage-good';
          if (percentage < 85) progressClass = 'percentage-warning';
          if (percentage < 70) progressClass = 'percentage-low';
          
          card.innerHTML = `
            <div class="nutrient-name">${nutrient.name}</div>
            <div class="nutrient-progress">
              <div class="nutrient-progress-bar ${progressClass}" style="width: ${Math.min(percentage, 100)}%"></div>
            </div>
            <div class="nutrient-details">
              <span>${nutrient.intake} / ${nutrient.target}</span>
              <span style="font-weight: bold; color: #000">${nutrient.percentage}</span>
            </div>
          `;
          
          nutrientsGrid.appendChild(card);
        });
        
        dailySection.appendChild(nutrientsGrid);
        container.appendChild(dailySection);
      }
      
      // Meal Breakdown Section (Enhanced with frontend-calculated totals)
      if (calorieData.individualFoods && Array.isArray(calorieData.individualFoods)) {
        const mealSection = document.createElement('div');
        mealSection.innerHTML = '<h3 style="color: #333; margin: 25px 0 15px 0; display: flex; align-items: center;"><i class="fas fa-utensils" style="margin-right: 10px; color: #7a9b8a;"></i>Meal Breakdown &amp; Individual Foods</h3>';
        mealSection.innerHTML += '<p style="color: #666; font-size: 14px; margin-bottom: 20px;">Nutritional breakdown calculated from individual food contributions for maximum accuracy:</p>';
        
        // Group individual foods by meal type and calculate totals
        const foodsByMeal = {};
        const calculatedMealTotals = {};
        
        calorieData.individualFoods.forEach(food => {
          const mealType = food.mealType || 'Other';
          if (!foodsByMeal[mealType]) {
            foodsByMeal[mealType] = [];
            calculatedMealTotals[mealType] = {
              calories: 0,
              protein: 0,
              carbs: 0,
              fat: 0
            };
          }
          foodsByMeal[mealType].push(food);
          
          // Extract numeric values from individual foods and sum them
          const calories = parseFloat(String(food.calories || food.caloriesPerServing || food.cal || '0').replace(/[^\d.]/g, '')) || 0;
          const protein = parseFloat(String(food.protein || food.proteinPerServing || '0').replace(/[^\d.]/g, '')) || 0;
          const carbs = parseFloat(String(food.carbs || food.carbsPerServing || food.carbohydrates || '0').replace(/[^\d.]/g, '')) || 0;
          const fat = parseFloat(String(food.fat || food.fatPerServing || '0').replace(/[^\d.]/g, '')) || 0;
          
          calculatedMealTotals[mealType].calories += calories;
          calculatedMealTotals[mealType].protein += protein;
          calculatedMealTotals[mealType].carbs += carbs;
          calculatedMealTotals[mealType].fat += fat;
        });
        
        // Create meal cards from calculated totals instead of AI-provided totals
        Object.entries(calculatedMealTotals).forEach(([mealType, totals]) => {
          const mealCard = document.createElement('div');
          mealCard.className = 'meal-card';
          mealCard.style.marginBottom = '20px';
          
          const mealIcon = getMealIcon(mealType);
          
          // Get foods for this meal
          const mealFoods = foodsByMeal[mealType] || [];
          const foodCountText = mealFoods.length > 0 ? ` (${mealFoods.length} items)` : '';
          
          // Format calculated totals with proper units
          const formattedCalories = Math.round(totals.calories);
          const formattedProtein = Math.round(totals.protein * 10) / 10;
          const formattedCarbs = Math.round(totals.carbs * 10) / 10;
          const formattedFat = Math.round(totals.fat * 10) / 10;
          
          // Calculate what percentage of daily calorie goal this meal represents
          // First, calculate total daily calories from all foods to determine the user's actual intake goal
          let totalDailyCalories = 0;
          Object.values(calculatedMealTotals).forEach(meal => {
            totalDailyCalories += meal.calories;
          });
          
          // Use the total daily calories as the goal (what they're actually eating)
          // Or fall back to 2000 if very low intake
          const dailyGoal = Math.max(totalDailyCalories, 1200);
          const mealCaloriePercentage = Math.round((formattedCalories / dailyGoal) * 100);
          
          // Determine meal size category and color based on typical meal distribution
          let mealSizeLabel, badgeColor;
          if (mealCaloriePercentage < 15) {
            mealSizeLabel = `${mealCaloriePercentage}% of daily calorie goal`;
            badgeColor = '#b8956d'; // Muted warm brown
          } else if (mealCaloriePercentage < 25) {
            mealSizeLabel = `${mealCaloriePercentage}% of daily calorie goal`;
            badgeColor = '#7a9b8a'; // Muted sage green  
          } else if (mealCaloriePercentage < 40) {
            mealSizeLabel = `${mealCaloriePercentage}% of daily calorie goal`;
            badgeColor = '#7a9b8a'; // Muted sage green
          } else {
            mealSizeLabel = `${mealCaloriePercentage}% of daily calorie goal`;
            badgeColor = '#a67c7c'; // Muted rose for very large portions
          }
          
          mealCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div class="meal-title" style="display: flex; align-items: center; margin: 0;">
                ${mealIcon} ${mealType}${foodCountText}
              </div>
              <div style="background: ${badgeColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                ${mealSizeLabel}
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; font-size: 13px; background: #f2f9f3; padding: 8px; border-radius: 4px; margin-bottom: ${mealFoods.length > 0 ? '15px' : '0'};">
              <div style="text-align: center;"><strong>Calories</strong><br>${formattedCalories} kcal</div>
              <div style="text-align: center;"><strong>Protein</strong><br>${formattedProtein}g</div>
              <div style="text-align: center;"><strong>Carbs</strong><br>${formattedCarbs}g</div>
              <div style="text-align: center;"><strong>Fat</strong><br>${formattedFat}g</div>
            </div>
          `;
          
          // Add individual foods directly under this meal's totals (existing code preserved)
          if (mealFoods.length > 0) {
            const foodsContainer = document.createElement('div');
            foodsContainer.style.cssText = 'margin-top: 12px; padding-top: 12px; border-top: 1px solid #e9ecef;';
            
            const foodsHeader = document.createElement('div');
            foodsHeader.style.cssText = 'font-size: 12px; color: #666; margin-bottom: 8px; font-weight: 500; display: flex; align-items: center;';
            foodsHeader.innerHTML = '<i class="fas fa-brain" style="margin-right: 6px; color: #7a9b8a; font-size: 11px;"></i>Individual Foods:';
            foodsContainer.appendChild(foodsHeader);
            
            mealFoods.forEach((food, index) => {
              const foodItem = document.createElement('div');
              foodItem.style.cssText = 'background: white; border: 1px solid #e9ecef; border-radius: 4px; padding: 6px; margin-bottom: 6px; font-size: 11px;';
              
              // Handle different possible field names for nutritional values
              const calories = food.calories || food.caloriesPerServing || food.cal || 'â€”';
              const protein = food.protein || food.proteinPerServing || 'â€”';
              const carbs = food.carbs || food.carbsPerServing || food.carbohydrates || 'â€”';
              const fat = food.fat || food.fatPerServing || 'â€”';
              const quantity = food.quantity || food.servingSize || food.amount || '1 serving';
              
              foodItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                  <div style="flex: 1;">
                    <strong style="color: #333; font-size: 12px;">${food.foodItem || food.name || 'Unknown Food'}</strong>
                    <div style="color: #666; font-size: 10px; margin-top: 1px;">${quantity}</div>
                  </div>
                  <div style="background: #f8f9fa; padding: 1px 4px; border-radius: 2px; font-size: 9px; color: #666;">
                    #${index + 1}
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 3px; font-size: 10px; background: #f8f9fa; padding: 4px; border-radius: 2px;">
                  <div style="text-align: center;"><strong>Cal</strong><br>${calories}</div>
                  <div style="text-align: center;"><strong>Pro</strong><br>${protein}</div>
                  <div style="text-align: center;"><strong>Carb</strong><br>${carbs}</div>
                  <div style="text-align: center;"><strong>Fat</strong><br>${fat}</div>
                </div>
                ${food.notes ? `<div style="background: #e8f0ec; padding: 4px; border-radius: 2px; font-size: 10px; color: #4a6b52; line-height: 1.3; margin-top: 4px;">
                  <strong style="color: #7a9b8a;">AI:</strong> ${food.notes}
                </div>` : ''}
              `;
              
              foodsContainer.appendChild(foodItem);
            });
            
            mealCard.appendChild(foodsContainer);
          }
          
          mealSection.appendChild(mealCard);
        });
        
        container.appendChild(mealSection);
      }
      
      // Individual foods are now integrated directly under each meal's breakdown above
      // This eliminates the separate section and improves UX flow
      
      // Recommendations Section (Enhanced)
      const recommendationsSection = document.createElement('div');
      recommendationsSection.className = 'meals-section';
      recommendationsSection.innerHTML = '<h3 style="color: #333; margin: 25px 0 15px 0; display: flex; align-items: center;"><i class="fas fa-lightbulb" style="margin-right: 10px; color: #7a9b8a;"></i>Personalized Recommendations</h3>';
      
      if (calorieData.mealRecommendations1) {
        const rec1 = document.createElement('div');
        rec1.className = 'meal-card';
        rec1.innerHTML = `
          <div class="meal-title" style="color: #a67c7c;"><i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>Priority Nutritional Needs</div>
          <div class="meal-content">${calorieData.mealRecommendations1}</div>
        `;
        recommendationsSection.appendChild(rec1);
      }
      
      if (calorieData.mealRecommendations2) {
        const rec2 = document.createElement('div');
        rec2.className = 'meal-card';
        rec2.innerHTML = `
          <div class="meal-title" style="color: #b8956d;"><i class="fas fa-balance-scale" style="margin-right: 8px;"></i>Secondary Nutrient Goals</div>
          <div class="meal-content">${calorieData.mealRecommendations2}</div>
        `;
        recommendationsSection.appendChild(rec2);
      }
      
      if (calorieData.mealRecommendations3) {
        const rec3 = document.createElement('div');
        rec3.className = 'meal-card';
        rec3.innerHTML = `
          <div class="meal-title" style="color: #7a9b8a;"><i class="fas fa-check-circle" style="margin-right: 8px;"></i>Complete Your Daily Goals</div>
          <div class="meal-content">${calorieData.mealRecommendations3}</div>
        `;
        recommendationsSection.appendChild(rec3);
      }
      
      container.appendChild(recommendationsSection);
      
      // Legacy nutrients support (fallback)
      if (calorieData.nutrients && Array.isArray(calorieData.nutrients) && !calorieData.dailyTotals) {
        const legacyNutrientsGrid = document.createElement('div');
        legacyNutrientsGrid.className = 'nutrients-grid';
        
        calorieData.nutrients.forEach(nutrient => {
          const card = document.createElement('div');
          card.className = 'nutrient-card';
          
          const percentage = parseInt(nutrient.percentage);
          let progressClass = 'percentage-good';
          if (percentage < 85) progressClass = 'percentage-warning';
          if (percentage < 70) progressClass = 'percentage-low';
          
          card.innerHTML = `
            <div class="nutrient-name">${nutrient.name}</div>
            <div class="nutrient-progress">
              <div class="nutrient-progress-bar ${progressClass}" style="width: ${percentage}%"></div>
            </div>
            <div class="nutrient-details">
              <span>${nutrient.intake} / ${nutrient.target}</span>
              <span style="font-weight: bold; color: #000">${nutrient.percentage}</span>
            </div>
          `;
          
          legacyNutrientsGrid.appendChild(card);
        });
        
        container.appendChild(legacyNutrientsGrid);
      }
      
      outputElement.appendChild(container);
    }
    
    function getMealIcon(mealType) {
      const icons = {
        'Breakfast': '<i class="fas fa-coffee" style="margin-right: 8px; color: #7a9b8a;"></i>',
        'Lunch': '<i class="fas fa-sun" style="margin-right: 8px; color: #7a9b8a;"></i>',
        'Dinner': '<i class="fas fa-moon" style="margin-right: 8px; color: #7a9b8a;"></i>',
        'Snack': '<i class="fas fa-apple-alt" style="margin-right: 8px; color: #7a9b8a;"></i>',
        'Snacks': '<i class="fas fa-apple-alt" style="margin-right: 8px; color: #7a9b8a;"></i>'
      };
      return icons[mealType] || '<i class="fas fa-utensils" style="margin-right: 8px; color: #7a9b8a;"></i>';
    }

    // ...existing code...
  </script>
</body>
</html>

