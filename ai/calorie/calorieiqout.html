<table class="nutrition-table">
        <thead>
            <tr>
                <th>METRIC</th>
                <th>TARGET</th>
                <th>INTAKE</th>
                <th>%</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Calories</strong></td>
                <td><span id="calories-target"></span></td>
                <td><span id="calories-intake"></span></td>
                <td><span id="calories-percent"></span></td>
            </tr>
            <tr>
                <td><strong>Protein</strong></td>
                <td><span id="protein-target"></span></td>
                <td><span id="protein-intake"></span></td>
                <td><span id="protein-percent"></span></td>
            </tr>
            <tr>
                <td><strong>Carbohydrate</strong></td>
                <td><span id="carbs-target"></span></td>
                <td><span id="carbs-intake"></span></td>
                <td><span id="carbs-percent"></span></td>
            </tr>
            <tr>
                <td><strong>Fat</strong></td>
                <td><span id="fat-target"></span></td>
                <td><span id="fat-intake"></span></td>
                <td><span id="fat-percent"></span></td>
            </tr>
            <tr>
                <td><strong>Fiber</strong></td>
                <td><span id="fiber-target"></span></td>
                <td><span id="fiber-intake"></span></td>
                <td><span id="fiber-percent"></span></td>
            </tr>
            <tr>
                <td><strong>Vitamin D</strong></td>
                <td><span id="vitaminD-target"></span></td>
                <td><span id="vitaminD-intake"></span></td>
                <td><span id="vitaminD-percent"></span></td>
            </tr>
            <tr>
                <td><strong>Iron</strong></td>
                <td><span id="iron-target"></span></td>
                <td><span id="iron-intake"></span></td>
                <td><span id="iron-percent"></span></td>
            </tr>
            <tr>
                <td><strong>Calcium</strong></td>
                <td><span id="calcium-target"></span></td>
                <td><span id="calcium-intake"></span></td>
                <td><span id="calcium-percent"></span></td>
            </tr>
        </tbody>
    </table>

    <span id="meal-recommendation" style="max-width: 530px;display: inline-block;"></span>

    <span id="BMI">BMI</span>

    <script>
        console.log("calorieout script working")
        function waitForElement(selector) {
    let tries = 0;
    return new Promise((resolve, reject) => {
        const attempt = () => {
            const el = document.querySelector(selector);
            if (el) {
                resolve(el);
            } else {
                tries++;
                if (tries > 50) {
                    reject(new Error(`Element not found after waiting: ${selector}`));
                    return;
                }
                setTimeout(attempt, 100);
            }
        };
        attempt();
    });
}

async function findAllElements() {
    const entries = await Promise.all(
        Object.entries(spanSelectors2).map(async ([key, selector]) => {
            try {
                const element = await waitForElement(selector);
                return [key, element];
            } catch (error) {
                console.warn(`Element not found: ${selector}`);
                return [key, null];
            }
        })
    );

    const elements = Object.fromEntries(entries);
    return elements;
}

var spanSelectors2 = {
    caloriesTarget: '#calories-target',
    caloriesIntake: '#calories-intake',
    caloriesPercent: '#calories-percent',
    proteinTarget: '#protein-target',
    proteinIntake: '#protein-intake',
    proteinPercent: '#protein-percent',
    carbsTarget: '#carbs-target',
    carbsIntake: '#carbs-intake',
    carbsPercent: '#carbs-percent',
    fatTarget: '#fat-target',
    fatIntake: '#fat-intake',
    fatPercent: '#fat-percent',
    fiberTarget: '#fiber-target',
    fiberIntake: '#fiber-intake',
    fiberPercent: '#fiber-percent',
    vitaminDTarget: '#vitaminD-target',
    vitaminDIntake: '#vitaminD-intake',
    vitaminDPercent: '#vitaminD-percent',
    ironTarget: '#iron-target',
    ironIntake: '#iron-intake',
    ironPercent: '#iron-percent',
    calciumTarget: '#calcium-target',
    calciumIntake: '#calcium-intake',
    calciumPercent: '#calcium-percent',
    mealRecommendation: '#meal-recommendation',
    bmi: '#BMI'
};

async function populate() {
    console.log('Trying to load saved data');

    if (!localStorage.getItem('calorieIqResponse')) {
        console.log('No saved data found');
        return;
    }

    try {
        const rawData = localStorage.getItem('calorieIqResponse');
        console.log('Raw data retrieved:', rawData);
        
        // Parse the JSON response
        const data = JSON.parse(rawData);
        console.log('Parsed data:', data);

        // Check if we have the new format with nutritional_analysis text
        if (data?.data?.nutritional_analysis) {
            console.log('Found nutritional_analysis format, parsing...');
            const parsedAnalysis = parseNutritionalAnalysis(data.data.nutritional_analysis);
            console.log('Parsed analysis:', parsedAnalysis);
            
            const spans = await findAllElements();
            
            // Populate BMI
            if (spans.bmi && parsedAnalysis.bmi) {
                spans.bmi.innerText = "BMI: " + parsedAnalysis.bmi;
            }
            
            // Populate nutrition table
            if (parsedAnalysis.nutritionTable && parsedAnalysis.nutritionTable.length > 0) {
                const nutrients = parsedAnalysis.nutritionTable;
                
                // Calories
                if (spans.caloriesTarget && nutrients[0]) spans.caloriesTarget.innerText = nutrients[0].target;
                if (spans.caloriesIntake && nutrients[0]) spans.caloriesIntake.innerText = nutrients[0].intake;
                if (spans.caloriesPercent && nutrients[0]) spans.caloriesPercent.innerText = nutrients[0].percent;
                
                // Protein
                if (spans.proteinTarget && nutrients[1]) spans.proteinTarget.innerText = nutrients[1].target;
                if (spans.proteinIntake && nutrients[1]) spans.proteinIntake.innerText = nutrients[1].intake;
                if (spans.proteinPercent && nutrients[1]) spans.proteinPercent.innerText = nutrients[1].percent;
                
                // Carbs
                if (spans.carbsTarget && nutrients[2]) spans.carbsTarget.innerText = nutrients[2].target;
                if (spans.carbsIntake && nutrients[2]) spans.carbsIntake.innerText = nutrients[2].intake;
                if (spans.carbsPercent && nutrients[2]) spans.carbsPercent.innerText = nutrients[2].percent;
                
                // Fat
                if (spans.fatTarget && nutrients[3]) spans.fatTarget.innerText = nutrients[3].target;
                if (spans.fatIntake && nutrients[3]) spans.fatIntake.innerText = nutrients[3].intake;
                if (spans.fatPercent && nutrients[3]) spans.fatPercent.innerText = nutrients[3].percent;
                
                // Fiber
                if (spans.fiberTarget && nutrients[4]) spans.fiberTarget.innerText = nutrients[4].target;
                if (spans.fiberIntake && nutrients[4]) spans.fiberIntake.innerText = nutrients[4].intake;
                if (spans.fiberPercent && nutrients[4]) spans.fiberPercent.innerText = nutrients[4].percent;
                
                // Vitamin D
                if (spans.vitaminDTarget && nutrients[5]) spans.vitaminDTarget.innerText = nutrients[5].target;
                if (spans.vitaminDIntake && nutrients[5]) spans.vitaminDIntake.innerText = nutrients[5].intake;
                if (spans.vitaminDPercent && nutrients[5]) spans.vitaminDPercent.innerText = nutrients[5].percent;
                
                // Iron
                if (spans.ironTarget && nutrients[6]) spans.ironTarget.innerText = nutrients[6].target;
                if (spans.ironIntake && nutrients[6]) spans.ironIntake.innerText = nutrients[6].intake;
                if (spans.ironPercent && nutrients[6]) spans.ironPercent.innerText = nutrients[6].percent;
                
                // Calcium
                if (spans.calciumTarget && nutrients[7]) spans.calciumTarget.innerText = nutrients[7].target;
                if (spans.calciumIntake && nutrients[7]) spans.calciumIntake.innerText = nutrients[7].intake;
                if (spans.calciumPercent && nutrients[7]) spans.calciumPercent.innerText = nutrients[7].percent;
            }
            
            // Populate meal recommendations
            if (spans.mealRecommendation && parsedAnalysis.mealRecommendations) {
                spans.mealRecommendation.innerText = parsedAnalysis.mealRecommendations;
            }
            
            console.log('Data population from nutritional_analysis successful');
            return;
        }
        
        // If the new format isn't found, try the old format
        if (!data?.data?.nutritionTable || !Array.isArray(data.data.nutritionTable)) {
            console.error('Invalid or missing nutritionTable data');
            return;
        }

        const spans = await findAllElements();

        // Populate the spans with data, with null checks (old format)
        if (spans.caloriesTarget && data.data.nutritionTable[0]) {
            spans.caloriesTarget.innerText = data.data.nutritionTable[0].targetAmount?.trim() || '';
        }
        if (spans.caloriesIntake && data.data.nutritionTable[0]) {
            spans.caloriesIntake.innerText = data.data.nutritionTable[0].intake?.trim() || '';
        }
        if (spans.caloriesPercent && data.data.nutritionTable[0]) {
            spans.caloriesPercent.innerText = data.data.nutritionTable[0].percentReached?.trim() || '';
        }
        if (spans.proteinTarget && data.data.nutritionTable[1]) {
            spans.proteinTarget.innerText = data.data.nutritionTable[1].targetAmount?.trim() || '';
        }
        if (spans.proteinIntake && data.data.nutritionTable[1]) {
            spans.proteinIntake.innerText = data.data.nutritionTable[1].intake?.trim() || '';
        }
        if (spans.proteinPercent && data.data.nutritionTable[1]) {
            spans.proteinPercent.innerText = data.data.nutritionTable[1].percentReached?.trim() || '';
        }
        if (spans.carbsTarget && data.data.nutritionTable[2]) {
            spans.carbsTarget.innerText = data.data.nutritionTable[2].targetAmount?.trim() || '';
        }
        if (spans.carbsIntake && data.data.nutritionTable[2]) {
            spans.carbsIntake.innerText = data.data.nutritionTable[2].intake?.trim() || '';
        }
        if (spans.carbsPercent && data.data.nutritionTable[2]) {
            spans.carbsPercent.innerText = data.data.nutritionTable[2].percentReached?.trim() || '';
        }
        if (spans.fatTarget && data.data.nutritionTable[3]) {
            spans.fatTarget.innerText = data.data.nutritionTable[3].targetAmount?.trim() || '';
        }
        if (spans.fatIntake && data.data.nutritionTable[3]) {
            spans.fatIntake.innerText = data.data.nutritionTable[3].intake?.trim() || '';
        }
        if (spans.fatPercent && data.data.nutritionTable[3]) {
            spans.fatPercent.innerText = data.data.nutritionTable[3].percentReached?.trim() || '';
        }
        if (spans.fiberTarget && data.data.nutritionTable[4]) {
            spans.fiberTarget.innerText = data.data.nutritionTable[4].targetAmount?.trim() || '';
        }
        if (spans.fiberIntake && data.data.nutritionTable[4]) {
            spans.fiberIntake.innerText = data.data.nutritionTable[4].intake?.trim() || '';
        }
        if (spans.fiberPercent && data.data.nutritionTable[4]) {
            spans.fiberPercent.innerText = data.data.nutritionTable[4].percentReached?.trim() || '';
        }
        if (spans.vitaminDTarget && data.data.nutritionTable[5]) {
            spans.vitaminDTarget.innerText = data.data.nutritionTable[5].targetAmount?.trim() || '';
        }
        if (spans.vitaminDIntake && data.data.nutritionTable[5]) {
            spans.vitaminDIntake.innerText = data.data.nutritionTable[5].intake?.trim() || '';
        }
        if (spans.vitaminDPercent && data.data.nutritionTable[5]) {
            spans.vitaminDPercent.innerText = data.data.nutritionTable[5].percentReached?.trim() || '';
        }
        if (spans.ironTarget && data.data.nutritionTable[6]) {
            spans.ironTarget.innerText = data.data.nutritionTable[6].targetAmount?.trim() || '';
        }
        if (spans.ironIntake && data.data.nutritionTable[6]) {
            spans.ironIntake.innerText = data.data.nutritionTable[6].intake?.trim() || '';
        }
        if (spans.ironPercent && data.data.nutritionTable[6]) {
            spans.ironPercent.innerText = data.data.nutritionTable[6].percentReached?.trim() || '';
        }
        if (spans.calciumTarget && data.data.nutritionTable[7]) {
            spans.calciumTarget.innerText = data.data.nutritionTable[7].targetAmount?.trim() || '';
        }
        if (spans.calciumIntake && data.data.nutritionTable[7]) {
            spans.calciumIntake.innerText = data.data.nutritionTable[7].intake?.trim() || '';
        }
        if (spans.calciumPercent && data.data.nutritionTable[7]) {
            spans.calciumPercent.innerText = data.data.nutritionTable[7].percentReached?.trim() || '';
        }
        if (spans.mealRecommendation) {
            spans.mealRecommendation.innerText = data?.data?.mealRecommendations != 'null' ? data?.data?.mealRecommendations?.trim() : '';
        }
        if (spans.bmi && data.data.metrics) {
            spans.bmi.innerText += " " + data.data.metrics.bmi?.trim() || '';
        }

        console.log('Data population successful');
    } catch (error) {
        console.error('Error populating data:', error);
    }
}

// Function to parse the nutritional_analysis string into a structured object
function parseNutritionalAnalysis(text) {
    console.log('Parsing nutritional analysis text:', text);
    const result = {
        bmi: null,
        nutritionTable: [],
        mealRecommendations: null
    };
    
    // Extract BMI
    const bmiMatch = text.match(/BMI:\s*(\d+\.?\d*)/);
    if (bmiMatch && bmiMatch[1]) {
        result.bmi = bmiMatch[1];
    }
    
    // Extract nutrition table
    const tableRegex = /```[\s\S]*?NUTRIENT[\s\S]*?\n([\s\S]*?)```/;
    const tableMatch = text.match(tableRegex);
    
    if (tableMatch && tableMatch[1]) {
        // Split the table into lines and process each nutrient line
        const lines = tableMatch[1].split('\n').filter(line => line.trim().length > 0);
        
        // Skip header separator line (has dashes)
        const dataLines = lines.filter(line => !line.match(/^-+\|/));
        
        dataLines.forEach(line => {
            // Split the line by | and trim each part
            const parts = line.split('|').map(part => part.trim());
            
            if (parts.length >= 4) {
                const nutrient = {
                    name: parts[0],
                    target: parts[1],
                    intake: parts[2],
                    percent: parts[3]
                };
                result.nutritionTable.push(nutrient);
            }
        });
    }
    
    // Extract meal recommendations
    const mealRecsRegex = /# MEAL RECOMMENDATIONS\s*\n\s*([\s\S]*?)(?=$|\n#)/;
    const mealRecsMatch = text.match(mealRecsRegex);
    
    if (mealRecsMatch && mealRecsMatch[1]) {
        result.mealRecommendations = mealRecsMatch[1].trim();
    }
    
    return result;
}

populate()

// Display function that can handle both the new structured format and the older text format
function displayCalorieOutput() {
  const outputElement = document.getElementById('calorie-output');
  outputElement.innerHTML = "<p>Processing data...</p>";
  
  try {
    // Get data from localStorage
    const storedData = localStorage.getItem('calorieIqResponse');
    
    if (!storedData) {
      outputElement.innerHTML = "<p>No data found in localStorage. Please generate new calorie data.</p>";
      return;
    }
    
    // Log raw data for debugging
    console.log("Raw stored data:", storedData);
    
    // Parse the outer response
    const parsedData = JSON.parse(storedData);
    console.log("Parsed data:", parsedData);
    
    // Check if we have the new structured format
    if (parsedData.data && parsedData.data.structured) {
      displayStructuredData(parsedData.data, outputElement);
    } 
    // Check if we have the old text format in a 'text' field
    else if (parsedData.text) {
      displayTextData(parsedData.text, outputElement);
    }
    // Fallback for any other format
    else {
      outputElement.innerHTML = `<h3>CalorieIQ Results</h3><pre>${JSON.stringify(parsedData, null, 2)}</pre>`;
    }
  } catch (error) {
    console.error("Error displaying calorie data:", error);
    outputElement.innerHTML = `
      <div style="color: red; margin-bottom: 15px;">Error displaying data: ${error.message}</div>
      <div style="color: orange;">
        <p>Raw data from localStorage:</p>
        <pre style="background: #f5f5f5; padding: 10px; overflow: auto; max-height: 300px; font-size: 12px;">${localStorage.getItem('calorieIqResponse') || 'No data found'}</pre>
      </div>
    `;
  }
}

// Display structured data in a nice format
function displayStructuredData(data, outputElement) {
  // Extract the components
  const { rawText, structured } = data;
  
  let htmlOutput = '<div class="results-container">';
  
  // BMI section
  if (structured && structured.bmi) {
    htmlOutput += `
      <div class="bmi-section">
        <h3>Your BMI</h3>
        <div class="bmi-value">${structured.bmi}</div>
      </div>
    `;
  }
  
  // Nutrients table section
  if (structured && structured.nutrients && structured.nutrients.length > 0) {
    htmlOutput += `
      <div class="nutrients-section">
        <h3>Nutrient Analysis</h3>
        <table class="nutrients-table">
          <thead>
            <tr>
              <th>Nutrient</th>
              <th>Daily Target</th>
              <th>Intake</th>
              <th>% of Target</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    structured.nutrients.forEach(nutrient => {
      htmlOutput += `
        <tr>
          <td>${nutrient.name}</td>
          <td>${nutrient.target}</td>
          <td>${nutrient.intake}</td>
          <td>${nutrient.percentage}</td>
        </tr>
      `;
    });
    
    htmlOutput += `
          </tbody>
        </table>
      </div>
    `;
  }
  
  // Meal recommendations section
  if (structured && structured.mealRecommendations && structured.mealRecommendations.length > 0) {
    htmlOutput += `
      <div class="recommendations-section">
        <h3>Meal Recommendations</h3>
        <ul class="recommendations-list">
    `;
    
    structured.mealRecommendations.forEach(recommendation => {
      if (recommendation.trim()) {
        htmlOutput += `<li>${recommendation}</li>`;
      }
    });
    
    htmlOutput += `
        </ul>
      </div>
    `;
  }
  
  // If we couldn't find structured data, display the raw text as fallback
  if (!structured || (!structured.bmi && !structured.nutrients.length && !structured.mealRecommendations.length)) {
    htmlOutput += `
      <div class="raw-text">
        <h3>Nutritional Analysis</h3>
        <div class="markdown-content">${formatMarkdown(rawText || '')}</div>
      </div>
    `;
  }
  
  htmlOutput += '</div>';
  outputElement.innerHTML = htmlOutput;
}

// Display text data with basic formatting
function displayTextData(text, outputElement) {
  try {
    // Try to parse the text as JSON in case it's a JSON string
    if (text.trim().startsWith('{') || text.trim().startsWith('[')) {
      try {
        const jsonData = JSON.parse(text);
        // If it has a Response field, extract and format that
        if (jsonData.Response) {
          outputElement.innerHTML = `<div class="markdown-content">${formatMarkdown(jsonData.Response)}</div>`;
          return;
        }
        // Otherwise just display the formatted JSON
        outputElement.innerHTML = `<pre>${JSON.stringify(jsonData, null, 2)}</pre>`;
        return;
      } catch (e) {
        console.log("Text is not valid JSON, displaying as text");
      }
    }
    
    // Format as plain text/markdown
    outputElement.innerHTML = `<div class="markdown-content">${formatMarkdown(text)}</div>`;
  } catch (error) {
    console.error("Error in displayTextData:", error);
    outputElement.innerHTML = `<pre>${text}</pre>`;
  }
}

// Format markdown text to HTML
function formatMarkdown(text) {
  if (!text) return '';
  
  // Format headers
  text = text.replace(/^# (.*$)/gm, '<h2>$1</h2>');
  text = text.replace(/^## (.*$)/gm, '<h3>$1</h3>');
  
  // Format code blocks
  text = text.replace(/```([\s\S]*?)```/g, function(match, p1) {
    // Check if it looks like a table (contains | character)
    if (p1.includes('|')) {
      return formatTable(p1);
    }
    return '<pre><code>' + p1 + '</code></pre>';
  });
  
  // Format lists
  text = text.replace(/^\s*[\-\*]\s+(.*$)/gm, '<li>$1</li>');
  text = text.replace(/(<li>.*<\/li>\n)+/g, '<ul>$&</ul>');
  
  // Format line breaks
  text = text.replace(/\n/g, '<br>');
  
  return text;
}

// Format tables from markdown-style to HTML
function formatTable(tableText) {
  const lines = tableText.trim().split('\n');
  let html = '<table class="nutrients-table">';
  
  // Process header (first row)
  if (lines.length > 0) {
    const headerCells = lines[0].split('|').map(cell => cell.trim()).filter(cell => cell);
    html += '<thead><tr>';
    headerCells.forEach(cell => {
      html += `<th>${cell}</th>`;
    });
    html += '</tr></thead>';
  }
  
  // Skip the separator row (if it exists)
  const dataStartIndex = lines.length > 1 && lines[1].includes('---') ? 2 : 1;
  
  // Process data rows
  if (lines.length > dataStartIndex) {
    html += '<tbody>';
    for (let i = dataStartIndex; i < lines.length; i++) {
      const cells = lines[i].split('|').map(cell => cell.trim()).filter(cell => cell);
      if (cells.length > 0) {
        html += '<tr>';
        cells.forEach(cell => {
          html += `<td>${cell}</td>`;
        });
        html += '</tr>';
      }
    }
    html += '</tbody>';
  }
  
  html += '</table>';
  return html;
}

// Copy output to clipboard
function copyCalorieOutput() {
  const output = document.getElementById('calorie-output').innerText;
  navigator.clipboard.writeText(output)
    .then(() => {
      alert('Copied to clipboard!');
    })
    .catch(err => {
      alert('Failed to copy: ' + err);
    });
}

// Debug function to inspect localStorage content
function debugLocalStorage() {
  const data = localStorage.getItem('calorieIqResponse');
  console.log("localStorage content:", data);
  alert("Data length: " + (data ? data.length : 0) + " characters. Check console for details.");
}

// Call immediately and also on load
displayCalorieOutput();
window.addEventListener('load', displayCalorieOutput);

// Add debug buttons
document.write('<div style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap;">');
document.write('<button onclick="displayCalorieOutput()" style="background-color:#e74c3c;color:white;padding:8px 15px;border:none;border-radius:4px;cursor:pointer;">Force Display Data</button>');
document.write('<button onclick="debugLocalStorage()" style="background-color:#3498db;color:white;padding:8px 15px;border:none;border-radius:4px;cursor:pointer;">Debug Storage</button>');
document.write('</div>');
    </script>