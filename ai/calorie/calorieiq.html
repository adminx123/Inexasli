<!--
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be prosecuted to the fullest extent of the law in British Columbia, Canada, and applicable jurisdictions worldwide.
 -->

 <div class="row1">
    <div class="grid-container" id="calorie-goal">
        <div class="grid-item" data-value="Lose Weight">I want to lose weight</div>
        <div class="grid-item" data-value="Gain Muscle">I want gain muscle</div>
        <div class="grid-item" data-value="Maintain Weight">I want maintain weight</div>
        <div class="grid-item" data-value="Improve Endurance">I want improve endurance</div>
    </div>
</div>

<div class="row1">
    <div class="grid-container" id="calorie-activity">
        <div class="grid-item" data-value="Sedentary">Sedentary (little to no exercise)</div>
        <div class="grid-item" data-value="Lightly Active">Lightly Active (light exercise 1-3 days/week)</div>
        <div class="grid-item" data-value="Moderately Active">Moderately Active (moderate exercise 3-5 days/week)</div>
        <div class="grid-item" data-value="Very Active">Very Active (hard exercise 6-7 days/week)</div>
        <div class="grid-item" data-value="Athlete">Athlete (intense training daily)</div>
    </div>
</div>

<div class="row1">
    <div class="grid-container" id="calorie-recommendations">
        <div class="grid-item" data-value="Meal Recommendations">Need meal recommendations to make up deficit</div>
    </div>
</div>

<div class="row1">
    <div class="grid-container" id="calorie-diet-type">
        <div class="grid-item" data-value="None">No Restrictions</div>
        <div class="grid-item" data-value="Vegetarian">Vegetarian</div>
        <div class="grid-item" data-value="Vegan">Vegan</div>
        <div class="grid-item" data-value="Gluten-Free">Gluten-Free</div>
        <div class="grid-item" data-value="Keto">Keto</div>
        <div class="grid-item" data-value="Paleo">Paleo</div>
        <div class="grid-item" data-value="Low-Carb">Low-Carb</div>
        <div class="grid-item" data-value="Mediterranean">Mediterranean</div>
    </div>
</div>

<div class="twoperrow">
    <input type="number" inputmode="numeric" id="calorie-age" placeholder="Age" min="0">
    <div class="rowuom">
        <input type="number" id="calorie-height" placeholder="Height" step="0.1" min="0">
        <select id="calorie-height-unit">
            <option value="ft">FT</option>
            <option value="cm">CM</option>
        </select>
    </div>
</div>
<div class="rowuom">
    <input type="number" inputmode="numeric" id="calorie-weight" placeholder="Weight" step="0.1" min="0">
    <select id="calorie-weight-unit">
        <option value="lbs">LB</option>
        <option value="kg">KG</option>
    </select>
</div>
<select id="calorie-measure">
    <option value="man">Man</option>
    <option value="woman">Woman</option>
</select>

<textarea id="calorie-food-log" rows="3" placeholder="Meals:
Chicken breast 200g with rice 1cup
Potato 100g with broccoli 150g"></textarea>
<button class="generate-btn">Generate Now!</button>
<button class="clear-btn">Clear All</button>

<script>
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be prosecuted to the fullest extent of the law in British Columbia, Canada, and applicable jurisdictions worldwide.
 */
(function () {
    console.log('CalorieIQ script started executing (calorieiq.html)');

    // Initialize form
    function initialize() {
        console.log('Initializing CalorieIQ form (calorieiq.html)');
        repopulateForm();
        bindEventListeners();
        // Set default values for selects if not saved
        setDefaultSelectValues();
    }

    // Handle dynamic content initialization
    document.addEventListener('dataInContentLoaded', function () {
        console.log('dataInContentLoaded fired (calorieiq.html)');
        initialize();
    });

    // Fallback: Initialize after DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOMContentLoaded fired for calorieiq.html');
        initialize();
    });

    function setDefaultSelectValues() {
        const selects = [
            { id: 'calorie-height-unit', defaultValue: 'ft' },
            { id: 'calorie-weight-unit', defaultValue: 'lbs' },
            { id: 'calorie-measure', defaultValue: 'man' }
        ];
        selects.forEach(select => {
            const element = document.getElementById(select.id);
            const key = `input_${select.id}`;
            if (!localStorage.getItem(key) && element) {
                element.value = select.defaultValue;
                localStorage.setItem(key, select.defaultValue);
                console.log(`Set default ${key}: ${select.defaultValue} (calorieiq.html)`);
            }
        });
    }

    function bindEventListeners() {
        // Grid items
        document.querySelectorAll('.grid-container .grid-item').forEach(item => {
            item.addEventListener('click', function (e) {
                e.stopPropagation();
                const container = item.closest('.grid-container');
                if (container.id === 'calorie-goal' || container.id === 'calorie-activity' || container.id === 'calorie-diet-type') {
                    container.querySelectorAll('.grid-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                } else {
                    item.classList.toggle('selected');
                }
                saveGridItem(item);
            });
        });

        // Inputs, textareas, selects
        document.querySelectorAll('input, textarea, select').forEach(element => {
            element.addEventListener('change', function () {
                saveInput(this);
            });
            // Trigger change on initial load to save default values
            if (element.tagName === 'SELECT' && element.value) {
                saveInput(element);
            }
        });

        // Generate button
        const generateBtn = document.querySelector('.generate-btn');
        if (generateBtn) {
            generateBtn.addEventListener('click', handleGetCalorieIq);
            console.log('Generate Now! button event listener bound (calorieiq.html)');
        } else {
            console.error('Generate Now! button not found (calorieiq.html)');
        }

        // Clear button
        const clearBtn = document.querySelector('.clear-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', clearLocalStorage);
            console.log('Clear All button event listener bound (calorieiq.html)');
        } else {
            console.error('Clear All button not found (calorieiq.html)');
        }

        // Auto-resize textarea
        const textarea = document.getElementById('calorie-food-log');
        if (textarea) {
            textarea.addEventListener('input', function () {
                this.style.height = '100px';
                this.style.height = `${this.scrollHeight}px`;
            });
        }
    }

    function saveGridItem(item) {
        const key = `grid_${item.parentElement.id}_${item.dataset.value.replace(/\s+/g, '_')}`;
        const value = item.classList.contains('selected') ? 'true' : 'false';
        try {
            localStorage.setItem(key, value);
            console.log(`Saved ${key}: ${value} (calorieiq.html)`);
        } catch (error) {
            console.error(`Error saving grid item ${key}:`, error);
        }
    }

    function saveInput(input) {
        const key = `input_${input.id}`;
        const value = input.value;
        try {
            localStorage.setItem(key, value);
            console.log(`Saved ${key}: ${value} (calorieiq.html)`);
        } catch (error) {
            console.error(`Error saving input ${key}:`, error);
        }
    }

    async function handleGetCalorieIq(e) {
        console.log('handleGetCalorieIq triggered (calorieiq.html)');
        const btn = e.target;
        const initialText = btn.innerText;
        btn.innerText = 'Loading...';
        btn.setAttribute('disabled', 'true');

        const formData = getFormData();
        if (!formData) {
            console.error('Form data is invalid or incomplete (calorieiq.html)');
            btn.innerText = initialText;
            btn.removeAttribute('disabled');
            return;
        }

        console.log('Processed form data:', formData);
        localStorage.setItem("calorieIqFormData", JSON.stringify(formData));

        const apiUrl = 'https://ocejuhqqla5zdps4uaiogwswki0vaclp.lambda-url.us-east-1.on.aws/';

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            if (data.message !== 'Success') {
                throw new Error(`An error occurred: ${data.message || data.error || ''}`);
            }

            console.log('API response:', data);
            btn.innerText = "Success";
            localStorage.setItem('calorieIqResponse', JSON.stringify(data));

            // Trigger data out container
            localStorage.setItem('lastDataOutUrl', '/ai/calorie/calorieiqout.html');
            document.dispatchEvent(new CustomEvent('dataOutRequested', {
                detail: { url: '/ai/calorie/calorieiqout.html' }
            }));

            setTimeout(() => {
                btn.innerText = initialText;
                btn.removeAttribute('disabled');
            }, 3000);
        } catch (error) {
            console.error('Error fetching data from API:', error);
            let errorMessage = 'An error occurred while fetching data. Please try again later.';
            if (error.message.includes('HTTP error')) {
                errorMessage = `Server error (${error.message}). Please check your connection or try again later.`;
            } else if (data?.message) {
                errorMessage = `Error: ${data.message}`;
            }
            alert(errorMessage);
            btn.innerText = 'Error';
            btn.removeAttribute('disabled');

            setTimeout(() => {
                btn.innerText = initialText;
                btn.removeAttribute('disabled');
            }, 4000);
        }
    }

    function getFormData() {
        console.log('getFormData called (calorieiq.html)');
        const formData = {
            goals: [],
            activityLevel: null,
            needMealRecommendation: false,
            dietRestriction: null,
            age: null,
            height: { height: null, unit: null },
            weight: { weight: null, unit: null },
            sex: null,
            foodLog: null
        };

        // Goals
        const selectedGoals = document.querySelectorAll('#calorie-goal .grid-item.selected');
        if (selectedGoals.length === 0) {
            alert('Please select at least one goal.');
            return;
        }
        selectedGoals.forEach(item => formData.goals.push(item.dataset.value));

        // Activity level
        const activityLevel = document.querySelector('#calorie-activity .grid-item.selected');
        if (!activityLevel) {
            alert('Please select your activity level.');
            return;
        }
        formData.activityLevel = activityLevel.dataset.value;

        // Meal recommendation
        const mealRecommendation = document.querySelector('#calorie-recommendations .grid-item.selected');
        if (mealRecommendation) {
            formData.needMealRecommendation = true;
        }

        // Diet restriction
        const dietRestriction = document.querySelector('#calorie-diet-type .grid-item.selected');
        if (!dietRestriction) {
            alert('Please select your diet restriction.');
            return;
        }
        formData.dietRestriction = dietRestriction.dataset.value;

        // Age
        const ageInput = document.getElementById('calorie-age');
        if (!ageInput?.value || isNaN(ageInput.value) || parseInt(ageInput.value, 10) <= 0) {
            alert('Please enter a valid age.');
            return;
        }
        formData.age = parseInt(ageInput.value, 10);

        // Height and unit
        const heightInput = document.getElementById('calorie-height');
        const heightUnitInput = document.getElementById('calorie-height-unit');
        if (!heightInput?.value || isNaN(heightInput.value) || parseFloat(heightInput.value) <= 0) {
            alert('Please enter a valid height.');
            return;
        }
        if (!heightUnitInput?.value) {
            alert('Please select a height unit.');
            return;
        }
        formData.height.height = parseFloat(heightInput.value);
        formData.height.unit = heightUnitInput.value;

        // Weight and unit
        const weightInput = document.getElementById('calorie-weight');
        const weightUnitInput = document.getElementById('calorie-weight-unit');
        if (!weightInput?.value || isNaN(weightInput.value) || parseFloat(weightInput.value) <= 0) {
            alert('Please enter a valid weight.');
            return;
        }
        if (!weightUnitInput?.value) {
            alert('Please select a weight unit.');
            return;
        }
        formData.weight.weight = parseFloat(weightInput.value);
        formData.weight.unit = weightUnitInput.value;

        // Sex
        const sexInput = document.getElementById('calorie-measure');
        if (!sexInput?.value) {
            alert('Please select your sex.');
            return;
        }
        formData.sex = sexInput.value;

        // Food log
        const foodLogInput = document.getElementById('calorie-food-log');
        formData.foodLog = foodLogInput?.value.trim() || '';

        return formData;
    }

    function repopulateForm() {
        console.log('repopulateForm called (calorieiq.html)');
        // Inputs, textareas, selects
        const elements = [
            'calorie-age',
            'calorie-height',
            'calorie-weight',
            'calorie-food-log',
            'calorie-height-unit',
            'calorie-weight-unit',
            'calorie-measure'
        ];
        elements.forEach(id => {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`Element with id ${id} not found (calorieiq.html)`);
                return;
            }
            const key = `input_${id}`;
            const value = localStorage.getItem(key);
            if (value !== null) {
                element.value = value;
                console.log(`Restored ${key}: ${value} (calorieiq.html)`);
            } else {
                console.log(`No saved value for ${key} (calorieiq.html)`);
            }
        });
    }

    function clearLocalStorage() {
        if (!confirm("Are you sure you want to clear all saved data? This action cannot be undone.")) {
            console.log("User canceled the clear action (calorieiq.html)");
            return;
        }
        document.querySelectorAll('.grid-container .grid-item').forEach(item => {
            const key = `grid_${item.parentElement.id}_${item.dataset.value.replace(/\s+/g, '_')}`;
            localStorage.removeItem(key);
            item.classList.remove('selected');
            console.log(`Cleared ${key} (calorieiq.html)`);
        });
        const elements = [
            'calorie-age',
            'calorie-height',
            'calorie-weight',
            'calorie-food-log',
            'calorie-height-unit',
            'calorie-weight-unit',
            'calorie-measure'
        ];
        elements.forEach(id => {
            const key = `input_${id}`;
            localStorage.removeItem(key);
            const element = document.getElementById(id);
            if (element) {
                element.value = '';
            }
            console.log(`Cleared ${key} (calorieiq.html)`);
        });
        setDefaultSelectValues();
        console.log("All saved data cleared and form reset (calorieiq.html)");
    }

    console.log('CalorieIQ script finished executing (calorieiq.html)');
})();
</script>