<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

 <div class="row1">
    <div class="grid-container" id="calorie-goal">
        <div class="grid-item" data-value="Lose Weight">I want to lose weight</div>
        <div class="grid-item" data-value="Gain Muscle">I want gain muscle</div>
        <div class="grid-item" data-value="Maintain Weight">I want maintain weight</div>
        <div class="grid-item" data-value="Improve Endurance">I want improve endurance</div>
    </div>
</div>

<div class="row1">
    <div class="grid-container" id="calorie-activity">
        <div class="grid-item" data-value="Sedentary">Sedentary (little to no exercise)</div>
        <div class="grid-item" data-value="Lightly Active">Lightly Active (light exercise 1-3 days/week)</div>
        <div class="grid-item" data-value="Moderately Active">Moderately Active (moderate exercise 3-5 days/week)</div>
        <div class="grid-item" data-value="Very Active">Very Active (hard exercise 6-7 days/week)</div>
        <div class="grid-item" data-value="Athlete">Athlete (intense training daily)</div>
    </div>
</div>

<div class="row1">
    <div class="grid-container" id="calorie-recommendations">
        <div class="grid-item" data-value="Meal Recommendations">Need meal recommendations to make up deficit</div>
    </div>
</div>

<div class="row1">
    <div class="grid-container" id="calorie-diet-type">
        <div class="grid-item" data-value="None">No Restrictions</div>
        <div class="grid-item" data-value="Vegetarian">Vegetarian</div>
        <div class="grid-item" data-value="Vegan">Vegan</div>
        <div class="grid-item" data-value="Gluten-Free">Gluten-Free</div>
        <div class="grid-item" data-value="Keto">Keto</div>
        <div class="grid-item" data-value="Paleo">Paleo</div>
        <div class="grid-item" data-value="Low-Carb">Low-Carb</div>
        <div class="grid-item" data-value="Mediterranean">Mediterranean</div>
    </div>
</div>

<div class="twoperrow">
    <input type="number" inputmode="numeric" id="calorie-age" placeholder="Age" min="0">
    <!-- <div class="rowuom"> -->
        <input id="calorie-height" placeholder="Height eg. 2 meters">
        <!-- <select id="calorie-height-unit">
            <option value="ft" selected>FT</option>
            <option value="cm">CM</option>
        </select> -->
    <!-- </div> -->
</div>
<div class="rowuom">
    <input id="calorie-weight" placeholder="Weight eg. 100 lbs">
    <!-- <select id="calorie-weight-unit">
        <option value="lbs" selected>LB</option>
        <option value="kg">KG</option>
    </select> -->
</div>
<select id="calorie-sex">
    <option value="man" selected>Man</option>
    <option value="woman">Woman</option>
</select>

<textarea id="calorie-food-log" rows="3" placeholder="Meals:
Chicken breast 200g with rice 1cup
Potato 100g with broccoli 150g"></textarea>
<button class="generate-btn" onclick="handleGetCalorieIq(event)">Generate Now!</button>
<button class="clear-btn">Clear All</button>

<script>
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be prosecuted to the fullest extent of the law in British Columbia, Canada, and applicable jurisdictions worldwide.
 */
(function () {
     console.log("new script is in action (calorieiq.html)")
    //  const storedFormData = JSON.parse(localStorage.getItem("calorieIqFormData"));
    // Wait for DOM to be ready and handle dynamic content
    document.addEventListener('DOMContentLoaded', function () {
        initializeForm();
    });

    function handleDocumentClick(e) {
        const target = e.target;

        // Handle grid item clicks
        // if (target.classList.contains('grid-item')) {
        //     const container = target.closest('.grid-container');
        //     if (container.id === 'calorie-activity' || container.id === 'calorie-diet-type') {
        //         container.querySelectorAll('.grid-item').forEach(item => item.classList.remove('selected'));
        //         target.classList.add('selected');
        //         console.log("toggeled 1 selection from calorieIq.html" )

        //     } else {
        //         target.classList.toggle('selected');
        //         console.log("toggeled the selection from calorieIq.html" )
        //     }
        //     // saveGridItem(target);
        // }

        // Handle generate button
        // if (target.classList.contains('generate-btn')) {
            // saveFormData();
        //     const promptType = target.getAttribute('data-prompt');
        //     generatePrompt(promptType);
        // }

        // Handle clear button
        if (target.classList.contains('clear-btn')) {
            console.log("clear button has been clicked")
            clearLocalStorage();
        }
    }

    function handleGridItemToggled (e) {
try {
    // Slimmed down silent version inside listener
    function getSilentFormData() {
        const formData = {
            goals: [],
            activityLevel: null,
            needMealRecommendation: false,
            dietRestriction: null
        };

        const selectedGoals = document.querySelectorAll('#calorie-goal .grid-item.selected');
        selectedGoals.forEach(item => {
            formData.goals.push(item.dataset.value);
        });

        const activityLevel = document.querySelector('#calorie-activity .grid-item.selected');
        if (activityLevel) {
            formData.activityLevel = activityLevel.dataset.value;
        }

        const mealRecommendation = document.querySelector('#calorie-recommendations .grid-item.selected');
        if (mealRecommendation) {
            formData.needMealRecommendation = true;
        }

        const dietRestriction = document.querySelector('#calorie-diet-type .grid-item.selected');
        if (dietRestriction) {
            formData.dietRestriction = dietRestriction.dataset.value;
        }

        return formData;
    }

    const partialFormData = getSilentFormData();
    if (partialFormData) {
        // Get full current stored form data
        const existingData = JSON.parse(localStorage.getItem('calorieIqFormData')) || {};

        // Merge the updated parts into existing data
        const updatedFormData = { ...existingData, ...partialFormData };

        // Save back to localStorage
        localStorage.setItem('calorieIqFormData', JSON.stringify(updatedFormData));
        console.log('Updated formData after toggle (silent, grid only)');
    }
} catch (error) {
    console.error('Error saving partial formData after toggle:', error);
}
}

function handleInputChange (e) {
    const target = e.target;

    if (target.matches('input, textarea, select')) {
        try {
            function getSilentInputFormData() {
                const formData = {};

                const ageInput = document.getElementById('calorie-age');
                if (ageInput?.value && !isNaN(ageInput.value) && parseInt(ageInput.value, 10) > 0) {
                    formData.age = parseInt(ageInput.value, 10);
                }

                const heightInput = document.getElementById('calorie-height');
                if (heightInput?.value) {
                    formData.height = heightInput.value;
                }

                const weightInput = document.getElementById('calorie-weight');
                if (weightInput?.value) {
                    formData.weight = weightInput.value;
                }

                const sexInput = document.getElementById('calorie-sex');
                if (sexInput?.value) {
                    formData.sex = sexInput.value;
                }

                const foodLogInput = document.getElementById('calorie-food-log');
                if (foodLogInput?.value.trim()) {
                    formData.foodLog = foodLogInput.value.trim();
                } else {
                    formData.foodLog = '';
                }

                return formData;
            }

            const partialFormData = getSilentInputFormData();
            if (partialFormData) {
                const existingData = JSON.parse(localStorage.getItem('calorieIqFormData')) || {};
                const updatedFormData = { ...existingData, ...partialFormData };
                localStorage.setItem('calorieIqFormData', JSON.stringify(updatedFormData));
                console.log('Updated formData after input/select change (silent)');
            }
        } catch (error) {
            console.error('Error saving formData after input/select change:', error);
        }
    }
}

function handleLeftSidebarOpen (e) {
            // console.log('Custom event "left-sidebar-open" triggered:', e.detail);
            const storedFormData = JSON.parse(localStorage.getItem("calorieIqFormData"));
            if (e.detail.state == "expanded" && storedFormData) {
                console.log("Left sidebar is expanded and storedFormData is available.");
                populateIn(storedFormData);
            } else {
                console.log("Left sidebar is not expanded or storedFormData is not available.");

            }
        }



    setTimeout(() => {
        // Handle grid item toggles
        document.removeEventListener('grid-item-toggled',handleGridItemToggled);
        document.addEventListener('grid-item-toggled', handleGridItemToggled);
        
        
        
        
        // Handle input changes
        document.removeEventListener('change', handleInputChange);
        document.addEventListener('change', handleInputChange);

    }, 300)
    const storedFormData = JSON.parse(localStorage.getItem("calorieIqFormData"));

    if (storedFormData) {
                    populateIn(storedFormData);
                }

    //  add event listener for custom event (left-sidebar-open)

    setTimeout(() => {


        document.removeEventListener('left-sidebar-open', handleLeftSidebarOpen);
        document.addEventListener('left-sidebar-open', handleLeftSidebarOpen)}, 300);
    

        document.removeEventListener('click', handleDocumentClick);
        document.addEventListener('click', handleDocumentClick );

    

    // Handle input changes
    document.addEventListener('change', function (e) {
        const target = e.target;
        if (target.matches('input, textarea, select')) {
            saveInput(target);
        }
    });

    // Initialize form (repopulate from localStorage)
    function initializeForm() {
        repopulateForm();

        // Auto-resize textareas
        document.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('input', function () {
                this.style.height = '100px';
                this.style.height = `${this.scrollHeight}px`;
            });
        });
    }

    function saveGridItem(item) {
        const key = `grid_${item.parentElement.id}_${item.dataset.value.replace(/\s+/g, '_')}`;
        const value = item.classList.contains('selected') ? 'true' : 'false';
        try {
            localStorage.setItem(key, value);
            console.log(`Saved ${key}: ${value}`);
        } catch (error) {
            console.error(`Error saving grid item ${key}:`, error);
        }
    }

    function saveInput(input) {
        const key = `input_${input.id}`;
        const value = input.value;
        try {
            localStorage.setItem(key, value);
            console.log(`Saved ${key}: ${value}`);
        } catch (error) {
            console.error(`Error saving input ${key}:`, error);
        }
    }


    async function handleGetCalorieIq(e) {
        const btn = e.target
        const initialText = btn.innerText;
        btn.innerText = 'Loading...';
        btn.setAttribute('disabled', 'true');

        console.log('Debug: handleGetCalorieIq function called');
        const formData = getFormData();
        if (!formData) {
            console.error('Form data is invalid or incomplete.');
            btn.innerText = initialText;
            btn.removeAttribute('disabled');
            return;
        }

        console.log('Processed form data:', formData);
        localStorage.setItem("calorieIqFormData", JSON.stringify(formData))

        // Updated with the new worker URL
        const apiUrl = 'https://calorieiqworker.4hm7q4q75z.workers.dev/';

        
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }


            
            const data = await response.json();
            if (data.message !== 'Success') {
                throw new Error(`An error occurred: ${data.message || data.error || ''}`);

            } else{
            console.log('API response:', data);
            btn.innerText = "success";
            
            localStorage.setItem('calorieIqResponse', JSON.stringify(data));

            
            toggleDataOutcontainer()
            // toggleDatainContainer()





              const spans = await findAllElements();
            //   console.log('All elements ready:', spans);
            // console.log("calorieiqresponse", data);
            
            // Safely populate the spans with data using defensive programming
            // Check if nutritionTable and its elements exist before accessing properties
            if (data.data && data.data.nutritionTable && Array.isArray(data.data.nutritionTable) && data.data.nutritionTable.length > 0) {
                // Calories
                if (data.data.nutritionTable[0]) {
                    spans.caloriesTarget.innerText = data.data.nutritionTable[0].targetAmount ? data.data.nutritionTable[0].targetAmount.trim() : 'N/A';
                    spans.caloriesIntake.innerText = data.data.nutritionTable[0].intake ? data.data.nutritionTable[0].intake.trim() : 'N/A';
                    spans.caloriesPercent.innerText = data.data.nutritionTable[0].percentReached ? data.data.nutritionTable[0].percentReached.trim() : 'N/A';
                }
                
                // Protein
                if (data.data.nutritionTable[1]) {
                    spans.proteinTarget.innerText = data.data.nutritionTable[1].targetAmount ? data.data.nutritionTable[1].targetAmount.trim() : 'N/A';
                    spans.proteinIntake.innerText = data.data.nutritionTable[1].intake ? data.data.nutritionTable[1].intake.trim() : 'N/A';
                    spans.proteinPercent.innerText = data.data.nutritionTable[1].percentReached ? data.data.nutritionTable[1].percentReached.trim() : 'N/A';
                }
                
                // Carbs
                if (data.data.nutritionTable[2]) {
                    spans.carbsTarget.innerText = data.data.nutritionTable[2].targetAmount ? data.data.nutritionTable[2].targetAmount.trim() : 'N/A';
                    spans.carbsIntake.innerText = data.data.nutritionTable[2].intake ? data.data.nutritionTable[2].intake.trim() : 'N/A';
                    spans.carbsPercent.innerText = data.data.nutritionTable[2].percentReached ? data.data.nutritionTable[2].percentReached.trim() : 'N/A';
                }
                
                // Fat
                if (data.data.nutritionTable[3]) {
                    spans.fatTarget.innerText = data.data.nutritionTable[3].targetAmount ? data.data.nutritionTable[3].targetAmount.trim() : 'N/A';
                    spans.fatIntake.innerText = data.data.nutritionTable[3].intake ? data.data.nutritionTable[3].intake.trim() : 'N/A';
                    spans.fatPercent.innerText = data.data.nutritionTable[3].percentReached ? data.data.nutritionTable[3].percentReached.trim() : 'N/A';
                }
                
                // Fiber
                if (data.data.nutritionTable[4]) {
                    spans.fiberTarget.innerText = data.data.nutritionTable[4].targetAmount ? data.data.nutritionTable[4].targetAmount.trim() : 'N/A';
                    spans.fiberIntake.innerText = data.data.nutritionTable[4].intake ? data.data.nutritionTable[4].intake.trim() : 'N/A';
                    spans.fiberPercent.innerText = data.data.nutritionTable[4].percentReached ? data.data.nutritionTable[4].percentReached.trim() : 'N/A';
                }
                
                // Vitamin D
                if (data.data.nutritionTable[5]) {
                    spans.vitaminDTarget.innerText = data.data.nutritionTable[5].targetAmount ? data.data.nutritionTable[5].targetAmount.trim() : 'N/A';
                    spans.vitaminDIntake.innerText = data.data.nutritionTable[5].intake ? data.data.nutritionTable[5].intake.trim() : 'N/A';
                    spans.vitaminDPercent.innerText = data.data.nutritionTable[5].percentReached ? data.data.nutritionTable[5].percentReached.trim() : 'N/A';
                }
                
                // Iron
                if (data.data.nutritionTable[6]) {
                    spans.ironTarget.innerText = data.data.nutritionTable[6].targetAmount ? data.data.nutritionTable[6].targetAmount.trim() : 'N/A';
                    spans.ironIntake.innerText = data.data.nutritionTable[6].intake ? data.data.nutritionTable[6].intake.trim() : 'N/A';
                    spans.ironPercent.innerText = data.data.nutritionTable[6].percentReached ? data.data.nutritionTable[6].percentReached.trim() : 'N/A';
                }
                
                // Calcium
                if (data.data.nutritionTable[7]) {
                    spans.calciumTarget.innerText = data.data.nutritionTable[7].targetAmount ? data.data.nutritionTable[7].targetAmount.trim() : 'N/A';
                    spans.calciumIntake.innerText = data.data.nutritionTable[7].intake ? data.data.nutritionTable[7].intake.trim() : 'N/A';
                    spans.calciumPercent.innerText = data.data.nutritionTable[7].percentReached ? data.data.nutritionTable[7].percentReached.trim() : 'N/A';
                }
            } else {
                console.warn('Nutrition table data is missing or invalid in the API response');
            }
            
            // Safely set meal recommendations and BMI
            if (spans.mealRecommendation) {
                spans.mealRecommendation.innerText = data?.data?.mealRecommendations && data.data.mealRecommendations !== 'null' 
                    ? data.data.mealRecommendations.trim() 
                    : '';
            }
            
            if (spans.bmi && data?.data?.metrics?.bmi) {
                spans.bmi.innerText += " " + data.data.metrics.bmi.trim();
            }


            setTimeout(() => {
                btn.innerText = initialText;
                btn.removeAttribute('disabled');
            }, 3000);

            }
            
        } catch (error) {
            console.error('Error fetching data from API:', error);
            alert('An error occurred while fetching data. Please try again later.');
            btn.innerText = error.message;
            btn.removeAttribute('disabled');

            setTimeout(() => {
                btn.innerText = initialText;
                btn.removeAttribute('disabled');
            }, 4000);

            
        }
    }

    function getFormData() {
        // console.clear();
        console.log('Debug: getFormData function called');
    
        const formData = {
            goals: [],
            activityLevel: null,
            needMealRecommendation: false,
            dietRestriction: null,
            age: null,
            height: null,
            weight: null,
            sex: null,
            foodLog: null
        };
    
        //goals
        const selectedGoals = document.querySelectorAll('#calorie-goal .grid-item.selected');
        if (selectedGoals.length === 0) {
            alert('Please select at least one goal.');
            return;
        }
        selectedGoals.forEach(item => {
            formData.goals.push(item.dataset.value);
        });
    
        //activity level
        const activityLevel = document.querySelector('#calorie-activity .grid-item.selected');
        if (!activityLevel) {
            alert('Please select your activity level.');
            return;
        }
        formData.activityLevel = activityLevel.dataset.value;
    
        //meal recommendation
        const mealRecommendation = document.querySelector('#calorie-recommendations .grid-item.selected');
        if (mealRecommendation) {
            formData.needMealRecommendation = true;
        }
    
        // diet restriction
        const dietRestriction = document.querySelector('#calorie-diet-type .grid-item.selected');
        if (!dietRestriction) {
            alert('Please select your diet restriction.');
            return;
        }
        formData.dietRestriction = dietRestriction.dataset.value;
    
        // age
        const ageInput = document.getElementById('calorie-age');
        if (!ageInput?.value || isNaN(ageInput.value) || parseInt(ageInput.value, 10) <= 0) {
            alert('Please enter a valid age.');
            return;
        }
        formData.age = parseInt(ageInput.value, 10);
    
        // height
        const heightInput = document.getElementById('calorie-height');
        if (!heightInput?.value) {
            alert('Please enter a valid height.');
            return;
        }
        formData.height = heightInput.value;
    
        //  weight and unit
        const weightInput = document.getElementById('calorie-weight');
        // const weightUnitInput = document.getElementById('calorie-weight-unit');
        if (!weightInput?.value) {
            alert('Please enter a valid weight.');
            return;
        }
        // if (!weightUnitInput?.value) {
        //     alert('Please select a weight unit.');
        //     return;
        // }
        formData.weight = weightInput.value;
        // formData.weight.unit = weightUnitInput.value;
    
        // sex
        const sexInput = document.getElementById('calorie-sex');
        if (!sexInput?.value) {
            alert('Please select your sex.');
            return;
        }
        formData.sex = sexInput.value;
    
        // food log
        const foodLogInput = document.getElementById('calorie-food-log');
        if (foodLogInput?.value.trim()) {

            formData.foodLog = foodLogInput.value.trim();
        } else {
            formData.foodLog = '';


        }
    
        // console.log('Form data:', formData);
        return formData;
    }

    function saveFormData() {
        document.querySelectorAll('.grid-container .grid-item').forEach(saveGridItem);
        document.querySelectorAll('input, textarea, select').forEach(saveInput);
    }

    function repopulateForm() {
        document.querySelectorAll('.grid-container .grid-item').forEach(item => {
            const key = `grid_${item.parentElement.id}_${item.dataset.value.replace(/\s+/g, '_')}`;
            const value = localStorage.getItem(key);
            if (value === 'true') {
                item.classList.add('selected');
                console.log(`Restored ${key}: true`);
            } else if (value === 'false') {
                item.classList.remove('selected');
                console.log(`Restored ${key}: false`);
            }
        });

        document.querySelectorAll('input, textarea').forEach(input => {
            const key = `input_${input.id}`;
            const value = localStorage.getItem(key);
            if (value !== null) {
                input.value = value;
                console.log(`Restored ${key}: ${value}`);
            }
        });

        document.querySelectorAll('select').forEach(select => {
            const key = `input_${select.id}`;
            const value = localStorage.getItem(key);
            if (value !== null) {
                const optionExists = Array.from(select.options).some(opt => opt.value === value);
                if (optionExists) {
                    select.value = value;
                    console.log(`Restored ${key}: ${value}`);
                } else {
                    console.warn(`Skipped restoring ${key}: value "${value}" not found in options`);
                }
            }
        });
    }

    function clearLocalStorage() {
        const storedFormData = JSON.parse(localStorage.getItem("calorieIqFormData"));


        if (storedFormData) {
            if (!confirm("Are you sure you want to clear all saved data? This action cannot be undone.")) {
                console.log("User canceled the clear action.");
                return;
            }
            document.querySelectorAll('.grid-container .grid-item').forEach(item => {
                // const key = `grid_${item.parentElement.id}_${item.dataset.value.replace(/\s+/g, '_')}`;
                try {
                    localStorage.removeItem('calorieIqFormData');
                    
                    item.classList.remove('selected');
                    // console.log(`Cleared ${key}`);
                } catch (error) {
                    // console.error(`Error clearing ${key}:`, error);
                }
            });
            document.querySelectorAll('input, textarea, select').forEach(input => {
                // const key = `input_${input.id}`;
                try {
                    // localStorage.removeItem(key);
                    input.value = '';
                    // console.log(`Cleared ${key}`);
                } catch (error) {
                    // console.error(`Error clearing ${key}:`, error);
                }
            });
            // const weightUnit = document.getElementById('calorie-weight-unit');
            // if (weightUnit) weightUnit.value = 'lbs';
            console.log("All saved data cleared and form reset.");
        }
    }

    const formatList = (items, prefix) => items ? `${prefix}:\n${items.split('\n').map((item, i) => `${i + 1}. ${item}`).join('\n')}\n\n` : '';
    const formatGrid = (selector, prefix) => {
        const items = Array.from(document.querySelectorAll(selector))
            .filter(el => el.classList.contains('selected'))
            .map(el => el.dataset.value)
            .join('\n');
        return items ? `${prefix}:\n${items.split('\n').map((item, i) => `${i + 1}. ${item}`).join('\n')}\n\n` : '';
    };

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            console.log('Prompt copied to clipboard successfully!');
        }).catch(err => {
            console.error('Failed to copy prompt to clipboard:', err);
        });
    }

    function generatePrompt(promptType) {
        console.log('Debug: generatePrompt function called with argument:', promptType);
        let prompt = '';
        if (promptType === 'CalorieIQ™') {
            prompt += formatGrid('#calorie-goal .grid-item.selected', 'Estimate calories and macronutrients for the following input as a percentage of daily requirements relative to my goal. Also analyze my height, weight, and age to compare me against the average person at my height, age, and weight. ');
            prompt += `
                Output only a text-based table in a code block with these exact columns: Nutrient, Target Amount, Food Log Intake, Percentage Reached. Use this header format in the code block:
                Include no text outside the code block—no comments, explanations, or recommendations unless specified below.
                `;
            const recommendations = document.querySelector('#calorie-recommendations .grid-item.selected');
            if (recommendations) {
                prompt += `
                    If there are deficits in calories or macronutrients based on my goal and food log, suggest meal recommendations to meet the remaining needs. Output meal suggestions in a separate text-based table in a code block with columns: Meal, Calories, Protein (g), Carbs (g), Fat (g). Use this header format:
                    Include no text outside the code blocks.
                    `;
            }
            prompt += `
                Add any future amounts I provide to the running totals unless I request a new estimate.
                `;
            const age = document.getElementById('calorie-age');
            if (age?.value) prompt += formatList(age.value, 'Age');
            const height = document.getElementById('calorie-height');
            if (height?.value) {
                prompt += formatList(`${height.value} ft`, 'Height');
            }
            const weight = document.getElementById('calorie-weight');
            const weightUnit = document.getElementById('calorie-weight-unit');
            if (weight?.value && weightUnit?.value) {
                prompt += formatList(`${weight.value} ${weightUnit.value}`, 'Weight');
            }
            const sex = document.getElementById('calorie-measure');
            if (sex?.value) prompt += formatList(sex.value, 'Sex');
            prompt += formatGrid('#calorie-activity .grid-item.selected', 'Activity Level');
            prompt += formatGrid('#calorie-diet-type .grid-item.selected', 'Diet Type');
            const foodLog = document.getElementById('calorie-food-log');
            if (foodLog?.value) prompt += `Day's Food Log (do not break down in summary):\n${foodLog.value}\n\n`;
        }
        if (prompt) {
            console.log('Debug: Generated prompt content:', prompt);
            copyToClipboard(prompt);
            openCustomModal(prompt);
        } else {
            console.error('No prompt generated for type:', promptType);
        }
    }

    function openCustomModal(content) {
        console.log('Debug: openCustomModal called with content:', content);
        try {
            if (typeof openGeneratedPromptModal === 'function') {
                openGeneratedPromptModal(content);
            } else {
                // Fallback: Display a simple alert or log
                console.warn('openGeneratedPromptModal not found, using fallback');
                alert('Generated prompt:\n' + content);
            }
        } catch (error) {
            console.error('Error opening modal:', error);
            alert('Generated prompt:\n' + content);
        }
    }


    function toggleDataOutcontainer() {
        const dataContainer = document.querySelector('.data-container-right');
        if (!dataContainer) {
            console.error('Data container not found.');
            return;
        }
    
        const isExpanded = dataContainer.dataset.state === 'expanded';
    
        if (isExpanded) {
            // Collapse the container
            dataContainer.classList.remove('expanded');
            dataContainer.classList.add('initial');
            dataContainer.dataset.state = 'initial';
            setLocal('dataOutContainerState', 'initial');
            dataContainer.innerHTML = `
                <span class="close-data-container">+</span>
                <span class="data-label">DATA OUT</span>
            `;
            console.log('Right data container collapsed and reset (calorieiq.js)');
        } else {
            // Expand the container
            dataContainer.classList.remove('initial');
            dataContainer.classList.add('expanded');
            dataContainer.dataset.state = 'expanded';
            setLocal('dataOutContainerState', 'expanded');
    
            const lastGridItemUrl = getLocal('lastGridItemUrl');
            const outputMap = {
                '/ai/calorie/calorieiq.html': '/ai/calorie/calorieiqout.html',
                '/ai/symptom/symptomiq.html': '/apioutput.html?gridItem=symptomiq',
                '/ai/book/bookiq.html': '/apioutput.html?gridItem=bookiq'
            };
    
            const outUrl = outputMap[lastGridItemUrl];
            if (outUrl) {
                setLocal('lastDataOutUrl', outUrl);
                loadStoredContent(dataContainer, outUrl);
            } else {
                dataContainer.innerHTML = `
                    <span class="close-data-container">-</span>
                    <span class="data-label">DATA OUT</span>
                    <div class="data-content">No relevant content available</div>
                `;
            }
            console.log('Right data container expanded (calorieiq.js)');
        }
    
        const newClose = dataContainer.querySelector('.close-data-container');
        const newLabel = dataContainer.querySelector('.data-label');
        if (newClose) {
            newClose.addEventListener('click', function (e) {
                e.preventDefault();
                toggleDataOutcontainer();
            });
        }
        if (newLabel) {
            newLabel.addEventListener('click', function (e) {
                e.preventDefault();
                toggleDataOutcontainer();
            });
        }
    }

    // function toggleDatainContainer() {
        
    //     const dataContainer = document.querySelector('.data-container-left');
    //     if (!dataContainer) {
    //         console.error('Left data container not found.');
    //         return;
    //     }
    
    //     const isExpanded = dataContainer.dataset.state === 'expanded';
    
    //     if (isExpanded) {
    //         // Collapse the container
    //         dataContainer.classList.remove('expanded');
    //         dataContainer.classList.add('initial');
    //         dataContainer.dataset.state = 'initial';
    //         setLocal('dataContainerState', 'initial');
    
    //         dataContainer.innerHTML = `
    //             <span class="close-data-container">+</span>
    //             <span class="data-label">DATA IN</span>
    //         `;
    
    //         console.log('Left data container collapsed and reset (calorieiq.js)');
    //     } else {
    //         dataContainer.classList.remove('initial');
    //         dataContainer.classList.add('expanded');
    //         dataContainer.dataset.state = 'expanded';
    //         setLocal('dataContainerState', 'expanded');
    
    //         console.log('Left data container expanded (calorieiq.js)');
    
    //         const storedUrl = getLocal('lastGridItemUrl');
    //         if (storedUrl) {
    //             loadStoredContent(dataContainer, storedUrl);
    //         }
    //     }
    
    //     const newClose = dataContainer.querySelector('.close-data-container');
    //     const newLabel = dataContainer.querySelector('.data-label');
    
    //     if (newClose) {
    //         newClose.addEventListener('click', function (e) {
    //             e.preventDefault();
    //             toggleDatainContainer();
    //         });
    //     }
    
    //     if (newLabel) {
    //         newLabel.addEventListener('click', function (e) {
    //             e.preventDefault();
    //             toggleDatainContainer();
    //         });
    //     }
    // }
    window.openCustomModal = openCustomModal;
    window.generatePrompt = generatePrompt;
    window.handleGetCalorieIq = handleGetCalorieIq;
})();


function setLocal(name, value, days) {
    // Handle undefined, null, or empty values
    if (value === undefined || value === null || value === '') {
        if (name.includes('_frequency')) {
            value = 'annually';
        } else if (name === 'RegionDropdown') {
            value = 'NONE';
        } else if (name === 'SubregionDropdown') {
            value = '';
        } else {
            value = '0'; // General default
        }
    } else {
        // Specific validation for RegionDropdown
        if (name === 'RegionDropdown' && !['CAN', 'USA'].includes(value)) {
            value = 'NONE';
        }
    }
    
    // Store in localStorage (days ignored as localStorage doesn't expire)
    localStorage.setItem(name, encodeURIComponent(value));
}

function getLocal(name) {
    const value = localStorage.getItem(name);
    console.log(`getLocal called for ${name}, stored value: ${value}`);
    
    if (value !== null) {
        const decodedValue = decodeURIComponent(value);
        console.log(`Decoded value for ${name}: ${decodedValue}`);
        
        if (decodedValue === '' || decodedValue === '0') {
            if (name.includes('_frequency')) return 'annually';
            return '';
        }
        
        if (name === 'RegionDropdown' && !['CAN', 'USA'].includes(decodedValue)) {
            console.log(`Invalid RegionDropdown value '${decodedValue}', returning 'NONE'`);
            return 'NONE';
        }
        
        return decodedValue;
    } else {
        console.log(`No value found for ${name}`);
        if (name.includes('_frequency')) return 'annually';
        if (name === 'RegionDropdown') return 'NONE';
        if (name === 'SubregionDropdown') return '';
        return '';
    }
}

async function loadStoredContent(dataContainer, url) {
    try {
        console.log(`Attempting to load stored content from ${url} (calorieiq.js)`);
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to fetch content from ${url}`);
        const content = await response.text();
        console.log('Stored content fetched successfully (calorieiq.js)');

        dataContainer.classList.remove('initial');
        dataContainer.classList.add('expanded');
        dataContainer.dataset.state = 'expanded';
        dataContainer.innerHTML = `
            <span class="close-data-container">-</span>
            <span class="data-label">DATA OUT</span>
            <div class="data-content">${content}</div>
        `;
        console.log(`Stored content loaded from ${url} into dataout container (calorieiq.js)`);

        const scriptUrl = url.replace('.html', '.js');
        try {
            const existingScripts = document.querySelectorAll(`script[data-source="${scriptUrl}"]`);
            existingScripts.forEach(script => script.remove());
            const scriptResponse = await fetch(scriptUrl);
            if (scriptResponse.ok) {
                const scriptContent = await scriptResponse.text();
                const script = document.createElement('script');
                script.textContent = scriptContent;
                script.dataset.source = scriptUrl;
                document.body.appendChild(script);
                console.log(`Loaded and executed script: ${scriptUrl} (calorieiq.js)`);
            }
        } catch (error) {
            console.log(`No script found or error loading ${scriptUrl}, skipping (calorieiq.js):`, error);
        }
    } catch (error) {
        console.error(`Error loading stored content (calorieiq.js):`, error);
        dataContainer.innerHTML = `
            <span class="close-data-container">-</span>
            <span class="data-label">DATA OUT</span>
            <div class="data-content">Error loading content</div>
        `;
    }
}


function waitForElement(selector) {
    let tries = 0;
    return new Promise((resolve, reject) => {
      const attempt = () => {
        const el = document.querySelector(selector);
        if (el) {
        //   console.log(`Element found: ${selector}`);
          resolve(el);
        } else {
          tries++;
          if (tries > 50) {
            reject(new Error(`Element not found after waiting: ${selector}`));
            return;
          }
          setTimeout(attempt, 100);
        }
      };
      attempt();
    });
  }
  
  async function findAllElements() {
   
  
    const entries = await Promise.all(
      Object.entries(spanSelectors).map(async ([key, selector]) => {
        const element = await waitForElement(selector);
        return [key, element];
      })
    );
  
    const elements = Object.fromEntries(entries);
    return elements;
  }


  var spanSelectors = {
    caloriesTarget: '#calories-target',
    caloriesIntake: '#calories-intake',
    caloriesPercent: '#calories-percent',
    proteinTarget: '#protein-target',
    proteinIntake: '#protein-intake',
    proteinPercent: '#protein-percent',
    carbsTarget: '#carbs-target',
    carbsIntake: '#carbs-intake',
    carbsPercent: '#carbs-percent',
    fatTarget: '#fat-target',
    fatIntake: '#fat-intake',
    fatPercent: '#fat-percent',
    fiberTarget: '#fiber-target',
    fiberIntake: '#fiber-intake',
    fiberPercent: '#fiber-percent',
    vitaminDTarget: '#vitaminD-target',
    vitaminDIntake: '#vitaminD-intake',
    vitaminDPercent: '#vitaminD-percent',
    ironTarget: '#iron-target',
    ironIntake: '#iron-intake',
    ironPercent: '#iron-percent',
    calciumTarget: '#calcium-target',
    calciumIntake: '#calcium-intake',
    calciumPercent: '#calcium-percent',
    mealRecommendation: '#meal-recommendation',
    bmi: '#BMI'
  };



  async function populateIn(storedFormData) {
            // console.log("Propagating stored form data into input fields, selects, and grid items.");
        
            async function waitForElement(selector) {
                let tries = 0;
                return new Promise((resolve, reject) => {
                    const attempt = () => {
                        const el = document.querySelector(selector);
                        if (el) {
                            resolve(el);
                        } else {
                            tries++;
                            if (tries > 50) {
                                reject(new Error(`Element not found after waiting: ${selector}`));
                                return;
                            }
                            setTimeout(attempt, 100);
                        }
                    };
                    attempt();
                });
            }
        
            if (storedFormData.goals && Array.isArray(storedFormData.goals)) {
                for (const goal of storedFormData.goals) {
                    try {
                        const goalElement = await waitForElement(`#calorie-goal .grid-item[data-value="${goal}"]`);
                        goalElement.classList.add('selected');
                        // console.log(`Goal selected: ${goal}`);
                    } catch (error) {
                        console.warn(`Goal element not found for value: ${goal}`);
                    }
                }
            }
        
            if (storedFormData.activityLevel) {
                try {
                    const activityElement = await waitForElement(`#calorie-activity .grid-item[data-value="${storedFormData.activityLevel}"]`);
                    activityElement.classList.add('selected');
                    // console.log(`Activity level selected: ${storedFormData.activityLevel}`);
                } catch (error) {
                    console.warn(`Activity level element not found for value: ${storedFormData.activityLevel}`);
                }
            }
        
            if (storedFormData.needMealRecommendation) {
                try {
                    const mealRecommendationElement = await waitForElement(`#calorie-recommendations .grid-item[data-value="Meal Recommendations"]`);
                    mealRecommendationElement.classList.add('selected');
                    // console.log("Meal recommendation selected.");
                } catch (error) {
                    console.warn("Meal recommendation element not found.");
                }
            }
        
            // Populate diet restriction (single grid item)
            if (storedFormData.dietRestriction) {
                try {
                    const dietElement = await waitForElement(`#calorie-diet-type .grid-item[data-value="${storedFormData.dietRestriction}"]`);
                    dietElement.classList.add('selected');
                    // console.log(`Diet restriction selected: ${storedFormData.dietRestriction}`);
                } catch (error) {
                    console.warn(`Diet restriction element not found for value: ${storedFormData.dietRestriction}`);
                }
            }
        
            // Populate age
            if (storedFormData.age) {
                try {
                    const ageInput = await waitForElement('#calorie-age');
                    ageInput.value = storedFormData.age;
                    // console.log(`Age populated: ${storedFormData.age}`);
                } catch (error) {
                    console.warn("Age input element not found.");
                }
            }
        
            if (storedFormData.height) {
                try {
                    const heightInput = await waitForElement('#calorie-height');
                    heightInput.value = storedFormData.height;
                    // console.log(`Height populated: ${storedFormData.height}`);
                } catch (error) {
                    console.warn("Height input element not found.");
                }
            }
        
            if (storedFormData.weight) {
                try {
                    const weightInput = await waitForElement('#calorie-weight');
                    // const weightUnitInput = await waitForElement('#calorie-weight-unit');
                    weightInput.value = storedFormData.weight;
                    // weightUnitInput.value = storedFormData.weight.unit;
                    // console.log(`Weight populated: ${storedFormData.weight.weight} ${storedFormData.weight.unit}`);
                } catch (error) {
                    console.warn("Weight input or unit element not found.");
                }
            }
        
            if (storedFormData.sex) {
                try {
                    const sexInput = await waitForElement('#calorie-sex');
                    sexInput.value = storedFormData.sex;
                    // console.log(`Sex populated: ${storedFormData.sex}`);
                } catch (error) {
                    console.warn("Sex input element not found.");
                }
            }
        
            if (storedFormData.foodLog) {
                try {
                    const foodLogInput = await waitForElement('#calorie-food-log');
                    foodLogInput.value = storedFormData.foodLog;
                    // console.log(`Food log populated: ${storedFormData.foodLog}`);
                } catch (error) {
                    console.warn("Food log input element not found.");
                }
            }
        
            console.log("Form data propagation completed.");
        }
</script>