<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->



<div class="device-container">
<div class="row1" data-step-label="Fitness Goal">
    <div class="grid-container" id="calorie-goal">
        <div class="grid-item" data-value="Lose Weight">I want to lose weight</div>
        <div class="grid-item" data-value="Gain Muscle">I want gain muscle</div>
        <div class="grid-item" data-value="Maintain Weight">I want maintain weight</div>
        <div class="grid-item" data-value="Improve Endurance">I want improve endurance</div>
    </div>
</div>

<div class="row1" data-step-label="Activity Level">
    <div class="grid-container" id="calorie-activity">
        <div class="grid-item" data-value="Sedentary">Sedentary (little to no exercise)</div>
        <div class="grid-item" data-value="Lightly Active">Lightly Active (light exercise 1-3 days/week)</div>
        <div class="grid-item" data-value="Moderately Active">Moderately Active (moderate exercise 3-5 days/week)</div>
        <div class="grid-item" data-value="Very Active">Very Active (hard exercise 6-7 days/week)</div>
        <div class="grid-item" data-value="Athlete">Athlete (intense training daily)</div>
    </div>
</div>

<div class="row1" data-step-label="Meal Planning">
    <div class="grid-container" id="calorie-recommendations">
        <div class="grid-item" data-value="Meal Recommendations">Need meal recommendations to make up deficit</div>
    </div>
</div>

<div class="row1" data-step-label="Dietary Preferences">
    <div class="grid-container" id="calorie-diet-type">
        <div class="grid-item" data-value="None">No Restrictions</div>
        <div class="grid-item" data-value="Vegetarian">Vegetarian</div>
        <div class="grid-item" data-value="Vegan">Vegan</div>
        <div class="grid-item" data-value="Gluten-Free">Gluten-Free</div>
        <div class="grid-item" data-value="Keto">Keto</div>
        <div class="grid-item" data-value="Paleo">Paleo</div>
        <div class="grid-item" data-value="Low-Carb">Low-Carb</div>
        <div class="grid-item" data-value="Mediterranean">Mediterranean</div>
    </div>
</div>

<div class="row1" data-step-label="Personal Information">
    <input id="calorie-age" type="text" placeholder="34">
    <input id="calorie-height" type="text" placeholder="5'10">
    <input id="calorie-weight" type="text" placeholder="70 kg">
    <select id="calorie-sex">
        <option value="" disabled selected>Select Gender</option>
        <option value="man">Man</option>
        <option value="woman">Woman</option>
    </select>
</div>

<div class="row1" data-step-label="Food Log">
    <input type="text" data-meal="breakfast" placeholder="Breakfast: 1 cup oatmeal, 0.5 cup berries, 1 tbsp honey">
    <input type="text" data-meal="lunch" placeholder="Lunch: 200g chicken, 150g salad, 2 tbsp olive oil">
    <input type="text" data-meal="dinner" placeholder="Dinner: 6 oz salmon, 1/2 cup quinoa, 100g broccoli">
    <button class="generate-btn" id="generate-calorie-btn">Generate Now!</button>
    <button class="clear-btn" id="clear-calorie-btn">Clear All</button>
</div>
   
</div> 

<script>
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

(function() {
  console.log("Calorie IQ script initializing");

  // Reintroduce addMealInput for dynamic meal inputs
  function addMealInput(mealType = null, value = '', skipRepositioning = false) {
    const inputGroup = document.createElement('div');
    inputGroup.style.cssText = 'display: flex; align-items: center; gap: 8px; margin: 8px auto; max-width: 460px; width: 100%;';
    
    const input = document.createElement('input');
    input.type = 'text';
    
    // Generate a unique meal type if none provided
    if (!mealType) {
      const existingMeals = document.querySelectorAll('input[data-meal]');
      mealType = `snack${existingMeals.length + 1}`;
    }
    
    // Set placeholder with measurement suggestions
    let placeholderText = '';
    if (mealType === 'breakfast') {
      placeholderText = 'Breakfast: 1 cup oatmeal, 0.5 cup berries, 1 tbsp honey';
    } else if (mealType === 'lunch') {
      placeholderText = 'Lunch: 200g chicken, 150g salad, 2 tbsp olive oil';
    } else if (mealType === 'dinner') {
      placeholderText = 'Dinner: 6 oz salmon, 1/2 cup quinoa, 100g broccoli';
    } else if (mealType && mealType.startsWith('snack')) {
      placeholderText = `${mealType.charAt(0).toUpperCase()+mealType.slice(1)}: 30g nuts, 1 medium apple`;
    } else {
      placeholderText = `${mealType ? mealType.charAt(0).toUpperCase()+mealType.slice(1) : 'Meal'}: 100g yogurt, 2 oz crackers`;
    }
    input.placeholder = placeholderText;
    input.style.cssText = 'flex: 1; margin: 0; width: 100%; height: 40px; padding: 8px 12px; font-size: 16px; line-height: 1.5; border: 1px solid #7c7c7c; border-radius: 6px; background-color: #f9f9f9; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); outline: none; transition: border-color 0.2s ease, box-shadow 0.2s ease; font-family: "Inter", sans-serif; box-sizing: border-box;';
    
    // Always set data-meal attribute for proper data collection
    input.dataset.meal = mealType;
    
    inputGroup.appendChild(input);
    
    const removeBtn = document.createElement('button');
    removeBtn.innerText = 'Ã—';
    removeBtn.style.cssText = 'width: 40px; height: 40px; border: 1.5px solid #000; border-radius: 6px; background-color: #fff; color: #000; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; box-shadow: 3px 3px 0.5px #000;';
    removeBtn.addEventListener('click', () => { 
      inputGroup.remove(); 
      // Only reposition button if not during form repopulation
      if (!skipRepositioning) {
        ensureAddButton();
      }
      // Save the current state after removing the input
      window.calorieFormPersistence.saveFormData();
    });
    removeBtn.addEventListener('mouseenter', () => { removeBtn.style.backgroundColor = '#e9e9e9'; });
    removeBtn.addEventListener('mouseleave', () => { removeBtn.style.backgroundColor = '#fff'; });
    inputGroup.appendChild(removeBtn);
    
    // Find the main food log container (row1) to add the new input below the existing ones
    const foodLogSection = document.querySelector('.row1:last-child');
    if (!foodLogSection) {
      console.error('[CalorieIQ] Could not find food log section');
      return;
    }
    
    // Find the generate button to insert before it
    const generateBtn = document.getElementById('generate-calorie-btn');
    if (generateBtn) {
      foodLogSection.insertBefore(inputGroup, generateBtn);
      console.log('[CalorieIQ] Added new meal input before generate button');
    } else {
      // Fallback: add to the end of the food log section
      foodLogSection.appendChild(inputGroup);
      console.log('[CalorieIQ] Added new meal input at end of food log section');
    }
    
    if (value) input.value = value;
    
    // Only trigger button management if not during form repopulation
    if (!skipRepositioning) {
      ensureAddButton();
      input.focus();
      
      // Save form data after adding new input
      window.calorieFormPersistence.saveFormData();
    }
  }

  // Simple, robust function to create and manage the add button
  function ensureAddButton() {
    console.log('[CalorieIQ] Ensuring add button exists...');
    
    // Check if button already exists
    if (document.getElementById('multifield-add-btn')) {
      console.log('[CalorieIQ] Add button already exists');
      return;
    }
    
    // Find the dinner input
    const dinnerInput = document.querySelector('input[data-meal="dinner"]');
    if (!dinnerInput) {
      console.error('[CalorieIQ] No dinner input found');
      return;
    }
    
    // Check if dinner input is already in a flex container
    if (dinnerInput.parentNode.style.display === 'flex') {
      console.log('[CalorieIQ] Dinner input already in flex container');
      return;
    }
    
    // Create flex container wrapper
    const flexContainer = document.createElement('div');
    flexContainer.style.cssText = 'display: flex; align-items: center; gap: 8px; margin: 8px auto; max-width: 460px; width: 100%;';
    
    // Insert flex container before dinner input
    dinnerInput.parentNode.insertBefore(flexContainer, dinnerInput);
    
    // Move dinner input into flex container and make it flex
    flexContainer.appendChild(dinnerInput);
    dinnerInput.style.flex = '1';
    
    // Create the add button
    const addBtn = document.createElement('button');
    addBtn.id = 'multifield-add-btn';
    addBtn.title = 'Add another meal/snack';
    addBtn.innerText = '+';
    addBtn.style.cssText = 'width: 40px; height: 40px; border: 1.5px solid #000; border-radius: 6px; background-color: #fff; color: #000; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; box-shadow: 3px 3px 0.5px #000;';
    addBtn.onclick = () => addMealInput();
    addBtn.onmouseenter = () => addBtn.style.backgroundColor = '#e9e9e9';
    addBtn.onmouseleave = () => addBtn.style.backgroundColor = '#fff';
    
    // Add button to flex container
    flexContainer.appendChild(addBtn);
    console.log('[CalorieIQ] Add button created and positioned in flex container');
  }

  async function handleGenerateCalorieIq() {
    try {
      const formData = window.calorieFormPersistence.getSavedFormData();
      if (!formData) { 
        alert('Please complete the form before generating a calorie plan.'); 
        return;
      }

      // Use enhanced loading with educational facts
      const result = await window.enhancedLoading(
        'generate-calorie-btn',
        'calorie',
        async () => {
          const apiUrl = 'https://calorie.4hm7q4q75z.workers.dev/';
          const response = await fetch(apiUrl, { 
            method: 'POST', 
            headers: {'Content-Type':'application/json'}, 
            body: JSON.stringify(formData) 
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          
          const responseData = await response.json();
          if (responseData.message !== 'Success') {
            throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
          }
          
          return responseData;
        }
      );

      // Store the response using centralized system
      window.calorieFormPersistence.saveResponseData(result);
      
      // Dispatch an event to notify dataout.js that a response was received
      const event = new CustomEvent('api-response-received', {
        detail: {
          module: 'calorieiq',
          type: 'worker-response',
          timestamp: Date.now()
        }
      });
      document.dispatchEvent(event);
      console.log('[CalorieIQ] Dispatched api-response-received event');
      
    } catch (error) {
      console.error('[CalorieIQ] Error generating calorie plan:', error);
      alert('An error occurred while generating your calorie plan. Please try again later.');
    }
  }

  // Simple initialization - just ensure the add button exists
  function initialize() {
    console.log("[CalorieIQ] Initializing...");
    
    // Set up event listeners
    const generateBtn = document.getElementById('generate-calorie-btn');
    if (generateBtn) {
      generateBtn.removeEventListener('click', handleGenerateCalorieIq);
      generateBtn.addEventListener('click', handleGenerateCalorieIq);
    }
    
    const clearBtn = document.getElementById('clear-calorie-btn');
    if (clearBtn) {
      clearBtn.removeEventListener('click', () => window.calorieFormPersistence.clearLocalStorage());
      clearBtn.addEventListener('click', () => window.calorieFormPersistence.clearLocalStorage());
    }
    
    // Set up guided forms toggle button
    const guidedToggleBtn = document.getElementById('guided-forms-toggle');
    if (guidedToggleBtn) {
      guidedToggleBtn.removeEventListener('click', toggleGuidedForms);
      guidedToggleBtn.addEventListener('click', toggleGuidedForms);
    }
    
    // Simply ensure the add button exists
    ensureAddButton();
  }

  // Toggle guided forms functionality
  let guidedFormsInstance = null;
  
  function toggleGuidedForms() {
    console.log('[CalorieIQ] Toggling guided forms');
    const toggleBtn = document.getElementById('guided-forms-toggle');
    
    if (guidedFormsInstance) {
      // Disable guided forms
      guidedFormsInstance.destroy();
      guidedFormsInstance = null;
      toggleBtn.textContent = 'ðŸš€ Enable Guided Form';
      toggleBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      console.log('[CalorieIQ] Guided forms disabled');
    } else {
      // Enable guided forms
      if (window.GuidedFormSystem) {
        guidedFormsInstance = new window.GuidedFormSystem({
          autoAdvance: true,
          showProgressIndicator: true,
          smoothTransitions: true,
          transitionDuration: 300,
          autoAdvanceDelay: 800,
          enableSkipping: true
        });
        
        guidedFormsInstance.init('device-container');
        
        toggleBtn.textContent = 'â¹ï¸ Disable Guided Form';
        toggleBtn.style.background = 'linear-gradient(135deg, #ea667e 0%, #a24b76 100%)';
        console.log('[CalorieIQ] Guided forms enabled');
      } else {
        console.error('[CalorieIQ] GuidedFormSystem not available');
        alert('Guided forms system is not loaded. Please refresh the page.');
      }
    }
  }

  // Initialize with multiple triggers to ensure reliability
  function runInitialization() {
    // Use a small delay to ensure DOM is ready
    setTimeout(initialize, 50);
  }

  // Initialize immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runInitialization);
  } else {
    runInitialization();
  }

  // Handle loading through datain.js
  document.addEventListener('data-in-loaded', function(e) {
    console.log("[CalorieIQ] Detected load through datain.js, reinitializing");
    runInitialization();
  });

  // Additional safety net - try again after a short delay
  setTimeout(() => {
    if (!document.getElementById('multifield-add-btn')) {
      console.log("[CalorieIQ] Add button not found, trying initialization again");
      initialize();
    }
  }, 200);
  
  // Export functions for external access
  window.calorieIq = { 
    addMealInput,
    getFormData: () => window.calorieFormPersistence.getSavedFormData(),
    saveFormData: () => window.calorieFormPersistence.saveFormData(),
    clearLocalStorage: () => window.calorieFormPersistence.clearLocalStorage()
  };
})();
</script>



