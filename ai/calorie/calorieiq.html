<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

 <div class="row1">
    <div class="grid-container" id="calorie-goal">
        <div class="grid-item" data-value="Lose Weight">I want to lose weight</div>
        <div class="grid-item" data-value="Gain Muscle">I want gain muscle</div>
        <div class="grid-item" data-value="Maintain Weight">I want maintain weight</div>
        <div class="grid-item" data-value="Improve Endurance">I want improve endurance</div>
    </div>
</div>

<div class="row1">
    <div class="grid-container" id="calorie-activity">
        <div class="grid-item" data-value="Sedentary">Sedentary (little to no exercise)</div>
        <div class="grid-item" data-value="Lightly Active">Lightly Active (light exercise 1-3 days/week)</div>
        <div class="grid-item" data-value="Moderately Active">Moderately Active (moderate exercise 3-5 days/week)</div>
        <div class="grid-item" data-value="Very Active">Very Active (hard exercise 6-7 days/week)</div>
        <div class="grid-item" data-value="Athlete">Athlete (intense training daily)</div>
    </div>
</div>

<div class="row1">
    <div class="grid-container" id="calorie-recommendations">
        <div class="grid-item" data-value="Meal Recommendations">Need meal recommendations to make up deficit</div>
    </div>
</div>

<div class="row1">
    <div class="grid-container" id="calorie-diet-type">
        <div class="grid-item" data-value="None">No Restrictions</div>
        <div class="grid-item" data-value="Vegetarian">Vegetarian</div>
        <div class="grid-item" data-value="Vegan">Vegan</div>
        <div class="grid-item" data-value="Gluten-Free">Gluten-Free</div>
        <div class="grid-item" data-value="Keto">Keto</div>
        <div class="grid-item" data-value="Paleo">Paleo</div>
        <div class="grid-item" data-value="Low-Carb">Low-Carb</div>
        <div class="grid-item" data-value="Mediterranean">Mediterranean</div>
    </div>
</div>

<div class="twoperrow">
    <input type="number" inputmode="numeric" id="calorie-age" placeholder="Age" min="0">
    <div class="rowuom">
        <input type="number" id="calorie-height" placeholder="Height" step="0.1" min="0">
        <select id="calorie-height-unit">
            <option value="ft" selected>FT</option>
            <option value="cm">CM</option>
        </select>
    </div>
</div>
<div class="rowuom">
    <input type="number" inputmode="numeric" id="calorie-weight" placeholder="Weight" step="0.1" min="0">
    <select id="calorie-weight-unit">
        <option value="lbs" selected>LB</option>
        <option value="kg">KG</option>
    </select>
</div>
<select id="calorie-measure">
    <option value="man" selected>Man</option>
    <option value="woman">Woman</option>
</select>

<textarea id="calorie-food-log" rows="3" placeholder="Meals:
Chicken breast 200g with rice 1cup
Potato 100g with broccoli 150g"></textarea>
<button class="generate-btn" onclick="handleGetCalorieIq(event)">Generate Now!</button>
<button class="clear-btn">Clear All</button>

<script>
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be prosecuted to the fullest extent of the law in British Columbia, Canada, and applicable jurisdictions worldwide.
 */
(function () {
    console.log('CalorieIQ script started executing (calorieiq.html)');

    // Wait for DOM to be ready and handle dynamic content
    document.addEventListener('DOMContentLoaded', function () {
        initializeForm();
        console.log('DOMContentLoaded fired, initializeForm called (calorieiq.html)');
    });

    // Handle input changes
    document.addEventListener('change', function (e) {
        const target = e.target;
        if (target.matches('input, textarea, select')) {
            saveInput(target);
        }
    });

    // Handle clear button
    document.addEventListener('click', function (e) {
        const target = e.target;
        if (target.classList.contains('clear-btn')) {
            clearLocalStorage();
        }
    });

    // Initialize form (repopulate from localStorage)
    function initializeForm() {
        repopulateForm();

        // Auto-resize textareas
        document.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('input', function () {
                this.style.height = '100px';
                this.style.height = `${this.scrollHeight}px`;
            });
        });
    }

    function saveInput(input) {
        const key = `input_${input.id}`;
        const value = input.value;
        try {
            localStorage.setItem(key, value);
            console.log(`Saved ${key}: ${value} (calorieiq.html)`);
        } catch (error) {
            console.error(`Error saving input ${key}:`, error);
        }
    }

    async function handleGetCalorieIq(e) {
        const btn = e.target;
        const initialText = btn.innerText;
        btn.innerText = 'Loading...';
        btn.setAttribute('disabled', 'true');

        console.log('Debug: handleGetCalorieIq function called (calorieiq.html)');
        const formData = getFormData();
        if (!formData) {
            console.error('Form data is invalid or incomplete (calorieiq.html)');
            btn.innerText = initialText;
            btn.removeAttribute('disabled');
            return;
        }

        console.log('Processed form data:', formData);
        localStorage.setItem("calorieIqFormData", JSON.stringify(formData));

        const apiUrl = 'https://ocejuhqqla5zdps4uaiogwswki0vaclp.lambda-url.us-east-1.on.aws/';

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            if (data.message !== 'Success') {
                throw new Error(`An error occurred: ${data.message || data.error || ''}`);
            }

            console.log('API response:', data);
            btn.innerText = "Success";
            localStorage.setItem('calorieIqResponse', JSON.stringify(data));

            // Trigger data out container with a specific event
            localStorage.setItem('lastDataOutUrl', '/ai/calorie/calorieiqout.html');
            document.dispatchEvent(new CustomEvent('dataOutRequested', {
                detail: { url: '/ai/calorie/calorieiqout.html' }
            }));

            setTimeout(() => {
                btn.innerText = initialText;
                btn.removeAttribute('disabled');
            }, 3000);
        } catch (error) {
            console.error('Error fetching data from API:', error);
            alert('An error occurred while fetching data. Please try again later.');
            btn.innerText = error.message;
            btn.removeAttribute('disabled');

            setTimeout(() => {
                btn.innerText = initialText;
                btn.removeAttribute('disabled');
            }, 4000);
        }
    }

    function getFormData() {
        console.log('Debug: getFormData function called (calorieiq.html)');

        const formData = {
            goals: [],
            activityLevel: null,
            needMealRecommendation: false,
            dietRestriction: null,
            age: null,
            height: {
                height: null,
                unit: null
            },
            weight: {
                weight: null,
                unit: null
            },
            sex: null,
            foodLog: null
        };

        // Goals
        const selectedGoals = document.querySelectorAll('#calorie-goal .grid-item.selected');
        if (selectedGoals.length === 0) {
            alert('Please select at least one goal.');
            return;
        }
        selectedGoals.forEach(item => {
            formData.goals.push(item.dataset.value);
        });

        // Activity level
        const activityLevel = document.querySelector('#calorie-activity .grid-item.selected');
        if (!activityLevel) {
            alert('Please select your activity level.');
            return;
        }
        formData.activityLevel = activityLevel.dataset.value;

        // Meal recommendation
        const mealRecommendation = document.querySelector('#calorie-recommendations .grid-item.selected');
        if (mealRecommendation) {
            formData.needMealRecommendation = true;
        }

        // Diet restriction
        const dietRestriction = document.querySelector('#calorie-diet-type .grid-item.selected');
        if (!dietRestriction) {
            alert('Please select your diet restriction.');
            return;
        }
        formData.dietRestriction = dietRestriction.dataset.value;

        // Age
        const ageInput = document.getElementById('calorie-age');
        if (!ageInput?.value || isNaN(ageInput.value) || parseInt(ageInput.value, 10) <= 0) {
            alert('Please enter a valid age.');
            return;
        }
        formData.age = parseInt(ageInput.value, 10);

        // Height and unit
        const heightInput = document.getElementById('calorie-height');
        const heightUnitInput = document.getElementById('calorie-height-unit');
        if (!heightInput?.value || isNaN(heightInput.value) || parseFloat(heightInput.value) <= 0) {
            alert('Please enter a valid height.');
            return;
        }
        if (!heightUnitInput?.value) {
            alert('Please select a height unit.');
            return;
        }
        formData.height.height = parseFloat(heightInput.value);
        formData.height.unit = heightUnitInput.value;

        // Weight and unit
        const weightInput = document.getElementById('calorie-weight');
        const weightUnitInput = document.getElementById('calorie-weight-unit');
        if (!weightInput?.value || isNaN(weightInput.value) || parseFloat(weightInput.value) <= 0) {
            alert('Please enter a valid weight.');
            return;
        }
        if (!weightUnitInput?.value) {
            alert('Please select a weight unit.');
            return;
        }
        formData.weight.weight = parseFloat(weightInput.value);
        formData.weight.unit = weightUnitInput.value;

        // Sex
        const sexInput = document.getElementById('calorie-measure');
        if (!sexInput?.value) {
            alert('Please select your sex.');
            return;
        }
        formData.sex = sexInput.value;

        // Food log
        const foodLogInput = document.getElementById('calorie-food-log');
        if (foodLogInput?.value.trim()) {
            formData.foodLog = foodLogInput.value.trim();
        } else {
            formData.foodLog = '';
        }

        return formData;
    }

    function repopulateForm() {
        document.querySelectorAll('input, textarea').forEach(input => {
            const key = `input_${input.id}`;
            const value = localStorage.getItem(key);
            if (value !== null) {
                input.value = value;
                console.log(`Restored ${key}: ${value} (calorieiq.html)`);
            }
        });

        document.querySelectorAll('select').forEach(select => {
            const key = `input_${select.id}`;
            const value = localStorage.getItem(key);
            if (value !== null) {
                const optionExists = Array.from(select.options).some(opt => opt.value === value);
                if (optionExists) {
                    select.value = value;
                    console.log(`Restored ${key}: ${value} (calorieiq.html)`);
                } else {
                    console.warn(`Skipped restoring ${key}: value "${value}" not found in options (calorieiq.html)`);
                }
            }
        });
    }

    function clearLocalStorage() {
        if (!confirm("Are you sure you want to clear all saved data? This action cannot be undone.")) {
            console.log("User canceled the clear action (calorieiq.html)");
            return;
        }
        document.querySelectorAll('.grid-container .grid-item').forEach(item => {
            const key = `grid_${item.parentElement.id}_${item.dataset.value.replace(/\s+/g, '_')}`;
            try {
                localStorage.removeItem(key);
                item.classList.remove('selected');
                console.log(`Cleared ${key} (calorieiq.html)`);
            } catch (error) {
                console.error(`Error clearing ${key}:`, error);
            }
        });
        document.querySelectorAll('input, textarea, select').forEach(input => {
            const key = `input_${input.id}`;
            try {
                localStorage.removeItem(key);
                input.value = '';
                console.log(`Cleared ${key} (calorieiq.html)`);
            } catch (error) {
                console.error(`Error clearing ${key}:`, error);
            }
        });
        const weightUnit = document.getElementById('calorie-weight-unit');
        if (weightUnit) weightUnit.value = 'lbs';
        const heightUnit = document.getElementById('calorie-height-unit');
        if (heightUnit) heightUnit.value = 'ft';
        console.log("All saved data cleared and form reset (calorieiq.html)");
    }

    // Expose necessary function globally
    window.handleGetCalorieIq = handleGetCalorieIq;
    console.log('CalorieIQ script finished executing (calorieiq.html)');
})();
</script>