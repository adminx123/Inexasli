<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

<div class="device-container">

<div class="row1">
    <label class="category-label">Fitness Goal</label>
    <div class="grid-container" id="calorie-goal">
        <div class="grid-item" data-value="Lose Weight">I want to lose weight</div>
        <div class="grid-item" data-value="Gain Muscle">I want gain muscle</div>
        <div class="grid-item" data-value="Maintain Weight">I want maintain weight</div>
        <div class="grid-item" data-value="Improve Endurance">I want improve endurance</div>
    </div>
</div>

<div class="row1">
    <label class="category-label">Activity Level</label>
    <div class="grid-container" id="calorie-activity">
        <div class="grid-item" data-value="Sedentary">Sedentary (little to no exercise)</div>
        <div class="grid-item" data-value="Lightly Active">Lightly Active (light exercise 1-3 days/week)</div>
        <div class="grid-item" data-value="Moderately Active">Moderately Active (moderate exercise 3-5 days/week)</div>
        <div class="grid-item" data-value="Very Active">Very Active (hard exercise 6-7 days/week)</div>
        <div class="grid-item" data-value="Athlete">Athlete (intense training daily)</div>
    </div>
</div>

<div class="row1">
    <label class="category-label">Meal Planning</label>
    <div class="grid-container" id="calorie-recommendations">
        <div class="grid-item" data-value="Meal Recommendations">Need meal recommendations to make up deficit</div>
    </div>
</div>

<div class="row1">
    <label class="category-label">Dietary Preferences</label>
    <div class="grid-container" id="calorie-diet-type">
        <div class="grid-item" data-value="None">No Restrictions</div>
        <div class="grid-item" data-value="Vegetarian">Vegetarian</div>
        <div class="grid-item" data-value="Vegan">Vegan</div>
        <div class="grid-item" data-value="Gluten-Free">Gluten-Free</div>
        <div class="grid-item" data-value="Keto">Keto</div>
        <div class="grid-item" data-value="Paleo">Paleo</div>
        <div class="grid-item" data-value="Low-Carb">Low-Carb</div>
        <div class="grid-item" data-value="Mediterranean">Mediterranean</div>
    </div>
</div>

<div class="row1">
    <label class="category-label">Personal Information</label>
    <input id="calorie-age" type="text" placeholder="Age">
    <input id="calorie-height" type="text" placeholder="Height eg. 2 meters">
    <input id="calorie-weight" type="text" placeholder="Weight eg. 100 lbs">
    <select id="calorie-sex">
        <option value="man" selected>Man</option>
        <option value="woman">Woman</option>
    </select>
</div>

<div class="row1">
    <label class="category-label">Food Log</label>
    <input type="text" data-meal="breakfast" placeholder="Breakfast: e.g., Oatmeal with berries">
    <input type="text" data-meal="lunch" placeholder="Lunch: e.g., Chicken salad with vegetables">
    <input type="text" data-meal="dinner" placeholder="Dinner: e.g., Salmon with quinoa and broccoli">
    <button id="multifield-add-btn" class="multifield-add-btn" title="Add another meal/snack">+</button>
 <button class="generate-btn" id="generate-calorie-btn">Generate Now!</button>
    <button class="clear-btn" id="clear-calorie-btn">Clear All</button>
</div>
   
</div> 

<script>
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/
(function() {
  console.log("Calorie IQ script initializing");

  // JSON storage helpers
  const setJSON = window.setJSON || function(name, value) {
    try {
      if (!name) return false;
      if (value === undefined) { localStorage.removeItem(name); return true; }
      localStorage.setItem(name, JSON.stringify(value));
      console.log(`[CalorieIQ] JSON saved ${name}`);
      return true;
    } catch (e) { console.error(`[CalorieIQ] Error storing JSON: ${e}`); return false; }
  };
  const getJSON = window.getJSON || function(name, defaultValue) {
    try {
      const item = localStorage.getItem(name);
      return item ? JSON.parse(item) : defaultValue;
    } catch (e) { console.error(`[CalorieIQ] Error retrieving JSON: ${e}`); return defaultValue; }
  };

  function saveGridItem(item) {
    console.log('[CalorieIQ] Saving all form data to JSON');
    setJSON('calorieIqInput', collectFormData());
  }
  
  // Listen for grid-item-toggled event from datain.js
  function handleGridItemToggled(event) {
    console.log('[CalorieIQ] Grid item toggled event received');
    const item = event.detail.item;
    const container = item.closest('.grid-container');
    
    // Handle single-selection logic for specific containers if needed
    // (No single-selection containers in calorieiq.html, but keeping structure for consistency)
    
    saveGridItem(item);
  }

  function saveInput(input) {
    console.log('[CalorieIQ] Saving all form data to JSON');
    setJSON('calorieIqInput', collectFormData());
  }

  function collectFormData() {
    const formData = { 
      goal: [], 
      activity: [], 
      recommendations: [], 
      dietType: [], 
      age: null, 
      height: null, 
      weight: null, 
      sex: null, 
      meals: []
    };
    
    // Collect selected grid items
    document.querySelectorAll('#calorie-goal .grid-item.selected').forEach(i => formData.goal.push(i.dataset.value));
    document.querySelectorAll('#calorie-activity .grid-item.selected').forEach(i => formData.activity.push(i.dataset.value));
    document.querySelectorAll('#calorie-recommendations .grid-item.selected').forEach(i => formData.recommendations.push(i.dataset.value));
    document.querySelectorAll('#calorie-diet-type .grid-item.selected').forEach(i => formData.dietType.push(i.dataset.value));
    
    // Collect input fields
    const ageEl = document.getElementById('calorie-age');
    if (ageEl && ageEl.value.trim()) formData.age = ageEl.value.trim();
    
    const heightEl = document.getElementById('calorie-height');
    if (heightEl && heightEl.value.trim()) formData.height = heightEl.value.trim();
    
    const weightEl = document.getElementById('calorie-weight');
    if (weightEl && weightEl.value.trim()) formData.weight = weightEl.value.trim();
    
    const sexEl = document.getElementById('calorie-sex');
    if (sexEl) formData.sex = sexEl.value;
    
    // Collect meal inputs
    document.querySelectorAll('input[data-meal]').forEach(input => {
      if (input.value.trim()) {
        formData.meals.push({
          type: input.dataset.meal || 'meal',
          content: input.value.trim()
        });
      }
    });
    
    return formData;
  }

  function repopulateForm() {
    console.log('[CalorieIQ] Repopulating form from JSON storage');
    const data = getJSON('calorieIqInput', null);
    if (!data) return;
    
    // Repopulate grid selections
    if (data.goal && Array.isArray(data.goal)) {
      data.goal.forEach(v => document.querySelector(`#calorie-goal .grid-item[data-value="${v}"]`)?.classList.add('selected'));
    }
    
    if (data.activity && Array.isArray(data.activity)) {
      data.activity.forEach(v => document.querySelector(`#calorie-activity .grid-item[data-value="${v}"]`)?.classList.add('selected'));
    }
    
    if (data.recommendations && Array.isArray(data.recommendations)) {
      data.recommendations.forEach(v => document.querySelector(`#calorie-recommendations .grid-item[data-value="${v}"]`)?.classList.add('selected'));
    }
    
    if (data.dietType && Array.isArray(data.dietType)) {
      data.dietType.forEach(v => document.querySelector(`#calorie-diet-type .grid-item[data-value="${v}"]`)?.classList.add('selected'));
    }
    
    // Repopulate form fields
    if (data.age) document.getElementById('calorie-age').value = data.age;
    if (data.height) document.getElementById('calorie-height').value = data.height;
    if (data.weight) document.getElementById('calorie-weight').value = data.weight;
    if (data.sex) document.getElementById('calorie-sex').value = data.sex;
    
    // Repopulate meals
    if (data.meals && Array.isArray(data.meals)) {
      // Clear existing meal inputs first
      document.querySelectorAll('input[data-meal]').forEach(input => input.value = '');
      
      data.meals.forEach((meal, index) => {
        const existingInput = document.querySelector(`[data-meal="${meal.type}"]`);
        if (existingInput) {
          existingInput.value = meal.content;
        } else {
          // Add new meal input if it doesn't exist
          addMealInput(meal.type, meal.content);
        }
      });
    }
    
    // Handle legacy foodLog format for backward compatibility
    if (data.foodLog && !data.meals) {
      const lines = data.foodLog.split('\n').filter(line => line.trim());
      lines.forEach((line, index) => {
        const mealTypes = ['breakfast', 'lunch', 'dinner'];
        const mealType = mealTypes[index] || `meal${index + 1}`;
        const existingInput = document.querySelector(`[data-meal="${mealType}"]`);
        if (existingInput) {
          existingInput.value = line.trim();
        } else {
          addMealInput(mealType, line.trim());
        }
      });
    }
  }

  function setupInputHandlers() {
    // Use event delegation to handle both existing and dynamically added inputs
    document.addEventListener('change', function(event) {
      if (event.target.matches('input, textarea, select')) {
        saveInput(event.target);
      }
    });
    
    document.addEventListener('input', function(event) {
      if (event.target.matches('input[data-meal], textarea')) {
        saveInput(event.target);
      }
    });
    
    document.addEventListener('blur', function(event) {
      if (event.target.matches('input[data-meal]')) {
        saveInput(event.target);
      }
    });
  }

  function clearLocalStorage() {
    if (!confirm('Are you sure you want to clear all saved data? This action cannot be undone.')) return;
    setJSON('calorieIqInput', undefined);
    setJSON('calorieIqResponse', undefined);
    document.querySelectorAll('.grid-container .grid-item').forEach(i => i.classList.remove('selected'));
    document.querySelectorAll('input, textarea').forEach(i => i.value = '');
    document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
    
    // Remove any additional meal inputs (keep only breakfast, lunch, dinner)
    const mealInputs = document.querySelectorAll('input[data-meal]');
    mealInputs.forEach((input, index) => {
      if (index >= 3) {
        input.closest('div').remove();
      }
    });
  }

  // Reintroduce addMealInput for dynamic meal inputs
  function addMealInput(mealType = null, value = '') {
    const addBtn = document.getElementById('multifield-add-btn');
    const inputGroup = document.createElement('div');
    inputGroup.style.cssText = 'display: flex; align-items: center; gap: 8px; margin: 8px auto; max-width: 460px; width: 100%;';
    
    const input = document.createElement('input');
    input.type = 'text';
    
    // Generate a unique meal type if none provided
    if (!mealType) {
      const existingMeals = document.querySelectorAll('input[data-meal]');
      mealType = `snack${existingMeals.length + 1}`;
    }
    
    input.placeholder = mealType ? `${mealType.charAt(0).toUpperCase()+mealType.slice(1)}: ` : 'Meal:';
    input.style.cssText = 'flex: 1; margin: 0; width: 100%; height: 40px; padding: 8px 12px; font-size: 16px; line-height: 1.5; border: 1px solid #7c7c7c; border-radius: 6px; background-color: #f9f9f9; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); outline: none; transition: border-color 0.2s ease, box-shadow 0.2s ease; font-family: "Inter", sans-serif; box-sizing: border-box;';
    
    // Always set data-meal attribute for proper data collection
    input.dataset.meal = mealType;
    
    inputGroup.appendChild(input);
    
    const removeBtn = document.createElement('button');
    removeBtn.innerText = '×';
    removeBtn.style.cssText = 'width: 40px; height: 40px; border: 1px solid #7c7c7c; border-radius: 6px; background-color: #f9f9f9; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;';
    removeBtn.addEventListener('click', () => { 
      inputGroup.remove(); 
      // Save the current state after removing the input
      setJSON('calorieIqInput', collectFormData());
    });
    removeBtn.addEventListener('mouseenter', () => { removeBtn.style.backgroundColor = '#e9e9e9'; });
    removeBtn.addEventListener('mouseleave', () => { removeBtn.style.backgroundColor = '#f9f9f9'; });
    inputGroup.appendChild(removeBtn);
    
    addBtn.parentNode.insertBefore(inputGroup, addBtn);
    if (value) input.value = value;
    
    // Event delegation will handle the events, so no need to add listeners here
    input.focus();
  }

  // Bind addMealInput to "+" button
  const addBtn = document.getElementById('multifield-add-btn');
  addBtn.addEventListener('click', () => addMealInput());

  async function handleGenerateCalorieIq() {
    const btn = document.getElementById('generate-calorie-btn');
    const initText = btn.innerText;
    btn.innerText = 'Loading...'; btn.disabled = true;
    try {
      const formData = getJSON('calorieIqInput');
      if (!formData) { alert('Please complete the form before generating a calorie plan.'); throw new Error('No input data'); }
      const apiUrl = 'https://calorie.4hm7q4q75z.workers.dev/'; // Update with the correct endpoint
      const resp = await fetch(apiUrl, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(formData) });
      if (!resp.ok) throw new Error(`HTTP error! Status: ${resp.status}`);
      const data = await resp.json();
      setJSON('calorieIqResponse', data);
      btn.innerText = 'Success!'; setTimeout(() => btn.disabled = false, 1000);
      document.dispatchEvent(new CustomEvent('api-response-received', { detail: { module: 'calorieiq', type: 'worker-response', timestamp: Date.now() } }));
    } catch (e) {
      console.error('[CalorieIQ] Error:', e);
      alert('An error occurred while generating your calorie plan.');
      btn.innerText = 'Error'; setTimeout(() => { btn.innerText = initText; btn.disabled = false; }, 2000);
    }
  }

  // Removed multifield script and related handlers
  document.getElementById('generate-calorie-btn').addEventListener('click', handleGenerateCalorieIq);
  document.getElementById('clear-calorie-btn').addEventListener('click', clearLocalStorage);

  // Initialize storage and handlers
  document.addEventListener('grid-item-toggled', handleGridItemToggled);
  repopulateForm();
  setupInputHandlers();
  setupConstraintInputs();
  
  // Export for potential external access
  window.calorieIq = { saveGridItem, saveInput, clearLocalStorage, getFormData: collectFormData };
})();
</script>

<!-- Close device-container -->
