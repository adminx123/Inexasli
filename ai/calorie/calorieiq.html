<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

 


<div class="device-container" id="calorieiq-device-container" >
  <div class="row1 product-description-container" data-step-label="Introduction">
    <h2 class="product-description-heading">Unlock Personalized Calorie Insights!</h2>
    <p class="product-description-text">
        Ever wondered how to get truly tailored advice on your calorie needs? Instead of guessing or struggling with generic information, CalorieIQâ„¢ guides you. By answering a few simple questions, you'll help us create a specialized query for our advanced AI. This means you get precise, actionable insights, presented in an easy-to-understand way, helping you make smarter decisions about your diet and health.
    </p>
    <p class="product-description-final">
        Let's get started!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a professional.</em>
    </p>
  </div>

  <div class="row1" data-step-label="Personal Information">
    <h3 class="tooltip1" data-tooltip="Basic physical information needed to calculate your personalized calorie requirements.">
      Personal Information<span class="tooltip1-content"></span>
    </h3>
    <input id="age" type="text" placeholder="Age">
    <input id="height" type="text" placeholder="5'10">
    <input id="weight" type="text" placeholder="70 kg">
    <select id="sex">
      <option value="" disabled selected>Select Gender</option>
      <option value="man">Man</option>
      <option value="woman">Woman</option>
    </select>
  </div>

  <div class="row1" data-step-label="Fitness Goal">
    <h3 class="tooltip1" data-tooltip="Choose your primary fitness objective to receive customized calorie recommendations.">
      Fitness Goal<span class="tooltip1-content"></span>
    </h3>
    <div class="grid-container" id="goal">
      <div class="grid-item" data-value="Lose Weight">Lose weight</div>
      <div class="grid-item" data-value="Gain Muscle">Gain muscle</div>
      <div class="grid-item" data-value="Maintain Weight">Maintain weight</div>
      <div class="grid-item" data-value="Improve Endurance">Improve endurance</div>
    </div>
  </div>

  <div class="row1" data-step-label="Activity Details">
    <h3 class="tooltip1" data-tooltip="Describe your weekly physical activity to help calculate your daily calorie needs based on your lifestyle.">
      Activity Details<span class="tooltip1-content"></span>
    </h3>
    <label for="calorie-activity-level" style="display:block; text-align:center; margin-bottom:4px;">Describe your weekly activity in your own words (voice or text):</label>
    <textarea id="activity-level" rows="2" style="width:100%;max-width:460px;display:block;margin:0 auto;" placeholder="E.g. 'I do cardio 3 times, weights 2 times, and yoga once a week. Each session is about 45 minutes.'"></textarea>
  </div>

  <div class="row1" data-step-label="Dietary Preferences">
    <h3 class="tooltip1" data-tooltip="Select your dietary preferences or restrictions to receive personalized meal recommendations that fit your lifestyle.">
      Dietary Preferences<span class="tooltip1-content"></span>
    </h3>
    <div class="grid-container" id="diet-type">
      <div class="grid-item" data-value="None">No Restrictions</div>
      <div class="grid-item" data-value="Vegetarian">Vegetarian</div>
      <div class="grid-item" data-value="Vegan">Vegan</div>
      <div class="grid-item" data-value="Gluten-Free">Gluten-Free</div>
      <div class="grid-item" data-value="Keto">Keto</div>
      <div class="grid-item" data-value="Paleo">Paleo</div>
      <div class="grid-item" data-value="Low-Carb">Low-Carb</div>
      <div class="grid-item" data-value="Mediterranean">Mediterranean</div>
    </div>
  </div>

  <div class="row1" data-step-label="Food Log">
    <h3 class="tooltip1" data-tooltip="Record what you typically eat throughout the day to get personalized nutritional analysis and recommendations.">
      Food Log<span class="tooltip1-content"></span>
    </h3>
    <textarea id="breakfast" data-meal="breakfast" placeholder="Breakfast:&#10;1 cup oatmeal&#10;0.5 cup berries&#10;1 tbsp honey" rows="3"></textarea>
    <textarea id="lunch" data-meal="lunch" placeholder="Lunch:&#10;200g chicken breast&#10;150g mixed salad&#10;2 tbsp olive oil" rows="3"></textarea>
    <textarea id="dinner" data-meal="dinner" placeholder="Dinner:&#10;6 oz salmon&#10;1/2 cup quinoa&#10;100g broccoli" rows="3"></textarea>
    <textarea id="snacks" data-meal="snacks" placeholder="Snacks:&#10;1 apple&#10;30g almonds&#10;1 cup green tea" rows="3"></textarea>
    <button class="generate-btn" id="generate-calorie-btn">Generate Now!</button>
  </div>
</div> 

<!-- Jump to Food Log button (conditionally rendered by JS) -->

<script type="module">
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

// Rate limiting utilities are now available globally via window.rateLimiter

(function() {
  // FormPersistence is initialized by datain.js and available as window.calorieFormPersistence
  // No need to create it here - just ensure it's available when we need it

  // Handle the generate button click
  async function handleGenerateCalorieIq() {
    const formData = window.calorieFormPersistence.getSavedFormData();
    if (!formData) {
      console.error('[CalorieIQ] No input data found in localStorage.');
      alert('Please complete the form before generating a calorie plan.');
      return;
    }

    // Check rate limiting before proceeding
    if (window.rateLimiter.isRateLimited('calorie', 8, 60 * 60 * 1000)) { // 8 requests per hour (as per rate-limiter config)
      alert('You have exceeded the request limit for calorie analysis. Please try again later.');
      return;
    }

    // Create worker payload with email for paid users (DRY function)
    const workerPayload = window.rateLimiter.createWorkerPayload('calorie', formData);
    
    const dataContainer = document.querySelector('.data-container-in');
    let backendResponse = null;
    try {
      backendResponse = await window.enhancedLoading(
        'generate-calorie-btn',
        'calorie',
        async () => {
          // Send data to worker
          const apiUrl = 'https://inexasli.com/api/generate';
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(workerPayload)
          });
          let responseData;
          try {
            responseData = await response.json();
          } catch (e) {
            responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
          }
          // Always call handleRateLimitResponse with backend response
          window.rateLimiter.handleRateLimitResponse(dataContainer, responseData, !response.ok);
          if (!response.ok) {
            throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
          }
          if (responseData.message !== 'Success') {
            throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
          }
          
          // Store the response
          window.calorieFormPersistence.saveResponseData(responseData);
          
          // Dispatch an event to notify dataout.js that a response was received
          const event = new CustomEvent('api-response-received', {
            detail: {
              module: 'calorieiq',
              type: 'worker-response',
              timestamp: Date.now()
            }
          });
          document.dispatchEvent(event);
          
          return responseData;
        }
      );
      window.rateLimiter.incrementRequestCount('calorie');
    } catch (error) {
      // If backendResponse is available, update rate limit display and show error
      if (backendResponse && dataContainer) {
        window.rateLimiter.handleRateLimitResponse(dataContainer, backendResponse, true);
      }
      // Optionally, show a toast/modal here for generic errors
      console.error('[CalorieIQ] Error:', error);
    }
  }

  // Initialization
  const generateCalorieBtn = document.getElementById('generate-calorie-btn');
  if (generateCalorieBtn) {
    generateCalorieBtn.addEventListener('click', handleGenerateCalorieIq);
    // Set flag to prevent duplicate handler attachment
    generateCalorieBtn.dataset.handlerAttached = 'true';
  }

  // Guided forms integration
  if (typeof GuidedForms !== 'undefined' && GuidedForms.calorieiq) {
    new GuidedForms.calorieiq();
  }

  // Function to handle jumping to the food log stage
  function jumpToFoodLogStage() {
    if (localStorage.getItem('calorieIqResponse')) {
      console.log('[CalorieIQ] Conditions met, attempting to jump to Food Log stage');
      // Wait for guided forms to initialize then jump to Food Log stage (step 5)
      setTimeout(() => {
        if (window.guidedForms && typeof window.guidedForms.showStep === 'function') {
          console.log('[CalorieIQ] Jumping to Food Log stage (step 5)');
          window.guidedForms.showStep(5);
          // Do not forcibly hide the intro; guidedForms will handle step visibility
        } else {
          console.log('[CalorieIQ] Guided forms not ready, will not jump to stage.');
        }
      }, 500); // A small delay to ensure guidedForms is ready
    }
  }

  // Try to jump immediately on load (for page refresh/reopen scenarios)
  jumpToFoodLogStage();

  // Listen for the promptGridItemSelected event to jump to the Food Log stage
  document.addEventListener('promptGridItemSelected', function(e) {
    console.log('[CalorieIQ] promptGridItemSelected event detected', e.detail);
    if (e.detail.url && e.detail.url.includes('/ai/calorie/calorieiq.html')) {
      jumpToFoodLogStage();
    }
  });

  // Handle loading through datain.js - also check for jump condition
  document.addEventListener('data-in-loaded', function(e) {
    if (e.detail && e.detail.module === 'calorie') {
      console.log("[CalorieIQ] Calorie module loaded through datain.js");
      jumpToFoodLogStage();
    }
  });
})();
</script>



