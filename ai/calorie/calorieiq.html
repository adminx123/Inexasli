<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

 


<div class="device-container">
  <div class="row1 product-description-container">
    <h2 class="product-description-heading">Unlock Personalized Calorie Insights!</h2>
    <p class="product-description-text">
        Ever wondered how to get truly tailored advice on your calorie needs? Instead of guessing or struggling with generic information, CalorieIQâ„¢ guides you. By answering a few simple questions, you'll help us create a specialized query for our advanced AI. This means you get precise, actionable insights, presented in an easy-to-understand way, helping you make smarter decisions about your diet and health.
    </p>
    <p class="product-description-final">
        Let's get started!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a professional.</em>
    </p>
  </div>
  <!-- Jump to Food Log button is injected by JS if calorieIqResponse exists -->

  <div class="row1" data-step-label="Personal Information">
    <h3 class="tooltip1" data-tooltip="Basic physical information needed to calculate your personalized calorie requirements.">
      Personal Information<span class="tooltip1-content"></span>
    </h3>
    <input id="calorie-age" type="text" placeholder="Age">
    <input id="calorie-height" type="text" placeholder="5'10">
    <input id="calorie-weight" type="text" placeholder="70 kg">
    <select id="calorie-sex">
      <option value="" disabled selected>Select Gender</option>
      <option value="man">Man</option>
      <option value="woman">Woman</option>
    </select>
  </div>

  <div class="row1" data-step-label="Fitness Goal">
    <h3 class="tooltip1" data-tooltip="Choose your primary fitness objective to receive customized calorie recommendations.">
      Fitness Goal<span class="tooltip1-content"></span>
    </h3>
    <div class="grid-container" id="calorie-goal">
      <div class="grid-item" data-value="Lose Weight">Lose weight</div>
      <div class="grid-item" data-value="Gain Muscle">Gain muscle</div>
      <div class="grid-item" data-value="Maintain Weight">Maintain weight</div>
      <div class="grid-item" data-value="Improve Endurance">Improve endurance</div>
    </div>
  </div>

  <div class="row1" data-step-label="Activity Details">
    <h3 class="tooltip1" data-tooltip="Describe your weekly physical activity to help calculate your daily calorie needs based on your lifestyle.">
      Activity Details<span class="tooltip1-content"></span>
    </h3>
    <label for="calorie-activity-level" style="display:block; text-align:center; margin-bottom:4px;">Describe your weekly activity in your own words (voice or text):</label>
    <textarea id="calorie-activity-level" rows="2" style="width:100%;max-width:460px;display:block;margin:0 auto;" placeholder="E.g. 'I do cardio 3 times, weights 2 times, and yoga once a week. Each session is about 45 minutes.'"></textarea>
  </div>

  <div class="row1" data-step-label="Dietary Preferences">
    <h3 class="tooltip1" data-tooltip="Select your dietary preferences or restrictions to receive personalized meal recommendations that fit your lifestyle.">
      Dietary Preferences<span class="tooltip1-content"></span>
    </h3>
    <div class="grid-container" id="calorie-diet-type">
      <div class="grid-item" data-value="None">No Restrictions</div>
      <div class="grid-item" data-value="Vegetarian">Vegetarian</div>
      <div class="grid-item" data-value="Vegan">Vegan</div>
      <div class="grid-item" data-value="Gluten-Free">Gluten-Free</div>
      <div class="grid-item" data-value="Keto">Keto</div>
      <div class="grid-item" data-value="Paleo">Paleo</div>
      <div class="grid-item" data-value="Low-Carb">Low-Carb</div>
      <div class="grid-item" data-value="Mediterranean">Mediterranean</div>
    </div>
  </div>

  <div class="row1" data-step-label="Food Log">
    <h3 class="tooltip1" data-tooltip="Record what you typically eat throughout the day to get personalized nutritional analysis and recommendations.">
      Food Log<span class="tooltip1-content"></span>
    </h3>
    <textarea id="calorie-breakfast" data-meal="breakfast" placeholder="Breakfast:&#10;1 cup oatmeal&#10;0.5 cup berries&#10;1 tbsp honey" rows="3"></textarea>
    <textarea id="calorie-lunch" data-meal="lunch" placeholder="Lunch:&#10;200g chicken breast&#10;150g mixed salad&#10;2 tbsp olive oil" rows="3"></textarea>
    <textarea id="calorie-dinner" data-meal="dinner" placeholder="Dinner:&#10;6 oz salmon&#10;1/2 cup quinoa&#10;100g broccoli" rows="3"></textarea>
    <textarea id="calorie-snacks" data-meal="snacks" placeholder="Snacks:&#10;1 apple&#10;30g almonds&#10;1 cup green tea" rows="3"></textarea>
    <button class="generate-btn" id="generate-calorie-btn">Generate Now!</button>
  </div>
</div> 

<!-- Jump to Food Log button (conditionally rendered by JS) -->

<script type="module">
import { initAutoExpandTextareas } from '../styles/inputFunctionality.js';
import { getFingerprintForWorker, incrementRequestCount, isRateLimited, handleRateLimitResponse } from '/utility/rateLimiter.js';

(function() {
  console.log("Calorie IQ script initializing");

  // Initialize textarea auto-expand
  initAutoExpandTextareas();
  document.addEventListener('textarea:changed', function(e) {
    // Save form data when any textarea changes
    if (window.calorieFormPersistence) {
      window.calorieFormPersistence.saveFormData();
    }
  });



  async function handleGenerateCalorieIq() {
    try {
      const formData = window.calorieFormPersistence.getSavedFormData();
      if (!formData) { 
        alert('Please complete the form before generating a calorie plan.'); 
        return;
      }

      // Check rate limiting before proceeding
      if (isRateLimited('calorie', 8, 60 * 60 * 1000)) { // 8 requests per hour (as per rate-limiter config)
        alert('You have exceeded the request limit for calorie analysis. Please try again later.');
        return;
      }

      // Get fingerprint data for rate limiting
      const fingerprintData = getFingerprintForWorker();
      
      // Create combined payload with both form data and fingerprint
      const workerPayload = {
        module: "calorie",
        formData: formData,
        fingerprint: fingerprintData
      };

      const dataContainer = document.querySelector('.device-container');
      let backendResponse = null;
      try {
        backendResponse = await window.enhancedLoading(
          'generate-calorie-btn',
          'calorie',
          async () => {
            const apiUrl = 'https://master.4hm7q4q75z.workers.dev/';
            const response = await fetch(apiUrl, { 
              method: 'POST', 
              headers: {'Content-Type':'application/json'}, 
              body: JSON.stringify(workerPayload)
            });
            let responseData;
            try {
              responseData = await response.json();
            } catch (e) {
              responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
            }
            // Always call handleRateLimitResponse with backend response
            handleRateLimitResponse(dataContainer, responseData, !response.ok, 'CalorieIQ');
            if (!response.ok) {
              throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
            }
            if (responseData.message !== 'Success') {
              throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
            }
            return responseData;
          }
        );
        incrementRequestCount('calorie');
        window.calorieFormPersistence.saveResponseData(backendResponse);
        const event = new CustomEvent('api-response-received', {
          detail: {
            module: 'calorieiq',
            type: 'worker-response',
            timestamp: Date.now()
          }
        });
        document.dispatchEvent(event);
        console.log('[CalorieIQ] Dispatched api-response-received event');
      } catch (error) {
        if (backendResponse && dataContainer) {
          handleRateLimitResponse(dataContainer, backendResponse, true, 'CalorieIQ');
        }
        console.error('[CalorieIQ] Error generating calorie plan:', error);
      }
    } catch (error) {
      console.error('[CalorieIQ] Error generating calorie plan:', error);
      alert('An error occurred while generating your calorie plan. Please try again later.');
    }
  }

  // Simple initialization - just ensure the add button exists
  function initialize() {
    console.log("[CalorieIQ] Initializing...");
    
    // Set up event listeners
    const generateBtn = document.getElementById('generate-calorie-btn');
    if (generateBtn) {
      generateBtn.removeEventListener('click', handleGenerateCalorieIq);
      generateBtn.addEventListener('click', handleGenerateCalorieIq);
    }
  }



  // Initialize with multiple triggers to ensure reliability
  function runInitialization() {
    // Use a small delay to ensure DOM is ready
    setTimeout(initialize, 50);
  }

  // Initialize immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runInitialization);
  } else {
    runInitialization();
  }

  // Handle loading through datain.js - only initialize if calorie module is loaded
  document.addEventListener('data-in-loaded', function(e) {
    const moduleType = e.detail?.moduleType;
    if (moduleType === 'calorie') {
      console.log("[CalorieIQ] Calorie module loaded through datain.js, reinitializing");
      runInitialization();
    }
  });

  // Additional safety net - try again after a short delay
  setTimeout(() => {
    const generateBtn = document.getElementById('generate-calorie-btn');
    if (generateBtn && !generateBtn.onclick) {
      console.log("[CalorieIQ] Generate button not initialized, trying again");
      initialize();
    }
  }, 200);
  
  // Add Jump to Food Log button if calorieIqResponse exists
  document.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('calorieIqResponse')) {
      const btn = document.createElement('button');
      btn.textContent = 'Jump to Food Log';
      btn.className = 'jump-to-foodlog-btn';
      btn.style.cssText = 'width: 180px; height: 40px; align-self: center; border: 1px solid #4a7c59; box-shadow: 2px 2px 4px rgba(74, 124, 89, 0.15); background-color: #f2f9f3; color: #2d5a3d; border-radius: 5px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; padding: 0; font-family: "Geist", sans-serif; margin: 18px auto 24px auto;';
      btn.onmouseenter = function() {
        btn.style.backgroundColor = '#eef7f0';
        btn.style.color = '#2d5a3d';
      };
      btn.onmouseleave = function() {
        btn.style.backgroundColor = '#f2f9f3';
        btn.style.color = '#2d5a3d';
      };
      btn.onclick = function() {
        const foodLog = document.querySelector('[data-step-label="Food Log"]');
        if (foodLog) foodLog.scrollIntoView({ behavior: 'smooth', block: 'start' });
      };
      const intro = document.querySelector('.product-description-container');
      if (intro) intro.after(btn);
    }
  });

  // Export functions for external access
  window.calorieIq = { 
    getFormData: () => window.calorieFormPersistence.getSavedFormData(),
    saveFormData: () => window.calorieFormPersistence.saveFormData()
  };
})();
</script>



