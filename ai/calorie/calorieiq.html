<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

 


<div class="device-container">
  <div class="row1 product-description-container">
    <h2 class="product-description-heading">Unlock Personalized Calorie Insights!</h2>
    <p class="product-description-text">
        Ever wondered how to get truly tailored advice on your calorie needs? Instead of guessing or struggling with generic information, CalorieIQ guides you. By answering a few simple questions, you'll help us create a specialized query for our advanced AI. This means you get precise, actionable insights, presented in an easy-to-understand way, helping you make smarter decisions about your diet and health.
    </p>
    <p class="product-description-disclaimer">
        <em>Important: The information and suggestions provided by this tool are for informational and educational purposes only and are generated by artificial intelligence. They are not a substitute for professional medical or health advice, and we make no guarantees regarding their accuracy, completeness, or suitability for your specific circumstances. Always consult with a qualified healthcare provider before making changes to your diet or health regimen. Use of this tool and its outputs is at your own risk.</em>
    </p>
    <p class="product-description-final">
        Let's get started!
    </p>
  </div>
  <!-- Jump to Food Log button is injected by JS if calorieIqResponse exists -->

  <div class="row1" data-step-label="Personal Information">
    <input id="calorie-age" type="text" placeholder="Age">
    <input id="calorie-height" type="text" placeholder="5'10">
    <input id="calorie-weight" type="text" placeholder="70 kg">
    <select id="calorie-sex">
      <option value="" disabled selected>Select Gender</option>
      <option value="man">Man</option>
      <option value="woman">Woman</option>
    </select>
  </div>

  <div class="row1" data-step-label="Fitness Goal">
    <div class="grid-container" id="calorie-goal">
      <div class="grid-item" data-value="Lose Weight">I want to lose weight</div>
      <div class="grid-item" data-value="Gain Muscle">I want gain muscle</div>
      <div class="grid-item" data-value="Maintain Weight">I want maintain weight</div>
      <div class="grid-item" data-value="Improve Endurance">I want improve endurance</div>
    </div>
  </div>

  <div class="row1" data-step-label="Activity Details">
    <label for="calorie-activity-level" style="display:block; text-align:center; margin-bottom:4px;">Describe your weekly activity in your own words (voice or text):</label>
    <textarea id="calorie-activity-level" rows="2" style="width:100%;max-width:460px;display:block;margin:0 auto;" placeholder="E.g. 'I do cardio 3 times, weights 2 times, and yoga once a week. Each session is about 45 minutes.'"></textarea>
  </div>

  <div class="row1" data-step-label="Dietary Preferences">
    <div class="grid-container" id="calorie-diet-type">
      <div class="grid-item" data-value="None">No Restrictions</div>
      <div class="grid-item" data-value="Vegetarian">Vegetarian</div>
      <div class="grid-item" data-value="Vegan">Vegan</div>
      <div class="grid-item" data-value="Gluten-Free">Gluten-Free</div>
      <div class="grid-item" data-value="Keto">Keto</div>
      <div class="grid-item" data-value="Paleo">Paleo</div>
      <div class="grid-item" data-value="Low-Carb">Low-Carb</div>
      <div class="grid-item" data-value="Mediterranean">Mediterranean</div>
    </div>
  </div>

  <div class="row1" data-step-label="Food Log">
    <textarea id="calorie-breakfast" data-meal="breakfast" placeholder="Breakfast: 1 cup oatmeal, 0.5 cup berries, 1 tbsp honey" rows="2"></textarea>
    <textarea id="calorie-lunch" data-meal="lunch" placeholder="Lunch: 200g chicken, 150g salad, 2 tbsp olive oil" rows="2"></textarea>
    <textarea id="calorie-dinner" data-meal="dinner" placeholder="Dinner: 6 oz salmon, 1/2 cup quinoa, 100g broccoli" rows="2"></textarea>
    <button class="generate-btn" id="generate-calorie-btn">Generate Now!</button>
  </div>
</div> 

<!-- Jump to Food Log button (conditionally rendered by JS) -->

<script>
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

(function() {
  console.log("Calorie IQ script initializing");

  // Reintroduce addMealInput for dynamic meal inputs
  function addMealInput(mealType = null, value = '', skipRepositioning = false) {
    // If mealType is not provided, generate a unique snackN id
    if (!mealType) {
      // Find all existing dynamic meal/snack textareas
      const existing = Array.from(document.querySelectorAll('textarea[id^="calorie-snack"]'));
      let maxNum = 0;
      existing.forEach(el => {
        const match = el.id.match(/^calorie-snack(\d+)$/);
        if (match) {
          const num = parseInt(match[1], 10);
          if (num > maxNum) maxNum = num;
        }
      });
      mealType = `snack${maxNum + 1}`;
    }
    
    const inputGroup = document.createElement('div');
    inputGroup.style.cssText = 'display: flex; align-items: center; gap: 8px; margin: 8px auto; max-width: 460px; width: 100%;';
    
    const textarea = document.createElement('textarea');
    textarea.rows = 2;
    textarea.style.flex = '1';
    textarea.style.margin = '0';
    textarea.style.width = '100%';
    textarea.style.fontSize = '16px';
    textarea.style.lineHeight = '1.5';
    textarea.style.border = '1px solid #7c7c7c';
    textarea.style.borderRadius = '6px';
    textarea.style.backgroundColor = '#f9f9f9';
    textarea.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.05)';
    textarea.style.outline = 'none';
    textarea.style.transition = 'border-color 0.2s ease, box-shadow 0.2s ease';
    textarea.style.fontFamily = '"Inter", sans-serif';
    textarea.style.boxSizing = 'border-box';
    textarea.style.padding = '12px';
    textarea.minHeight = '40px';
    textarea.setAttribute('data-meal', mealType || '');
    textarea.id = `calorie-${mealType}`;
    textarea.placeholder = mealType ? mealType.charAt(0).toUpperCase() + mealType.slice(1) + ': 100g yogurt, 2 oz crackers' : 'Meal: 100g yogurt, 2 oz crackers';
    if (value) textarea.value = value;
    inputGroup.appendChild(textarea);
    // Auto-expand textarea as user types
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
      if (window.calorieFormPersistence) window.calorieFormPersistence.saveFormData();
    });
    setTimeout(() => {
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight) + 'px';
    }, 0);
    
    const removeBtn = document.createElement('button');
    removeBtn.innerText = 'Ã—';
    removeBtn.title = 'Remove this meal/snack';
    removeBtn.style.cssText = 'width: 40px; height: 40px; align-self: center; border: 1px solid #4a7c59; box-shadow: 2px 2px 4px rgba(74, 124, 89, 0.15); background-color: #f2f9f3; color: #2d5a3d; border-radius: 5px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; padding: 0; font-family: "Geist", sans-serif; margin-left: 0;';
    removeBtn.addEventListener('click', () => { 
      inputGroup.remove(); 
      // Only reposition button if not during form repopulation
      if (!skipRepositioning) {
        ensureAddButton();
      }
      // Save the current state after removing the input
      window.calorieFormPersistence.saveFormData();
    });
    removeBtn.onmouseenter = () => {
      removeBtn.style.backgroundColor = '#eef7f0';
      removeBtn.style.color = '#2d5a3d';
    };
    removeBtn.onmouseleave = () => {
      removeBtn.style.backgroundColor = '#f2f9f3';
      removeBtn.style.color = '#2d5a3d';
    };
    inputGroup.appendChild(removeBtn);
    
    // Find the main food log container (row1) to add the new input below the existing ones
    const foodLogSection = document.querySelector('.row1:last-child');
    if (!foodLogSection) {
      console.error('[CalorieIQ] Could not find food log section');
      return;
    }
    
    // Find the generate button to insert before it
    const generateBtn = document.getElementById('generate-calorie-btn');
    if (generateBtn) {
      foodLogSection.insertBefore(inputGroup, generateBtn);
      console.log('[CalorieIQ] Added new meal input before generate button');
    } else {
      // Fallback: add to the end of the food log section
      foodLogSection.appendChild(inputGroup);
      console.log('[CalorieIQ] Added new meal input at end of food log section');
    }
    
    if (!skipRepositioning) {
      ensureAddButton();
      textarea.focus();
      
      // Refresh input handlers to pick up the new input
      if (window.calorieFormPersistence && window.calorieFormPersistence.refreshInputHandlers) {
        window.calorieFormPersistence.refreshInputHandlers();
      }
      
      // Save form data after adding new input
      window.calorieFormPersistence.saveFormData();
    }
  }

  // Simple, robust function to create and manage the add button
  function ensureAddButton() {
    console.log('[CalorieIQ] Ensuring add button exists...');
    
    // Check if button already exists
    if (document.getElementById('multifield-add-btn')) {
      console.log('[CalorieIQ] Add button already exists');
      return;
    }
    
    // Find the dinner input (now a textarea)
    const dinnerInput = document.querySelector('textarea[data-meal="dinner"]');
    if (!dinnerInput) {
      console.error('[CalorieIQ] No dinner input found');
      return;
    }
    
    // Check if dinner textarea is already in a flex container
    if (dinnerInput.parentNode && dinnerInput.parentNode.classList && dinnerInput.parentNode.classList.contains('flex-meal-container')) {
      console.log('[CalorieIQ] Dinner textarea already in flex container');
      return;
    }
    
    // Create flex container wrapper
    const flexContainer = document.createElement('div');
    flexContainer.className = 'flex-meal-container';
    flexContainer.style.cssText = 'display: flex; align-items: center; gap: 8px; margin: 8px auto; max-width: 460px; width: 100%;';
    
    // Insert flex container after dinner textarea
    const foodLogSection = dinnerInput.parentNode;
    foodLogSection.insertBefore(flexContainer, dinnerInput.nextSibling);
    
    // Move dinner textarea into flex container and make it flex
    flexContainer.appendChild(dinnerInput);
    dinnerInput.style.flex = '1';
    
    // Create the add button
    const addBtn = document.createElement('button');
    addBtn.id = 'multifield-add-btn';
    addBtn.title = 'Add another meal/snack';
    addBtn.innerText = '+';
    addBtn.style.cssText = 'width: 40px; height: 40px; align-self: center; border: 1px solid #4a7c59; box-shadow: 2px 2px 4px rgba(74, 124, 89, 0.15); background-color: #f2f9f3; color: #2d5a3d; border-radius: 5px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; padding: 0; font-family: "Geist", sans-serif;';
    addBtn.onclick = () => addMealInput();
    addBtn.onmouseenter = () => {
      addBtn.style.backgroundColor = '#eef7f0';
      addBtn.style.color = '#2d5a3d';
    };
    addBtn.onmouseleave = () => {
      addBtn.style.backgroundColor = '#f2f9f3';
      addBtn.style.color = '#2d5a3d';
    };
    
    // Add button to flex container
    flexContainer.appendChild(addBtn);
    console.log('[CalorieIQ] Add button created and positioned in flex container');
  }

  async function handleGenerateCalorieIq() {
    try {
      const formData = window.calorieFormPersistence.getSavedFormData();
      if (!formData) { 
        alert('Please complete the form before generating a calorie plan.'); 
        return;
      }

      // Use enhanced loading with educational facts
      const result = await window.enhancedLoading(
        'generate-calorie-btn',
        'calorie',
        async () => {
          const apiUrl = 'https://calorie.4hm7q4q75z.workers.dev/';
          const response = await fetch(apiUrl, { 
            method: 'POST', 
            headers: {'Content-Type':'application/json'}, 
            body: JSON.stringify(formData) 
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          
          const responseData = await response.json();
          if (responseData.message !== 'Success') {
            throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
          }
          
          return responseData;
        }
      );

      // Store the response using centralized system
      window.calorieFormPersistence.saveResponseData(result);
      
      // Dispatch an event to notify dataout.js that a response was received
      const event = new CustomEvent('api-response-received', {
        detail: {
          module: 'calorieiq',
          type: 'worker-response',
          timestamp: Date.now()
        }
      });
      document.dispatchEvent(event);
      console.log('[CalorieIQ] Dispatched api-response-received event');
      
    } catch (error) {
      console.error('[CalorieIQ] Error generating calorie plan:', error);
      alert('An error occurred while generating your calorie plan. Please try again later.');
    }
  }

  // Simple initialization - just ensure the add button exists
  function initialize() {
    console.log("[CalorieIQ] Initializing...");
    
    // Set up event listeners
    const generateBtn = document.getElementById('generate-calorie-btn');
    if (generateBtn) {
      generateBtn.removeEventListener('click', handleGenerateCalorieIq);
      generateBtn.addEventListener('click', handleGenerateCalorieIq);
    }
    

    
    // Simply ensure the add button exists
    ensureAddButton();
  }



  // Initialize with multiple triggers to ensure reliability
  function runInitialization() {
    // Use a small delay to ensure DOM is ready
    setTimeout(initialize, 50);
  }

  // Initialize immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runInitialization);
  } else {
    runInitialization();
  }

  // Handle loading through datain.js - only initialize if calorie module is loaded
  document.addEventListener('data-in-loaded', function(e) {
    const moduleType = e.detail?.moduleType;
    if (moduleType === 'calorie') {
      console.log("[CalorieIQ] Calorie module loaded through datain.js, reinitializing");
      runInitialization();
    }
  });

  // Additional safety net - try again after a short delay
  setTimeout(() => {
    if (!document.getElementById('multifield-add-btn')) {
      console.log("[CalorieIQ] Add button not found, trying initialization again");
      initialize();
    }
  }, 200);
  
  // Add Jump to Food Log button if calorieIqResponse exists
  document.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('calorieIqResponse')) {
      const btn = document.createElement('button');
      btn.textContent = 'Jump to Food Log';
      btn.className = 'jump-to-foodlog-btn';
      btn.style.cssText = 'width: 180px; height: 40px; align-self: center; border: 1px solid #4a7c59; box-shadow: 2px 2px 4px rgba(74, 124, 89, 0.15); background-color: #f2f9f3; color: #2d5a3d; border-radius: 5px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; padding: 0; font-family: "Geist", sans-serif; margin: 18px auto 24px auto;';
      btn.onmouseenter = function() {
        btn.style.backgroundColor = '#eef7f0';
        btn.style.color = '#2d5a3d';
      };
      btn.onmouseleave = function() {
        btn.style.backgroundColor = '#f2f9f3';
        btn.style.color = '#2d5a3d';
      };
      btn.onclick = function() {
        const foodLog = document.querySelector('[data-step-label="Food Log"]');
        if (foodLog) foodLog.scrollIntoView({ behavior: 'smooth', block: 'start' });
      };
      const intro = document.querySelector('.product-description-container');
      if (intro) intro.after(btn);
    }
  });

  // Export functions for external access
  window.calorieIq = { 
    addMealInput,
    getFormData: () => window.calorieFormPersistence.getSavedFormData(),
    saveFormData: () => window.calorieFormPersistence.saveFormData()
  };
})();
</script>



