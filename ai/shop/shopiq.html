<!--
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
-->

<script src="../../payment/paymentform.js"></script>

<div class="device-container">

<div class="row1 product-description-container">
    <h2 class="product-description-heading">Make Smarter Shopping Decisions!</h2>
    <p class="product-description-text">
        Tired of buying products that don't live up to their promises or discovering safety concerns after purchase? ShopIQâ„¢ helps you make informed buying decisions before you spend your money. Our AI analyzes products for safety concerns, quality issues, misleading claims, and value proposition to help you shop with confidence.
    </p>
    <p class="product-description-final">
        Let's analyze your product!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a professional.</em>
    </p>
</div>

<div class="premium-blur">

        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Choose how you want to identify the product - scan barcode with camera or type product name manually.">
                Product Identification<span class="tooltip1-content"></span>
            </h3>
            
            <div class="input-method-toggle">
                <div class="toggle-buttons">
                    <button type="button" class="toggle-btn active" data-method="barcode">
                        <i class="fas fa-barcode"></i> Scan Barcode
                    </button>
                    <button type="button" class="toggle-btn" data-method="manual">
                        <i class="fas fa-keyboard"></i> Type Product Name
                    </button>
                </div>
            </div>

            <div id="barcode-input-section" class="input-section active">
                <div class="barcode-scanner">
                    <video id="camera-preview" style="display: none; width: 100%; max-width: 400px; border-radius: 8px;"></video>
                    <div id="camera-controls" style="text-align: center; margin-top: 10px;">
                        <button type="button" id="stop-camera-btn" class="camera-btn" style="display: none;">
                            <i class="fas fa-stop"></i> Stop Camera
                        </button>
                    </div>
                    <div id="scan-result" style="display: none;">
                        <p>Scanned: <span id="barcode-value"></span></p>
                    </div>
                </div>
            </div>

            <div id="manual-input-section" class="input-section">
                <textarea id="product-name" rows="2" placeholder="Apple iPhone 15 Pro Max 256GB
Tide Liquid Laundry Detergent, Original Scent"></textarea>
            </div>
        </div>

        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Enter the price you see for this product to compare with average market prices.">
                Price You See<span class="tooltip1-content"></span>
            </h3>
            <input id="user-price" type="text" placeholder="$29.99">
        </div>

        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Optional: Let us know your budget range to get more targeted recommendations.">
                Budget Constraints<span class="tooltip1-content"></span>
            </h3>
            <textarea id="budget-constraints" rows="2" placeholder="Looking to spend under $50
Budget is flexible but prefer good value"></textarea>
        </div>

        <div class="row1">
            <button class="generate-btn" id="generate-shop-btn">Analyze Product Now!</button>
        </div>

</div>

</div>

<script type="module">
import { setupFormPersistence } from '../../utility/formPersistence.js';

// Form persistence
setupFormPersistence('shop', [
  'product-name', 'user-price', 'budget-constraints'
]);

// Input method toggle functionality
const toggleButtons = document.querySelectorAll('.toggle-btn');
const barcodeSection = document.getElementById('barcode-input-section');
const manualSection = document.getElementById('manual-input-section');

toggleButtons.forEach(btn => {
  btn.addEventListener('click', function() {
    // Remove active class from all buttons
    toggleButtons.forEach(b => b.classList.remove('active'));
    // Add active class to clicked button
    this.classList.add('active');
    
    const method = this.dataset.method;
    
    if (method === 'barcode') {
      barcodeSection.classList.add('active');
      manualSection.classList.remove('active');
      // Clear manual input when switching to barcode
      document.getElementById('product-name').value = '';
      // Automatically start camera when barcode mode is selected
      startCamera();
    } else {
      barcodeSection.classList.remove('active');
      manualSection.classList.add('active');
      // Stop camera and clear barcode when switching to manual
      stopCamera();
      document.getElementById('barcode-value').textContent = '';
      document.getElementById('scan-result').style.display = 'none';
    }
  });
});

// Barcode scanning functionality
let cameraStream = null;
const stopCameraBtn = document.getElementById('stop-camera-btn');
const cameraPreview = document.getElementById('camera-preview');
const scanResult = document.getElementById('scan-result');
const barcodeValue = document.getElementById('barcode-value');

stopCameraBtn.addEventListener('click', stopCamera);

async function startCamera() {
  try {
    // Stop existing stream if any
    stopCamera();
    
    // Request camera access
    cameraStream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: 'environment' // Use back camera if available
      } 
    });
    
    cameraPreview.srcObject = cameraStream;
    cameraPreview.style.display = 'block';
    cameraPreview.play();
    
    stopCameraBtn.style.display = 'inline-block';
    
    // Note: In a real implementation, you would integrate a barcode scanning library here
    // For now, we'll simulate scanning after 3 seconds
    setTimeout(() => {
      simulateBarcodeScan();
    }, 3000);
    
  } catch (error) {
    console.error('Camera access error:', error);
    alert('Unable to access camera. Please ensure camera permissions are granted and try again.');
  }
}

function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
  cameraPreview.style.display = 'none';
  cameraPreview.srcObject = null;
  stopCameraBtn.style.display = 'none';
}

function simulateBarcodeScan() {
  // Simulate a scanned barcode (in real implementation, this would come from barcode library)
  const simulatedBarcode = '123456789012';
  barcodeValue.textContent = simulatedBarcode;
  scanResult.style.display = 'block';
  stopCamera();
}

// Generate button handler
async function handleGenerateShopIq() {
  const productName = document.getElementById('product-name').value.trim();
  const barcodeScanned = document.getElementById('barcode-value').textContent.trim();
  const userPrice = document.getElementById('user-price').value.trim();
  const budgetConstraints = document.getElementById('budget-constraints').value.trim();

  // Validate that we have either product name or barcode
  if (!productName && !barcodeScanned) {
    alert('Please either scan a barcode or enter a product name.');
    return;
  }

  // Prepare form data
  const formData = {
    'product-name': productName,
    'barcode': barcodeScanned,
    'user-price': userPrice,
    'budget-constraints': budgetConstraints
  };

  // Use the payment form handler
  if (window.handlePayment) {
    try {
      await window.handlePayment(
        'shop',
        'generate-shop-btn',
        'ai/shop/shopoutput.html',
        formData,
        {
          apiUrl: 'https://inexasli.com/api/generate',
          module: 'shop'
        }
      );
    } catch (error) {
      console.error('Shop analysis error:', error);
      alert('An error occurred while analyzing the product. Please try again.');
    }
  } else {
    console.error('Payment handler not available');
    alert('Payment system not loaded. Please refresh the page and try again.');
  }
}

// Set up event listener
document.addEventListener('DOMContentLoaded', function() {
  const generateShopBtn = document.getElementById('generate-shop-btn');
  if (generateShopBtn && !generateShopBtn.dataset.handlerAttached) {
    generateShopBtn.addEventListener('click', handleGenerateShopIq);
    generateShopBtn.dataset.handlerAttached = 'true';
  }
});
</script>

<style>
.input-method-toggle {
  margin-bottom: 15px;
}

.toggle-buttons {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.toggle-btn {
  flex: 1;
  padding: 12px 20px;
  border: 2px solid #e0e0e0;
  background: #f8f8f8;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 14px;
  font-weight: 500;
}

.toggle-btn:hover {
  border-color: #007bff;
  background: #f0f8ff;
}

.toggle-btn.active {
  border-color: #007bff;
  background: #007bff;
  color: white;
}

.input-section {
  display: none;
}

.input-section.active {
  display: block;
}

.barcode-scanner {
  text-align: center;
}

.camera-btn {
  padding: 15px 30px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  margin-bottom: 15px;
  transition: background 0.3s ease;
}

.camera-btn:hover {
  background: #218838;
}

#scan-result {
  margin-top: 15px;
  padding: 10px;
  background: #d4edda;
  border: 1px solid #c3e6cb;
  border-radius: 4px;
  color: #155724;
}
</style>
