<!--
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
-->

<div class="device-container">

<div class="row1 product-description-container">
    <h2 class="product-description-heading">Make Smarter Shopping Decisions!</h2>
    <p class="product-description-text">
        Tired of buying products that don't live up to their promises or discovering safety concerns after purchase? ShopIQâ„¢ helps you make informed buying decisions before you spend your money. Our AI analyzes products for safety concerns, quality issues, misleading claims, and value proposition to help you shop with confidence.
    </p>
    <p class="product-description-final">
        Let's analyze your product!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a professional.</em>
    </p>
</div>

<div class="premium-blur">

        <div class="row1" data-step-label="Add Products">
            <h3 class="tooltip1" data-tooltip="Choose how you want to add products for analysis - scan barcodes/QR codes or enter product names manually.">
                Add Products<span class="tooltip1-content"></span>
            </h3>
            
            <!-- Input Method Toggle -->
            <div class="input-method-toggle">
                <div class="toggle-buttons">
                    <button type="button" class="toggle-btn active" data-method="scan">
                        <i class="bx bx-scan"></i>
                        <span>Scan Items</span>
                    </button>
                    <button type="button" class="toggle-btn" data-method="manual">
                        <i class="bx bx-edit"></i>
                        <span>Enter Manually</span>
                    </button>
                </div>
            </div>
            
            <!-- Scan Mode -->
            <div class="input-section active" id="scan-section">
                <div class="scan-description">
                    <p>Scan up to 3 barcodes or QR codes for instant product analysis</p>
                </div>
                <div id="mixed-scanner-container"></div>
            </div>
            
            <!-- Manual Entry Mode -->
            <div class="input-section" id="manual-section">
                <div class="manual-description">
                    <p>Enter product names manually for analysis</p>
                </div>
                <textarea id="product-name" rows="3" placeholder="Apple iPhone 15 Pro Max 256GB
Tide Liquid Laundry Detergent, Original Scent
Samsung Galaxy S24 Ultra 512GB"></textarea>
            </div>
        

      
            <h3 class="tooltip1" data-tooltip="Enter the price you see for this product to compare with average market prices.">
                Price You See<span class="tooltip1-content"></span>
            </h3>
            <input id="user-price" type="text" placeholder="$29.99">

            <button class="generate-btn" id="generate-shop-btn">Analyze Items Now!</button>
        </div>




</div>

</div>

<script type="module">
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

(function() {
  // FormPersistence is initialized by datain.js and available as window.shopFormPersistence
  // MixedScanner is available via window.initializeMixedScanner

  let mixedScanner;
  
  // Initialize the mixed scanner when DOM is ready
  function initScanner() {
    if (typeof window.initializeMixedScanner === 'function') {
      mixedScanner = window.initializeMixedScanner('mixed-scanner-container', {
        maxItems: 3,
        scanTypes: 'both',
        simulationDelay: 3000
      });
      console.log('[ShopIQ] Mixed scanner initialized successfully');
    } else {
      console.log('[ShopIQ] Waiting for initializeMixedScanner...');
      setTimeout(initScanner, 100);
    }
  }
  
  // Setup input method toggle functionality
  function initializeToggle() {
    const toggleButtons = document.querySelectorAll('.toggle-btn');
    const scanSection = document.getElementById('scan-section');
    const manualSection = document.getElementById('manual-section');
    
    toggleButtons.forEach(button => {
      button.addEventListener('click', () => {
        const method = button.getAttribute('data-method');
        
        // Update active states
        toggleButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        // Show/hide sections with animation
        if (method === 'scan') {
          scanSection.classList.add('active');
          manualSection.classList.remove('active');
        } else {
          manualSection.classList.add('active');
          scanSection.classList.remove('active');
        }
        
        console.log('[ShopIQ] Switched to', method, 'mode');
      });
    });
  }
  
  // Start scanner initialization and toggle setup
  initScanner();
  initializeToggle();

  // Handle the generate button click
  async function handleGenerateShopIq() {
    const productName = document.getElementById('product-name').value.trim();
    const userPrice = document.getElementById('user-price').value.trim();
    const scannedItems = mixedScanner ? mixedScanner.getScannedItems() : [];

    // Validate that we have either product name or scanned items
    if (!productName && scannedItems.length === 0) {
      alert('Please either scan items or enter a product name.');
      return;
    }

    // Prepare form data
    const formData = {
      'product-name': productName,
      'scanned-items': scannedItems,
      'user-price': userPrice
    };

    // Check rate limiting before proceeding
    if (window.rateLimiter && window.rateLimiter.isRateLimited('shop', 6, 60 * 60 * 1000)) {
      alert('You have exceeded the request limit for shop analysis. Please try again later.');
      return;
    }

    // Create worker payload with email for paid users
    const workerPayload = window.rateLimiter ? window.rateLimiter.createWorkerPayload('shop', formData) : { module: 'shop', ...formData };
    
    try {
      const backendResponse = await window.enhancedLoading(
        'generate-shop-btn',
        'shop',
        async () => {
          // Send data to worker
          const apiUrl = 'https://inexasli.com/api/generate';
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(workerPayload)
          });
          
          let responseData;
          try {
            responseData = await response.json();
          } catch (e) {
            console.error('[ShopIQ] Failed to parse JSON response:', e);
            throw new Error('Invalid response format');
          }

          if (!response.ok) {
            if (window.rateLimiter) {
              window.rateLimiter.handleRateLimitResponse(responseData, 'shop');
            }
            throw new Error(responseData.error || 'Request failed');
          }

          return responseData;
        }
      );

      if (backendResponse && backendResponse.output) {
        // Load output page with response
        window.loadWithResponse('ai/shop/shopoutput.html', backendResponse.output);
      }

    } catch (error) {
      console.error('[ShopIQ] Shop analysis error:', error);
      alert('An error occurred while analyzing the items. Please try again.');
    }
  }

  // Set up event listener
  const generateShopBtn = document.getElementById('generate-shop-btn');
  if (generateShopBtn && !generateShopBtn.dataset.handlerAttached) {
    generateShopBtn.addEventListener('click', handleGenerateShopIq);
    generateShopBtn.dataset.handlerAttached = 'true';
  }
})();
</script>

<style>
.input-method-toggle {
  margin-bottom: 20px;
}

.toggle-buttons {
  display: flex;
  gap: 0;
  margin-bottom: 20px;
  background: #f8f9fa;
  border-radius: 12px;
  padding: 4px;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
}

.toggle-btn {
  flex: 1;
  padding: 12px 16px;
  border: none;
  background: transparent;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 14px;
  font-weight: 500;
  color: #6c757d;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  position: relative;
}

.toggle-btn i {
  font-size: 16px;
}

.toggle-btn:hover {
  color: #495057;
  background: rgba(255, 255, 255, 0.5);
}

.toggle-btn.active {
  background: white;
  color: #007bff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  font-weight: 600;
}

.toggle-btn.active i {
  color: #007bff;
}

.input-section {
  display: none;
  animation: fadeIn 0.3s ease-in-out;
}

.input-section.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.scan-description,
.manual-description {
  margin-bottom: 16px;
  text-align: center;
}

.scan-description p,
.manual-description p {
  margin: 0;
  color: #6c757d;
  font-size: 14px;
  font-style: italic;
}

#product-name {
  width: 100%;
  min-height: 80px;
  padding: 12px;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  font-size: 14px;
  line-height: 1.5;
  resize: vertical;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
  background: white;
}

#product-name:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

#product-name::placeholder {
  color: #adb5bd;
  font-style: italic;
}

/* Enhanced scanner container styling */
#mixed-scanner-container {
  background: white;
  border-radius: 12px;
  padding: 20px;
  border: 2px solid #e9ecef;
  transition: border-color 0.3s ease;
}

#mixed-scanner-container:hover {
  border-color: #007bff;
}

/* Mobile responsiveness */
@media (max-width: 480px) {
  .toggle-buttons {
    gap: 0;
    padding: 3px;
  }
  
  .toggle-btn {
    padding: 10px 12px;
    font-size: 13px;
    gap: 6px;
  }
  
  .toggle-btn i {
    font-size: 14px;
  }
  
  .toggle-btn span {
    display: none;
  }
  
  .scan-description p,
  .manual-description p {
    font-size: 13px;
  }
  
  #product-name {
    min-height: 70px;
    padding: 10px;
    font-size: 13px;
  }
  
  #mixed-scanner-container {
    padding: 15px;
  }
}

/* Legacy styles kept for compatibility */
.input-method-toggle {
  margin-bottom: 15px;
}

.barcode-scanner {
  text-align: center;
}

.camera-btn {
  padding: 15px 30px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  margin-bottom: 15px;
  transition: background 0.3s ease;
}

.camera-btn:hover {
  background: #218838;
}

#scan-result {
  margin-top: 15px;
  padding: 10px;
  background: #d4edda;
  border: 1px solid #c3e6cb;
  border-radius: 4px;
  color: #155724;
}
</style>
