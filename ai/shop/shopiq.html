<!--
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
-->

<div class="device-container" id="shopiq-device-container">

<div class="row1 product-description-container">
    <h2 class="product-description-heading">Make Smarter Shopping Decisions!</h2>
    <p class="product-description-text">
        Tired of buying products that don't live up to their promises or discovering safety concerns after purchase? ShopIQ™ helps you make informed buying decisions before you spend your money. Our AI analyzes products for safety concerns, quality issues, misleading claims, and value proposition to help you shop with confidence.
    </p>
    <p class="product-description-final">
        Let's analyze your product!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a professional.</em>
    </p>
</div>

<div class="premium-blur">

        <div class="row1" data-step-label="Add Products">
            <h3 class="tooltip1" data-tooltip="Choose how you want to add products for analysis - scan barcodes/QR codes or enter product names manually.">
                Add Products<span class="tooltip1-content"></span>
            </h3>
            
            <!-- Input Method Toggle -->
            <div class="input-method-toggle">
                <div class="toggle-buttons">
                    <button type="button" class="toggle-btn" data-method="scan" disabled style="opacity:0.5;cursor:not-allowed;">
                        <i class="bx bx-scan"></i>
                        <span>Scan Items (Coming Soon)</span>
                    </button>
                    <button type="button" class="toggle-btn active" data-method="manual" disabled style="cursor:not-allowed;">
                        <i class="bx bx-edit"></i>
                        <span>Enter Manually</span>
                    </button>
                </div>
            </div>
            <!-- Scan Mode (hidden/disabled) -->
            <!-- <div class="input-section" id="scan-section" style="display:none;">
                <div class="scan-description">
                    <p>Scan up to 3 barcodes or QR codes for instant product analysis</p>
                </div>
                <div id="mixed-scanner-container"></div>
            </div> -->
            <!-- Manual Entry Mode (active) -->
            <div class="input-section active" id="manual-section">
                <div class="manual-description">
                    <p>Enter 1 product to analyze, or 2–3 to compare.</p>
                </div>
                <textarea id="product-name" rows="3" placeholder="Apple iPhone 15 Pro Max 256GB - $1399.99 CAD
Samsung Galaxy S24 Ultra 512GB - $1799.99 CAD
Google Pixel 8 Pro 256GB - $1199.99 CAD"></textarea>
            </div>
        

      
            <button class="generate-btn" id="generate-shop-btn">Analyze Items Now!</button>
        </div>




</div>

</div>

<script type="module">
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

(function() {
  // FormPersistence is initialized by datain.js and available as window.shopFormPersistence
  // MixedScanner is available via window.initializeMixedScanner

  let mixedScanner;
  
  // Initialize the mixed scanner when DOM is ready
  function initScanner() {
    if (typeof window.initializeMixedScannerWithLibrary === 'function') {
      window.initializeMixedScannerWithLibrary('mixed-scanner-container', {
        maxItems: 3,
        scanTypes: 'both',
        simulationDelay: 3000
      }).then(scanner => {
        mixedScanner = scanner;
        
        // Listen for scanner events and save to localStorage
        // Listen for scanner events and save IMMEDIATELY to localStorage
        document.addEventListener('scanner-item-scanned', (event) => {
          console.log('[ShopIQ] Item scanned - Full event detail:', event.detail);
          console.log('[ShopIQ] Event detail keys:', Object.keys(event.detail));
          console.log('[ShopIQ] AllItems from event:', event.detail.allItems);
          console.log('[ShopIQ] Data from event:', event.detail.data);
          
          // Save scanner data IMMEDIATELY to localStorage
          const productName = document.getElementById('product-name').value.trim();
          const userPrice = document.getElementById('user-price').value.trim();
          const scannedItems = event.detail.allItems || [];
          
          console.log('[ShopIQ] About to save to localStorage - scannedItems:', scannedItems);
          
          const formData = {
            'product-name': productName,
            'user-price': userPrice,
            'scanned-items': scannedItems
          };
          
          // Save directly to localStorage using setJSON
          if (window.setJSON) {
            window.setJSON('shopIqInput', formData);
            console.log('[ShopIQ] Scanner data saved IMMEDIATELY to shopIqInput:', formData);
          } else {
            localStorage.setItem('shopIqInput', JSON.stringify(formData));
            console.log('[ShopIQ] Scanner data saved IMMEDIATELY to shopIqInput (fallback):', formData);
          }
          
          // Verify data was saved
          const savedData = window.getJSON ? window.getJSON('shopIqInput') : JSON.parse(localStorage.getItem('shopIqInput') || '{}');
          console.log('[ShopIQ] Verification - Data in localStorage:', savedData);
        });
        
        document.addEventListener('scanner-item-removed', (event) => {
          console.log('[ShopIQ] Item removed - Full event detail:', event.detail);
          console.log('[ShopIQ] AllItems from removal event:', event.detail.allItems);
          
          // Save scanner data IMMEDIATELY to localStorage
          const productName = document.getElementById('product-name').value.trim();
          const userPrice = document.getElementById('user-price').value.trim();
          const scannedItems = event.detail.allItems || [];
          
          console.log('[ShopIQ] About to save after removal - scannedItems:', scannedItems);
          
          const formData = {
            'product-name': productName,
            'user-price': userPrice,
            'scanned-items': scannedItems
          };
          
          // Save directly to localStorage using setJSON
          if (window.setJSON) {
            window.setJSON('shopIqInput', formData);
            console.log('[ShopIQ] Scanner data saved IMMEDIATELY to shopIqInput after removal:', formData);
          } else {
            localStorage.setItem('shopIqInput', JSON.stringify(formData));
            console.log('[ShopIQ] Scanner data saved IMMEDIATELY to shopIqInput after removal (fallback):', formData);
          }
          
          // Verify data was saved
          const savedData = window.getJSON ? window.getJSON('shopIqInput') : JSON.parse(localStorage.getItem('shopIqInput') || '{}');
          console.log('[ShopIQ] Verification after removal - Data in localStorage:', savedData);
        });
        
        console.log('[ShopIQ] Mixed scanner initialized successfully');
      }).catch(error => {
        console.error('[ShopIQ] Failed to initialize scanner:', error);
      });
    } else {
      console.log('[ShopIQ] Waiting for initializeMixedScannerWithLibrary...');
      setTimeout(initScanner, 100);
    }
  }
  
  // Save form data using FormPersistence for manual inputs only
  function saveFormData() {
    // FormPersistence handles manual input fields (product-name, user-price)
    // Scanner data is saved immediately via direct localStorage in scanner events
    window.shopFormPersistence.saveFormData();
    console.log('[ShopIQ] Form data saved via FormPersistence (manual inputs only)');
  }
  
  // Listen for input changes and save to localStorage
  function attachFormListeners() {
    const productNameInput = document.getElementById('product-name');
    const userPriceInput = document.getElementById('user-price');
    
    if (productNameInput) {
      productNameInput.addEventListener('input', saveFormData);
    }
    if (userPriceInput) {
      userPriceInput.addEventListener('input', saveFormData);
    }
  }
  
  // Setup input method toggle functionality
  function initializeToggle() {
    const toggleButtons = document.querySelectorAll('.toggle-btn');
    const scanSection = document.getElementById('scan-section');
    const manualSection = document.getElementById('manual-section');
    
    toggleButtons.forEach(button => {
      button.addEventListener('click', () => {
        const method = button.getAttribute('data-method');
        
        // Update active states
        toggleButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        // Show/hide sections with animation
        if (method === 'scan') {
          scanSection.classList.add('active');
          manualSection.classList.remove('active');
        } else {
          manualSection.classList.add('active');
          scanSection.classList.remove('active');
        }
        
        console.log('[ShopIQ] Switched to', method, 'mode');
      });
    });
  }
  
  // Start scanner initialization and toggle setup
  initScanner();
  initializeToggle();
  attachFormListeners(); // Add form listeners for real-time saving

  // Handle the generate button click
  async function handleGenerateShopIq() {
    const formData = window.shopFormPersistence.getSavedFormData();
    if (!formData) {
      console.error('[ShopIQ] No input data found in localStorage.');
      alert('Please enter product information before proceeding.');
      return;
    }

    // Validate that we have either product name or scanned items
    const hasProductName = formData['product-name'] && formData['product-name'].trim();
    const hasScannedItems = formData['scanned-items'] && formData['scanned-items'].length > 0;
    
    if (!hasProductName && !hasScannedItems) {
      alert('Please either scan items or enter a product name.');
      return;
    }

    // Check rate limiting before proceeding
    if (window.rateLimiter.isRateLimited('shop', 6, 60 * 60 * 1000)) { // 6 requests per hour
      alert('You have exceeded the request limit for shop analysis. Please try again later.');
      return;
    }

    // Create worker payload with email for paid users (DRY function)
    const workerPayload = window.rateLimiter.createWorkerPayload('shop', formData);
    
    const dataContainer = document.querySelector('.data-container-in');
    let backendResponse = null;
    try {
      backendResponse = await window.enhancedLoading(
        'generate-shop-btn',
        'shop',
        async () => {
          // Send data to worker
          const apiUrl = 'https://inexasli.com/api/generate';
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(workerPayload)
          });
          let responseData;
          try {
            responseData = await response.json();
          } catch (e) {
            responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
          }
          // Always call handleRateLimitResponse with backend response
          window.rateLimiter.handleRateLimitResponse(dataContainer, responseData, !response.ok);
          if (!response.ok) {
            throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
          }
          if (responseData.message !== 'Success') {
            throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
          }
          
          // Store the response using FormPersistence (same as calorie module)
          window.shopFormPersistence.saveResponseData(responseData);
          
          // Dispatch an event to notify dataout.js that a response was received
          const event = new CustomEvent('api-response-received', {
            detail: {
              module: 'shopiq',
              type: 'worker-response',
              timestamp: Date.now()
            }
          });
          document.dispatchEvent(event);
          
          return responseData;
        }
      );
      window.rateLimiter.incrementRequestCount('shop');
    } catch (error) {
      // If backendResponse is available, update rate limit display and show error
      if (backendResponse && dataContainer) {
        window.rateLimiter.handleRateLimitResponse(dataContainer, backendResponse, true);
      }
      // Optionally, show a toast/modal here for generic errors
      console.error('[ShopIQ] Error:', error);
    }
  }

  // Set up event listener
  const generateShopBtn = document.getElementById('generate-shop-btn');
  if (generateShopBtn && !generateShopBtn.dataset.handlerAttached) {
    generateShopBtn.addEventListener('click', handleGenerateShopIq);
    generateShopBtn.dataset.handlerAttached = 'true';
  }
})();
</script>

<style>
.input-method-toggle {
  margin-bottom: 20px;
}

.toggle-buttons {
  display: flex;
  gap: 0;
  margin-bottom: 20px;
  background: #f8f9fa;
  border-radius: 12px;
  padding: 4px;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
}

.toggle-btn {
  flex: 1;
  padding: 12px 16px;
  border: none;
  background: transparent;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 14px;
  font-weight: 500;
  color: #6c757d;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  position: relative;
}

.toggle-btn i {
  font-size: 16px;
}

.toggle-btn:hover {
  color: #495057;
  background: rgba(255, 255, 255, 0.5);
}

.toggle-btn.active {
  background: white;
  color: #007bff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  font-weight: 600;
}

.toggle-btn.active i {
  color: #007bff;
}

.input-section {
  display: none;
  animation: fadeIn 0.3s ease-in-out;
}

.input-section.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.scan-description,
.manual-description {
  margin-bottom: 16px;
  text-align: center;
}

.scan-description p,
.manual-description p {
  margin: 0;
  color: #6c757d;
  font-size: 14px;
  font-style: italic;
}

#product-name {
  width: 100% !important;
  max-width: 100% !important;
  min-width: 0 !important;
  min-height: 80px;
  padding: 12px;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  font-size: 14px;
  line-height: 1.5;
  resize: vertical;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
  background: white;
  box-sizing: border-box;
  display: block;
}

/* Ensure all parent containers are full width */
.device-container .row1,
.device-container .input-section,
.device-container .manual-description {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}

#product-name:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

#product-name::placeholder {
  color: #adb5bd;
  font-style: italic;
}

/* Enhanced scanner container styling */
#mixed-scanner-container {
  background: white;
  border-radius: 12px;
  padding: 20px;
  border: 2px solid #e9ecef;
  transition: border-color 0.3s ease;
}

#mixed-scanner-container:hover {
  border-color: #007bff;
}

/* Mobile responsiveness */
@media (max-width: 480px) {
  .toggle-buttons {
    gap: 0;
    padding: 3px;
  }
  
  .toggle-btn {
    padding: 10px 12px;
    font-size: 13px;
    gap: 6px;
  }
  
  .toggle-btn i {
    font-size: 14px;
  }
  
  .toggle-btn span {
    display: none;
  }
  
  .scan-description p,
  .manual-description p {
    font-size: 13px;
  }
  
  #product-name {
    min-height: 70px;
    padding: 10px;
    font-size: 13px;
  }
  
  #mixed-scanner-container {
    padding: 15px;
  }
}

/* Legacy styles kept for compatibility */
.input-method-toggle {
  margin-bottom: 15px;
}

.barcode-scanner {
  text-align: center;
}

.camera-btn {
  padding: 15px 30px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  margin-bottom: 15px;
  transition: background 0.3s ease;
}

.camera-btn:hover {
  background: #218838;
}

#scan-result {
  margin-top: 15px;
  padding: 10px;
  background: #d4edda;
  border: 1px solid #c3e6cb;
  border-radius: 4px;
  color: #155724;
}
</style>
