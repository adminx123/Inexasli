<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decision Tree Interactive Test</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        button {
            background: #1976D2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background: #1565C0;
        }
        #test-output {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            min-height: 200px;
        }
        
        /* Enhanced test styles */
        .feature-demo {
            background: #f0f8ff;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .feature-demo h4 {
            margin: 0 0 12px 0;
            color: #2E7D32;
        }
        
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .feature-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        
        .enhancement-note {
            background: linear-gradient(45deg, #FFF3E0, #E8F5E8);
            border-left: 4px solid #FF9800;
            padding: 16px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

    </style>
</head>
<body>
    <div class="test-container">
        <h1>üå≥ Decision Tree Interactive Test</h1>
        <p>This test will demonstrate the interactive decision tree functionality with sample data.</p>
        
        <div class="enhancement-note">
            <h4>üöÄ New Enhanced Features Added:</h4>
            <div class="feature-list">
                <div class="feature-item">üéØ <strong>Keyboard Navigation</strong><br>Use arrow keys to navigate between nodes</div>
                <div class="feature-item">‚ôø <strong>Accessibility</strong><br>Screen reader support and ARIA labels</div>
                <div class="feature-item">üì± <strong>Mobile Touch</strong><br>Optimized for touch interactions</div>
                <div class="feature-item">üîç <strong>Search & Filter</strong><br>Find specific nodes quickly</div>
                <div class="feature-item">üì• <strong>Export Functionality</strong><br>Download tree data as JSON</div>
                <div class="feature-item">üß≠ <strong>Breadcrumb Navigation</strong><br>Track your path through the tree</div>
            </div>
        </div>
        
        <button onclick="testBasicTree()">Test Basic Decision Tree</button>
        <button onclick="testComplexTree()">Test Complex Decision Tree</button>
        <button onclick="testCareerTree()">Test Career Decision Tree</button>
        <button onclick="demonstrateFeatures()">üéØ Demo All Features</button>
        
        <div class="feature-demo" id="instructions" style="display: none;">
            <h4>üéÆ Try These Interactions:</h4>
            <ul>
                <li><strong>Click/Tap:</strong> Click any node to see details</li>
                <li><strong>Keyboard:</strong> Tab to focus tree, use arrow keys to navigate, Enter to select</li>
                <li><strong>Search:</strong> Use the search box to filter nodes</li>
                <li><strong>Export:</strong> Click the export button to download tree data</li>
                <li><strong>Help:</strong> Click the help button for full instructions</li>
            </ul>
        </div>

        <div id="test-output"></div>
    </div>

    <!-- Include Mermaid for decision trees -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <script>
        // Copy the decision tree functions from the main file
        // This would normally be included from the main file, but for testing we'll inline it
        
        // Sample test data
        const basicTreeData = {
            analysisType: 'decision-tree',
            decisionTitle: 'Should I Exercise Today?',
            mermaidSyntax: `flowchart TD
    A[Start: Exercise Decision] --> B{How do I feel?}
    B -->|Energetic| C[Go to Gym]
    B -->|Tired| D[Light Walk]
    B -->|Sick| E[Rest Day]
    C --> F[High Impact Workout]
    D --> G[20 min Walk]
    E --> H[Recovery Activities]`,
            nodes: [
                {
                    id: 'A',
                    name: 'Start: Exercise Decision',
                    type: 'start',
                    description: 'Initial decision point for daily exercise'
                },
                {
                    id: 'B',
                    name: 'How do I feel?',
                    type: 'decision',
                    description: 'Assessment of current energy and health status'
                },
                {
                    id: 'C',
                    name: 'Go to Gym',
                    type: 'action',
                    description: 'High-energy exercise option',
                    cost: '$50/month membership',
                    timeframe: '60-90 minutes'
                },
                {
                    id: 'D',
                    name: 'Light Walk',
                    type: 'action',
                    description: 'Moderate exercise when energy is low',
                    cost: 'Free',
                    timeframe: '20-30 minutes'
                },
                {
                    id: 'E',
                    name: 'Rest Day',
                    type: 'action',
                    description: 'Recovery when not feeling well',
                    cost: 'Free',
                    timeframe: 'All day'
                }
            ],
            edges: [
                { from: 'A', to: 'B' },
                { from: 'B', to: 'C' },
                { from: 'B', to: 'D' },
                { from: 'B', to: 'E' }
            ],
            options: [
                { name: 'High Intensity Workout', probability: 0.3 },
                { name: 'Moderate Exercise', probability: 0.5 },
                { name: 'Rest and Recovery', probability: 0.2 }
            ]
        };

        const complexTreeData = {
            analysisType: 'decision-tree',
            decisionTitle: 'Investment Strategy Decision',
            mermaidSyntax: `flowchart TD
    A[Investment Decision] --> B{Risk Tolerance?}
    B -->|High| C[Aggressive Portfolio]
    B -->|Medium| D[Balanced Portfolio]
    B -->|Low| E[Conservative Portfolio]
    C --> F[80% Stocks, 20% Bonds]
    D --> G[60% Stocks, 40% Bonds]
    E --> H[30% Stocks, 70% Bonds]
    F --> I[Expected Return: 8-12%]
    G --> J[Expected Return: 6-8%]
    H --> K[Expected Return: 4-6%]`,
            nodes: [
                {
                    id: 'A',
                    name: 'Investment Decision',
                    type: 'start',
                    description: 'Starting point for investment strategy'
                },
                {
                    id: 'B',
                    name: 'Risk Tolerance Assessment',
                    type: 'decision',
                    description: 'Evaluate comfort level with market volatility',
                    criteria: ['Age', 'Income stability', 'Investment timeline', 'Experience']
                },
                {
                    id: 'C',
                    name: 'Aggressive Portfolio',
                    type: 'outcome',
                    description: 'High-risk, high-reward investment strategy',
                    risk: 'High',
                    timeframe: '10+ years',
                    outcomes: ['Higher potential returns', 'Significant volatility', 'Requires active monitoring']
                }
            ],
            recommendation: {
                topChoice: 'Balanced Portfolio - Best for most investors starting out'
            }
        };

        function testBasicTree() {
            const output = document.getElementById('test-output');
            output.innerHTML = '<h3>Loading Basic Decision Tree...</h3>';
            
            // Simulate the decision tree creation (this would call the actual function)
            createTestVisualization(basicTreeData, 'test-output');
        }

        function testComplexTree() {
            const output = document.getElementById('test-output');
            output.innerHTML = '<h3>Loading Complex Decision Tree...</h3>';
            
            createTestVisualization(complexTreeData, 'test-output');
        }

        function testCareerTree() {
            const careerData = {
                analysisType: 'decision-tree',
                decisionTitle: 'Career Path Decision',
                mermaidSyntax: `flowchart TD
    A[Career Decision] --> B{Current Satisfaction?}
    B -->|Satisfied| C[Stay Current Role]
    B -->|Unsatisfied| D{What's Missing?}
    D -->|Growth| E[Internal Promotion]
    D -->|Pay| F[External Opportunity]
    D -->|Culture| G[Industry Change]
    C --> H[Focus on Skill Development]
    E --> I[Discuss with Manager]
    F --> J[Update Resume & Apply]
    G --> K[Research New Industries]`,
                nodes: [
                    {
                        id: 'A',
                        name: 'Career Decision',
                        type: 'start',
                        description: 'Evaluating current career path'
                    },
                    {
                        id: 'B',
                        name: 'Current Satisfaction?',
                        type: 'decision',
                        description: 'Assessment of job satisfaction level'
                    },
                    {
                        id: 'D',
                        name: 'What\'s Missing?',
                        type: 'decision',
                        description: 'Identify specific areas of dissatisfaction'
                    }
                ],
                options: [
                    'Stay and grow internally',
                    'Seek external opportunities',
                    'Change industries entirely'
                ]
            };
            
            createTestVisualization(careerData, 'test-output');
        }

        function demonstrateFeatures() {
            const output = document.getElementById('test-output');
            const instructions = document.getElementById('instructions');
            
            // Show the feature demonstration tree
            testComplexTree();
            
            // Show instructions
            instructions.style.display = 'block';
            
            // Scroll to output
            output.scrollIntoView({ behavior: 'smooth' });
            
            // Add a welcome message with animations
            setTimeout(() => {
                if (window.TreeInteractionManager) {
                    TreeInteractionManager.announceToScreenReader('Feature demonstration loaded. Try the keyboard navigation and search features!');
                }
            }, 1000);
        }

        // Copy enhanced TreeInteractionManager for testing
        window.TreeInteractionManager = {
            currentFocusedNode: null,
            breadcrumbPath: [],
            isKeyboardNavigationActive: false,
            containerId: 'test-output',

            init: function(containerId) {
                this.containerId = containerId;
                this.setupKeyboardNavigation();
                this.setupAccessibility();
                this.setupMobileSupport();
                this.setupSearch();
                console.log('TreeInteractionManager initialized for', containerId);
            },

            setupKeyboardNavigation: function() {
                document.addEventListener('keydown', (e) => {
                    if (!this.isKeyboardNavigationActive) return;

                    const mermaidDiv = document.querySelector(`#${this.containerId} .mermaid`);
                    if (!mermaidDiv) return;

                    const nodes = Array.from(mermaidDiv.querySelectorAll('.node'));
                    if (nodes.length === 0) return;

                    switch(e.key) {
                        case 'ArrowRight':
                        case 'ArrowDown':
                            e.preventDefault();
                            this.focusNextNode(nodes);
                            break;
                        case 'ArrowLeft':
                        case 'ArrowUp':
                            e.preventDefault();
                            this.focusPrevNode(nodes);
                            break;
                        case 'Enter':
                        case ' ':
                            e.preventDefault();
                            if (this.currentFocusedNode) {
                                this.selectNode(this.currentFocusedNode);
                            }
                            break;
                        case 'Escape':
                            e.preventDefault();
                            this.clearFocus();
                            break;
                    }
                });

                const container = document.getElementById(this.containerId);
                if (container) {
                    container.addEventListener('focus', () => {
                        this.isKeyboardNavigationActive = true;
                    }, true);
                }
            },

            focusNextNode: function(nodes) {
                if (!this.currentFocusedNode) {
                    this.focusNode(nodes[0]);
                } else {
                    const currentIndex = nodes.indexOf(this.currentFocusedNode);
                    const nextIndex = (currentIndex + 1) % nodes.length;
                    this.focusNode(nodes[nextIndex]);
                }
            },

            focusPrevNode: function(nodes) {
                if (!this.currentFocusedNode) {
                    this.focusNode(nodes[nodes.length - 1]);
                } else {
                    const currentIndex = nodes.indexOf(this.currentFocusedNode);
                    const prevIndex = currentIndex === 0 ? nodes.length - 1 : currentIndex - 1;
                    this.focusNode(nodes[prevIndex]);
                }
            },

            focusNode: function(node) {
                this.clearFocus();
                this.currentFocusedNode = node;
                node.style.outline = '3px solid #FFA726';
                node.style.outlineOffset = '2px';
                node.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                this.announceToScreenReader(`Focused on ${node.textContent || 'Decision node'}`);
            },

            selectNode: function(node) {
                node.style.filter = 'drop-shadow(0 4px 12px rgba(25,118,210,0.4))';
                node.style.transform = 'scale(1.05)';
                const nodeId = this.getNodeId(node);
                showTestNodeDetails(nodeId);
                this.updateBreadcrumb(nodeId);
            },

            clearFocus: function() {
                if (this.currentFocusedNode) {
                    this.currentFocusedNode.style.outline = '';
                    this.currentFocusedNode.style.filter = '';
                    this.currentFocusedNode.style.transform = '';
                    this.currentFocusedNode = null;
                }
            },

            setupAccessibility: function() {
                setTimeout(() => {
                    const mermaidDiv = document.querySelector(`#${this.containerId} .mermaid`);
                    if (mermaidDiv) {
                        mermaidDiv.setAttribute('role', 'application');
                        mermaidDiv.setAttribute('aria-label', 'Interactive decision tree');
                        mermaidDiv.setAttribute('tabindex', '0');

                        const nodes = mermaidDiv.querySelectorAll('.node');
                        nodes.forEach((node, index) => {
                            node.setAttribute('role', 'button');
                            node.setAttribute('tabindex', '-1');
                            const nodeText = node.textContent || `Decision node ${index + 1}`;
                            node.setAttribute('aria-label', `${nodeText}. Press Enter to view details`);
                        });
                    }
                }, 500);
            },

            setupMobileSupport: function() {
                // Mobile support implementation would go here
                console.log('Mobile support initialized');
            },

            setupSearch: function() {
                // Search functionality would be initialized here
                console.log('Search functionality initialized');
            },

            getNodeId: function(node) {
                return node.id || node.getAttribute('data-id') || 'unknown-node';
            },

            updateBreadcrumb: function(nodeId) {
                if (!this.breadcrumbPath.includes(nodeId)) {
                    this.breadcrumbPath.push(nodeId);
                    console.log('Breadcrumb path:', this.breadcrumbPath);
                }
            },

            announceToScreenReader: function(message) {
                const announcement = document.createElement('div');
                announcement.setAttribute('aria-live', 'polite');
                announcement.style.position = 'absolute';
                announcement.style.left = '-10000px';
                announcement.textContent = message;
                document.body.appendChild(announcement);
                
                setTimeout(() => {
                    if (document.body.contains(announcement)) {
                        document.body.removeChild(announcement);
                    }
                }, 1000);
            }
        };

        // Simplified version of the decision tree creation for testing
        function createTestVisualization(data, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Initialize mermaid if not already done
            if (typeof mermaid !== 'undefined') {
                try {
                    mermaid.initialize({ 
                        startOnLoad: true, 
                        theme: 'default',
                        securityLevel: 'strict' // Prevent URL navigation issues
                    });
                } catch (error) {
                    console.warn('Mermaid init error:', error);
                }
            }

            container.innerHTML = `
                <div class="decision-tree-container" style="background-color: #fafafa; border: 2px solid #333; border-radius: 12px; padding: 20px; margin: 20px 0;">
                    <div class="decision-tree-header" style="text-align: center; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0;">${data.decisionTitle || 'Decision Tree Analysis'}</h3>
                        <div style="color: #666; font-size: 14px; font-style: italic;">Interactive decision flow visualization</div>
                    </div>
                    
                    <div class="mermaid" id="test-mermaid">
                        ${data.mermaidSyntax}
                    </div>
                    
                    <div class="tree-details-panel" id="test-details" style="background-color: white; border: 2px solid #333; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: none;">
                        <div class="details-header" style="background-color: #333; color: white; padding: 15px 20px; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <h4 style="margin: 0; font-size: 16px;">Node Details</h4>
                            <button onclick="closeTestDetails()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">√ó</button>
                        </div>
                        <div class="details-content" style="padding: 20px;">
                            <p>Click on a node in the tree to see detailed information here.</p>
                        </div>
                    </div>
                    
                    <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 12px; margin-top: 15px; font-size: 13px; color: #856404; text-align: center; font-style: italic;">
                        üñ±Ô∏è Interactive tree: Click on nodes to explore decision paths and see detailed information
                    </div>
                </div>
            `;

            // Store data globally for click handlers
            window.currentTestTreeData = data;

            // Enhanced click handlers after mermaid renders
            setTimeout(() => {
                const mermaidDiv = document.getElementById('test-mermaid');
                if (mermaidDiv) {
                    const nodes = mermaidDiv.querySelectorAll('.node, .nodeLabel, g[id*="flowchart"]');
                    console.log(`Found ${nodes.length} interactive elements in tree`);
                    
                    nodes.forEach((node, index) => {
                        node.style.cursor = 'pointer';
                        node.style.pointerEvents = 'auto';
                        
                        node.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Extract node ID using multiple methods
                            let nodeId = node.id || node.getAttribute('data-id');
                            
                            if (!nodeId) {
                                const textElement = node.querySelector('text, .nodeLabel, span');
                                if (textElement && textElement.textContent) {
                                    nodeId = textElement.textContent.trim();
                                }
                            }
                            
                            if (!nodeId && node.closest('[id]')) {
                                nodeId = node.closest('[id]').id;
                            }
                            
                            if (!nodeId) {
                                nodeId = `node${index}`;
                            }
                            
                            // Extract from Mermaid generated IDs
                            if (nodeId && nodeId.includes('flowchart-')) {
                                const match = nodeId.match(/flowchart-([^-]+)/);
                                if (match) {
                                    nodeId = match[1];
                                }
                            }
                            
                            console.log(`Test node clicked: ${nodeId}`);
                            showTestNodeDetails(nodeId);
                        });
                        
                        // Add keyboard support
                        node.setAttribute('tabindex', '0');
                        node.setAttribute('role', 'button');
                        node.setAttribute('aria-label', `Decision node ${index + 1}. Press Enter to view details.`);
                        
                        node.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                node.click();
                            }
                        });
                    });

                    // Initialize enhanced features
                    if (window.TreeInteractionManager) {
                        window.TreeInteractionManager.init('test-output');
                        console.log('Enhanced tree interactions initialized');
                    }
                }
            }, 500);
        }

        function showTestNodeDetails(nodeId) {
            const detailsPanel = document.getElementById('test-details');
            const content = detailsPanel.querySelector('.details-content');
            const data = window.currentTestTreeData;
            
            const nodeData = data.nodes?.find(node => node.id === nodeId);
            
            if (nodeData) {
                content.innerHTML = `
                    <h5>üéØ ${nodeData.name || nodeId}</h5>
                    <p><strong>Type:</strong> ${nodeData.type || 'Unknown'}</p>
                    ${nodeData.description ? `<p><strong>Description:</strong> ${nodeData.description}</p>` : ''}
                    ${nodeData.cost ? `<p><strong>Cost:</strong> ${nodeData.cost}</p>` : ''}
                    ${nodeData.timeframe ? `<p><strong>Timeframe:</strong> ${nodeData.timeframe}</p>` : ''}
                    ${nodeData.risk ? `<p><strong>Risk Level:</strong> ${nodeData.risk}</p>` : ''}
                    ${nodeData.criteria ? `<p><strong>Criteria:</strong> ${nodeData.criteria.join(', ')}</p>` : ''}
                    ${nodeData.outcomes ? `<p><strong>Outcomes:</strong><ul>${nodeData.outcomes.map(o => `<li>${o}</li>`).join('')}</ul></p>` : ''}
                `;
            } else {
                content.innerHTML = `
                    <h5>üéØ Node: ${nodeId}</h5>
                    <p>This node represents a decision point in your analysis.</p>
                    <p><strong>Total Nodes:</strong> ${data.nodes?.length || 0}</p>
                    <p><strong>Available Options:</strong> ${data.options?.length || 0}</p>
                `;
            }
            
            detailsPanel.style.display = 'block';
            detailsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function closeTestDetails() {
            document.getElementById('test-details').style.display = 'none';
        }

        // Auto-run basic test on load
        window.addEventListener('load', () => {
            console.log('Test page loaded, Mermaid available:', typeof mermaid !== 'undefined');
        });
    </script>
</body>
</html>
