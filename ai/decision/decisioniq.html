<!--
 * Copyright (c) 2025 INEXASLI. All rights reserv            <textarea id="decision-options" rows="3" placeholder="Option 1: Salesforce CRM Premium Package - $150/user/month
Option 2: HubSpot Enterprise Solution - $120/user/month
Option 3: Build custom solution in-house"></textarea>
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
-->

<script src="../../payment/paymentform.js"></script>

<div class="device-container">

<div class="row1 product-description-container">
    <h2 class="product-description-heading">Make Clearer, More Confident Decisions!</h2>
    <p class="product-description-text">
        Facing a tough choice or complex problem? DecisionIQ™ helps you navigate the complexities. By guiding you through key questions about your situation, we help our advanced AI understand your unique context. This allows us to provide structured insights and perspectives, empowering you to approach your decisions with greater clarity and confidence.
    </p>
    <p class="product-description-final">
        Let's explore your options!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a professional.</em>
    </p>
</div>


<div class="premium-blur">

        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Clearly describe what decision you need to make or problem you need to solve.">
                Goal<span class="tooltip1-content"></span>
            </h3>
            <textarea id="decision-goal" rows="2" placeholder="Choose a software vendor for our CRM system
Select new office location for regional headquarters"></textarea>
      
       
            <h3 class="tooltip1" data-tooltip="Choose the analytical framework that best suits your decision-making needs.">
                Analysis Type<span class="tooltip1-content"></span>
            </h3>
            <select id="decision-analysis-type">
                <option value="" disabled selected>Select Analysis Type</option>
                <option value="swot">SWOT Analysis</option>
                <option value="pros-cons">Cost-Benefit / Pros-Cons Analysis</option>
                <option value="weighted-scoring">Weighted Scoring</option>
                <option value="decision-tree">Decision Tree</option>
            </select>
      
      
            <h3 class="tooltip1" data-tooltip="List all the potential options or alternatives you're considering for this decision.">
                Decision Options<span class="tooltip1-content"></span>
            </h3>
            <textarea id="decision-options" rows="4" placeholder="Option 1: Salesforce CRM Premium Package
Option 2: HubSpot Enterprise Solution 
Option 3: Build custom solution in-house"></textarea>
       
  <h3>Priority</h3>
            <textarea id="decision-priorities" rows="2" placeholder="Cost effectiveness is our top priority"></textarea>
            

</div>

        
        <div class="row1">
       
            
          
            <h3>Constraint</h3>
            <textarea id="decision-constraints" rows="2" placeholder="Budget limit $50,000 total implementation cost"></textarea>
            
            <h3>Timeline</h3>
            <textarea id="decision-timeline" rows="2" placeholder="Must be implemented within 6 months"></textarea>
            
            <h3>Technical</h3>
            <textarea id="decision-technical" rows="2" placeholder="Must integrate with existing Oracle database"></textarea>
            
            <h3>Stakeholders</h3>
            <textarea id="decision-stakeholders" rows="2" placeholder="IT team and executive leadership must approve"></textarea>
            
            <h3>Compliance</h3>
            <textarea id="decision-compliance" rows="2" placeholder="GDPR compliance required for European customers"></textarea>
        
       
            <button class="generate-btn" id="generate-decision-btn">Generate Decision Analysis Now!</button>
        </div>
 
<script type="module">
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

// Rate limiting utilities are now available globally via window.rateLimiter

(function() {
  console.log("Decision IQ script initializing");

  // Generate button handler - matches income module pattern
  async function handleGenerateDecisionIq() {
    try {
      // Get form data using FormPersistence (with fallback)
      let formData = null;
      if (window.decisionFormPersistence && typeof window.decisionFormPersistence.getSavedFormData === 'function') {
        formData = window.decisionFormPersistence.getSavedFormData();
      } else {
        console.warn("[DecisionIQ] FormPersistence not available, trying to collect form data manually");
        // Fallback: try to collect basic form data manually
        formData = collectFormDataManually();
      }
      
      if (!formData || Object.keys(formData).length === 0) {
        console.error("[DecisionIQ] No form data available");
        alert('Please fill out the form before generating your decision analysis.');
        return;
      }

      // Check rate limiting before proceeding
      if (window.rateLimiter && window.rateLimiter.isRateLimited('decision', 10, 60 * 60 * 1000)) { // 10 requests per hour
        alert('You have exceeded the request limit for decision analysis. Please try again later.');
        return;
      }

      console.log("[DecisionIQ] Form data collected:", formData);

      // Get fingerprint data for rate limiting
      const fingerprintData = window.rateLimiter.getFingerprintForWorker();
      
      // Create combined payload with both form data and fingerprint
      const workerPayload = {
        module: 'decision',
        formData: formData,
        fingerprint: fingerprintData
      };
      
      // DEBUG: Log the final payload (hide sensitive fingerprint details)
      console.log("[DecisionIQ] Final payload being sent to worker:", JSON.stringify({
        formData: formData,
        fingerprint: { 
          deviceId: fingerprintData.deviceId.slice(0, 8) + '...', 
          sessionId: fingerprintData.sessionId.slice(0, 8) + '...',
          requestCount: Object.keys(fingerprintData.requestCounts).length 
        }
      }, null, 2));

      // Use enhanced loading with educational facts
      const dataContainer = document.querySelector('.device-container') || document.body;
      let backendResponse = null;
      
      try {
        const result = await window.enhancedLoading(
          'generate-decision-btn',
          'decision',
          async () => {
            // Use the proper Cloudflare-secured API endpoint
            const apiUrl = 'https://inexasli.com/api/generate';
            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(workerPayload)
            });

            let responseData;
            try {
              responseData = await response.json();
            } catch (e) {
              responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
            }
            
            // Store backend response for error handling
            backendResponse = responseData;
            
            // Always call handleRateLimitResponse with backend response
            window.rateLimiter.handleRateLimitResponse(dataContainer, responseData, !response.ok, 'DecisionIQ');

            if (!response.ok) {
              throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
            }

            if (responseData.message !== 'Success') {
              throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
            }

            return responseData;
          }
        );
        
        // Increment request count after successful response
        window.rateLimiter.incrementRequestCount('decision');

        // Store the response using centralized system
        if (window.decisionFormPersistence) {
          window.decisionFormPersistence.saveResponseData(result);
        }

        // Dispatch an event to notify dataout.js that a response was received
        const event = new CustomEvent('api-response-received', {
          detail: {
            module: 'decisioniq',
            type: 'worker-response',
            timestamp: Date.now()
          }
        });
        document.dispatchEvent(event);
        console.log('[DecisionIQ] Dispatched api-response-received event');
        
        console.log('[DecisionIQ] Decision analysis generated successfully');
      } catch (error) {
        // If backendResponse is available, update rate limit display and show error
        if (backendResponse && dataContainer) {
          window.rateLimiter.handleRateLimitResponse(dataContainer, backendResponse, true, 'DecisionIQ');
        }
        console.error('[DecisionIQ] Error generating decision analysis:', error);
        throw error; // Re-throw to handle in outer catch
      }
    } catch (error) {
      console.error('[DecisionIQ] Error generating decision analysis:', error);
      alert('An error occurred while generating your decision analysis. Please try again later.');
    }
  }

  // Initialize form functionality to match income module pattern
  function initDecisionForm() {
    console.log("[DecisionIQ] Initializing form functionality");
    
    // Use FormPersistence from window (exposed by datain.js)
    if (!window.decisionFormPersistence && window.FormPersistence) {
      console.log("[DecisionIQ] Creating FormPersistence instance using window.FormPersistence");
      window.decisionFormPersistence = window.FormPersistence.getInstance('decision', {
        singleSelection: ['decision-analysis-type', 'decision-priority'],
        multiSelection: ['decision-criteria', 'decision-constraint-types', 'decision-stakeholders']
      });
      
      window.decisionFormPersistence.init({
        moduleName: 'decision',
        singleSelection: ['decision-analysis-type', 'decision-priority'],
        multiSelection: ['decision-criteria', 'decision-constraint-types', 'decision-stakeholders']
      });
      
      console.log("[DecisionIQ] FormPersistence instance created and initialized");
    }
    
    console.log("[DecisionIQ] Using FormPersistence instance:", window.decisionFormPersistence);
    
    // Setup the rest of the functionality
    setupDecisionFormHandlers();
  }

  // Separate function to setup form handlers
  function setupDecisionFormHandlers() {
    // Setup generate button
    const generateBtn = document.getElementById('generate-decision-btn');
    if (generateBtn) {
      generateBtn.removeEventListener('click', handleGenerateDecisionIq);
      generateBtn.addEventListener('click', handleGenerateDecisionIq);
      console.log("[DecisionIQ] Generate button event listener set up");
    } else {
      console.error("[DecisionIQ] Generate button not found!");
    }
    
    // Set up guided forms toggle button
    const guidedToggleBtn = document.getElementById('guided-forms-toggle');
    if (guidedToggleBtn) {
      guidedToggleBtn.removeEventListener('click', toggleGuidedForms);
      guidedToggleBtn.addEventListener('click', toggleGuidedForms);
    }

    // Export the FormPersistence instance for external access
    console.log("[DecisionIQ] Form handlers setup complete");
  }

  // Legacy function for backward compatibility
  function saveFormData() {
    if (window.decisionFormPersistence) {
      console.log("[DecisionIQ] Saving form data via FormPersistence");
      window.decisionFormPersistence.saveFormData();
    }
  }

  // Legacy function for backward compatibility
  function loadSavedData() {
    if (window.decisionFormPersistence) {
      console.log("[DecisionIQ] Loading saved data via FormPersistence");
      const savedData = window.decisionFormPersistence.getSavedFormData();
      if (savedData) {
        window.decisionFormPersistence.repopulateForm(savedData);
      }
    }
  }

  // Toggle guided forms functionality
  let guidedFormsInstance = null;
  
  function toggleGuidedForms() {
    console.log('[DecisionIQ] Toggling guided forms');
    const toggleBtn = document.getElementById('guided-forms-toggle');
    
    if (guidedFormsInstance) {
      // Disable guided forms
      guidedFormsInstance.destroy();
      guidedFormsInstance = null;
      toggleBtn.textContent = '🚀 Enable Guided Form';
      toggleBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      console.log('[DecisionIQ] Guided forms disabled');
    } else {
      // Enable guided forms
      if (window.GuidedFormSystem) {
        guidedFormsInstance = new window.GuidedFormSystem({
          autoAdvance: true,
          showProgressIndicator: true,
          smoothTransitions: true,
          transitionDuration: 300,
          autoAdvanceDelay: 800,
          enableSkipping: true
        });
        
        guidedFormsInstance.init('device-container');
        
        toggleBtn.textContent = '⏹️ Disable Guided Form';
        toggleBtn.style.background = 'linear-gradient(135deg, #ea667e 0%, #a24b76 100%)';
        console.log('[DecisionIQ] Guided forms enabled');
      } else {
        console.error('[DecisionIQ] GuidedFormSystem not available');
        alert('Guided forms system is not loaded. Please refresh the page.');
      }
    }
  }

  // Initialize with multiple triggers to ensure reliability
  function runInitialization() {
    // Use a small delay to ensure DOM is ready
    setTimeout(initDecisionForm, 50);
  }

  // Initialize form persistence when DOM is ready
  function initializeDecisionIQ() {
    console.log("Decision IQ DOM ready, initializing form persistence");
    
    // Use FormPersistence from window (exposed by datain.js)
    if (window.FormPersistence) {
      const persistence = window.FormPersistence.getInstance('decision', {
        singleSelection: ['decision-analysis-type', 'decision-priority'], // Single selection containers  
        multiSelection: ['decision-criteria', 'decision-constraint-types', 'decision-stakeholders'] // Multi selection containers
      });
      
      persistence.init({
        moduleName: 'decision',
        singleSelection: ['decision-analysis-type', 'decision-priority'],
        multiSelection: ['decision-criteria', 'decision-constraint-types', 'decision-stakeholders']
      });
      
      console.log("Decision IQ form persistence initialized");
      
      // Initialize the rest of the functionality after form persistence is set up
      runInitialization();
    } else {
      console.warn("FormPersistence not available from window, skipping persistence setup");
      runInitialization();
    }
  }

  // Initialize immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDecisionIQ);
  } else {
    initializeDecisionIQ();
  }

  // Handle loading through datain.js - only initialize if decision module is loaded
  document.addEventListener('data-in-loaded', function(e) {
    const moduleType = e.detail?.moduleType;
    if (moduleType === 'decision') {
      console.log("[DecisionIQ] Decision module loaded through datain.js, reinitializing");
      initDecisionForm();
    }
  });

  // Additional safety net - try again after a short delay
  setTimeout(() => {
    const generateBtn = document.getElementById('generate-decision-btn');
    if (generateBtn && !generateBtn.onclick) {
      console.log("[DecisionIQ] Generate button found but no handler, trying initialization again");
      initDecisionForm();
    }
  }, 200);
  
  // Export functions for external access
  window.decisionIq = { 
    getFormData: () => window.decisionFormPersistence ? window.decisionFormPersistence.getSavedFormData() : null,
    saveFormData: () => saveFormData(),
    loadSavedData: () => loadSavedData()
  };

  // Fallback function to collect form data manually when FormPersistence is not available
  function collectFormDataManually() {
    console.log("[DecisionIQ] Collecting form data manually as fallback");
    
    const formData = {};
    
    // Collect text inputs and textareas
    const inputs = document.querySelectorAll('input[type="text"], textarea');
    inputs.forEach(input => {
      if (input.id && input.value.trim()) {
        formData[input.id] = input.value.trim();
      }
    });
    
    // Collect selected grid items
    const selectedItems = document.querySelectorAll('.grid-item.active, .grid-item.selected');
    selectedItems.forEach(item => {
      const container = item.closest('[id]');
      if (container && container.id) {
        if (!formData[container.id]) {
          formData[container.id] = [];
        }
        const value = item.getAttribute('data-value') || item.textContent.trim();
        if (value && !formData[container.id].includes(value)) {
          formData[container.id].push(value);
        }
      }
    });
    
    console.log("[DecisionIQ] Manually collected form data:", formData);
    return formData;
  }

})();
</script>
</div>
</div>