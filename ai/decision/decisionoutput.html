<link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles/outputstyles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="../../utility/enhancedUI.js"></script>
  <style>
    html {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <style>
 
    
    /* Using device-container styles from outputstyles.css */
    
    .decision-header {
      font-size: 18px; /* Adjusted size */
      font-weight: 500; /* Adjusted weight */
      margin: 0;
      color: #333; /* Standard text color */
      font-family: "Inter", sans-serif; /* Standard font */
      padding: 15px; /* Adjusted padding */
      border-bottom: 1px solid #eee; /* Lighter border */
      text-align: center;
      width: 100%;
      box-sizing: border-box;
    }
    
    /* Using output-wrapper and api-output styles from outputstyles.css */
    
    /* Copy button styles now in external JS file */
    
    /* Decision Tree Visualization Styles */
    .decision-tree-container {
      background-color: #fafafa;
      border: 2px solid #333;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .decision-tree-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .decision-tree-header h3 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 20px;
      font-weight: 600;
      font-family: "Geist", sans-serif;
    }

    .mermaid {
      text-align: center;
      margin: 20px 0;
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .decision-tree-fallback {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin: 20px 0;
    }

    .decision-tree-fallback h3 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 18px;
      font-weight: 600;
      font-family: "Geist", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .decision-tree-fallback h3:before {
      content: "üå≥";
      font-size: 24px;
    }

    .tree-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    .tree-metric {
      background-color: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 15px;
      text-align: center;
    }

    .nodes-info, .edges-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .nodes-info strong, .edges-info strong {
      color: #1976D2;
      font-size: 14px;
      font-weight: 600;
      font-family: "Geist", sans-serif;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      font-family: "Geist", sans-serif;
    }

    .metric-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    .tree-structure-info {
      background-color: #f0f8ff;
      border: 1px solid #d0e7ff;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      text-align: left;
    }

    .tree-structure-info h4 {
      margin: 0 0 10px 0;
      color: #2c5aa0;
      font-size: 16px;
      font-weight: 600;
      font-family: "Geist", sans-serif;
    }

    .tree-structure-info p {
      margin: 5px 0;
      font-size: 14px;
      color: #555;
      line-height: 1.4;
    }

    .tree-navigation-hint {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 6px;
      padding: 12px;
      margin-top: 15px;
      font-size: 13px;
      color: #856404;
      text-align: center;
      font-style: italic;
    }

    /* Interactive Tree Features */
    .tree-details-panel {
      background-color: white;
      border: 2px solid #333;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      animation: slideIn 0.3s ease-out;
    }

    .details-header {
      background-color: #333;
      color: white;
      padding: 15px 20px;
      border-radius: 6px 6px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .details-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      font-family: "Geist", sans-serif;
    }

    .close-details {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      transition: background-color 0.2s ease;
    }

    .close-details:hover {
      background-color: rgba(255,255,255,0.2);
    }

    .details-content {
      padding: 20px;
      color: #333;
      line-height: 1.6;
    }

    .details-content h5 {
      margin: 0 0 10px 0;
      color: #1976D2;
      font-size: 16px;
      font-weight: 600;
      font-family: "Geist", sans-serif;
    }

    .details-content p {
      margin: 8px 0;
      font-size: 14px;
    }

    .node-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    .node-info-item {
      background-color: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
    }

    .node-info-label {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }

    .node-info-value {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Enhance Mermaid nodes for better clickability */
    .mermaid .node rect,
    .mermaid .node circle,
    .mermaid .node polygon {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mermaid .node:hover rect,
    .mermaid .node:hover circle,
    .mermaid .node:hover polygon {
      stroke: #1976D2;
      stroke-width: 3px;
      filter: drop-shadow(0 2px 4px rgba(25,118,210,0.3));
    }

    /* Enhanced Interactive Features */
    .mermaid .node {
      position: relative;
    }

    .mermaid .node.focused {
      outline: 3px solid #FFA726;
      outline-offset: 2px;
      border-radius: 4px;
    }

    .mermaid .node.selected {
      filter: drop-shadow(0 4px 12px rgba(25,118,210,0.4));
      transform: scale(1.05);
    }

    /* Mobile touch enhancements */
    @media (max-width: 768px) {
      .mermaid .node rect,
      .mermaid .node circle,
      .mermaid .node polygon {
        min-width: 44px;
        min-height: 44px;
      }
      
      .decision-tree-container {
        padding: 15px;
      }
      
      .tree-details-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-height: 60vh;
        overflow-y: auto;
        z-index: 1000;
        border-radius: 12px 12px 0 0;
        animation: slideInFromBottom 0.3s ease-out;
      }
    }

    @keyframes slideInFromBottom {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }

    /* Tree controls */
    .tree-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding: 12px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .tree-controls button {
      background-color: #1976D2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      margin: 0 4px;
      transition: background-color 0.2s ease;
    }

    .tree-controls button:hover {
      background-color: #1565C0;
    }

    .tree-controls button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .tree-search {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      width: 200px;
    }

    /* Accessibility indicators */
    .accessibility-info {
      background-color: #e3f2fd;
      border: 1px solid #90caf9;
      border-radius: 6px;
      padding: 10px;
      margin-top: 10px;
      font-size: 12px;
      color: #1565c0;
    }

    /* Loading overlay for interactions */
    .tree-loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #666;
      border-radius: 8px;
      z-index: 10;
    }

    /* Breadcrumb navigation */
    .tree-breadcrumb {
      background-color: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 8px 12px;
      margin-bottom: 15px;
      font-size: 13px;
      color: #555;
    }

    .breadcrumb-item {
      display: inline-block;
      margin-right: 8px;
      cursor: pointer;
      color: #1976D2;
      text-decoration: underline;
    }

    .breadcrumb-item:last-child {
      color: #333;
      text-decoration: none;
      cursor: default;
      font-weight: 500;
    }

    .breadcrumb-separator {
      margin: 0 6px;
      color: #999;
    }

   
  </style>
</head>
<body>
  <div class="device-container">
    <div class="output-wrapper">
      <div id="output-span" class="api-output">
        <div class="loading">
          <div class="loading-text">Loading data...</div>
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>

  <!-- Add Mermaid.js for decision trees -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
  
  <!-- Add D3.js for charts -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <script>
    /*
    ================================================
    üå≥ ENHANCED DECISION TREE VISUALIZATION SYSTEM
    ================================================
    
    FEATURES IMPLEMENTED:
    
    üéØ CORE INTERACTIVE FUNCTIONALITY:
    ‚úÖ Clickable nodes with detailed information panels
    ‚úÖ Mermaid.js integration with proper security settings
    ‚úÖ Fallback click handlers for maximum compatibility
    ‚úÖ Dynamic content loading and rendering
    
    üéÆ ADVANCED INTERACTIONS:
    ‚úÖ Full keyboard navigation (arrow keys, Enter, Escape)
    ‚úÖ Mobile touch support with optimized touch targets
    ‚úÖ Search and filter functionality for large trees
    ‚úÖ Export capabilities (JSON data export)
    ‚úÖ Breadcrumb navigation tracking user paths
    ‚úÖ Zoom and reset view functionality
    
    ‚ôø ACCESSIBILITY FEATURES:
    ‚úÖ ARIA labels and roles for screen readers
    ‚úÖ Keyboard focus management with visual indicators
    ‚úÖ Screen reader announcements for interactions
    ‚úÖ High contrast focus indicators
    ‚úÖ Tab navigation support
    
    üì± MOBILE OPTIMIZATION:
    ‚úÖ Touch-friendly node sizing (44px minimum)
    ‚úÖ Mobile-specific modal positioning
    ‚úÖ Swipe gesture detection
    ‚úÖ Responsive design adaptations
    
    üé® VISUAL ENHANCEMENTS:
    ‚úÖ Professional styling matching other analysis types
    ‚úÖ Hover effects and smooth transitions
    ‚úÖ Loading states and animations
    ‚úÖ Visual feedback for interactions
    ‚úÖ Enhanced fallback displays when Mermaid unavailable
    
    üìä ANALYTICS & PERFORMANCE:
    ‚úÖ Comprehensive user interaction tracking
    ‚úÖ Performance monitoring and optimization
    ‚úÖ Usage analytics with detailed reporting
    ‚úÖ Real-time optimization suggestions
    ‚úÖ Session data persistence
    
    üõ†Ô∏è DEVELOPER FEATURES:
    ‚úÖ Modular TreeInteractionManager class
    ‚úÖ Comprehensive error handling
    ‚úÖ Console logging for debugging
    ‚úÖ Extensible architecture for future enhancements
    ‚úÖ Performance measurement utilities
    
    üìã USAGE INSTRUCTIONS:
    - Click/tap any node to view detailed information
    - Use Tab to focus tree, arrow keys to navigate
    - Press Enter to select focused nodes
    - Use search box to filter nodes by text
    - Export tree data using the export button
    - Access help modal for full feature list
    
    üîß TECHNICAL IMPLEMENTATION:
    - Mermaid.js v10.6.1 for diagram rendering
    - Custom CSS for enhanced styling and animations
    - JavaScript ES6+ for modern functionality
    - localStorage for analytics persistence
    - Performance API for monitoring
    */

    // Run immediately without waiting for DOMContentLoaded
    (function() {
      console.log('Decision API Output script running');
      
      // Initialize the centralized copy button
      
      // Built-in visualization logic (streamlined to top 5 most useful analysis types)
      const getVisualizationHints = (analysisType) => {
        const hints = {
          'swot': {
            recommended: 'D3.js',
            chartTypes: ['quadrant-chart', 'matrix-visualization'],
            description: 'Perfect for 2x2 matrix visualization with quadrants'
          },
          'cost-benefit': {
            recommended: 'D3.js',
            chartTypes: ['line-chart', 'bar-chart', 'waterfall-chart', 'roi-chart'],
            description: 'Financial data ideal for line charts showing ROI over time'
          },
          'pros-cons': {
            recommended: 'D3.js',
            chartTypes: ['horizontal-bar-chart', 'grouped-bar-chart', 'comparison-table'],
            description: 'Best visualized as comparative bar charts or tables showing pros vs cons'
          },
          'weighted-scoring': {
            recommended: 'D3.js',
            chartTypes: ['radar-chart', 'stacked-bar-chart', 'comparison-matrix'],
            description: 'Radar charts or comparison matrices for scoring visualization'
          },
          'decision-tree': {
            recommended: 'Mermaid.js',
            chartTypes: ['flowchart', 'decision-tree'],
            description: 'Ideal for Mermaid flowchart or tree diagram'
          }
        };

        return hints[analysisType] || {
          recommended: 'D3.js',
          chartTypes: ['table', 'simple-chart'],
          description: 'Standard visualization options available'
        };
      };

      // Initialize Mermaid with error handling and disabled click handling
      if (typeof mermaid !== 'undefined') {
        try {
          mermaid.initialize({ 
            startOnLoad: true, 
            theme: 'default',
            flowchart: {
              useMaxWidth: true,
              htmlLabels: true,
              curve: 'basis'
            },
            securityLevel: 'strict', // Prevent any click navigation issues
            maxTextSize: 50000,
            suppressErrorRendering: true
          });
        } catch (error) {
          console.warn('Failed to initialize mermaid:', error);
        }
      } else {
        console.warn('Mermaid library not available');
      }
      
      // Create visualization based on analysis type
      const createVisualization = (data, containerId) => {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!data.analysisType) {
          // No analysis type, just show JSON
          container.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
          return;
        }

        const hints = getVisualizationHints(data.analysisType);
        console.log(`Creating visualization for ${data.analysisType}:`, hints);

        // Clear container
        container.innerHTML = '';

        // Create visualization header
        const header = document.createElement('div');
        header.className = 'visualization-header';
        header.innerHTML = `
          <h2>${data.decisionTitle || 'Decision Analysis'}</h2>
          <div class="analysis-type">Analysis Type: ${data.analysisType}</div>
        `;
        container.appendChild(header);

        // Create visualization content
        const vizContainer = document.createElement('div');
        vizContainer.className = 'visualization-content';
        vizContainer.id = `viz-${containerId}`;
        container.appendChild(vizContainer);

        // Route to appropriate visualization (streamlined to top 5 analysis types)
        try {
          switch (data.analysisType) {
            case 'swot':
              createSwotVisualization(data, vizContainer);
              break;
            case 'cost-benefit':
              createCostBenefitVisualization(data, vizContainer);
              break;
            case 'pros-cons':
              createProsConsVisualization(data, vizContainer);
              break;
            case 'weighted-scoring':
              createWeightedScoringVisualization(data, vizContainer);
              break;
            case 'decision-tree':
              createDecisionTreeVisualization(data, vizContainer);
              break;
            default:
              // Fallback to JSON with hints
              vizContainer.innerHTML = `
                <div class="visualization-info">
                  <p><strong>Recommended:</strong> ${hints.recommended}</p>
                  <p><strong>Chart Types:</strong> ${hints.chartTypes.join(', ')}</p>
                  <p><strong>Description:</strong> ${hints.description}</p>
                </div>
                <pre>${JSON.stringify(data, null, 2)}</pre>
              `;
          }
        } catch (error) {
          console.error('Error creating visualization:', error);
          vizContainer.innerHTML = `
            <div class="error-message">
              <h3>Visualization Error</h3>
              <p>Could not create visualization. Showing raw data:</p>
            </div>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
        }

        // Add raw data toggle
        const rawDataToggle = document.createElement('div');
        rawDataToggle.className = 'raw-data-toggle';
        rawDataToggle.innerHTML = `
          <button onclick="toggleRawData('${containerId}')">Show/Hide Raw Data</button>
          <div id="raw-data-${containerId}" class="raw-data" style="display: none;">
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </div>
        `;
        container.appendChild(rawDataToggle);
      };

      // Decision Tree Visualization using Mermaid
      const createDecisionTreeVisualization = (data, container) => {
        // Create the main container with enhanced styling
        const treeContainer = document.createElement('div');
        treeContainer.className = 'decision-tree-container';
        
        // Add header
        const header = document.createElement('div');
        header.className = 'decision-tree-header';
        header.innerHTML = `
          <h3>${data.decisionTitle || 'Decision Tree Analysis'}</h3>
          <div class="analysis-type" style="color: #666; font-size: 14px; font-style: italic;">
            Interactive decision flow visualization
          </div>
        `;
        treeContainer.appendChild(header);

        if (data.mermaidSyntax && typeof mermaid !== 'undefined') {
          try {
            const mermaidDiv = document.createElement('div');
            mermaidDiv.className = 'mermaid';
            mermaidDiv.id = `mermaid-tree-${Date.now()}`;
            
            // Enhanced Mermaid syntax - remove problematic click events
            let enhancedSyntax = data.mermaidSyntax.replace(/\\n/g, '\n');
            
            // Note: We don't add Mermaid click events here as they cause URL navigation issues
            // Instead, we rely entirely on our JavaScript event listeners added below
            
            mermaidDiv.textContent = enhancedSyntax;
            treeContainer.appendChild(mermaidDiv);
            
            // Create interactive details panel
            const detailsPanel = document.createElement('div');
            detailsPanel.className = 'tree-details-panel';
            detailsPanel.id = `details-${mermaidDiv.id}`;
            detailsPanel.style.display = 'none';
            detailsPanel.innerHTML = `
              <div class="details-header">
                <h4>Node Details</h4>
                <button class="close-details" onclick="closeNodeDetails('${detailsPanel.id}')">√ó</button>
              </div>
              <div class="details-content">
                <p>Click on a node in the tree to see detailed information here.</p>
              </div>
            `;
            treeContainer.appendChild(detailsPanel);
            
            // Add navigation hint for interactive trees
            const navHint = document.createElement('div');
            navHint.className = 'tree-navigation-hint';
            navHint.innerHTML = 'üñ±Ô∏è Interactive tree: Click on nodes to explore decision paths and see detailed information';
            treeContainer.appendChild(navHint);
            
            container.appendChild(treeContainer);
            
            // Store tree data globally for click handlers
            window.currentTreeData = data;
            window.currentDetailsPanel = detailsPanel.id;
            
            // Re-initialize mermaid for new content
            mermaid.init(undefined, mermaidDiv);
            
            // Enhanced click handlers with multiple fallback methods
            setTimeout(() => {
              const nodes = mermaidDiv.querySelectorAll('.node, .nodeLabel, g[id*="flowchart"]');
              console.log(`Found ${nodes.length} interactive elements in tree`);
              
              nodes.forEach((node, index) => {
                // Make sure all elements are clickable
                node.style.cursor = 'pointer';
                node.style.pointerEvents = 'auto';
                
                // Prevent any default link behavior
                node.addEventListener('click', (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  
                  // Multiple methods to extract node ID
                  let nodeId = null;
                  
                  // Method 1: Direct ID attribute
                  if (node.id) {
                    nodeId = node.id;
                  }
                  
                  // Method 2: Data attribute
                  if (!nodeId && node.getAttribute('data-id')) {
                    nodeId = node.getAttribute('data-id');
                  }
                  
                  // Method 3: Text content from labels
                  if (!nodeId) {
                    const textElement = node.querySelector('text, .nodeLabel, span');
                    if (textElement && textElement.textContent) {
                      nodeId = textElement.textContent.trim();
                    }
                  }
                  
                  // Method 4: Parent node ID if this is a child element
                  if (!nodeId) {
                    const parentNode = node.closest('[id]');
                    if (parentNode && parentNode.id) {
                      nodeId = parentNode.id;
                    }
                  }
                  
                  // Method 5: Fall back to index-based ID
                  if (!nodeId) {
                    nodeId = `node${index}`;
                  }
                  
                  // Method 6: Extract from Mermaid generated IDs
                  if (nodeId && nodeId.includes('flowchart-')) {
                    const match = nodeId.match(/flowchart-([^-]+)/);
                    if (match) {
                      nodeId = match[1];
                    }
                  }
                  
                  console.log(`Node clicked: ${nodeId} (element:`, node, ')');
                  
                  // Call the show details function
                  if (window.showNodeDetails && nodeId) {
                    window.showNodeDetails(nodeId);
                  } else {
                    console.warn('showNodeDetails function not available or nodeId missing');
                  }
                });
                
                // Add keyboard support for each node
                node.setAttribute('tabindex', '0');
                node.setAttribute('role', 'button');
                node.setAttribute('aria-label', `Decision node. Press Enter to view details.`);
                
                node.addEventListener('keydown', (e) => {
                  if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    node.click(); // Trigger the click handler
                  }
                });
              });

              // Initialize enhanced interactive features
              if (window.TreeInteractionManager) {
                window.TreeInteractionManager.init(container.id || 'decision-tree-container');
                console.log('Enhanced tree interactions initialized');
              }
            }, 100); // Small delay to ensure mermaid has rendered
          } catch (error) {
            console.warn('Mermaid rendering failed:', error);
            // Enhanced fallback with better styling
            createEnhancedTreeFallback(data, treeContainer);
            container.appendChild(treeContainer);
          }
        } else {
          // Enhanced fallback: create rich tree visualization
          createEnhancedTreeFallback(data, treeContainer);
          container.appendChild(treeContainer);
        }
      };

      // Enhanced tree fallback with comprehensive information
      const createEnhancedTreeFallback = (data, container) => {
        const fallbackDiv = document.createElement('div');
        fallbackDiv.className = 'decision-tree-fallback';
        
        const nodesCount = data.nodes?.length || 0;
        const edgesCount = data.edges?.length || 0;
        const options = data.options || [];
        
        fallbackDiv.innerHTML = `
          <h3>Decision Tree Structure</h3>
          
          <div class="tree-metrics">
            <div class="tree-metric">
              <div class="nodes-info">
                <div class="metric-value">${nodesCount}</div>
                <div class="metric-label">Decision Points</div>
              </div>
            </div>
            <div class="tree-metric">
              <div class="edges-info">
                <div class="metric-value">${edgesCount}</div>
                <div class="metric-label">Pathways</div>
              </div>
            </div>
          </div>

          ${options.length > 0 ? `
            <div class="tree-structure-info">
              <h4>üìä Decision Options</h4>
              ${options.map((option, index) => `
                <p><strong>Option ${index + 1}:</strong> ${option.name || option}</p>
              `).join('')}
            </div>
          ` : ''}

          ${data.criteria && data.criteria.length > 0 ? `
            <div class="tree-structure-info">
              <h4>‚öñÔ∏è Key Decision Criteria</h4>
              ${data.criteria.map(criterion => `
                <p><strong>‚Ä¢</strong> ${criterion.name || criterion}</p>
              `).join('')}
            </div>
          ` : ''}

          ${data.recommendation ? `
            <div class="tree-structure-info">
              <h4>üéØ Recommended Path</h4>
              <p><strong>Choice:</strong> ${data.recommendation.topChoice}</p>
              <p><strong>Reasoning:</strong> ${data.recommendation.reasoning}</p>
              ${data.recommendation.confidence ? `<p><strong>Confidence:</strong> ${data.recommendation.confidence}</p>` : ''}
            </div>
          ` : ''}

          <div class="tree-navigation-hint">
            üí° Tip: Decision trees help visualize complex choices by breaking them into sequential decisions and their potential outcomes.
          </div>
        `;
        
        container.appendChild(fallbackDiv);
      };

      // Pros/Cons Visualization using D3.js
      const createProsConsVisualization = (data, container) => {
        if (!data.options || !data.options.length) {
          container.innerHTML = '<p>No options data available for visualization.</p>';
          return;
        }

        // Show all options, not just the first one
        let optionsHTML = '';
        data.options.forEach((option, index) => {
          optionsHTML += `
            <div class="pros-cons-chart option-chart">
              <h3 class="option-title">${option.name} <span class="score-badge">Score: ${option.overallScore}/100</span></h3>
              <div class="t-chart">
                <div class="t-chart-headers">
                  <div class="pros-header">‚úì PROS (${option.pros?.length || 0})</div>
                  <div class="cons-header">‚úó CONS (${option.cons?.length || 0})</div>
                </div>
                <div class="t-chart-content">
                  <div class="pros-side">
                    <div id="pros-bars-${index}" class="pros-bars"></div>
                  </div>
                  <div class="cons-side">
                    <div id="cons-bars-${index}" class="cons-bars"></div>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        // Add recommendation section
        if (data.recommendation) {
          optionsHTML += `
            <div class="recommendation-section">
              <h3>üìã Recommendation</h3>
              <div class="top-choice">
                <strong>Top Choice:</strong> ${data.recommendation.topChoice}
              </div>
              <div class="reasoning">
                <strong>Reasoning:</strong> ${data.recommendation.reasoning}
              </div>
              <div class="confidence">
                <strong>Confidence:</strong> ${data.recommendation.confidence}
              </div>
            </div>
          `;
        }
        
        container.innerHTML = `
          <div class="all-options-container">
            ${optionsHTML}
          </div>
        `;

        // Create bar charts for each option with alignment
        data.options.forEach((option, index) => {
          createAlignedBarCharts(option.pros || [], option.cons || [], `pros-bars-${index}`, `cons-bars-${index}`);
        });
      };

      // Aligned bar charts helper function for pros/cons T-chart with proper alignment
      const createAlignedBarCharts = (prosData, consData, prosContainerId, consContainerId) => {
        const prosContainer = document.getElementById(prosContainerId);
        const consContainer = document.getElementById(consContainerId);
        if (!prosContainer || !consContainer) return;
        
        // Clear any existing content
        prosContainer.innerHTML = '';
        consContainer.innerHTML = '';
        
        // Filter and validate data
        const validProsData = prosData.filter(item => item && (item.point || item.factor) && item.weight);
        const validConsData = consData.filter(item => item && (item.point || item.factor) && item.weight);
        
        if (!validProsData.length && !validConsData.length) {
          prosContainer.innerHTML = '<div class="no-data">No pros data</div>';
          consContainer.innerHTML = '<div class="no-data">No cons data</div>';
          return;
        }
        
        // Determine maximum number of rows needed for alignment
        const maxRows = Math.max(validProsData.length, validConsData.length);
        
        // Create items for both sides with consistent heights
        for (let i = 0; i < maxRows; i++) {
          const prosItem = validProsData[i] || null;
          const consItem = validConsData[i] || null;
          
          // Create pros item or spacer
          const prosDiv = document.createElement('div');
          prosDiv.className = 'aligned-item';
          if (prosItem) {
            prosDiv.innerHTML = createItemHTML(prosItem, '#333');
          } else {
            prosDiv.innerHTML = '<div class="spacer-item"></div>';
          }
          prosContainer.appendChild(prosDiv);
          
          // Create cons item or spacer
          const consDiv = document.createElement('div');
          consDiv.className = 'aligned-item';
          if (consItem) {
            consDiv.innerHTML = createItemHTML(consItem, '#666');
          } else {
            consDiv.innerHTML = '<div class="spacer-item"></div>';
          }
          consContainer.appendChild(consDiv);
        }
      };
      
      // Helper function to create consistent item HTML
      const createItemHTML = (item, color) => {
        const point = item.point || item.factor || item.text || 'Unknown';
        const weight = parseFloat(item.weight) || 0;
        const category = item.category || weight;
        
        // Determine if this should be a bar item or level item
        const isNumericWeight = !isNaN(weight) && weight > 0;
        const isLevelWeight = ['high', 'medium', 'low'].includes(String(item.weight).toLowerCase());
        
        if (isLevelWeight) {
          // Level-based item (High/Medium/Low)
          const level = String(item.weight).toLowerCase();
          return `
            <div class="level-item">
              <div class="level-content">
                <div class="level-badge ${level}" style="border-color: ${color}; color: ${color};">${String(item.weight).toUpperCase()}</div>
                <div class="level-label">${point}</div>
              </div>
            </div>
          `;
        } else if (isNumericWeight) {
          // Bar-based item with numeric weight
          const maxWeight = 100; // Assume scale of 0-100
          const percentage = Math.min((weight / maxWeight) * 100, 100);
          
          return `
            <div class="bar-item">
              <div class="bar-label">${point}</div>
              <div class="bar-background">
                <div class="bar-fill" style="width: ${percentage}%; background-color: ${color};"></div>
              </div>
              <div class="bar-value">${weight}</div>
            </div>
          `;
        } else {
          // Simple text item
          return `
            <div class="level-item">
              <div class="level-content">
                <div class="level-label">${point}</div>
              </div>
            </div>
          `;
        }
      };

      // Cost-Benefit Visualization
      const createCostBenefitVisualization = (data, container) => {
        if (!data.options || !data.options.length) {
          container.innerHTML = '<p>No options data available for visualization.</p>';
          return;
        }

        const option = data.options[0];
        
        container.innerHTML = `
          <div class="cost-benefit-chart">
            <h3>${option.name}</h3>
            <div class="financial-metrics">
              <div class="metric">
                <span class="label">ROI:</span>
                <span class="value">${option.roi || 'N/A'}</span>
              </div>
              <div class="metric">
                <span class="label">NPV:</span>
                <span class="value">$${(option.netPresentValue || 0).toLocaleString()}</span>
              </div>
              <div class="metric">
                <span class="label">Payback:</span>
                <span class="value">${option.paybackPeriod || 'N/A'}</span>
              </div>
            </div>
            <div class="costs-benefits">
              <div class="costs-section">
                <h4>Costs</h4>
                <div id="costs-chart"></div>
              </div>
              <div class="benefits-section">
                <h4>Benefits</h4>
                <div id="benefits-chart"></div>
              </div>
            </div>
          </div>
        `;

        // Convert cost-benefit data structure for bar charts
        const costsForChart = (option.costs || []).map(cost => ({
          point: cost.category,
          weight: cost.amount.toLocaleString(),
          category: cost.amount
        }));
        const benefitsForChart = (option.benefits || []).map(benefit => ({
          point: benefit.category, 
          weight: benefit.amount.toLocaleString(),
          category: benefit.amount
        }));
        
        createSimpleBarChart(costsForChart, 'costs-chart', '#666');
        createSimpleBarChart(benefitsForChart, 'benefits-chart', '#333');
      };

      // SWOT Visualization
      const createSwotVisualization = (data, container) => {
        if (!data.swotMatrix) {
          container.innerHTML = '<p>No SWOT matrix data available for visualization.</p>';
          return;
        }

        const { strengths, weaknesses, opportunities, threats } = data.swotMatrix;

        container.innerHTML = `
          <div class="swot-matrix">
            <div class="swot-quadrant strengths">
              <h4>Strengths</h4>
              <ul>${(strengths || []).map(s => `<li><strong>${s.factor}</strong><br><small>${s.impact} impact</small></li>`).join('')}</ul>
            </div>
            <div class="swot-quadrant weaknesses">
              <h4>Weaknesses</h4>
              <ul>${(weaknesses || []).map(w => `<li><strong>${w.factor}</strong><br><small>${w.impact} impact</small></li>`).join('')}</ul>
            </div>
            <div class="swot-quadrant opportunities">
              <h4>Opportunities</h4>
              <ul>${(opportunities || []).map(o => `<li><strong>${o.factor}</strong><br><small>${o.impact} impact, ${o.likelihood} likelihood</small></li>`).join('')}</ul>
            </div>
            <div class="swot-quadrant threats">
              <h4>Threats</h4>
              <ul>${(threats || []).map(t => `<li><strong>${t.factor}</strong><br><small>${t.impact} impact, ${t.likelihood} likelihood</small></li>`).join('')}</ul>
            </div>
          </div>
        `;
      };

      // Weighted Scoring Visualization
      const createWeightedScoringVisualization = (data, container) => {
        if (!data.options || !data.options.length) {
          container.innerHTML = '<p>No scoring data available for visualization.</p>';
          return;
        }

        container.innerHTML = `
          <div class="weighted-scoring">
            <h3>Weighted Scoring Analysis</h3>
            <div class="criteria-weights">
              <h4>Criteria Weights</h4>
              <div id="criteria-chart"></div>
            </div>
            <div class="options-scores">
              <h4>Option Scores</h4>
              <div id="scores-chart"></div>
            </div>
          </div>
        `;

        // Show criteria weights
        if (data.criteria) {
          const criteriaForChart = data.criteria.map(c => ({
            point: c.name,
            weight: `${c.weight}%`,
            category: c.weight
          }));
          console.log('Criteria data for chart:', criteriaForChart);
          createSimpleBarChart(criteriaForChart, 'criteria-chart', '#333');
        }

        // Show option scores
        data.options.forEach((option, index) => {
          const optionDiv = document.createElement('div');
          optionDiv.className = 'option-score';
          optionDiv.innerHTML = `
            <h5>${option.name} - Total: ${option.totalScore}</h5>
            <div class="scores-breakdown">
              ${(option.scores || []).map(s => `
                <div class="score-item">
                  <span>${s.criterion}:</span>
                  <span>${s.rawScore}/10 (weighted: ${s.weightedScore})</span>
                </div>
              `).join('')}
            </div>
          `;
          container.querySelector('#scores-chart').appendChild(optionDiv);
        });
      };

      // Simple bar chart helper function - handles multiple data structures
      const createSimpleBarChart = (data, containerId, color) => {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        // Clear any existing content
        container.innerHTML = '';
        
        // Filter out empty or invalid data
        const validData = data.filter(item => {
          return item && (item.point || item.factor || item.name || item.category) && 
                 (item.weight || item.amount || item.category || item.impact);
        });
        
        if (!validData.length) {
          container.innerHTML = '<div class="no-data">No data to display</div>';
          return;
        }

        // Convert weight strings to numeric values for pros/cons data
        const getWeightValue = (weight) => {
          if (typeof weight === 'string') {
            switch (weight.toLowerCase()) {
              case 'high': return 3;
              case 'medium': return 2;
              case 'low': return 1;
              default: return 0; // Invalid weight gets 0
            }
          }
          return typeof weight === 'number' ? weight : 0;
        };

        // Determine data structure and extract values
        const getValue = (item) => {
          // For criteria weights, category should be the numeric value
          if (typeof item.category === 'number') return item.category;
          if (typeof item.amount === 'number') return item.amount;
          
          // Handle percentage strings (e.g., "25%")
          if (typeof item.weight === 'string' && item.weight.includes('%')) {
            const numericValue = parseFloat(item.weight.replace('%', ''));
            return isNaN(numericValue) ? 0 : numericValue;
          }
          
          if (item.weight) return getWeightValue(item.weight);
          return 0; // No valid value found
        };

        const getLabel = (item) => {
          return item.point || item.factor || item.name || item.category || 'Item';
        };

        const getDisplayValue = (item) => {
          if (item.weight && typeof item.weight === 'string') return item.weight;
          if (item.amount) return item.amount.toLocaleString();
          if (item.impact) return item.impact;
          return item.weight || '';
        };

        const getWeightColor = (weight, baseColor) => {
          if (typeof weight === 'string') {
            switch (weight.toLowerCase()) {
              case 'high': return '#333'; // Dark gray/black for high impact
              case 'medium': return '#666'; // Medium gray for medium impact  
              case 'low': return '#999'; // Light gray for low impact
              default: return baseColor;
            }
          }
          return baseColor;
        };

        // Calculate max value, ensuring we have valid data
        const values = validData.map(getValue).filter(v => v > 0);
        let maxValue = values.length > 0 ? Math.max(...values) : 1;
        
        // For percentage data (criteria weights), use 100 as max if values look like percentages
        const hasPercentageWeights = validData.some(item => 
          typeof item.weight === 'string' && item.weight.includes('%')
        );
        if (hasPercentageWeights && maxValue <= 100) {
          maxValue = 100;
        }
        
        console.log('Chart data:', {
          validData: validData,
          values: values,
          maxValue: maxValue,
          hasPercentageWeights: hasPercentageWeights
        });
        
        validData.forEach(item => {
          const value = getValue(item);
          const label = getLabel(item);
          const displayValue = getDisplayValue(item);
          
          // Skip items with no actual value or label
          if (value <= 0 || !label) return;
          
          const barContainer = document.createElement('div');
          
          // Check if this is a level-based representation (High/Medium/Low)
          const isLevelBased = typeof item.weight === 'string' && 
                              ['high', 'medium', 'low'].includes(item.weight.toLowerCase());
          
          if (isLevelBased) {
            // For level-based items, show simple text representation without bars
            barContainer.className = 'level-item';
            const levelColor = getWeightColor(item.weight, color);
            
            barContainer.innerHTML = `
              <div class="level-content">
                <div class="level-badge" style="color: ${levelColor}; border-color: ${levelColor};">${displayValue}</div>
                <div class="level-label">${label}</div>
              </div>
            `;
          } else {
            // For numeric/quantitative data, show bars as before
            barContainer.className = 'bar-item';
            const percentage = Math.max((value / maxValue) * 100, 5); // Minimum 5% for visibility
            const barColor = getWeightColor(item.weight, color);
            
            barContainer.innerHTML = `
              <div class="bar-label">${label}</div>
              <div class="bar-background">
                <div class="bar-fill" style="width: ${percentage}%; background-color: ${barColor};"></div>
                <div class="bar-value" style="left: calc(${percentage}% + 4px);">${displayValue}</div>
              </div>
            `;
          }
          
          container.appendChild(barContainer);
        });
      };

      // Toggle raw data function
      window.toggleRawData = (containerId) => {
        const rawDataDiv = document.getElementById(`raw-data-${containerId}`);
        if (rawDataDiv) {
          rawDataDiv.style.display = rawDataDiv.style.display === 'none' ? 'block' : 'none';
        }
      };

      // Interactive Tree Functions
      window.showNodeDetails = (nodeId) => {
        const detailsPanel = document.getElementById(window.currentDetailsPanel);
        if (!detailsPanel || !window.currentTreeData) return;

        // Find the node data
        const nodeData = window.currentTreeData.nodes?.find(node => 
          node.id === nodeId || node.name === nodeId
        );

        if (!nodeData) {
          // Generic node info if specific data not found
          displayGenericNodeInfo(detailsPanel, nodeId);
        } else {
          displaySpecificNodeInfo(detailsPanel, nodeData);
        }

        // Show the panel with animation
        detailsPanel.style.display = 'block';
        detailsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      };

      const displaySpecificNodeInfo = (panel, nodeData) => {
        const content = panel.querySelector('.details-content');
        const treeData = window.currentTreeData;
        
        content.innerHTML = `
          <h5>üéØ ${nodeData.name || nodeData.id || 'Decision Node'}</h5>
          
          ${nodeData.description ? `<p><strong>Description:</strong> ${nodeData.description}</p>` : ''}
          
          <div class="node-info-grid">
            ${nodeData.type ? `
              <div class="node-info-item">
                <div class="node-info-label">Node Type</div>
                <div class="node-info-value">${nodeData.type}</div>
              </div>
            ` : ''}
            
            ${nodeData.cost ? `
              <div class="node-info-item">
                <div class="node-info-label">Associated Cost</div>
                <div class="node-info-value">${nodeData.cost}</div>
              </div>
            ` : ''}
            
            ${nodeData.timeframe ? `
              <div class="node-info-item">
                <div class="node-info-label">Timeframe</div>
                <div class="node-info-value">${nodeData.timeframe}</div>
              </div>
            ` : ''}
            
            ${nodeData.risk ? `
              <div class="node-info-item">
                <div class="node-info-label">Risk Level</div>
                <div class="node-info-value">${nodeData.risk}</div>
              </div>
            ` : ''}
          </div>

          ${nodeData.outcomes && nodeData.outcomes.length > 0 ? `
            <div style="margin-top: 15px;">
              <strong>üìä Possible Outcomes:</strong>
              <ul style="margin-top: 8px; padding-left: 20px;">
                ${nodeData.outcomes.map(outcome => `<li>${outcome}</li>`).join('')}
              </ul>
            </div>
          ` : ''}

          ${nodeData.criteria && nodeData.criteria.length > 0 ? `
            <div style="margin-top: 15px;">
              <strong>‚öñÔ∏è Decision Criteria:</strong>
              <ul style="margin-top: 8px; padding-left: 20px;">
                ${nodeData.criteria.map(criterion => `<li>${criterion}</li>`).join('')}
              </ul>
            </div>
          ` : ''}

          <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; font-size: 13px; color: #666;">
            üí° <em>This represents a key decision point in your analysis. Consider the associated factors when making your choice.</em>
          </div>
        `;
      };

      const displayGenericNodeInfo = (panel, nodeId) => {
        const content = panel.querySelector('.details-content');
        const treeData = window.currentTreeData;
        
        content.innerHTML = `
          <h5>üéØ Decision Point: ${nodeId}</h5>
          
          <p>This is a decision node in your analysis tree. Each node represents a choice or outcome in your decision-making process.</p>
          
          <div class="node-info-grid">
            <div class="node-info-item">
              <div class="node-info-label">Total Nodes</div>
              <div class="node-info-value">${treeData.nodes?.length || 0}</div>
            </div>
            
            <div class="node-info-item">
              <div class="node-info-label">Total Pathways</div>
              <div class="node-info-value">${treeData.edges?.length || 0}</div>
            </div>
          </div>

          ${treeData.options && treeData.options.length > 0 ? `
            <div style="margin-top: 15px;">
              <strong>üìã Available Options:</strong>
              <ul style="margin-top: 8px; padding-left: 20px;">
                ${treeData.options.map(option => `<li>${option.name || option}</li>`).join('')}
              </ul>
            </div>
          ` : ''}

          ${treeData.recommendation ? `
            <div style="margin-top: 15px;">
              <strong>üéØ Recommended Path:</strong>
              <p style="margin-top: 5px;"><em>${treeData.recommendation.topChoice}</em></p>
            </div>
          ` : ''}

          <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; font-size: 13px; color: #666;">
            üí° <em>Click on different nodes to explore various decision paths and their implications.</em>
          </div>
        `;
      };

      window.closeNodeDetails = (panelId) => {
        const panel = document.getElementById(panelId);
        if (panel) {
          panel.style.display = 'none';
        }
      };

      // Enhanced Interactive Tree Features
      window.TreeInteractionManager = {
        currentFocusedNode: null,
        breadcrumbPath: [],
        isKeyboardNavigationActive: false,

        // Initialize enhanced features
        init: function(containerId) {
          this.containerId = containerId;
          this.setupKeyboardNavigation();
          this.setupAccessibility();
          this.setupMobileSupport();
          this.setupSearch();
        },

        // Keyboard navigation support
        setupKeyboardNavigation: function() {
          document.addEventListener('keydown', (e) => {
            if (!this.isKeyboardNavigationActive) return;

            const mermaidDiv = document.querySelector(`#${this.containerId} .mermaid`);
            if (!mermaidDiv) return;

            const nodes = Array.from(mermaidDiv.querySelectorAll('.node'));
            if (nodes.length === 0) return;

            switch(e.key) {
              case 'ArrowRight':
              case 'ArrowDown':
                e.preventDefault();
                this.focusNextNode(nodes);
                break;
              case 'ArrowLeft':
              case 'ArrowUp':
                e.preventDefault();
                this.focusPrevNode(nodes);
                break;
              case 'Enter':
              case ' ':
                e.preventDefault();
                if (this.currentFocusedNode) {
                  this.selectNode(this.currentFocusedNode);
                }
                break;
              case 'Escape':
                e.preventDefault();
                this.clearFocus();
                break;
              case 'Tab':
                if (!e.shiftKey) {
                  this.isKeyboardNavigationActive = true;
                }
                break;
            }
          });

          // Activate keyboard navigation on focus
          const container = document.getElementById(this.containerId);
          if (container) {
            container.addEventListener('focus', () => {
              this.isKeyboardNavigationActive = true;
            }, true);

            container.addEventListener('blur', () => {
              this.isKeyboardNavigationActive = false;
            }, true);
          }
        },

        // Focus management
        focusNextNode: function(nodes) {
          if (!this.currentFocusedNode) {
            this.focusNode(nodes[0]);
          } else {
            const currentIndex = nodes.indexOf(this.currentFocusedNode);
            const nextIndex = (currentIndex + 1) % nodes.length;
            this.focusNode(nodes[nextIndex]);
          }
        },

        focusPrevNode: function(nodes) {
          if (!this.currentFocusedNode) {
            this.focusNode(nodes[nodes.length - 1]);
          } else {
            const currentIndex = nodes.indexOf(this.currentFocusedNode);
            const prevIndex = currentIndex === 0 ? nodes.length - 1 : currentIndex - 1;
            this.focusNode(nodes[prevIndex]);
          }
        },

        focusNode: function(node) {
          this.clearFocus();
          this.currentFocusedNode = node;
          node.classList.add('focused');
          node.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          
          // Announce for screen readers
          const nodeText = node.textContent || 'Decision node';
          this.announceToScreenReader(`Focused on ${nodeText}`);
        },

        selectNode: function(node) {
          node.classList.add('selected');
          const nodeId = this.getNodeId(node);
          window.showNodeDetails(nodeId);
          
          // Update breadcrumb
          this.updateBreadcrumb(nodeId);
        },

        clearFocus: function() {
          if (this.currentFocusedNode) {
            this.currentFocusedNode.classList.remove('focused', 'selected');
            this.currentFocusedNode = null;
          }
        },

        // Accessibility enhancements
        setupAccessibility: function() {
          const mermaidDiv = document.querySelector(`#${this.containerId} .mermaid`);
          if (!mermaidDiv) return;

          // Add ARIA attributes
          mermaidDiv.setAttribute('role', 'application');
          mermaidDiv.setAttribute('aria-label', 'Interactive decision tree');
          mermaidDiv.setAttribute('tabindex', '0');

          // Add node accessibility
          setTimeout(() => {
            const nodes = mermaidDiv.querySelectorAll('.node');
            nodes.forEach((node, index) => {
              node.setAttribute('role', 'button');
              node.setAttribute('tabindex', '-1');
              node.setAttribute('aria-describedby', 'tree-instructions');
              
              const nodeText = node.textContent || `Decision node ${index + 1}`;
              node.setAttribute('aria-label', `${nodeText}. Press Enter to view details`);
            });

            // Add instructions for screen readers
            this.addScreenReaderInstructions();
          }, 500);
        },

        addScreenReaderInstructions: function() {
          const container = document.getElementById(this.containerId);
          if (!container) return;

          const instructions = document.createElement('div');
          instructions.id = 'tree-instructions';
          instructions.className = 'sr-only';
          instructions.textContent = 'Use arrow keys to navigate between decision nodes. Press Enter to view node details. Press Escape to clear selection.';
          container.appendChild(instructions);

          // Add visual accessibility info
          const accessibilityInfo = document.createElement('div');
          accessibilityInfo.className = 'accessibility-info';
          accessibilityInfo.innerHTML = `
            <strong>üéØ Accessibility:</strong> Use Tab to focus, arrow keys to navigate, Enter to select nodes, Escape to clear selection.
          `;
          container.appendChild(accessibilityInfo);
        },

        // Mobile touch support
        setupMobileSupport: function() {
          if ('ontouchstart' in window) {
            const mermaidDiv = document.querySelector(`#${this.containerId} .mermaid`);
            if (!mermaidDiv) return;

            let touchStartY = 0;
            let touchStartX = 0;

            mermaidDiv.addEventListener('touchstart', (e) => {
              touchStartY = e.touches[0].clientY;
              touchStartX = e.touches[0].clientX;
            });

            mermaidDiv.addEventListener('touchend', (e) => {
              const touchEndY = e.changedTouches[0].clientY;
              const touchEndX = e.changedTouches[0].clientX;
              
              const deltaY = Math.abs(touchEndY - touchStartY);
              const deltaX = Math.abs(touchEndX - touchStartX);
              
              // If it's a tap (not a swipe)
              if (deltaY < 10 && deltaX < 10) {
                const target = e.target.closest('.node');
                if (target) {
                  this.selectNode(target);
                }
              }
            });
          }
        },

        // Search functionality
        setupSearch: function() {
          const container = document.getElementById(this.containerId);
          if (!container) return;

          const treeContainer = container.querySelector('.decision-tree-container');
          if (!treeContainer) return;

          // Add search controls
          const controlsDiv = document.createElement('div');
          controlsDiv.className = 'tree-controls';
          controlsDiv.innerHTML = `
            <div>
              <input type="text" class="tree-search" placeholder="Search nodes..." id="tree-search-${this.containerId}">
              <button onclick="TreeInteractionManager.clearSearch()">Clear</button>
            </div>
            <div>
              <button onclick="TreeInteractionManager.exportTree()">üì• Export</button>
              <button onclick="TreeInteractionManager.resetZoom()">üîç Reset View</button>
              <button onclick="TreeInteractionManager.toggleHelp()">‚ùì Help</button>
            </div>
          `;
          
          treeContainer.insertBefore(controlsDiv, treeContainer.firstChild);

          // Add search functionality
          const searchInput = document.getElementById(`tree-search-${this.containerId}`);
          if (searchInput) {
            searchInput.addEventListener('input', (e) => {
              this.performSearch(e.target.value);
            });
          }
        },

        // Search implementation
        performSearch: function(searchTerm) {
          const mermaidDiv = document.querySelector(`#${this.containerId} .mermaid`);
          if (!mermaidDiv) return;

          const nodes = mermaidDiv.querySelectorAll('.node');
          const term = searchTerm.toLowerCase().trim();

          nodes.forEach(node => {
            const nodeText = node.textContent.toLowerCase();
            if (!term || nodeText.includes(term)) {
              node.style.opacity = '1';
              node.style.filter = 'none';
            } else {
              node.style.opacity = '0.3';
              node.style.filter = 'grayscale(100%)';
            }
          });

          if (term) {
            this.announceToScreenReader(`Filtered to show nodes containing "${searchTerm}"`);
          }
        },

        clearSearch: function() {
          const searchInput = document.getElementById(`tree-search-${this.containerId}`);
          if (searchInput) {
            searchInput.value = '';
            this.performSearch('');
          }
        },

        // Utility functions
        getNodeId: function(node) {
          return node.id || node.getAttribute('data-id') || 'unknown-node';
        },

        updateBreadcrumb: function(nodeId) {
          if (!this.breadcrumbPath.includes(nodeId)) {
            this.breadcrumbPath.push(nodeId);
            this.renderBreadcrumb();
          }
        },

        renderBreadcrumb: function() {
          const container = document.getElementById(this.containerId);
          if (!container) return;

          let breadcrumbDiv = container.querySelector('.tree-breadcrumb');
          if (!breadcrumbDiv) {
            breadcrumbDiv = document.createElement('div');
            breadcrumbDiv.className = 'tree-breadcrumb';
            const treeContainer = container.querySelector('.decision-tree-container');
            if (treeContainer) {
              treeContainer.appendChild(breadcrumbDiv);
            }
          }

          breadcrumbDiv.innerHTML = `
            <strong>üìç Path:</strong> 
            ${this.breadcrumbPath.map((nodeId, index) => `
              <span class="breadcrumb-item" onclick="TreeInteractionManager.navigateToNode('${nodeId}')">${nodeId}</span>
              ${index < this.breadcrumbPath.length - 1 ? '<span class="breadcrumb-separator">‚Üí</span>' : ''}
            `).join('')}
          `;
        },

        navigateToNode: function(nodeId) {
          window.showNodeDetails(nodeId);
        },

        // Export functionality
        exportTree: function() {
          const data = window.currentTreeData;
          if (!data) return;

          const exportData = {
            title: data.decisionTitle || 'Decision Tree',
            timestamp: new Date().toISOString(),
            nodes: data.nodes || [],
            edges: data.edges || [],
            options: data.options || [],
            mermaidSyntax: data.mermaidSyntax
          };

          const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'decision-tree-export.json';
          a.click();
          URL.revokeObjectURL(url);

          this.announceToScreenReader('Decision tree exported successfully');
        },

        // Screen reader announcements
        announceToScreenReader: function(message) {
          const announcement = document.createElement('div');
          announcement.setAttribute('aria-live', 'polite');
          announcement.setAttribute('aria-atomic', 'true');
          announcement.className = 'sr-only';
          announcement.textContent = message;
          document.body.appendChild(announcement);
          
          setTimeout(() => {
            document.body.removeChild(announcement);
          }, 1000);
        },

        resetZoom: function() {
          const mermaidDiv = document.querySelector(`#${this.containerId} .mermaid`);
          if (mermaidDiv) {
            mermaidDiv.style.transform = 'scale(1)';
            mermaidDiv.style.transformOrigin = 'center';
          }
        },

        toggleHelp: function() {
          const helpModal = document.getElementById('tree-help-modal');
          if (helpModal) {
            helpModal.style.display = helpModal.style.display === 'none' ? 'block' : 'none';
          } else {
            this.createHelpModal();
          }
        },

        createHelpModal: function() {
          const modal = document.createElement('div');
          modal.id = 'tree-help-modal';
          modal.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; border: 2px solid #333; border-radius: 12px;
            padding: 24px; max-width: 500px; z-index: 1001;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
          `;
          
          modal.innerHTML = `
            <h3>üå≥ Interactive Decision Tree Help</h3>
            <h4>Mouse/Touch:</h4>
            <ul>
              <li>Click or tap any node to view details</li>
              <li>Hover over nodes for visual feedback</li>
              <li>Use search box to filter nodes</li>
            </ul>
            <h4>Keyboard Navigation:</h4>
            <ul>
              <li><kbd>Tab</kbd> - Focus tree area</li>
              <li><kbd>Arrow Keys</kbd> - Navigate between nodes</li>
              <li><kbd>Enter/Space</kbd> - Select focused node</li>
              <li><kbd>Escape</kbd> - Clear selection</li>
            </ul>
            <h4>Features:</h4>
            <ul>
              <li>Export tree data as JSON</li>
              <li>Search and filter nodes</li>
              <li>Breadcrumb path tracking</li>
              <li>Mobile-optimized interactions</li>
            </ul>
            <button onclick="TreeInteractionManager.toggleHelp()" style="margin-top: 16px; padding: 8px 16px; background: #1976D2; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
          `;
          
          document.body.appendChild(modal);
        }
      };

      // Auto-initialize analytics
      if (typeof window !== 'undefined') {
        window.addEventListener('load', () => {
          if (window.TreeAnalytics) {
            window.TreeAnalytics.init();
          }
        });
      }

      // Performance monitoring wrapper
      window.measureTreePerformance = function(functionName, fn) {
        return function(...args) {
          const startTime = performance.now();
          const result = fn.apply(this, args);
          
          if (window.TreeAnalytics) {
            window.TreeAnalytics.trackPerformance(functionName, startTime);
          }
          
          return result;
        };
      };
      
      // Initialize Enhanced UI System
      function initEnhancedUISystem() {
        // Wait a bit to ensure DOM and containers are ready
        setTimeout(() => {
          // Initialize the enhanced UI with embed detection
          if (window.enhancedUI) {
            window.enhancedUI.init({
              containerId: 'main-content',
              scrollToTop: true,
              embedEnforcement: true,
              accessibility: true
            });
          } else {
            console.warn('Enhanced UI system not loaded');
          }
        }, 100);
      }
      
      // Initialize when page loads
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEnhancedUISystem);
      } else {
        initEnhancedUISystem();
      }
    })();

  </script>
  
  <style>
    /* Additional styles for loading and empty state */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 20px;
      color: #888; /* Lighter text for loading/empty states */
    }
    
    .loading-text {
      margin-bottom: 20px;
      font-size: 18px;
      font-family: "Playfair Display", serif;
      letter-spacing: 0.5px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0,0,0,0.1);
      border-left: 4px solid #555;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .no-data {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 20px;
      text-align: center;
    }
    
    .no-data-icon {
      font-size: 50px;
      margin-bottom: 20px;
      opacity: 0.6;
    }
    
    .no-data-message {
      font-size: 18px;
      margin-bottom: 10px;
      font-weight: 600;
      color: #555;
    }
    
    .no-data-help {
      font-size: 14px;
      color: #777;
    }

    /* Visualization Components CSS */
    .visualization-header h2 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 20px;
      font-weight: 600;
    }

    .analysis-type {
      color: #666;
      font-size: 14px;
      margin-bottom: 20px;
      font-style: italic;
    }

    /* Pros/Cons Charts */
    .all-options-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .option-chart {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      background-color: #fafafa;
    }

    .option-chart h3 {
      margin: 0 0 15px 0;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .score-badge {
      background-color: #333;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    /* T-Chart Layout - Bold T-Shape with Black/White Theme */
    .t-chart {
      background-color: white;
      border: 2px solid #333;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .t-chart-headers {
      display: grid;
      grid-template-columns: 1fr 1fr;
      background-color: #333;
      /* Remove border-bottom to connect properly with content */
    }

    .pros-header, .cons-header {
      padding: 15px;
      font-size: 15px;
      font-weight: 700;
      text-align: center;
      color: white;
      background-color: #333;
      position: relative;
    }

    .pros-header {
      border-right: 3px solid #333; /* Bold vertical line of the T - matches content border */
    }

    .t-chart-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      min-height: 200px;
      background-color: white;
      align-items: start; /* Align content to top */
    }

    .pros-side, .cons-side {
      padding: 0 20px 20px 20px; /* Remove top padding to eliminate gap */
      background-color: white;
    }

    .pros-side {
      border-right: 3px solid #333; /* Continue the bold vertical line seamlessly */
    }

    .charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .pros-chart, .cons-chart {
      background-color: white;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #ddd;
    }

    .pros-chart h4 {
      color: #333;
      margin: 0 0 15px 0;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
    }

    .pros-chart h4:before {
      content: "‚úì";
      margin-right: 8px;
      font-weight: bold;
      color: #333;
    }

    .cons-chart h4 {
      color: #333;
      margin: 0 0 15px 0;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
    }

    .cons-chart h4:before {
      content: "‚úó";
      margin-right: 8px;
      font-weight: bold;
      color: #333;
    }

    .pros-bars, .cons-bars {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    /* Bar chart items */
    .bar-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 0;
      min-height: 30px;
      justify-content: flex-start;
    }

    .bar-label {
      font-size: 12px;
      font-weight: 500;
      color: #555;
      line-height: 1.3;
    }

    .bar-background {
      background-color: #e8e8e8;
      border-radius: 4px;
      height: 16px;
      position: relative;
      overflow: visible; /* Allow text to extend beyond */
      border: 1px solid #ddd;
    }

    .bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
      min-width: 8px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
      position: absolute;
      top: 0;
      left: 0;
    }

    .bar-value {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      left: calc(100% + 4px); /* Position just after the end of the bar fill */
      font-size: 11px;
      color: #333;
      font-weight: 700;
      line-height: 1;
      white-space: nowrap;
      z-index: 2;
    }

    /* Aligned items for proper T-chart row alignment */
    .aligned-item {
      min-height: 45px; /* Consistent minimum height for perfect alignment */
      display: flex;
      align-items: flex-start;
      margin-bottom: 4px;
    }

    .spacer-item {
      height: 45px; /* Match the aligned-item height */
      visibility: hidden; /* Invisible but takes up space */
    }

    /* Level-based items (High/Medium/Low) - no bars, just badges */
    .level-item {
      margin-bottom: 0; /* Remove bottom margin to reduce spacing */
      padding: 0;
      min-height: 40px; /* Same as bar-item for consistent alignment */
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
    }

    .level-content {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    .level-badge {
      font-size: 9px;
      font-weight: 600;
      padding: 2px 6px;
      border: 1px solid;
      border-radius: 8px;
      background-color: transparent;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      align-self: flex-start;
    }

    /* Specific level badge colors for better visibility */
    .level-badge.high {
      color: #333 !important;
      border-color: #333 !important;
    }

    .level-badge.medium {
      color: #666 !important;
      border-color: #666 !important;
    }

    .level-badge.low {
      color: #999 !important;
      border-color: #999 !important;
    }

    .level-label {
      font-size: 12px;
      font-weight: 500;
      color: #555;
      line-height: 1.3;
    }

    /* No data message */
    .no-data {
      padding: 10px;
      text-align: center;
      color: #999;
      font-style: italic;
      background-color: #f5f5f5;
      border-radius: 4px;
      border: 1px dashed #ddd;
    }

    /* Recommendation section */
    .recommendation-section {
      background-color: #f8f8f8;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }

    .recommendation-section h3 {
      margin: 0 0 15px 0;
      color: #333;
    }

    .top-choice, .reasoning, .confidence {
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .top-choice strong, .reasoning strong, .confidence strong {
      color: #1976D2;
    }

    /* SWOT Matrix */
    .swot-matrix {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 20px 0;
    }

    .swot-quadrant {
      padding: 15px;
      border-radius: 8px;
      border: 2px solid;
    }

    .swot-quadrant.strengths {
      background-color: #f8f8f8;
      border-color: #333;
    }

    .swot-quadrant.weaknesses {
      background-color: #f0f0f0;
      border-color: #666;
    }

    .swot-quadrant.opportunities {
      background-color: #f8f8f8;
      border-color: #333;
    }

    .swot-quadrant.threats {
      background-color: #f0f0f0;
      border-color: #666;
    }

    .swot-quadrant h4 {
      margin: 0 0 10px 0;
      font-weight: 600;
    }

    .swot-quadrant ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .swot-quadrant li {
      margin-bottom: 8px;
      padding: 5px;
      background: rgba(255,255,255,0.7);
      border-radius: 4px;
    }

    /* Financial Metrics */
    .financial-metrics {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }

    .metric {
      text-align: center;
    }

    .metric .label {
      display: block;
      font-weight: 600;
      color: #666;
      margin-bottom: 5px;
    }

    .metric .value {
      display: block;
      font-size: 18px;
      font-weight: 700;
      color: #333;
    }

    /* Charts Container */
    .charts-container,
    .costs-benefits {
      display: flex;
      gap: 20px;
      margin: 20px 0;
    }

    .pros-chart,
    .cons-chart,
    .costs-section,
    .benefits-section {
      flex: 1;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }

    /* Weighted Scoring */
    .weighted-scoring {
      margin: 20px 0;
    }

    .criteria-weights,
    .options-scores {
      margin-bottom: 10px;
    }

    .option-score {
      margin-bottom: 10px;
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }

    .option-score h5 {
      margin: 0 0 5px 0;
      color: #333;
      font-weight: 600;
    }

    .scores-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .score-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 10px;
      background-color: white;
      border-radius: 4px;
      font-size: 14px;
    }

    /* Raw Data Toggle */
    .raw-data-toggle {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }

    .raw-data-toggle button {
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .raw-data-toggle button:hover {
      background-color: #5a6268;
    }

    .raw-data {
      margin-top: 15px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
    }
    
    /* Card animation setup */
    .quote-card {
      opacity: 0;
      transform: translateY(20px);
    }

    /* Visualization info styling */
    .visualization-info {
      background-color: #f0f8ff;
      border: 1px solid #d0e7ff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      font-family: "Inter", sans-serif;
    }

    .visualization-info h3 {
      margin: 0 0 10px 0;
      color: #2c5aa0;
      font-size: 16px;
      font-weight: 600;
    }

    .visualization-info p {
      margin: 5px 0;
      font-size: 14px;
      color: #555;
    }

    .visualization-info strong {
      color: #333;
      font-weight: 500;
    }

    /* Paired content for horizontal alignment */
    .paired-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
    }

    .paired-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      min-height: 40px;
      align-items: start;
    }

    .paired-cell {
      padding: 0 20px;
      display: flex;
      align-items: flex-start;
      min-height: 40px;
    }

    .paired-cell.pros-cell {
      border-right: 3px solid #333;
      background-color: white;
    }

    .paired-cell.cons-cell {
      background-color: white;
    }

    .empty-cell {
      min-height: 40px;
      width: 100%;
    }

    /* Ensure items in paired cells take full width */
    .paired-cell .bar-item,
    .paired-cell .level-item {
      width: 100%;
      margin-bottom: 0;
    }

    /* Analytics Dashboard Styles */
    #analytics-dashboard {
      position: fixed;
      top: 50px;
      right: 20px;
      width: 400px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    #analytics-dashboard.hidden {
      transform: translateX(420px);
      opacity: 0;
    }
    
    .dashboard-header {
      padding: 16px 20px;
      background: #1976D2;
      color: white;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .dashboard-header h3 {
      margin: 0;
      font-size: 16px;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
    }
    
    .dashboard-content {
      padding: 20px;
    }
    
    .metric-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .metric-card {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    
    .metric-card h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
    }
    
    .metric-card div {
      font-size: 18px;
      font-weight: bold;
      color: #1976D2;
    }
    
    .chart-container {
      margin: 20px 0;
      text-align: center;
    }
    
    .insights-panel {
      background: #f9f9f9;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    
    .insights-panel h4 {
      margin: 0 0 12px 0;
      color: #333;
    }
    
    .insight-item {
      margin: 8px 0;
      padding: 8px;
      background: white;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .analytics-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #1976D2;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      font-size: 24px;
      z-index: 999;
      transition: all 0.3s ease;
    }
    
    .analytics-toggle:hover {
      background: #1565C0;
      transform: scale(1.1);
    }
    
    .integration-test-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 10px 0;
    }
    
    .integration-test-btn:hover {
      background: #45a049;
    }
    
    .performance-suggestions {
      background: #fff3e0;
      border: 1px solid #ff9800;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }
    
    .performance-suggestions h4 {
      color: #f57c00;
      margin: 0 0 12px 0;
    }
    
    .performance-suggestions ul {
      margin: 0;
      padding-left: 20px;
    }
    
    .performance-suggestions li {
      margin: 6px 0;
      color: #333;
    }
    
    .collapse-btn {
      background: none;
      border: none;
      font-size: 12px;
      cursor: pointer;
      margin-left: 8px;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(255,255,255,0.8);
    }
    
    .collapse-btn:hover {
      background: rgba(255,255,255,1);
    }
  </style>

  <!-- Main content container with ID for accessibility -->
  <div id="main-content" class="device-container decision-container">
    <script>
      // Initialize Enhanced UI System
      function initEnhancedUISystem() {
        // Wait a bit to ensure DOM and containers are ready
        setTimeout(() => {
          // Initialize the enhanced UI with embed detection
          if (window.enhancedUI) {
            window.enhancedUI.init({
              containerId: 'main-content',
              scrollToTop: true,
              embedEnforcement: true,
              accessibility: true
            });
          } else {
            console.warn('Enhanced UI system not loaded');
          }
        }, 100);
      }
      
      // Initialize when page loads
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEnhancedUISystem);
      } else {
        initEnhancedUISystem();
      }
    </script>
