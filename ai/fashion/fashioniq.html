<!--
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
-->


<div class="device-container">

  <div class="row1 product-description-container">
    <h2 class="product-description-heading">Get AI-Powered Fashion Critique!</h2>
    <p class="product-description-text">
        Want honest feedback on how your outfits look? Upload photos of yourself wearing different outfits and get personalized fashion critique from our advanced AI. Our system analyzes not just whether an outfit looks good, but how it specifically suits you based on your complexion, body type, and personal style. Get recommendations on colors that complement your skin tone, styling tips, and honest assessments of how each piece works together.
    </p>
    <p class="product-description-final">
        Let's analyze your style!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a professional.</em>
    </p>
</div>

<div class="row1" data-step-label="Personal Style">

       <h3 class="tooltip1" data-tooltip="Basic information to help provide age-appropriate and body-type-conscious fashion advice.">
        Personal Information<span class="tooltip1-content"></span>
    </h3>
    <input id="fashion-age" type="text" placeholder="Age">
    <input id="fashion-height" type="text" placeholder="5'6">
    <select id="fashion-gender">
        <option value="" disabled selected>Select Gender</option>
        <option value="woman">Woman</option>
        <option value="man">Man</option>
    </select>


    <h3 class="tooltip1" data-tooltip="Select your preferred fashion style to receive personalized recommendations that match your aesthetic preferences.">
        Personal Style<span class="tooltip1-content"></span>
    </h3>
    <div class="grid-container" id="fashion-personal-style">
        <div class="grid-item" data-value="Casual">Casual & Comfortable</div>
        <div class="grid-item" data-value="Business">Business & Professional</div>
        <div class="grid-item" data-value="Formal">Formal & Elegant</div>
        <div class="grid-item" data-value="Trendy">Trendy & Fashion-Forward</div>
        <div class="grid-item" data-value="Classic">Classic & Timeless</div>
        <div class="grid-item" data-value="Bohemian">Bohemian & Artistic</div>
        <div class="grid-item" data-value="Minimalist">Minimalist & Clean</div>
        <div class="grid-item" data-value="Eclectic">Eclectic & Unique</div>
    </div>


</div>


<div class="row1" data-step-label="Weather Conditions">
    <h3 class="tooltip1" data-tooltip="Choose your weather conditions to receive weather-appropriate outfit recommendations and fabric suggestions.">
        Weather Conditions<span class="tooltip1-content"></span>
    </h3>
    <div class="grid-container" id="fashion-weather">
        <div class="grid-item" data-value="Snow, freezing temperatures">Snow, freezing temperatures</div>
        <div class="grid-item" data-value="Four seasons, moderate weather">Four seasons, moderate weather</div>
        <div class="grid-item" data-value="Mild winters, no snow">Mild winters, no snow</div>
        <div class="grid-item" data-value="Desert-like, sun protection">Desert-like, sun protection</div>
        <div class="grid-item" data-value="Tropical, breathable fabrics">Tropical, breathable fabrics</div>
        <div class="grid-item" data-value="No weather concerns">No weather concerns</div>
    </div>
</div>

<div class="row1" data-step-label="Event/Occasion">
    <h3 class="tooltip1" data-tooltip="Select the occasion to receive outfit recommendations appropriate for the specific event or setting.">
        Event/Occasion<span class="tooltip1-content"></span>
    </h3>
    <div class="grid-container" id="fashion-occasion">
        <div class="grid-item" data-value="Work">Work/Office</div>
        <div class="grid-item" data-value="Casual Day">Casual Day Out</div>
        <div class="grid-item" data-value="Date Night">Date Night</div>
        <div class="grid-item" data-value="Party">Party/Event</div>
        <div class="grid-item" data-value="Travel">Travel/Vacation</div>
        <div class="grid-item" data-value="Exercise">Gym/Exercise</div>
        <div class="grid-item" data-value="Formal Event">Formal Event</div>
        <div class="grid-item" data-value="Everyday">Everyday Wear</div>
        <div class="grid-item" data-value="Special Occasion">Special Occasion</div>
        <div class="grid-item" data-value="Interview">Job Interview</div>
        <div class="grid-item" data-value="Wedding">Wedding Guest</div>
        <div class="grid-item" data-value="Brunch">Brunch/Social</div>
    </div>
</div>

<div class="row1" data-step-label="Upload Outfit Photos">
    <h3 class="tooltip1" data-tooltip="Upload clear photos of yourself wearing different outfits. Our AI will analyze fit, color coordination, and overall style. Maximum 5 photos.">
        Upload Outfit Photos (Required)<span class="tooltip1-content"></span>
    </h3>
    <div id="image-upload-container" class="image-upload-container" data-image-upload data-module="fashion" data-fashion-mode="true" data-max-images="1"></div>

    <button class="generate-btn" id="generate-fashion-btn" disabled>Generate Fashion Analysis</button>

  </div>



</div>

<script type="module">
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

// Rate limiting utilities are now available globally via window.rateLimiter

(function() {
  async function handleGenerateFashionIq() {
    try {
      // Debug: Check if image upload utility is available
      console.log('[FashionIQ DEBUG] Image upload utility availability check:');
      console.log('[FashionIQ DEBUG] window.getImageUploadImages:', typeof window.getImageUploadImages);
      console.log('[FashionIQ DEBUG] window.imageUploadInstances:', window.imageUploadInstances);
      console.log('[FashionIQ DEBUG] window.initializeImageUpload:', typeof window.initializeImageUpload);
      
      // Force re-initialization if needed
      if (typeof window.initializeImageUpload === 'function') {
        console.log('[FashionIQ DEBUG] Re-initializing image upload...');
        window.initializeImageUpload();
        // Wait a moment for initialization
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      const formData = window.fashionFormPersistence.getSavedFormData();
      if (!formData) {
        alert('Please complete the form before generating a fashion analysis.');
        return;
      }

      // Get images from saved form data (stored in KV via FormPersistence)
      const dataUrlImages = formData.images || [];
      
      console.log('[FashionIQ DEBUG] Images from FormPersistence:', dataUrlImages.length);
      
      if (dataUrlImages.length === 0) {
        console.log('[FashionIQ DEBUG] No images found in saved data - showing alert');
        alert('Please upload at least one outfit photo before generating analysis.');
        return;
      }

      // Check rate limits before proceeding
      if (window.rateLimiter.isRateLimited('fashion', 5, 60 * 60 * 1000)) {
        alert('You have exceeded the request limit for fashion analysis. Please try again later.');
        return;
      }

      // Fashion module needs special payload structure with images
      const fashionFormData = {
        ...formData,
        images: dataUrlImages // Send full data URLs
      };

      // Create worker payload with email for paid users (DRY function)
      const workerPayload = window.rateLimiter.createWorkerPayload('fashion', fashionFormData);

      // Use enhanced loading with educational facts
      const dataContainer = document.querySelector('.device-container') || document.body;
      let backendResponse = null;
      
      try {
        const result = await window.enhancedLoading(
          'generate-fashion-btn',
          'fashion',
          async () => {
            const apiUrl = 'https://inexasli.com/api/generate';
            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(workerPayload)
            });

            let responseData;
            try {
              responseData = await response.json();
            } catch (e) {
              responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
            }
            
            // Store backend response for error handling
            backendResponse = responseData;
            
            // Always call handleRateLimitResponse with backend response
            window.rateLimiter.handleRateLimitResponse(dataContainer, responseData, !response.ok, 'FashionIQ');

            if (!response.ok) {
              throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
            }

            if (responseData.message !== 'Success') {
              throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
            }

            return responseData;
          }
        );

        // Increment request count after successful response
        window.rateLimiter.incrementRequestCount('fashion');

        // Store the response using centralized system
        window.fashionFormPersistence.saveResponseData(result);

        // Dispatch an event to notify dataout.js that a response was received
        const event = new CustomEvent('api-response-received', {
          detail: {
            module: 'fashioniq',
            type: 'worker-response',
            timestamp: Date.now()
          }
        });
        document.dispatchEvent(event);
        
      } catch (error) {
        // If backendResponse is available, update rate limit display and show error
        if (backendResponse && dataContainer) {
          window.rateLimiter.handleRateLimitResponse(dataContainer, backendResponse, true, 'FashionIQ');
        }
        console.error('[FashionIQ] Error generating fashion analysis:', error);
        alert('An error occurred while analyzing your fashion. Please try again later.');
      }
      
    } catch (error) {
      console.error('[FashionIQ] Error generating fashion analysis:', error);
      alert('An error occurred while analyzing your fashion. Please try again later.');
    }
  }

  // Button state management for image requirements
  function updateButtonState() {
    const generateBtn = document.getElementById('generate-fashion-btn');
    if (!generateBtn) return;
    
    // Check for images in saved form data (FormPersistence)
    const formData = window.fashionFormPersistence ? window.fashionFormPersistence.getSavedFormData() : null;
    const hasImages = formData && formData.images && Array.isArray(formData.images) && formData.images.length > 0;
    
    if (hasImages) {
      generateBtn.disabled = false;
    } else {
      generateBtn.disabled = true;
    }
  }

  // Initialization - simplified to match calorie module pattern
  const generateFashionBtn = document.getElementById('generate-fashion-btn');
  if (generateFashionBtn) {
    generateFashionBtn.addEventListener('click', handleGenerateFashionIq);
    // Set flag to prevent duplicate handler attachment
    generateFashionBtn.dataset.handlerAttached = 'true';
  }

  // Listen for image upload changes to update button state
  document.addEventListener('imageUploadChanged', updateButtonState);
  
  // Listen for form persistence events (when data is saved/loaded)
  document.addEventListener('formpersistence:repopulated', updateButtonState);
  
  // Listen for any changes that might affect form data
  document.addEventListener('input', updateButtonState);
  document.addEventListener('change', updateButtonState);
  
  // Initial button state check
  updateButtonState();

  // Export functions for external access
  window.fashionIq = { 
    getFormData: () => window.fashionFormPersistence ? window.fashionFormPersistence.getSavedFormData() : null,
    saveFormData: () => window.fashionFormPersistence ? window.fashionFormPersistence.saveFormData() : null,
    updateButtonState: updateButtonState
  };

})();
</script>
