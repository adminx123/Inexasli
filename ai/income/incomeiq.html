<!--
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 
 
 "stepwise" is what i used to solev conditonal formating and repopulation issue
 
 -->




<div class="device-container" id="incomeiq-device-container">

<style>
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.tax-recalc-notification {
    transition: opacity 0.3s ease, transform 0.3s ease;
}
</style>

<div class="row1 product-description-container">
    <h2 class="product-description-heading">Organize Your Finances & Understand Your Tax Position</h2>
    <p class="product-description-text">
        Navigate your finances with greater clarity using IncomeIQ™. Our platform empowers you to systematically record your income, expenses, assets, and liabilities. As you progress, you'll find helpful explanations of key financial terms, enhancing your financial literacy along the way. Once your information is entered, our AI can generate illustrative estimates for potential taxes and contributions. It's important to remember these figures are provided strictly for educational and conceptual purposes, offering a general idea of financial scenarios, and should not be taken as professional financial advice.
    </p>
    <p class="product-description-final">
        Start organizing and explore illustrative financial estimates!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a professional.</em>
    </p>
</div>

<!-- Stage 1: Tax Residency & Personal Details -->
<!-- NEW ARCHITECTURE: This section now uses a state-machine approach with:
     - IntroStateManager: Centralized state management with event system
     - DropdownManager: Handles dropdown dependencies and population
     - VisibilityManager: Manages conditional field visibility
     - IntroSectionController: Coordinates all intro functionality
     
     Benefits:
     - Eliminates race conditions with proper event-driven updates
     - Robust state restoration with validation and retry logic
     - Centralized state management for reliable conditional UI logic
     - Clean separation of concerns for maintainability
-->
<div class="row1" data-step-label="Tax Residency">
    <!-- Warning banner for stale AI response when tax-affecting data changes -->
    <div id="intro-section-warning" class="tax-recalc-notification" style="display: none; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-bottom: 15px; color: #856404; font-size: 14px; animation: slideIn 0.3s ease;">
        <strong>⚠️ Note:</strong> Changes to tax residency or personal details will clear your AI tax estimates. You'll need to regenerate them after making changes.
    </div>
    
    <h3 class="tooltip1" data-tooltip="Where you're legally considered to live for tax purposes, based on factors like time spent or ties to the country.">
        Select Tax Residency<span class="tooltip1-content"></span>
    </h3>
    
    <select id="country" style="width: 345px; max-width: 100%; margin: 0 auto; display: block;">
        <option value="">Select Country</option>
        <option value="CAN">Canada</option>
        <option value="USA">USA</option>
        <option value="UK">United Kingdom</option>
        <option value="AUS">Australia</option>
        <option value="OTHER">Other</option>
    </select>

    <div id="subregionContainer" style="display: none;">
        <select id="subregion" style="width: 345px; max-width: 100%; margin: 0 auto; display: block; margin-top: 5px;">
            <option value="">Select Tax Subregion</option>
        </select>
    </div>

    <div id="residencyStatus" style="display: none;">
        <select id="residency" style="width: 345px; max-width: 100%; margin: 0 auto; display: block; margin-top: 5px;">
            <option value="">Select Residency Status</option>
            <option value="Full_Resident">Full Resident (Lived entire year, full taxes)</option>
            <option value="Part_Year_Resident">Part-Year Resident (Lived part-year, partial taxes)</option>
            <option value="Non_Resident">Non Resident (Not living here, some taxes)</option>
            <option value="Temporary_Resident">Temporary Resident (Temporary stay, tax exemptions)</option>
        </select>
    </div>

    <h3 class="tooltip1" data-tooltip="What your legally status is for tax purposes">
        Select Filing Status<span class="tooltip1-content"></span>
    </h3>
    
    <select id="filingStatus" style="width: 345px; max-width: 100%; margin: 0 auto; display: block;">
        <option value="">Select Filing Status</option>
    </select>

    <div id="specifics" style=" text-align: center;">
        <h3 class="tooltip1" data-tooltip="Relevant personal information.">
            Select Personal Details<span class="tooltip1-content"></span>
        </h3>

        <input type="number" placeholder="Your Age" inputmode="numeric" id="ageSelf" min="0" style="width: 345px; max-width: 100%; margin: 0 auto; display: block;">

        <select id="employmentStatus" style="width: 345px; max-width: 100%; margin: 0 auto; display: block; margin-top: 5px;">
            <option value="">Select Your Employment Status</option>
            <option value="employed">Employed</option>
            <option value="self_employed">Self-Employed</option>
            <option value="unemployed">Unemployed</option>
            <option value="retired">Retired</option>
            <option value="student">Student</option>
        </select>
        
        <div class="income-spouseFields" style="display: none;">
            <input type="number" placeholder="Spouse Age" inputmode="numeric" id="ageSpouse" min="0" style="width: 345px; max-width: 100%; margin: 0 auto; display: block; margin-top: 5px;">
            <select id="employmentStatusSpouse" style="width: 345px; max-width: 100%; margin: 0 auto; display: block; margin-top: 5px;">
                <option value="">Select Spouse Employment Status</option>
                <option value="employed">Employed</option>
                <option value="self_employed">Self-Employed</option>
                <option value="unemployed">Unemployed</option>
                <option value="retired">Retired</option>
                <option value="student">Student</option>
            </select>
        </div>

        <div class="dependantsContainer" style="display: none;">
            <h3 class="tooltip1" data-tooltip="Enter the birth years of disabled dependants, separated by commas.">
                Disabled Dependant Birth Year(s)<span class="tooltip1-content"></span>
            </h3>
            <textarea id="birthYearDisabledDependants" placeholder="e.g., 2005, 2010, 2015" style="width: 345px; max-width: 100%; margin: 0 auto; display: block;"></textarea>
        </div>
    </div>
</div>

<!-- Stage 2: Income Information -->
<div class="row1" data-step-label="Income Sources">
    <!-- Warning banner for stale AI response when tax-affecting data changes -->
    <div id="income-section-warning" class="tax-recalc-notification" style="display: none; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-bottom: 15px; color: #856404; font-size: 14px; animation: slideIn 0.3s ease;">
        <strong>⚠️ Note:</strong> Changes to income data will clear your AI tax estimates. You'll need to regenerate them after making changes.
    </div>
    
    <h3 class="tooltip1" data-tooltip="Employment involves working under a contract for an employer, receiving a regular salary or wage, and generally includes benefits like health insurance. Self-employment means working for oneself, where income might fluctuate based on work volume, with the individual handling their own taxes, benefits, and business expenses.">
        Input Employment - Self Employment Income<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow">
        <label for="income-salary-wages" style="font-size: unset;" class="tooltip" data-tooltip="Enter gross amount before tax and contributions.">
            <span class="tooltip-content"></span>
            Salary/Wages:
        </label>
        <input type="number" inputmode="numeric" id="income-salary-wages">
        <div data-frequency-id="income-salary-wages-frequency"></div>
        <span id="income-salary-wages-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-tips" style="font-size: unset;" class="tooltip" data-tooltip="Enter gross amount before tax and contributions.">
            <span class="tooltip-content"></span>
            Tips:
        </label>
        <input type="number" inputmode="numeric" id="income-tips">
        <div data-frequency-id="income-tips-frequency"></div>
        <span id="income-tips-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-bonuses" style="font-size: unset;" class="tooltip" data-tooltip="Enter gross amount before tax and contributions.">
            <span class="tooltip-content"></span>
            Bonus:
        </label>
        <input type="number" inputmode="numeric" id="income-bonuses">
        <div data-frequency-id="income-bonuses-frequency"></div>
        <span id="income-bonuses-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-sole-prop" style="font-size: unset;" class="tooltip" data-tooltip="Enter net income after business expenses but before taxes.">
            <span class="tooltip-content"></span>
            Self Employment:
        </label>
        <input type="number" inputmode="numeric" id="income-sole-prop">
        <div data-frequency-id="income-sole-prop-frequency"></div>
        <span id="income-sole-prop-annual"></span>
    </div>

    <h3 class="tooltip1" data-tooltip="Retirement income refers to the money received by individuals after they stop working, sourced from personal savings, pensions, or investment plans. Social benefit income encompasses payments from government welfare programs providing financial assistance based on criteria like age, unemployment, or disability, aimed at supporting those in need when they cannot earn through regular employment.">
        Input Retirement - Social Benefit Income<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow">
        <label for="income-federal-pension" style="font-size: unset;" class="tooltip" data-tooltip="Enter gross amount before tax and contributions.">
            <span class="tooltip-content"></span>
            Pension, Federal:
        </label>
        <input type="number" inputmode="numeric" id="income-federal-pension">
        <div data-frequency-id="income-federal-pension-frequency"></div>
        <span id="income-federal-pension-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-provincial-pension" style="font-size: unset;" class="tooltip" data-tooltip="Enter gross amount before tax and contributions.">
            <span class="tooltip-content"></span>
            Pension, Provincial:
        </label>
        <input type="number" inputmode="numeric" id="income-provincial-pension">
        <div data-frequency-id="income-provincial-pension-frequency"></div>
        <span id="income-provincial-pension-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-private-pension" style="font-size: unset;" class="tooltip" data-tooltip="Enter gross amount before tax and contributions.">
            <span class="tooltip-content"></span>
            Pension, Private:
        </label>
        <input type="number" inputmode="numeric" id="income-private-pension">
        <div data-frequency-id="income-private-pension-frequency"></div>
        <span id="income-private-pension-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-old-age-security" style="font-size: unset;" class="tooltip" data-tooltip="Enter gross amount before tax and contributions.">
            <span class="tooltip-content"></span>
            Old Age Security:
        </label>
        <input type="number" inputmode="numeric" id="income-old-age-security">
        <div data-frequency-id="income-old-age-security-frequency"></div>
        <span id="income-old-age-security-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-employment-insurance" style="font-size: unset;" class="tooltip" data-tooltip="Enter gross amount before tax and contributions.">
            <span class="tooltip-content"></span>
            Employment Insurance:
        </label>
        <input type="number" inputmode="numeric" id="income-employment-insurance">
        <div data-frequency-id="income-employment-insurance-frequency"></div>
        <span id="income-employment-insurance-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-social-security" style="font-size: unset;" class="tooltip" data-tooltip="Enter gross amount before tax and contributions.">
            <span class="tooltip-content"></span>
            Social Security:
        </label>
        <input type="number" inputmode="numeric" id="income-social-security">
        <div data-frequency-id="income-social-security-frequency"></div>
        <span id="income-social-security-annual"></span>
    </div>

    <h3 class="tooltip1" data-tooltip="Passive income is earnings derived from ventures in which an individual is not actively involved, such as rental properties, royalties from creative works, or income from investments like dividends from stocks, interest from savings, or capital gains from asset sales. It contrasts with active income from employment or business operations where direct labor is exchanged for money.">
        Input Passive Income<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow">
        <label for="income-investment-property" style="font-size: unset;" class="tooltip" data-tooltip="Enter the net income after all operating expenses (e.g., maintenance, insurance) but before income taxes.">
            <span class="tooltip-content"></span>
            Investment Property:
        </label>
        <input type="number" inputmode="numeric" id="income-investment-property">
        <div data-frequency-id="income-investment-property-frequency"></div>
        <span id="income-investment-property-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-capital-gains-losses" style="font-size: unset;" class="tooltip" data-tooltip="Enter amount before tax.">
            <span class="tooltip-content"></span>
            Capital Gains/Losses:
        </label>
        <input type="number" inputmode="numeric" id="income-capital-gains-losses">
        <div data-frequency-id="income-capital-gains-losses-frequency"></div>
        <span id="income-capital-gains-losses-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-venture-capital" style="font-size: unset;" class="tooltip" data-tooltip="Enter gross amount before tax and after expenses.">
            <span class="tooltip-content"></span>
            Venture:
        </label>
        <input type="number" inputmode="numeric" id="income-venture-capital">
        <div data-frequency-id="income-venture-capital-frequency"></div>
        <span id="income-venture-capital-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-public-dividend" style="font-size: unset;" class="tooltip" data-tooltip="Enter amount before tax.">
            <span class="tooltip-content"></span>
            Dividend, Public:
        </label>
        <input type="number" inputmode="numeric" id="income-public-dividend">
        <div data-frequency-id="income-public-dividend-frequency"></div>
        <span id="income-public-dividend-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-owner-dividend" style="font-size: unset;" class="tooltip" data-tooltip="Enter amount before tax.">
            <span class="tooltip-content"></span>
            Dividend, Owner:
        </label>
        <input type="number" inputmode="numeric" id="income-owner-dividend">
        <div data-frequency-id="income-owner-dividend-frequency"></div>
        <span id="income-owner-dividend-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-interest" style="font-size: unset;" class="tooltip" data-tooltip="Enter amount before tax.">
            <span class="tooltip-content"></span>
            Interest:
        </label>
        <input type="number" inputmode="numeric" id="income-interest">
        <div data-frequency-id="income-interest-frequency"></div>
        <span id="income-interest-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-royalties" style="font-size: unset;" class="tooltip" data-tooltip="Enter amount before tax.">
            <span class="tooltip-content"></span>
            Royalties:
        </label>
        <input type="number" inputmode="numeric" id="income-royalties">
        <div data-frequency-id="income-royalties-frequency"></div>
        <span id="income-royalties-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-peer-to-peer-lending" style="font-size: unset;" class="tooltip" data-tooltip="Enter amount before tax.">
            <span class="tooltip-content"></span>
            Peer to Peer Lending:
        </label>
        <input type="number" inputmode="numeric" id="income-peer-to-peer-lending">
        <div data-frequency-id="income-peer-to-peer-lending-frequency"></div>
        <span id="income-peer-to-peer-lending-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-trust" style="font-size: unset;" class="tooltip" data-tooltip="Enter amount before tax.">
            <span class="tooltip-content"></span>
            Trust:
        </label>
        <input type="number" inputmode="numeric" id="income-trust">
        <div data-frequency-id="income-trust-frequency"></div>
        <span id="income-trust-annual"></span>
    </div>

    <h3 class="tooltip1" data-tooltip="Refers to any income that doesn't fit neatly into the categories of employment, self-employment, investment, or social benefits. This can include earnings from side gigs not considered a primary job, child support or alimony, lottery winnings, inheritances, or any other miscellaneous sources of revenue not derived from regular work or investments.">
        Input Other Income<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow">
        <label for="income-alimony" style="font-size: unset;" class="tooltip" data-tooltip="Enter amount before tax.">
            <span class="tooltip-content"></span>
            Alimony:
        </label>
        <input type="number" inputmode="numeric" id="income-alimony">
        <div data-frequency-id="income-alimony-frequency"></div>
        <span id="income-alimony-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-scholarships-grants" style="font-size: unset;" class="tooltip" data-tooltip="Enter amount before tax.">
            <span class="tooltip-content"></span>
            Scholarship/Grants:
        </label>
        <input type="number" inputmode="numeric" id="income-scholarships-grants">
        <div data-frequency-id="income-scholarships-grants-frequency"></div>
        <span id="income-scholarships-grants-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-tax-free-income" style="font-size: unset;" class="tooltip" data-tooltip="Enter total amount received. Note: Some regions tax inheritance or gifts; consult a financial advisor.">
            <span class="tooltip-content"></span>
            Tax Free - Inheritance/Gifts:
        </label>
        <input type="number" inputmode="numeric" id="income-tax-free-income">
        <div data-frequency-id="income-tax-free-income-frequency"></div>
        <span id="income-tax-free-income-annual"></span>
    </div>

    <div class="checkboxrow">
        <label for="income-gambling-winnings" style="font-size: unset;" class="tooltip" data-tooltip="Enter gross amount before tax. Note: Canadians don't pay tax on winnings unless professional; US residents do.">
            <span class="tooltip-content"></span>
            Gambling:
        </label>
        <input type="number" inputmode="numeric" id="income-gambling-winnings">
        <div data-frequency-id="income-gambling-winnings-frequency"></div>
        <span id="income-gambling-winnings-annual"></span>
    </div>
</div>

<!-- Stage 3: Expenses -->
<div class="row1" data-step-label="Expenses">
    <h3 class="tooltip1" data-tooltip="Expenses that are necessary for basic living, health, and safety, without which one's quality of life or ability to function would be significantly compromised. These are non-negotiable costs like food, housing, healthcare, and utilities.">
        Input Essentials Expenses<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow">
        <label for="expenses-grocery" style="font-size: unset;" class="tooltip" data-tooltip="Enter your monthly grocery expenses.">
            <span class="tooltip-content"></span>
            Grocery:
        </label>
        <input type="number" inputmode="numeric" id="expenses-grocery">
        <div data-frequency-id="expenses-grocery-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-fitness" style="font-size: unset;" class="tooltip" data-tooltip="Enter your monthly fitness or gym expenses.">
            <span class="tooltip-content"></span>
            Fitness:
        </label>
        <input type="number" inputmode="numeric" id="expenses-fitness">
        <div data-frequency-id="expenses-fitness-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-hygiene" style="font-size: unset;" class="tooltip" data-tooltip="Enter your monthly hygiene and personal care expenses.">
            <span class="tooltip-content"></span>
            Hygiene:
        </label>
        <input type="number" inputmode="numeric" id="expenses-hygiene">
        <div data-frequency-id="expenses-hygiene-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-medical-dental" style="font-size: unset;" class="tooltip" data-tooltip="Enter your monthly medical, dental, and insurance expenses.">
            <span class="tooltip-content"></span>
            Medical, Dental & Insurance:
        </label>
        <input type="number" inputmode="numeric" id="expenses-medical-dental">
        <div data-frequency-id="expenses-medical-dental-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-perscription" style="font-size: unset;" class="tooltip" data-tooltip="Enter your monthly prescription expenses.">
            <span class="tooltip-content"></span>
            Prescription:
        </label>
        <input type="number" inputmode="numeric" id="expenses-perscription">
        <div data-frequency-id="expenses-perscription-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-clothing" style="font-size: unset;" class="tooltip" data-tooltip="Enter your monthly clothing expenses.">
            <span class="tooltip-content"></span>
            Clothing:
        </label>
        <input type="number" inputmode="numeric" id="expenses-clothing">
        <div data-frequency-id="expenses-clothing-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-cellphone-service" style="font-size: unset;" class="tooltip" data-tooltip="Enter your monthly cellphone service expenses.">
            <span class="tooltip-content"></span>
            Cellphone:
        </label>
        <input type="number" inputmode="numeric" id="expenses-cellphone-service">
        <div data-frequency-id="expenses-cellphone-service-frequency"></div>
    </div>

    <h3 class="tooltip1" data-tooltip="Expenses that are not essential for survival or basic functioning but are related to lifestyle choices, comfort, entertainment, or luxury. These are costs you have control over and can adjust or eliminate without affecting your basic needs, such as dining out, vacations, subscriptions for entertainment, and non-essentials.">
        Input Discretionary Expenses<span class="tooltip1-content"></span>
    </h3>
    
    <div class="checkboxrow">
        <label for="expenses-retirement" style="font-size: unset;" class="tooltip" data-tooltip="Enter your expense amount.">
            <span class="tooltip-content"></span>
            Retirement Plan Contribution:
        </label>
        <input type="number" inputmode="numeric" id="expenses-retirement">
        <div data-frequency-id="expenses-retirement-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-dining" style="font-size: unset;" class="tooltip" data-tooltip="Enter your expense amount.">
            <span class="tooltip-content"></span>
            Dining:
        </label>
        <input type="number" inputmode="numeric" id="expenses-dining">
        <div data-frequency-id="expenses-dining-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-entertainment" style="font-size: unset;" class="tooltip" data-tooltip="Concert tickets, movies, sporting events, nightlife, video games. Enter your expense amount.">
            <span class="tooltip-content"></span>
            Entertainment:
        </label>
        <input type="number" inputmode="numeric" id="expenses-entertainment">
        <div data-frequency-id="expenses-entertainment-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-vacation" style="font-size: unset;" class="tooltip" data-tooltip="Enter your expense amount.">
            <span class="tooltip-content"></span>
            Vacation:
        </label>
        <input type="number" inputmode="numeric" id="expenses-vacation">
        <div data-frequency-id="expenses-vacation-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-travel-life-insurance" style="font-size: unset;" class="tooltip" data-tooltip="Enter your expense amount.">
            <span class="tooltip-content"></span>
            Life & Travel Insurance:
        </label>
        <input type="number" inputmode="numeric" id="expenses-travel-life-insurance">
        <div data-frequency-id="expenses-travel-life-insurance-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-subscriptions" style="font-size: unset;" class="tooltip" data-tooltip="Enter your expense amount.">
            <span class="tooltip-content"></span>
            Subscriptions:
        </label>
        <input type="number" inputmode="numeric" id="expenses-subscriptions">
        <div data-frequency-id="expenses-subscriptions-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-beauty" style="font-size: unset;" class="tooltip" data-tooltip="Include all salon services such as hair, makeup, nails, waxing, eyebrows, teeth whitening, and more. Enter your expense amount.">
            <span class="tooltip-content"></span>
            Beauty:
        </label>
        <input type="number" inputmode="numeric" id="expenses-beauty">
        <div data-frequency-id="expenses-beauty-frequency"></div>
    </div>

    <h3 class="tooltip1" data-tooltip="This heading covers all costs related to your living space, including rent or mortgage, utilities, property taxes, insurance, and home maintenance or improvements. It's the foundation of your expense tracking, ensuring your home sweet home remains a sanctuary, not a financial burden.">
        Input Housing Expenses<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow">
        <label for="housing-mortgage-payment" style="font-size: unset;" class="tooltip" data-tooltip="Your monthly payment for your home mortgage, including principal and interest.">
            <span class="tooltip-content"></span>
            Mortgage Payment:
        </label>
        <input type="number" inputmode="numeric" id="housing-mortgage-payment">
        <div data-frequency-id="housing-mortgage-payment-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="housing-rent-payment" style="font-size: unset;" class="tooltip" data-tooltip="Your regular rent payment for your primary residence.">
            <span class="tooltip-content"></span>
            Rent:
        </label>
        <input type="number" inputmode="numeric" id="housing-rent-payment">
        <div data-frequency-id="housing-rent-payment-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="housing-property-tax" style="font-size: unset;" class="tooltip" data-tooltip="Annual or periodic property tax paid to your local government.">
            <span class="tooltip-content"></span>
            Property Tax:
        </label>
        <input type="number" inputmode="numeric" id="housing-property-tax">
        <div data-frequency-id="housing-property-tax-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="housing-condo-fee" style="font-size: unset;" class="tooltip" data-tooltip="Monthly or periodic fees paid to your condominium association for building maintenance and amenities.">
            <span class="tooltip-content"></span>
            Condo Fee:
        </label>
        <input type="number" inputmode="numeric" id="housing-condo-fee">
        <div data-frequency-id="housing-condo-fee-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="housing-hydro" style="font-size: unset;" class="tooltip" data-tooltip="Electricity or hydro bill for your home or apartment.">
            <span class="tooltip-content"></span>
            Hydro:
        </label>
        <input type="number" inputmode="numeric" id="housing-hydro">
        <div data-frequency-id="housing-hydro-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="housing-water" style="font-size: unset;" class="tooltip" data-tooltip="Water and sewage bill for your residence.">
            <span class="tooltip-content"></span>
            Water:
        </label>
        <input type="number" inputmode="numeric" id="housing-water">
        <div data-frequency-id="housing-water-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="housing-gas" style="font-size: unset;" class="tooltip" data-tooltip="Natural gas, propane, wood, oil, or other heating fuel costs for your home.">
            <span class="tooltip-content"></span>
            Heating:
        </label>
        <input type="number" inputmode="numeric" id="housing-gas">
        <div data-frequency-id="housing-gas-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="housing-insurance" style="font-size: unset;" class="tooltip" data-tooltip="Homeowner's or renter's insurance premiums for your property or belongings.">
            <span class="tooltip-content"></span>
            Insurance:
        </label>
        <input type="number" inputmode="numeric" id="housing-insurance">
        <div data-frequency-id="housing-insurance-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="housing-repairs" style="font-size: unset;" class="tooltip" data-tooltip="Repairs and maintenance costs for your home, such as plumbing, electrical, or general upkeep.">
            <span class="tooltip-content"></span>
            Repairs:
        </label>
        <input type="number" inputmode="numeric" id="housing-repairs">
        <div data-frequency-id="housing-repairs-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="housing-internet" style="font-size: unset;" class="tooltip" data-tooltip="Internet service bill for your home or apartment.">
            <span class="tooltip-content"></span>
            Internet:
        </label>
        <input type="number" inputmode="numeric" id="housing-internet">
        <div data-frequency-id="housing-internet-frequency"></div>
    </div>

    <h3 class="tooltip1" data-tooltip="Transportation costs including vehicle payments, fuel, insurance, public transit, and maintenance to get you where you need to go.">
        Input Transportation Expenses<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow">
        <label for="transportation-car-loan-payment" style="font-size: unset;" class="tooltip" data-tooltip="Monthly payment for your car loan, including principal and interest.">
            <span class="tooltip-content"></span>
            Car Loan Payment:
        </label>
        <input type="number" inputmode="numeric" id="transportation-car-loan-payment">
        <div data-frequency-id="transportation-car-loan-payment-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="transportation-fuel" style="font-size: unset;" class="tooltip" data-tooltip="Gasoline, diesel, or other fuel costs for your vehicle(s).">
            <span class="tooltip-content"></span>
            Fuel:
        </label>
        <input type="number" inputmode="numeric" id="transportation-fuel">
        <div data-frequency-id="transportation-fuel-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="transportation-insurance" style="font-size: unset;" class="tooltip" data-tooltip="Insurance premiums for your car(s) or other vehicles.">
            <span class="tooltip-content"></span>
            Car Insurance:
        </label>
        <input type="number" inputmode="numeric" id="transportation-insurance">
        <div data-frequency-id="transportation-insurance-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="transportation-maintenance" style="font-size: unset;" class="tooltip" data-tooltip="Maintenance and repair costs for your vehicle(s), such as oil changes, tires, and servicing.">
            <span class="tooltip-content"></span>
            Car Maintenance:
        </label>
        <input type="number" inputmode="numeric" id="transportation-maintenance">
        <div data-frequency-id="transportation-maintenance-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="transportation-public-transit" style="font-size: unset;" class="tooltip" data-tooltip="Bus, subway, train, or other public transportation fares.">
            <span class="tooltip-content"></span>
            Public Transit:
        </label>
        <input type="number" inputmode="numeric" id="transportation-public-transit">
        <div data-frequency-id="transportation-public-transit-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="transportation-ride-hailing" style="font-size: unset;" class="tooltip" data-tooltip="Expenses for ride-hailing services such as Uber, Lyft, or taxis.">
            <span class="tooltip-content"></span>
            Ride Hailing:
        </label>
        <input type="number" inputmode="numeric" id="transportation-ride-hailing">
        <div data-frequency-id="transportation-ride-hailing-frequency"></div>
    </div>

    <h3 class="tooltip1" data-tooltip="Debt payments refer to the regular amounts paid towards loans, credit cards, or any borrowed money. This includes principal and interest, reducing what you owe over time.">
        Input Debt Payments<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow">
        <label for="expenses-line-of-credit-payment" style="font-size: unset;" class="tooltip" data-tooltip="Payment made toward your line of credit balance.">
            <span class="tooltip-content"></span>
            Line of Credit Payment:
        </label>
        <input type="number" inputmode="numeric" id="expenses-line-of-credit-payment">
        <div data-frequency-id="expenses-line-of-credit-payment-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-student-loan-payment" style="font-size: unset;" class="tooltip" data-tooltip="Payment made toward your student loan(s).">
            <span class="tooltip-content"></span>
            Student Loan Payment:
        </label>
        <input type="number" inputmode="numeric" id="expenses-student-loan-payment">
        <div data-frequency-id="expenses-student-loan-payment-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-credit-card-payment" style="font-size: unset;" class="tooltip" data-tooltip="Payment made toward the balance carried over from previous credit card billing cycles.">
            <span class="tooltip-content"></span>
            Credit Card, Payment on Previous Balance:
        </label>
        <input type="number" inputmode="numeric" id="expenses-credit-card-payment">
        <div data-frequency-id="expenses-credit-card-payment-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-tax-arrears-payment" style="font-size: unset;" class="tooltip" data-tooltip="Payment for unpaid taxes from prior years.">
            <span class="tooltip-content"></span>
            Tax Arrears Payment:
        </label>
        <input type="number" inputmode="numeric" id="expenses-tax-arrears-payment">
        <div data-frequency-id="expenses-tax-arrears-payment-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="expenses-small-business-loan-payment" style="font-size: unset;" class="tooltip" data-tooltip="Payment made toward your small business loan(s).">
            <span class="tooltip-content"></span>
            Small Business Loan Payment:
        </label>
        <input type="number" inputmode="numeric" id="expenses-small-business-loan-payment">
        <div data-frequency-id="expenses-small-business-loan-payment-frequency"></div>
    </div>

    <h3 class="tooltip1" data-tooltip="Costs associated with supporting family members or others who rely on you financially, plus expenses for pets like food, veterinary care, and pet supplies.">
        Input Dependents/Pets Expenses<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow">
        <label for="dependant-day-care" style="font-size: unset;" class="tooltip" data-tooltip="Day care or child care expenses for dependents.">
            <span class="tooltip-content"></span>
            Day Care:
        </label>
        <input type="number" inputmode="numeric" id="dependant-day-care">
        <div data-frequency-id="dependant-day-care-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="dependant-medical-dental" style="font-size: unset;" class="tooltip" data-tooltip="Medical, dental, and insurance expenses for dependents.">
            <span class="tooltip-content"></span>
            Medical, Dental & Insurance:
        </label>
        <input type="number" inputmode="numeric" id="dependant-medical-dental">
        <div data-frequency-id="dependant-medical-dental-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="dependant-clothing" style="font-size: unset;" class="tooltip" data-tooltip="Clothing and apparel expenses for dependents.">
            <span class="tooltip-content"></span>
            Clothing:
        </label>
        <input type="number" inputmode="numeric" id="dependant-clothing">
        <div data-frequency-id="dependant-clothing-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="dependant-sports-recreation" style="font-size: unset;" class="tooltip" data-tooltip="Sports, recreation, and extracurricular activity expenses for dependents.">
            <span class="tooltip-content"></span>
            Sports & Recreation:
        </label>
        <input type="number" inputmode="numeric" id="dependant-sports-recreation">
        <div data-frequency-id="dependant-sports-recreation-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="dependant-transportation" style="font-size: unset;" class="tooltip" data-tooltip="Transportation expenses for dependents, such as school bus or transit passes.">
            <span class="tooltip-content"></span>
            Transportation:
        </label>
        <input type="number" inputmode="numeric" id="dependant-transportation">
        <div data-frequency-id="dependant-transportation-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="dependant-tuition" style="font-size: unset;" class="tooltip" data-tooltip="Tuition and education-related expenses for dependents.">
            <span class="tooltip-content"></span>
            Tuition:
        </label>
        <input type="number" inputmode="numeric" id="dependant-tuition">
        <div data-frequency-id="dependant-tuition-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="dependant-housing" style="font-size: unset;" class="tooltip" data-tooltip="Housing or accommodation expenses for dependents.">
            <span class="tooltip-content"></span>
            Housing:
        </label>
        <input type="number" inputmode="numeric" id="dependant-housing">
        <div data-frequency-id="dependant-housing-frequency"></div>
    </div>

    <div class="checkboxrow">
        <label for="dependant-cellular-service" style="font-size: unset;" class="tooltip" data-tooltip="Cellular or mobile phone service expenses for dependents.">
            <span class="tooltip-content"></span>
            Cellular Service:
        </label>
        <input type="number" inputmode="numeric" id="dependant-cellular-service">
        <div data-frequency-id="dependant-cellular-service-frequency"></div>
    </div>
</div>

<!-- Stage 4: Assets -->
<div class="row1" data-step-label="Assets">
    <h3 class="tooltip1" data-tooltip="Assets that an individual can readily convert to cash or use to pay for immediate needs within a short period, typically within one year.">
        Input Current Assets<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow dual-input">
        <label for="assets-checking-accounts" class="tooltip" data-tooltip="Funds available in your checking/current account for daily transactions.">Checking Account:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="assets-checking-accounts">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="assets-checking-accounts-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="assets-savings-accounts" class="tooltip" data-tooltip="Funds set aside in a savings account, typically earning interest.">Savings Account:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="assets-savings-accounts">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="assets-savings-accounts-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="assets-other-liquid-accounts" class="tooltip" data-tooltip="Other accounts that can be quickly converted to cash, such as money market funds.">Other Liquid Account:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="assets-other-liquid-accounts">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="assets-other-liquid-accounts-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="assets-money-lent-out" style="font-size: unset;" class="tooltip1" data-tooltip="Include money owed to you from both personal sources (like loans to friends) and business activities (like sales on credit) that you haven't accounted for elsewhere. As a sole proprietor, these are all considered your assets.">
            <span class="tooltip1-content"></span>
            Accounts Receivable:</label>
        <input type='number' inputmode="numeric" id="assets-money-lent-out">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="assets-money-lent-out-percent" inputmode="numeric">
    </div>

    <h3 class="tooltip1" data-tooltip="Assets in personal finance that are not expected to be converted into cash or used up within one year. These assets might provide value over a longer period.">
        Input Non-Current/Long Term Assets<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow dual-input">
        <label for="assets-long-term-investment-accounts" class="tooltip" data-tooltip="Investments intended to be held for more than one year, such as retirement accounts or bonds.">Long Term Investment Account:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="assets-long-term-investment-accounts">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="assets-long-term-investment-accounts-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="assets-investment-properties" class="tooltip" data-tooltip="Real estate or property held for investment purposes, not for personal use.">Investment Property:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="assets-investment-properties">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="assets-investment-properties-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="assets-art-jewelry" class="tooltip" data-tooltip="Valuable art, jewelry, or collectibles considered as part of your assets.">Art/Jewelry:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="assets-art-jewelry">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="assets-art-jewelry-percent" inputmode="numeric">
    </div>

    <h3 class="tooltip1" data-tooltip="Assets that are fixed from a personal view are those meant for long-term use, like homes, cars, or furniture, which you don't plan to sell soon.">
        Input Fixed Assets<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow dual-input">
        <label for="assets-primary-residence" class="tooltip" data-tooltip="The market value of your main home or residence.">Primary Residence:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="assets-primary-residence">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="assets-primary-residence-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="assets-small-business" class="tooltip" data-tooltip="The value of any small business you own, including sole proprietorships or partnerships.">Small Business:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="assets-small-business">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="assets-small-business-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="assets-vehicles" class="tooltip" data-tooltip="The current value of your car, truck, or other vehicles.">Vehicle:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="assets-vehicles">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="assets-vehicles-percent" inputmode="numeric">
    </div>
</div>

<!-- Stage 5: Liabilities -->
<div class="row1" data-step-label="Liabilities">
    <h3 class="tooltip1" data-tooltip="A type of debt where the borrower receives a fixed amount of money upfront, which they repay over time through regular payments until the loan is fully paid off. Once the loan is settled, the account is closed, and the borrower must apply for a new loan if they need more funds.">
        Input Non-Revolving Liabilities<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow dual-input">
        <label for="liabilities-small-business-loan" class="tooltip" data-tooltip="Outstanding balance on loans taken for your small business.">Small Business Loan:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="liabilities-small-business-loan">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="liabilities-small-business-loan-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="liabilities-primary-residence" class="tooltip" data-tooltip="Remaining mortgage balance on your primary residence.">Primary Residence, Mortgage:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="liabilities-primary-residence">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="liabilities-primary-residence-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="liabilities-investment-properties" class="tooltip" data-tooltip="Outstanding mortgage on investment properties you own.">Investment Property, Mortgage:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="liabilities-investment-properties">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="liabilities-investment-properties-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="liabilities-vehicle-loan" class="tooltip" data-tooltip="Remaining balance on loans for your vehicles.">Vehicle Loan:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="liabilities-vehicle-loan">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="liabilities-vehicle-loan-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="liabilities-personal-debt" style="font-size: unset;" class="tooltip1" data-tooltip="List money you owe, whether it's to personal connections (like borrowing from family) or business suppliers that hasn't been accounted for elsewhere. In a sole proprietorship, these liabilities are part of your personal financial responsibility.">
            <span class="tooltip1-content"></span>
            Accounts Payable:</label>
        <input type='number' inputmode="numeric" id="liabilities-personal-debt">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="liabilities-personal-debt-percent" inputmode="numeric">
    </div>

    <h3 class="tooltip1" data-tooltip="Debts where you can borrow money up to a certain limit, pay it back, and borrow again. The amount you can borrow revolves as you pay off what you owe.">
        Input Revolving Liabilities<span class="tooltip1-content"></span>
    </h3>

    <div class="checkboxrow dual-input">
        <label for="liabilities-student-loan" class="tooltip" data-tooltip="Outstanding student loan balance.">Student Loan:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="liabilities-student-loan">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="liabilities-student-loan-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="liabilities-line-of-credit" class="tooltip" data-tooltip="Current balance owed on your line of credit.">Line of Credit:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="liabilities-line-of-credit">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="liabilities-line-of-credit-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="liabilities-credit-card" class="tooltip" data-tooltip="Total current balance on your credit cards.">Credit Card, Current Balance:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="liabilities-credit-card">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="liabilities-credit-card-percent" inputmode="numeric">
    </div>

    <div class="checkboxrow dual-input">
        <label for="liabilities-tax-arrears" class="tooltip" data-tooltip="Unpaid taxes owed to government authorities.">Tax Arrears:<span class="tooltip-content"></span></label>
        <input type='number' inputmode="numeric" id="liabilities-tax-arrears">
        <input type="number" min="0" max="100" placeholder="100%" class="percent-input" id="liabilities-tax-arrears-percent" inputmode="numeric">
    </div>

    <button class="generate-btn" id="generate-income-btn">Generate Analysis</button>
</div>

</div>

<script type="module">
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

// Utility functions are now available via window from datain.js
// No direct imports needed
// Rate limiting utilities are now available globally via window.rateLimiter

(function() {
    console.log("Income IQ script initializing");

    // Initialize FormPersistence for income module
    let incomeFormPersistence = null;
    // --- Robust State Restoration for Tax Residency Dropdowns ---
    function restoreTaxResidencyState(savedState) {
        // savedState: { country, subregion, residency, filingStatus }
        const countrySelect = document.getElementById('country');
        const subregionSelect = document.getElementById('subregion');
        const residencySelect = document.getElementById('residency');
        const filingStatusSelect = document.getElementById('filingStatus');

        // 1. Set country first
        if (savedState.country) {
            countrySelect.value = savedState.country;
        } else {
            countrySelect.value = '';
        }

        // 2. Repopulate subregion dropdown based on country
        let subregions = subregionMap[countrySelect.value] || [];
        subregionSelect.innerHTML = '<option value="">Select Tax Subregion</option>' + subregions.map(r => `<option value="${r}">${r}</option>`).join('');
        if (savedState.subregion && subregions.includes(savedState.subregion)) {
            subregionSelect.value = savedState.subregion;
        } else {
            subregionSelect.value = '';
        }

        // 3. Set residency dropdown (if needed)
        if (savedState.residency) {
            residencySelect.value = savedState.residency;
        } else {
            residencySelect.value = '';
        }

        // 4. Repopulate filing status dropdown based on country
        let filingStatuses = filingStatusMap[countrySelect.value] || [];
        filingStatusSelect.innerHTML = '<option value="">Select Filing Status</option>' + filingStatuses.map(f => `<option value="${f.value}">${f.text}</option>`).join('');
        if (savedState.filingStatus && filingStatuses.some(f => f.value === savedState.filingStatus)) {
            filingStatusSelect.value = savedState.filingStatus;
        } else {
            filingStatusSelect.value = '';
        }

        // 5. Restore personal details (age, employment status, spouse age, spouse employment status, disabled dependants age)
        const ageSelfInput = document.getElementById('ageSelf');
        if (ageSelfInput) ageSelfInput.value = savedState.ageSelf || '';
        const employmentStatusInput = document.getElementById('employmentStatus');
        if (employmentStatusInput) employmentStatusInput.value = savedState.employmentStatus || '';
        const ageSpouseInput = document.getElementById('ageSpouse');
        if (ageSpouseInput) ageSpouseInput.value = savedState.ageSpouse || '';
        const employmentStatusSpouseInput = document.getElementById('employmentStatusSpouse');
        if (employmentStatusSpouseInput) employmentStatusSpouseInput.value = savedState.employmentStatusSpouse || '';
        const birthYearDisabledDependantsInput = document.getElementById('birthYearDisabledDependants');
        if (birthYearDisabledDependantsInput) birthYearDisabledDependantsInput.value = savedState.birthYearDisabledDependants || '';

        // 6. After all dropdowns and personal details are restored, force visibility update for spouseFields and dependantsContainer
        if (window.introSectionController && window.introSectionController.visibilityManager) {
            window.introSectionController.visibilityManager.updateAllVisibility();
        }
    }

    // Example usage: restoreTaxResidencyState({ country: 'CAN', subregion: 'British Columbia', residency: 'Full_Resident', filingStatus: 'married_with_dependants' });

    // Subregion mapping for different countries
    const subregionMap = {
        CAN: ["Alberta", "British Columbia", "Manitoba", "New Brunswick", "Newfoundland and Labrador", "Nova Scotia", "Northwest Territories", "Nunavut", "Ontario", "Prince Edward Island", "Quebec", "Saskatchewan", "Yukon"],
        USA: ["Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming"],
        UK: ["England", "Scotland", "Wales", "Northern Ireland", "Greater London", "West Midlands", "South East", "North West", "East of England", "Yorkshire and The Humber", "South West", "East Midlands", "North East"],
        AUS: ["New South Wales", "Victoria", "Queensland", "South Australia", "Western Australia", "Tasmania", "Australian Capital Territory", "Northern Territory"],
        OTHER: ["Province", "State", "Region", "District", "Territory", "Prefecture", "County", "Municipality"]
    };

    // Filing status mapping by country with metadata for conditional UI
    const filingStatusMap = {
        CAN: [
            { value: "single_no_dependants", text: "Single, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_with_dependants", text: "Single with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_with_disabled_dependants", text: "Single with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true },
            { value: "single_self_disabled", text: "Single, Self-Disabled", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_caregiver", text: "Single, Caregiver", showSpouseFields: false, showDisabledDependants: false },
            { value: "common_law_no_dependants", text: "Common-Law, No Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "common_law_with_dependants", text: "Common-Law with Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "common_law_with_disabled_dependants", text: "Common-Law with Disabled Dependants", showSpouseFields: true, showDisabledDependants: true },
            { value: "common_law_self_disabled", text: "Common-Law, Self-Disabled", showSpouseFields: true, showDisabledDependants: false },
            { value: "common_law_spouse_disabled", text: "Common-Law, Spouse-Disabled", showSpouseFields: true, showDisabledDependants: false },
            { value: "common_law_caregiver", text: "Common-Law, Caregiver", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_no_dependants", text: "Married, No Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_with_dependants", text: "Married with Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_with_disabled_dependants", text: "Married with Disabled Dependants", showSpouseFields: true, showDisabledDependants: true },
            { value: "married_self_disabled", text: "Married, Self-Disabled", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_spouse_disabled", text: "Married, Spouse-Disabled", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_caregiver", text: "Married, Caregiver", showSpouseFields: true, showDisabledDependants: false },
            { value: "widowed_no_dependants", text: "Widowed, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "widowed_with_dependants", text: "Widowed with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "widowed_with_disabled_dependants", text: "Widowed with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true },
            { value: "separated_no_dependants", text: "Separated, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "separated_with_dependants", text: "Separated with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "separated_with_disabled_dependants", text: "Separated with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true }
        ],
        USA: [
            { value: "single_no_dependants", text: "Single, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_with_dependants", text: "Single with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_with_disabled_dependants", text: "Single with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true },
            { value: "single_self_disabled", text: "Single, Self-Disabled", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_caregiver", text: "Single, Caregiver", showSpouseFields: false, showDisabledDependants: false },
            { value: "married_filing_jointly_no_dependants", text: "Married Filing Jointly, No Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_filing_jointly_with_dependants", text: "Married Filing Jointly with Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_filing_jointly_with_disabled_dependants", text: "Married Filing Jointly with Disabled Dependants", showSpouseFields: true, showDisabledDependants: true },
            { value: "married_filing_jointly_self_disabled", text: "Married Filing Jointly, Self-Disabled", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_filing_jointly_spouse_disabled", text: "Married Filing Jointly, Spouse-Disabled", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_filing_jointly_caregiver", text: "Married Filing Jointly, Caregiver", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_filing_separately_no_dependants", text: "Married Filing Separately, No Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_filing_separately_with_dependants", text: "Married Filing Separately with Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_filing_separately_with_disabled_dependants", text: "Married Filing Separately with Disabled Dependants", showSpouseFields: true, showDisabledDependants: true },
            { value: "married_filing_separately_self_disabled", text: "Married Filing Separately, Self-Disabled", showSpouseFields: true, showDisabledDependants: false },
            { value: "head_of_household_no_dependants", text: "Head of Household, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "head_of_household_with_dependants", text: "Head of Household with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "head_of_household_with_disabled_dependants", text: "Head of Household with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true },
            { value: "head_of_household_caregiver", text: "Head of Household, Caregiver", showSpouseFields: false, showDisabledDependants: false },
            { value: "qualifying_widow_no_dependants", text: "Qualifying Widow(er), No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "qualifying_widow_with_dependants", text: "Qualifying Widow(er) with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "qualifying_widow_with_disabled_dependants", text: "Qualifying Widow(er) with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true }
        ],
        UK: [
            { value: "single_no_dependants", text: "Single, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_with_dependants", text: "Single with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_with_disabled_dependants", text: "Single with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true },
            { value: "single_self_disabled", text: "Single, Self-Disabled", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_caregiver", text: "Single, Caregiver", showSpouseFields: false, showDisabledDependants: false },
            { value: "married_or_civil_partnership_no_dependants", text: "Married or Civil Partnership, No Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_or_civil_partnership_with_dependants", text: "Married or Civil Partnership with Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_or_civil_partnership_with_disabled_dependants", text: "Married or Civil Partnership with Disabled Dependants", showSpouseFields: true, showDisabledDependants: true },
            { value: "married_or_civil_partnership_self_disabled", text: "Married or Civil Partnership, Self-Disabled", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_or_civil_partnership_spouse_disabled", text: "Married or Civil Partnership, Spouse-Disabled", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_or_civil_partnership_caregiver", text: "Married or Civil Partnership, Caregiver", showSpouseFields: true, showDisabledDependants: false },
            { value: "widowed_no_dependants", text: "Widowed, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "widowed_with_dependants", text: "Widowed with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "widowed_with_disabled_dependants", text: "Widowed with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true },
            { value: "separated_no_dependants", text: "Separated, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "separated_with_dependants", text: "Separated with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "separated_with_disabled_dependants", text: "Separated with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true }
        ],
        AUS: [
            { value: "single_no_dependants", text: "Single, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_with_dependants", text: "Single with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_with_disabled_dependants", text: "Single with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true },
            { value: "single_self_disabled", text: "Single, Self-Disabled", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_caregiver", text: "Single, Caregiver", showSpouseFields: false, showDisabledDependants: false },
            { value: "married_or_de_facto_no_dependants", text: "Married or De Facto, No Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_or_de_facto_with_dependants", text: "Married or De Facto with Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_or_de_facto_with_disabled_dependants", text: "Married or De Facto with Disabled Dependants", showSpouseFields: true, showDisabledDependants: true },
            { value: "married_or_de_facto_self_disabled", text: "Married or De Facto, Self-Disabled", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_or_de_facto_spouse_disabled", text: "Married or De Facto, Spouse-Disabled", showSpouseFields: true, showDisabledDependants: false },
            { value: "married_or_de_facto_caregiver", text: "Married or De Facto, Caregiver", showSpouseFields: true, showDisabledDependants: false },
            { value: "widowed_no_dependants", text: "Widowed, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "widowed_with_dependants", text: "Widowed with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "widowed_with_disabled_dependants", text: "Widowed with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true },
            { value: "separated_no_dependants", text: "Separated, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "separated_with_dependants", text: "Separated with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "separated_with_disabled_dependants", text: "Separated with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true }
        ],
        OTHER: [
            { value: "single_no_dependants", text: "Single, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_with_dependants", text: "Single with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_with_disabled_dependants", text: "Single with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true },
            { value: "single_self_disabled", text: "Single, Self-Disabled", showSpouseFields: false, showDisabledDependants: false },
            { value: "single_caregiver", text: "Single, Caregiver", showSpouseFields: false, showDisabledDependants: false },
            { value: "coupled_no_dependants", text: "Coupled, No Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "coupled_with_dependants", text: "Coupled with Dependants", showSpouseFields: true, showDisabledDependants: false },
            { value: "coupled_with_disabled_dependants", text: "Coupled with Disabled Dependants", showSpouseFields: true, showDisabledDependants: true },
            { value: "coupled_self_disabled", text: "Coupled, Self-Disabled", showSpouseFields: true, showDisabledDependants: false },
            { value: "coupled_spouse_disabled", text: "Coupled, Spouse-Disabled", showSpouseFields: true, showDisabledDependants: false },
            { value: "coupled_caregiver", text: "Coupled, Caregiver", showSpouseFields: true, showDisabledDependants: false },
            { value: "widowed_no_dependants", text: "Widowed, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "widowed_with_dependants", text: "Widowed with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "widowed_with_disabled_dependants", text: "Widowed with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true },
            { value: "separated_no_dependants", text: "Separated, No Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "separated_with_dependants", text: "Separated with Dependants", showSpouseFields: false, showDisabledDependants: false },
            { value: "separated_with_disabled_dependants", text: "Separated with Disabled Dependants", showSpouseFields: false, showDisabledDependants: true }
        ]
    };

    // ===== REDESIGNED INTRO SECTION STATE MANAGEMENT =====
    
    /**
     * IntroStateManager - Centralized state management for intro section
     * Handles all intro section state with validation and event-driven updates
     */
    class IntroStateManager {
        constructor() {
            this.state = {
                country: '',
                subregion: '',
                residency: '',
                filingStatus: '',
                ageSelf: '',
                employmentStatus: '',
                ageSpouse: '',
                employmentStatusSpouse: '',
                birthYearDisabledDependants: ''
            };
            
            this.listeners = new Map();
            this.isInitialized = false;
            this.pendingOperations = [];
            
            console.log("[IntroStateManager] Initialized");
        }
        
        // Add event listener for state changes
        addEventListener(event, callback) {
            if (!this.listeners.has(event)) {
                this.listeners.set(event, []);
            }
            this.listeners.get(event).push(callback);
        }
        
        // Remove event listener
        removeEventListener(event, callback) {
            if (this.listeners.has(event)) {
                const callbacks = this.listeners.get(event);
                const index = callbacks.indexOf(callback);
                if (index > -1) {
                    callbacks.splice(index, 1);
                }
            }
        }
        
        // Emit event to all listeners
        emit(event, data) {
            if (this.listeners.has(event)) {
                this.listeners.get(event).forEach(callback => {
                    try {
                        callback(data);
                    } catch (error) {
                        console.error(`[IntroStateManager] Error in ${event} listener:`, error);
                    }
                });
            }
        }
        
        // Update state and emit change events
        updateState(field, value) {
            const oldValue = this.state[field];
            this.state[field] = value;
            
            console.log(`[IntroStateManager] State updated: ${field} = ${value}`);
            
            // Emit specific field change event
            this.emit(`${field}Changed`, { field, value, oldValue });
            
            // Emit general state change event
            this.emit('stateChanged', { field, value, oldValue, state: { ...this.state } });
        }
        
        // Get current state
        getState() {
            return { ...this.state };
        }
        
        // Get specific field value
        getField(field) {
            return this.state[field];
        }
        
        // Validate state for conditional logic
        isValidForConditionalLogic() {
            return this.state.country && this.state.filingStatus;
        }
        
        // Set initialization complete
        setInitialized(initialized = true) {
            this.isInitialized = initialized;
            if (initialized) {
                console.log("[IntroStateManager] Initialization complete, processing pending operations");
                this.processPendingOperations();
            }
        }
        
        // Add operation to pending queue if not initialized
        addPendingOperation(operation) {
            if (!this.isInitialized) {
                this.pendingOperations.push(operation);
                return true;
            }
            return false;
        }
        
        // Process all pending operations
        processPendingOperations() {
            while (this.pendingOperations.length > 0) {
                const operation = this.pendingOperations.shift();
                try {
                    operation();
                } catch (error) {
                    console.error("[IntroStateManager] Error processing pending operation:", error);
                }
            }
        }
        
        // Load state from FormPersistence
        loadFromFormPersistence(formPersistence) {
            if (!formPersistence) return;
            
            const savedData = formPersistence.getSavedFormData();
            if (!savedData) return;
            
            console.log("[IntroStateManager] Loading state from FormPersistence:", savedData);
            
            // Update state from saved data
            Object.keys(this.state).forEach(field => {
                if (savedData[field] !== undefined) {
                    this.state[field] = savedData[field];
                }
            });
            
            this.emit('stateLoaded', { state: { ...this.state } });
        }
        
        // Save state to FormPersistence
        saveToFormPersistence(formPersistence) {
            if (!formPersistence) return;
            
            console.log("[IntroStateManager] Saving state to FormPersistence");
            formPersistence.saveFormData();
        }
    }
    
    /**
     * DropdownManager - Manages dropdown dependencies and population
     * Handles the complex relationships between country, subregion, and filing status
     */
    class DropdownManager {
        constructor(stateManager) {
            this.stateManager = stateManager;
            this.dropdowns = {
                country: document.getElementById('country'),
                subregion: document.getElementById('subregion'),
                residency: document.getElementById('residency'),
                filingStatus: document.getElementById('filingStatus')
            };
            
            this.containers = {
                subregion: document.getElementById('subregionContainer')
            };
            
            this.setupEventListeners();
            console.log("[DropdownManager] Initialized");
        }
        
        setupEventListeners() {
            // Listen for country changes to update subregion and filing status
            this.stateManager.addEventListener('countryChanged', (data) => {
                this.updateSubregionDropdown(data.value);
                this.updateFilingStatusDropdown(data.value);
            });
        }
        
        // Update subregion dropdown based on country
        updateSubregionDropdown(country) {
            const subregionDropdown = this.dropdowns.subregion;
            const subregionContainer = this.containers.subregion;
            
            if (!subregionDropdown) {
                console.error("[DropdownManager] Subregion dropdown not found");
                return;
            }
            
            // Clear existing options
            subregionDropdown.innerHTML = '<option value="">Select Tax Subregion</option>';
            
            if (country && subregionMap[country]) {
                console.log(`[DropdownManager] Adding ${subregionMap[country].length} subregions for ${country}`);
                subregionMap[country].forEach(subregionName => {
                    const option = document.createElement('option');
                    option.text = subregionName;
                    option.value = subregionName;
                    subregionDropdown.appendChild(option);
                });
                subregionContainer.style.display = 'block';
            } else {
                console.log(`[DropdownManager] No subregions found for country: ${country}`);
                subregionContainer.style.display = 'none';
            }
            
            // Clear subregion value if country changed
            this.stateManager.updateState('subregion', '');
        }
        
        // Update filing status dropdown based on country
        updateFilingStatusDropdown(country) {
            const filingStatusDropdown = this.dropdowns.filingStatus;
            
            if (!filingStatusDropdown) {
                console.error("[DropdownManager] Filing status dropdown not found");
                return;
            }
            
            // Clear existing options
            filingStatusDropdown.innerHTML = '<option value="">Select Filing Status</option>';
            
            if (country && filingStatusMap[country]) {
                console.log(`[DropdownManager] Adding ${filingStatusMap[country].length} filing statuses for ${country}`);
                filingStatusMap[country].forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.text = option.text;
                    filingStatusDropdown.appendChild(optionElement);
                });
            } else {
                console.log(`[DropdownManager] No filing statuses found for country: ${country}`);
            }
            
            // Clear filing status value if country changed
            this.stateManager.updateState('filingStatus', '');
        }
        
        // Validate that all required dropdowns are properly populated
        validateDropdowns() {
            const errors = [];
            
            Object.entries(this.dropdowns).forEach(([name, dropdown]) => {
                if (!dropdown) {
                    errors.push(`${name} dropdown not found`);
                } else if (dropdown.options.length <= 1) {
                    errors.push(`${name} dropdown has no valid options`);
                }
            });
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }
        
        // Restore dropdown values from state in strict cascading order, stepwise (with delay)
        async restoreDropdownValues(state) {
            function delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            console.log("[DropdownManager] Restoring dropdown values from state (stepwise):", state);
            // 1. Set country, repopulate subregion/filing status
            if (state.country && this.dropdowns.country) {
                this.dropdowns.country.value = state.country;
                this.updateSubregionDropdown(state.country);
                this.updateFilingStatusDropdown(state.country);
                await delay(200);
            }

            // 2. Set subregion (after subregion options are populated)
            if (state.subregion && this.dropdowns.subregion) {
                const subregionDropdown = this.dropdowns.subregion;
                const found = Array.from(subregionDropdown.options).some(opt => opt.value === state.subregion);
                if (found) {
                    subregionDropdown.value = state.subregion;
                } else {
                    subregionDropdown.value = '';
                }
                await delay(200);
            }

            // 3. Repopulate filing status again (future-proofing)
            if (state.country && this.dropdowns.filingStatus) {
                this.updateFilingStatusDropdown(state.country);
                await delay(200);
            }

            // 4. Set filing status (after options are populated)
            if (state.filingStatus && this.dropdowns.filingStatus) {
                const filingStatusDropdown = this.dropdowns.filingStatus;
                const found = Array.from(filingStatusDropdown.options).some(opt => opt.value === state.filingStatus);
                if (found) {
                    filingStatusDropdown.value = state.filingStatus;
                } else {
                    filingStatusDropdown.value = '';
                }
                if (this.stateManager.getField('filingStatus') !== filingStatusDropdown.value) {
                    this.stateManager.updateState('filingStatus', filingStatusDropdown.value);
                }
                if (window.introSectionController && window.introSectionController.visibilityManager) {
                    window.introSectionController.visibilityManager.updateDependantsVisibility();
                }
                await delay(200);
            }

            // 5. Set residency (independent dropdown)
            if (state.residency && this.dropdowns.residency) {
                const residencyDropdown = this.dropdowns.residency;
                const found = Array.from(residencyDropdown.options).some(opt => opt.value === state.residency);
                if (found) {
                    residencyDropdown.value = state.residency;
                } else {
                    residencyDropdown.value = '';
                }
                await delay(200);
            }

            // 6. After all dropdowns are set, update visibility (for dependants section, etc)
            if (window.introSectionController && window.introSectionController.visibilityManager) {
                console.log("[DropdownManager] Forcing visibility update after dropdown restoration");
                window.introSectionController.visibilityManager.updateAllVisibility();
            }
            console.log("[DropdownManager] All dropdown values restored (stepwise)");
            return Promise.resolve();
        }
        
        // (waitForDropdownPopulation removed: now synchronous population)
    }
    
    /**
     * VisibilityManager - Manages conditional field visibility
     * Handles showing/hiding spouse fields and dependants based on filing status
     */
    class VisibilityManager {
        constructor(stateManager) {
            this.stateManager = stateManager;
            this.elements = {
                specifics: document.getElementById('income-specifics'),
                spouseFields: document.querySelector('.income-spouseFields'),
                dependantsContainer: document.querySelector('.dependantsContainer')
            };
            
            this.setupEventListeners();
            console.log("[VisibilityManager] Initialized");
        }
        
        setupEventListeners() {
            // Listen for state changes that affect visibility
            this.stateManager.addEventListener('filingStatusChanged', () => {
                this.updateAllVisibility();
            });
            
            this.stateManager.addEventListener('stateLoaded', () => {
                this.updateAllVisibility();
            });
        }
        
        // Update all conditional visibility
        updateAllVisibility() {
            this.updateSpecificsVisibility();
            this.updateSpouseVisibility();
            this.updateDependantsVisibility();
            
            // Adjust container size when conditional content appears
            this.adjustContainerSize();
        }
        
        // Adjust container size after visibility changes
        adjustContainerSize() {
            if (window.dataInContainerManager && window.dataInContainerManager.adjustContainerSize) {
                setTimeout(() => {
                    // Pass the form container so it can measure the actual content height
                    const formContainer = document.querySelector('.device-container') || document.querySelector('.data-container-in');
                    window.dataInContainerManager.adjustContainerSize(formContainer);
                }, 100);
            }
        }
        
        // Remove all conditional visibility logic for personal details fields
        updateSpecificsVisibility() {
            // Intentionally left blank. Awaiting new instructions.
        }
        
        // Show/hide spouse fields based on filing status
        updateSpouseVisibility() {
            const spouseFields = this.elements.spouseFields;
            const country = this.stateManager.getField('country');
            const filingStatus = this.stateManager.getField('filingStatus');
            const metadata = this.getFilingStatusMetadata(country, filingStatus);
            const shouldShow = metadata.showSpouseFields && Boolean(filingStatus);

            console.log('---[DEBUG: updateSpouseVisibility]---');
            console.log('country:', country);
            console.log('filingStatus:', filingStatus);
            console.log('metadata:', metadata);
            console.log('shouldShow:', shouldShow);
            console.log('spouseFields element:', spouseFields);

            if (!spouseFields) {
                console.error('[VisibilityManager] spouseFields element NOT FOUND. Check selector .income-spouseFields');
                return;
            }

            spouseFields.style.display = shouldShow ? 'block' : 'none';

            if (shouldShow) {
                console.log('[VisibilityManager] spouseFields should be VISIBLE.');
            } else {
                console.log('[VisibilityManager] spouseFields should be HIDDEN.');
            }
        }
        
        // Show/hide dependants container based on filing status
        updateDependantsVisibility() {
            const dependantsContainer = this.elements.dependantsContainer;
            const country = this.stateManager.getField('country');
            const filingStatus = this.stateManager.getField('filingStatus');
            
            if (!dependantsContainer) return;
            
            const metadata = this.getFilingStatusMetadata(country, filingStatus);
            const shouldShow = metadata.showDisabledDependants && Boolean(filingStatus);
            
            dependantsContainer.style.display = shouldShow ? 'block' : 'none';
            
            console.log(`[VisibilityManager] Dependants container visibility: ${shouldShow} (country: ${country}, filingStatus: ${filingStatus})`);
        }
        
        // Get filing status metadata
        getFilingStatusMetadata(country, filingStatus) {
            if (!country || !filingStatus || !filingStatusMap[country]) {
                return { showSpouseFields: false, showDisabledDependants: false };
            }
            
            const statusOption = filingStatusMap[country].find(option => option.value === filingStatus);
            return statusOption ? {
                showSpouseFields: statusOption.showSpouseFields,
                showDisabledDependants: statusOption.showDisabledDependants
            } : { showSpouseFields: false, showDisabledDependants: false };
        }
    }
    
    /**
     * IntroSectionController - Main controller that coordinates all intro section functionality
     * Replaces the old fragmented approach with a unified, reliable system
     */
    class IntroSectionController {
        constructor() {
            this.stateManager = new IntroStateManager();
            this.dropdownManager = new DropdownManager(this.stateManager);
            this.visibilityManager = new VisibilityManager(this.stateManager);
            
            this.isInitialized = false;
            this.formPersistence = null;
            
            console.log("[IntroSectionController] Initialized");
        }
        
        // Initialize the intro section with FormPersistence integration
        async initialize(formPersistence) {
            console.log("[IntroSectionController] Starting initialization");
            console.log("[IntroSectionController] formPersistence:", formPersistence);
            
            this.formPersistence = formPersistence;
            
            // Setup DOM event listeners
            console.log("[IntroSectionController] Setting up DOM event listeners");
            this.setupDOMEventListeners();
            
            // Load saved state
            console.log("[IntroSectionController] Loading state from FormPersistence");
            this.stateManager.loadFromFormPersistence(formPersistence);
            
            // Restore dropdown values and visibility
            console.log("[IntroSectionController] Restoring intro state (dropdowns, inputs, visibility)");
            await this.restoreIntroState();
            
            // Mark as initialized
            console.log("[IntroSectionController] Marking as initialized");
            this.stateManager.setInitialized(true);
            this.isInitialized = true;
            
            console.log("[IntroSectionController] Initialization complete");

            // Explicitly update visibility again after all restoration (fix for disabled dependants section)
            console.log("[IntroSectionController] Explicitly updating all visibility after initialization");
            this.visibilityManager.updateAllVisibility();

            // Explicitly update visibility again after all restoration (fix for disabled dependants section)
            this.visibilityManager.updateAllVisibility();
        }
        
        // Setup DOM event listeners for form inputs
        setupDOMEventListeners() {
            const fieldMappings = {
                'country': 'country',
                'subregion': 'subregion',
                'residency': 'residency',
                'filingStatus': 'filingStatus',
                'ageSelf': 'ageSelf',
                'employmentStatus': 'employmentStatus',
                'ageSpouse': 'ageSpouse',
                'employmentStatusSpouse': 'employmentStatusSpouse',
                'birthYearDisabledDependants': 'birthYearDisabledDependants'
            };
            
            Object.entries(fieldMappings).forEach(([elementId, stateField]) => {
                const element = document.getElementById(elementId);
                if (element) {
                    const handler = (event) => {
                        console.log(`[IntroSectionController] Event '${event.type}' on ${elementId}, value:`, event.target.value);
                        this.stateManager.updateState(stateField, event.target.value);
                        this.saveFormData();
                    };
                    element.addEventListener('change', handler);
                    element.addEventListener('input', handler);
                    console.log(`[IntroSectionController] Setup listener for ${elementId} -> ${stateField}`);
                } else {
                    console.warn(`[IntroSectionController] Element not found for ${elementId}`);
                }
            });
        }
        
        // Restore intro section state from saved data
        async restoreIntroState() {
            console.log("[IntroSectionController] Restoring intro state");
            
            const state = this.stateManager.getState();
            console.log("[IntroSectionController] Current state:", state);
            
            // Restore dropdown values (handles dependencies)
            console.log("[IntroSectionController] Restoring dropdown values");
            await this.dropdownManager.restoreDropdownValues(state);
            
            // Restore other input values
            console.log("[IntroSectionController] Restoring input values");
            this.restoreInputValues(state);
            
            // Update visibility after restoration
            console.log("[IntroSectionController] Updating all visibility after state restoration");
            this.visibilityManager.updateAllVisibility();
            
            console.log("[IntroSectionController] Intro state restoration complete");
        }
        
        // Restore input field values
        restoreInputValues(state) {
            const inputMappings = {
                'ageSelf': state.ageSelf,
                'employmentStatus': state.employmentStatus,
                'ageSpouse': state.ageSpouse,
                'employmentStatusSpouse': state.employmentStatusSpouse,
                'birthYearDisabledDependants': state.birthYearDisabledDependants
            };
            
            Object.entries(inputMappings).forEach(([elementId, value]) => {
                const element = document.getElementById(elementId);
                if (element && value) {
                    element.value = value;
                    console.log(`[IntroSectionController] Restored ${elementId} = ${value}`);
                } else if (!element) {
                    console.warn(`[IntroSectionController] Input element not found for ${elementId}`);
                } else if (!value) {
                    console.log(`[IntroSectionController] No value to restore for ${elementId}`);
                }
            });
        }
        
        // Save form data
        saveFormData() {
            if (this.formPersistence) {
                this.stateManager.saveToFormPersistence(this.formPersistence);
            }
        }
        
        // Get current intro state
        getIntroState() {
            return this.stateManager.getState();
        }
        
        // Check if intro section is valid for conditional logic
        isValidForConditionalLogic() {
            return this.stateManager.isValidForConditionalLogic();
        }
    }
    
    // Global intro section controller instance
    let introSectionController = null;

    // Initialize form functionality with new state management
    function initIncomeForm() {
        console.log("[IncomeIQ] Initializing form functionality with new state management");
        
        // Use FormPersistence instance created by datain.js, or create our own if not available
        incomeFormPersistence = window.incomeFormPersistence;
        if (!incomeFormPersistence) {
            console.warn("[IncomeIQ] FormPersistence not found from datain.js, creating our own instance");
            
            // Create our own FormPersistence instance
            if (typeof FormPersistence !== 'undefined') {
                incomeFormPersistence = FormPersistence.getInstance('income', {
                    singleSelection: [],
                    multiSelection: [],
                    customFormDataCollector: null,
                    customFormRepopulator: null // Let new system handle this
                });
            } else {
                console.error("[IncomeIQ] FormPersistence class not available");
                return;
            }
        }
        
        console.log("[IncomeIQ] Using FormPersistence instance:", incomeFormPersistence);
        
        // Initialize new intro section controller
        introSectionController = new IntroSectionController();
        introSectionController.initialize(incomeFormPersistence);
        
        // Set up additional input handlers for normalization
        setupAdditionalInputHandlers();

        // Setup generate button
        const generateBtn = document.getElementById('generate-income-btn');
        if (generateBtn) {
            generateBtn.addEventListener('click', function() {
                handleGenerateIncomeIq();
            });
            // Set flag to prevent duplicate handler attachment
            generateBtn.dataset.handlerAttached = 'true';
        }
        
        // Listen for regenerateIncomeCalculations event from modal
        window.addEventListener('regenerateIncomeCalculations', function() {
            console.log('[IncomeIQ] Received regenerateIncomeCalculations event, triggering regeneration...');
            handleGenerateIncomeIq();
        });

        // Export the FormPersistence instance for external access
        window.incomeFormPersistence = incomeFormPersistence;
        window.introSectionController = introSectionController;
        console.log("[IncomeIQ] FormPersistence instance and IntroSectionController exported to window");
    }

    // Legacy functions for backward compatibility
    function saveFormData() {
        if (introSectionController) {
            introSectionController.saveFormData();
        } else if (incomeFormPersistence) {
            console.log("[IncomeIQ] Saving form data via FormPersistence (legacy)");
            incomeFormPersistence.saveFormData();
            
            // Also normalize and save income/expense data when form is saved
            if (typeof window.normalizeIncomeExpenses === 'function') {
                console.log("[IncomeIQ] Auto-normalizing data on form save");
                const result = window.normalizeIncomeExpenses();
                if (result.success) {
                    console.log("[IncomeIQ] Auto-normalization completed");
                }
            }
        } else {
            console.warn("[IncomeIQ] No state management system available, cannot save data");
        }
    }

    function loadSavedData() {
        // New system handles this automatically during initialization
        console.log("[IncomeIQ] loadSavedData called - handled by new state management system");
    }

    function customFormRepopulator(data) {
        // New system handles this automatically
        console.log("[IncomeIQ] customFormRepopulator called - handled by new state management system");
    }

    // Legacy visibility functions - now delegated to new system
    function updateDependantsVisibility() {
        if (introSectionController && introSectionController.isInitialized) {
            introSectionController.visibilityManager.updateDependantsVisibility();
        }
    }

    function updateMaritalStatusVisibility() {
        if (introSectionController && introSectionController.isInitialized) {
            introSectionController.visibilityManager.updateSpouseVisibility();
        }
    }

    function updateSpecificsVisibility() {
        if (introSectionController && introSectionController.isInitialized) {
            introSectionController.visibilityManager.updateSpecificsVisibility();
        }
    }

    function updateSubregionDropdown(country) {
        if (introSectionController && introSectionController.isInitialized) {
            introSectionController.dropdownManager.updateSubregionDropdown(country);
        }
    }

    function updateFilingStatusOptions(country) {
        if (introSectionController && introSectionController.isInitialized) {
            introSectionController.dropdownManager.updateFilingStatusDropdown(country);
        }
    }

    function repopulateFromSavedData() {
        // New system handles this automatically
        console.log("[IncomeIQ] repopulateFromSavedData called - handled by new state management system");
    }

    // Helper function to get filing status metadata (backward compatibility)
    function getFilingStatusMetadata(country, filingStatus) {
        if (!country || !filingStatus || !filingStatusMap[country]) {
            return { showSpouseFields: false, showDisabledDependants: false };
        }
        
        const statusOption = filingStatusMap[country].find(option => option.value === filingStatus);
        return statusOption ? {
            showSpouseFields: statusOption.showSpouseFields,
            showDisabledDependants: statusOption.showDisabledDependants
        } : { showSpouseFields: false, showDisabledDependants: false };
    }

    function setupInputHandlers() {
        // New system handles intro section input listeners
        // Just setup additional handlers for normalization
        console.log("[IncomeIQ] Setting up additional input handlers for normalization");
        setupAdditionalInputHandlers();
    }

    function setupAdditionalInputHandlers() {
        // Add normalization triggers for income and intro fields (XAI-dependent)
        const xaiDependentInputs = document.querySelectorAll(
            'input[id^="income-"], select[id^="income-"]'
        );
        
        xaiDependentInputs.forEach(input => {
            // Remove existing listeners to avoid duplicates
            input.removeEventListener('input', handleXAIDependentInput);
            input.removeEventListener('change', handleXAIDependentInput);
            
            // Add new listeners
            input.addEventListener('input', handleXAIDependentInput);
            input.addEventListener('change', handleXAIDependentInput);
        });
        
        // Add normalization triggers for expenses, assets, liabilities (XAI-independent)
        const xaiIndependentInputs = document.querySelectorAll(
            'input[id^="expenses-"], input[id^="housing-"], input[id^="transportation-"], input[id^="dependant-"], input[id^="assets-"], input[id^="liabilities-"]'
        );
        
        xaiIndependentInputs.forEach(input => {
            // Remove existing listeners to avoid duplicates
            input.removeEventListener('input', handleXAIIndependentInput);
            input.removeEventListener('change', handleXAIIndependentInput);
            
            // Add new listeners
            input.addEventListener('input', handleXAIIndependentInput);
            input.addEventListener('change', handleXAIIndependentInput);
        });
        
        console.log("[IncomeIQ] Set up tiered handlers:", xaiDependentInputs.length, "XAI-dependent inputs and", xaiIndependentInputs.length, "XAI-independent inputs");
    }



    function handleXAIDependentInput(event) {
        console.log("[IncomeIQ] XAI-dependent input changed:", event.target.id);
        
        // Save form data first
        if (incomeFormPersistence) {
            incomeFormPersistence.saveFormData();
        }
        
        // Normalize and save data
        if (typeof window.normalizeIncomeExpenses === 'function') {
            const result = window.normalizeIncomeExpenses();
            if (result.success) {
                console.log("[IncomeIQ] ✅ Data normalized and saved to localStorage");
                
                // Trigger dashboard update for XAI-independent metrics only
                triggerDashboardUpdate(false); // false = don't update tax-dependent metrics
            } else {
                console.error("[IncomeIQ] ❌ Failed to normalize data:", result.error);
            }
        }
    }



    function handleXAIIndependentInput(event) {
        console.log("[IncomeIQ] XAI-independent input changed:", event.target.id);
        
        // Save form data first
        if (incomeFormPersistence) {
            incomeFormPersistence.saveFormData();
        }
        
        // Normalize and save data
        if (typeof window.normalizeIncomeExpenses === 'function') {
            const result = window.normalizeIncomeExpenses();
            if (result.success) {
                console.log("[IncomeIQ] ✅ Data normalized and saved to localStorage");
                
                // Trigger full dashboard update (taxes/contributions remain unchanged)
                triggerDashboardUpdate(true); // true = update all metrics using existing tax data
            } else {
                console.error("[IncomeIQ] ❌ Failed to normalize data:", result.error);
            }
        }
    }

    function markTaxCalculationsStale() {
        // Set a flag indicating tax calculations are outdated
        localStorage.setItem('taxCalculationsStale', 'true');
        localStorage.setItem('taxCalculationsStaleTimestamp', Date.now().toString());
        console.log("[IncomeIQ] 🔄 Tax calculations marked as stale");
    }

    function triggerDashboardUpdate(updateAllMetrics) {
        // Dispatch custom event to notify dashboard to update
        const updateEvent = new CustomEvent('dashboard-update-needed', {
            detail: {
                updateAllMetrics: updateAllMetrics,
                timestamp: Date.now()
            }
        });
        document.dispatchEvent(updateEvent);
        console.log("[IncomeIQ] 📊 Dashboard update triggered, updateAllMetrics:", updateAllMetrics);
    }

    // Update filing status options based on country (legacy compatibility)
    function updateFilingStatusOptions(country) {
        if (introSectionController && introSectionController.isInitialized) {
            introSectionController.dropdownManager.updateFilingStatusDropdown(country);
        } else {
            // Fallback for legacy compatibility
            const filingStatusDropdown = document.getElementById('filingStatus');
            if (!filingStatusDropdown) return;

            filingStatusDropdown.innerHTML = '<option value="">Select Filing Status</option>';

            if (country && filingStatusMap[country]) {
                filingStatusMap[country].forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.text = option.text;
                    filingStatusDropdown.appendChild(optionElement);
                });
            }
        }
    }    // Show/hide dependants container based on filing status (legacy compatibility)
    function updateDependantsVisibility() {
        if (introSectionController && introSectionController.isInitialized) {
            introSectionController.visibilityManager.updateDependantsVisibility();
        } else {
            // Fallback for legacy compatibility
            const dependantsContainer = document.querySelector('.income-dependantsContainer');
            const filingStatusDropdown = document.getElementById('filingStatus');
            const countryDropdown = document.getElementById('income-country');
            
            if (!dependantsContainer || !filingStatusDropdown || !countryDropdown) {
                console.warn('[IncomeIQ] updateDependantsVisibility: missing container or dropdown');
                return;
            }
            
            const selectedCountry = countryDropdown.value;
            const selectedFilingStatus = filingStatusDropdown.value;
            const metadata = getFilingStatusMetadata(selectedCountry, selectedFilingStatus);
            
            dependantsContainer.style.display = metadata.showDisabledDependants ? 'block' : 'none';
            console.log(`[IncomeIQ] updateDependantsVisibility: country='${selectedCountry}', filingStatus='${selectedFilingStatus}', show=${metadata.showDisabledDependants}`);
        }
    }

    // Show/hide spouse fields based on filing status (legacy compatibility)
    function updateMaritalStatusVisibility() {
        if (introSectionController && introSectionController.isInitialized) {
            introSectionController.visibilityManager.updateSpouseVisibility();
        } else {
            // Fallback for legacy compatibility
            const spouseFields = document.querySelector('.income-spouseFields');
            const filingStatusDropdown = document.getElementById('income-filingStatus');
            const countryDropdown = document.getElementById('income-country');
            
            if (!spouseFields || !filingStatusDropdown || !countryDropdown) return;
            
            const selectedCountry = countryDropdown.value;
            const selectedFilingStatus = filingStatusDropdown.value;
            const metadata = getFilingStatusMetadata(selectedCountry, selectedFilingStatus);
            
            spouseFields.style.display = metadata.showSpouseFields && selectedFilingStatus ? 'block' : 'none';
            console.log(`[IncomeIQ] updateMaritalStatusVisibility: country='${selectedCountry}', filingStatus='${selectedFilingStatus}', show=${metadata.showSpouseFields}`);
        }
    }

    // Show/hide personal details section (legacy compatibility)
    function updateSpecificsVisibility() {
        if (introSectionController && introSectionController.isInitialized) {
            introSectionController.visibilityManager.updateSpecificsVisibility();
        } else {
            // Fallback for legacy compatibility
            const specificsDiv = document.getElementById('income-specifics');
            const filingStatusDropdown = document.getElementById('income-filingStatus');
            
            if (!specificsDiv || !filingStatusDropdown) return;
            
            specificsDiv.style.display = filingStatusDropdown.value ? 'block' : 'none';
        }
    }

    // Generate IncomeIQ report - ONLY send normalized incomeIqinput1 data
    async function handleGenerateIncomeIq() {
        try {
            // Force normalization to ensure we have fresh normalized data
            console.log("[IncomeIQ] Running normalization before sending to worker");
            const normalizationResult = window.normalizeIncomeExpenses();
            if (!normalizationResult.success) {
                console.error("[IncomeIQ] Failed to normalize data:", normalizationResult.error);
                alert('Failed to process your form data. Please check your inputs and try again.');
                return;
            }
            
            // Get ONLY the normalized data from localStorage
            const incomeIqinput1Raw = localStorage.getItem('incomeIqinput1');
            if (!incomeIqinput1Raw) {
                console.error("[IncomeIQ] No normalized data found in incomeIqinput1");
                alert('No normalized data available. Please fill out the form and try again.');
                return;
            }

            // Check rate limiting before proceeding
            if (window.rateLimiter.isRateLimited('income', 10, 60 * 60 * 1000)) { // 10 requests per hour
                alert('You have exceeded the request limit for income analysis. Please try again later.');
                return;
            }

            let payloadToSend;
            try {
                payloadToSend = JSON.parse(incomeIqinput1Raw);
                console.log("[IncomeIQ] ✅ Using ONLY normalized data from incomeIqinput1");
            } catch (e) {
                console.error("[IncomeIQ] Error parsing incomeIqinput1:", e);
                alert('Error processing normalized data. Please try again.');
                return;
            }

            // Create worker payload with email for paid users (DRY function)
            const workerPayload = window.rateLimiter.createWorkerPayload('income', payloadToSend);
            
            // DEBUG: Log the final payload (hide sensitive fingerprint details)
            console.log("[IncomeIQ] Final payload being sent to worker:", JSON.stringify({
                module: workerPayload.module,
                email: workerPayload.email || 'not provided',
                formData: payloadToSend,
                fingerprint: { 
                    deviceId: workerPayload.fingerprint.deviceId.slice(0, 8) + '...', 
                    sessionId: workerPayload.fingerprint.sessionId.slice(0, 8) + '...',
                    requestCount: Object.keys(workerPayload.fingerprint.requestCounts).length 
                }
            }, null, 2));

            // Use enhanced loading with educational facts
            const dataContainer = document.querySelector('.device-container') || document.body;
            let backendResponse = null;
            
            try {
                const result = await window.enhancedLoading(
                    'generate-income-btn',
                    'income',
                    async () => {
                        // Use the proper Cloudflare-secured API endpoint
                        const apiUrl = 'https://inexasli.com/api/generate';
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(workerPayload)
                        });

                        let responseData;
                        try {
                            responseData = await response.json();
                        } catch (e) {
                            responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
                        }
                        
                        // Store backend response for error handling
                        backendResponse = responseData;
                        
                        // Always call handleRateLimitResponse with backend response
                        window.rateLimiter.handleRateLimitResponse(dataContainer, responseData, !response.ok, 'IncomeIQ');

                        if (!response.ok) {
                            throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
                        }

                        if (responseData.message !== 'Success') {
                            throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
                        }

                        return responseData;
                    }
                );
                
                // Increment request count after successful response
                window.rateLimiter.incrementRequestCount('income');

                // Store the response using centralized system
                if (window.incomeFormPersistence) {
                    window.incomeFormPersistence.saveResponseData(result);
                }

                // Clear stale tax calculations flag
                localStorage.removeItem('taxCalculationsStale');
                localStorage.removeItem('taxCalculationsStaleTimestamp');
                console.log("[IncomeIQ] ✅ Tax calculations are now fresh");

                // Dispatch an event to notify dataout.js that a response was received
                const event = new CustomEvent('api-response-received', {
                    detail: {
                        module: 'incomeiq',
                        type: 'worker-response',
                        timestamp: Date.now()
                    }
                });
                document.dispatchEvent(event);
                console.log('[IncomeIQ] Dispatched api-response-received event');
                
                console.log('[IncomeIQ] Income report generated successfully');
            } catch (error) {
                // If backendResponse is available, update rate limit display and show error
                if (backendResponse && dataContainer) {
                    window.rateLimiter.handleRateLimitResponse(dataContainer, backendResponse, true, 'IncomeIQ');
                }
                console.error('[IncomeIQ] Error generating income report:', error);
                alert('An error occurred while generating your income report. Please try again later.');
            }

        } catch (error) {
            console.error('[IncomeIQ] Error generating income report:', error);
            alert('An error occurred while generating your income report. Please try again later.');
        }
    }

    // Debug function to test percentage calculations
    function testPercentageCalculation() {
        console.log("=== Testing Percentage Calculations ===");
        
        // Test asset calculation
        const testAssetValue = 100000; // $100,000
        const testAssetPercent = 50; // 50%
        const calculatedAsset = testAssetValue * (testAssetPercent / 100);
        console.log(`Asset Test: $${testAssetValue} * ${testAssetPercent}% = $${calculatedAsset}`);
        
        // Test liability calculation  
        const testLiabilityValue = 200000; // $200,000
        const testLiabilityPercent = 75; // 75%
        const calculatedLiability = testLiabilityValue * (testLiabilityPercent / 100);
        console.log(`Liability Test: $${testLiabilityValue} * ${testLiabilityPercent}% = $${calculatedLiability}`);
        
        console.log("=== Percentage Calculation Tests Complete ===");
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initIncomeForm);
    } else {
        initIncomeForm();
    }

    // Listen for datain.js events - only initialize if income module is loaded
    document.addEventListener('data-in-loaded', function(e) {
        const moduleType = e.detail?.moduleType;
        if (moduleType === 'income') {
            console.log("[IncomeIQ] Income module loaded through datain.js, reinitializing");
            initIncomeForm();
        }
    });

    // Additional safety net - try again after a short delay, but prevent duplicate handlers
    setTimeout(() => {
        const generateBtn = document.getElementById('generate-income-btn');
        if (generateBtn && !generateBtn.onclick && !generateBtn.dataset.handlerAttached) {
            console.log("[IncomeIQ] Generate button found but no handler, trying initialization again");
            initIncomeForm();
        } else if (generateBtn && generateBtn.dataset.handlerAttached) {
            console.log("[IncomeIQ] Generate button already has handler attached, skipping retry initialization");
        }
    }, 200);

    // Export functions for external access
    window.incomeIq = { 
        getFormData: () => incomeFormPersistence ? incomeFormPersistence.getSavedFormData() : null,
        saveFormData: () => saveFormData(),
        loadSavedData: () => loadSavedData(),
        customFormRepopulator: customFormRepopulator,
        // New state management access
        getIntroState: () => introSectionController ? introSectionController.getIntroState() : null,
        isValidForConditionalLogic: () => introSectionController ? introSectionController.isValidForConditionalLogic() : false,
        introSectionController: () => introSectionController
    };

    // Normalize income and expenses function
    window.normalizeIncomeExpenses = function() {
        console.log("[IncomeIQ] Starting normalization of income and expenses");
        
        // Get frequency settings from localStorage
        const getFrequencySetting = (frequencyId, defaultValue = 'annually') => {
            try {
                const settings = JSON.parse(localStorage.getItem('frequencySettings')) || {};
                return settings[frequencyId] || defaultValue;
            } catch (error) {
                console.warn(`Error getting frequency setting for ${frequencyId}:`, error);
                return defaultValue;
            }
        };

        // Calculate annual value based on frequency
        const calculateAnnual = (value, frequency) => {
            const numValue = parseFloat(value) || 0;
            switch (frequency) {
                case 'annually': return numValue * 1;
                case 'quarterly': return numValue * 4;
                case 'monthly': return numValue * 12;
                case 'weekly': return numValue * 52;
                default: return numValue;
            }
        };

        // Income fields to normalize
        const incomeFields = [
            'income-salary-wages',
            'income-tips',
            'income-bonuses',
            'income-sole-prop',
            'income-federal-pension',
            'income-provincial-pension',
            'income-private-pension',
            'income-old-age-security',
            'income-employment-insurance',
            'income-social-security',
            'income-investment-property',
            'income-capital-gains-losses',
            'income-venture-capital',
            'income-public-dividend',
            'income-owner-dividend',
            'income-interest',
            'income-royalties',
            'income-peer-to-peer-lending',
            'income-trust',
            'income-alimony',
            'income-scholarships-grants',
            'income-tax-free-income',
            'income-gambling-winnings'
        ];

        // Expense fields to normalize
        const expenseFields = [
            // Essential expenses
            'expenses-grocery',
            'expenses-fitness',
            'expenses-hygiene',
            'expenses-medical-dental',
            'expenses-perscription',
            'expenses-clothing',
            'expenses-cellphone-service',
            // Discretionary expenses
            'expenses-retirement',
            'expenses-dining',
            'expenses-entertainment',
            'expenses-vacation',
            'expenses-travel-life-insurance',
            'expenses-subscriptions',
            'expenses-beauty',
            // Housing expenses
            'housing-mortgage-payment',
            'housing-rent-payment',
            'housing-property-tax',
            'housing-condo-fee',
            'housing-hydro',
            'housing-water',
            'housing-gas',
            'housing-insurance',
            'housing-repairs',
            'housing-internet',
            // Transportation expenses
            'transportation-car-loan-payment',
            'transportation-fuel',
            'transportation-insurance',
            'transportation-maintenance',
            'transportation-public-transit',
            'transportation-ride-hailing',
            // Debt expenses
            'expenses-line-of-credit-payment',
            'expenses-student-loan-payment',
            'expenses-credit-card-payment',
            'expenses-tax-arrears-payment',
            'expenses-small-business-loan-payment',
            // Dependents expenses
            'dependant-day-care',
            'dependant-medical-dental',
            'dependant-clothing',
            'dependant-sports-recreation',
            'dependant-transportation',
            'dependant-tuition',
            'dependant-housing',
            'dependant-cellular-service'
        ];

        // Normalize income data
        const normalizedIncome = {};
        incomeFields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element && element.value) {
                const frequencyId = `${fieldId}-frequency`;
                const frequency = getFrequencySetting(frequencyId, 'annually');
                const annualValue = calculateAnnual(element.value, frequency);
                normalizedIncome[fieldId] = annualValue;
                console.log(`Income ${fieldId}: $${element.value} ${frequency} = $${annualValue} annually`);
            }
        });

        // Normalize expense data
        const normalizedExpenses = {};
        expenseFields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element && element.value) {
                const frequencyId = `${fieldId}-frequency`;
                const frequency = getFrequencySetting(frequencyId, 'annually');
                const annualValue = calculateAnnual(element.value, frequency);
                normalizedExpenses[fieldId] = annualValue;
                console.log(`Expense ${fieldId}: $${element.value} ${frequency} = $${annualValue} annually`);
            }
        });

        // Collect assets data with percentage calculation
        const assetFields = [
            'assets-checking-accounts',
            'assets-savings-accounts', 
            'assets-other-liquid-accounts',
            'assets-money-lent-out',
            'assets-long-term-investment-accounts',
            'assets-investment-properties',
            'assets-art-jewelry',
            'assets-primary-residence',
            'assets-small-business',
            'assets-vehicles',
            'assets-investment-accounts',
            'assets-vehicle-value',
            'assets-other-assets'
        ];
        
        const assetsData = {};
        assetFields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element && element.value) {
                let assetValue = parseFloat(element.value) || 0;
                
                // Check for percentage input
                const percentElement = document.getElementById(`${fieldId}-percent`);
                if (percentElement && percentElement.value) {
                    const percentValue = parseFloat(percentElement.value) || 100;
                    assetValue = assetValue * (percentValue / 100);
                    console.log(`Asset ${fieldId}: $${element.value} * ${percentValue}% = $${assetValue.toFixed(2)}`);
                } else {
                    console.log(`Asset ${fieldId}: $${element.value}`);
                }
                
                assetsData[fieldId] = assetValue;
            }
        });

        // Collect liabilities data with percentage calculation
        const liabilityFields = [
            'liabilities-small-business-loan',
            'liabilities-primary-residence',
            'liabilities-investment-properties',
            'liabilities-vehicle-loan',
            'liabilities-personal-debt',
            'liabilities-line-of-credit',
            'liabilities-student-loan',
            'liabilities-credit-card',
            'liabilities-tax-arrears'
        ];
        
        const liabilitiesData = {};
        liabilityFields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element && element.value) {
                let liabilityValue = parseFloat(element.value) || 0;
                
                // Check for percentage input
                const percentElement = document.getElementById(`${fieldId}-percent`);
                if (percentElement && percentElement.value) {
                    const percentValue = parseFloat(percentElement.value) || 100;
                    liabilityValue = liabilityValue * (percentValue / 100);
                    console.log(`Liability ${fieldId}: $${element.value} * ${percentValue}% = $${liabilityValue.toFixed(2)}`);
                } else {
                    console.log(`Liability ${fieldId}: $${element.value}`);
                }
                
                liabilitiesData[fieldId] = liabilityValue;
            }
        });

        // Calculate totals
        const totalAnnualIncome = Object.values(normalizedIncome).reduce((sum, value) => sum + value, 0);
        const totalAnnualExpenses = Object.values(normalizedExpenses).reduce((sum, value) => sum + value, 0);
        const totalAssets = Object.values(assetsData).reduce((sum, value) => sum + value, 0);
        const totalLiabilities = Object.values(liabilitiesData).reduce((sum, value) => sum + value, 0);

        console.log(`Total Annual Income: $${totalAnnualIncome.toFixed(2)}`);
        console.log(`Total Annual Expenses: $${totalAnnualExpenses.toFixed(2)}`);
        console.log(`Total Assets: $${totalAssets.toFixed(2)}`);
        console.log(`Total Liabilities: $${totalLiabilities.toFixed(2)}`);

        // Save normalized data to localStorage
        try {
            // Collect all Tax Residency & Personal Details fields
            const taxResidencyFields = [
                'income-country',
                'income-subregion',
                'income-residency',
                'income-filingStatus',
                'income-ageSelf',
                'income-employmentStatus',
                'income-ageSpouse',
                'income-employmentStatusSpouse',
                'income-birthYearDisabledDependants'
            ];
            const taxResidencyData = {};
            taxResidencyFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) taxResidencyData[id.replace('income-', '')] = el.value;
            });

            // Save to localStorage in the correct structure for the worker
            const incomeIqinput1 = {
                introData: taxResidencyData,
                incomeData: normalizedIncome
            };
            
            // Save expenses to incomeIqInput2 as requested (no introData needed)
            const incomeIqInput2 = {
                expenseData: normalizedExpenses
            };
            
            localStorage.setItem('incomeIqinput1', JSON.stringify(incomeIqinput1));
            localStorage.setItem('incomeIqInput2', JSON.stringify(incomeIqInput2));
            // Keep the original for backward compatibility
            localStorage.setItem('incomeIqExpense', JSON.stringify(normalizedExpenses));
            
            // Store assets and liabilities separately
            localStorage.setItem('incomeIqAssets', JSON.stringify(assetsData));
            localStorage.setItem('incomeIqLiabilities', JSON.stringify(liabilitiesData));

            console.log("[IncomeIQ] ✅ Successfully saved normalized data to localStorage");
            console.log("Income data saved to 'incomeIqinput1':", incomeIqinput1);
            console.log("Expense data saved to 'incomeIqInput2':", incomeIqInput2);
            console.log("Expense data also saved to 'incomeIqExpense':", normalizedExpenses);
            console.log("Assets data saved to 'incomeIqAssets':", assetsData);
            console.log("Liabilities data saved to 'incomeIqLiabilities':", liabilitiesData);

            return {
                success: true,
                income: normalizedIncome,
                expenses: normalizedExpenses,
                assets: assetsData,
                liabilities: liabilitiesData,
                summary: {
                    totalIncome: totalAnnualIncome,
                    totalExpenses: totalAnnualExpenses,
                    totalAssets: totalAssets,
                    totalLiabilities: totalLiabilities,
                    netWorth: totalAssets - totalLiabilities,
                    netIncome: totalAnnualIncome - totalAnnualExpenses
                }
            };

        } catch (error) {
            console.error("[IncomeIQ] ❌ Error saving normalized data:", error);
            return {
                success: false,
                error: error.message
            };
        }
    };

})();
</script>

<!-- Load frequency.js module for frequency dropdown functionality -->
<script src="/ai/income/frequency.js" type="module"></script>
<script src="/utility/toolTip.js" type="module"></script>



<!-- Initialize frequency dropdowns and tooltips -->
<script>
(function() {
    let tooltipInitAttempts = 0;
    let frequencyInitAttempts = 0;
    const maxAttempts = 20; // Try for up to 2 seconds
    
    // Function to initialize frequency dropdowns with fallback
    function initFrequencyDropdowns() {
        frequencyInitAttempts++;
        console.log(`[IncomeIQ] Frequency init attempt ${frequencyInitAttempts}`);
        
        if (typeof window.initializeFrequencyGroups === 'function') {
            console.log('[IncomeIQ] Initializing frequency groups...');
            window.initializeFrequencyGroups();
        } else if (frequencyInitAttempts < maxAttempts) {
            console.warn('[IncomeIQ] initializeFrequencyGroups not available, retrying in 100ms...');
            setTimeout(initFrequencyDropdowns, 100);
        } else {
            console.error('[IncomeIQ] Failed to initialize frequency groups after maximum attempts');
        }
    }

    // Function to initialize tooltips with fallback
    function initTooltips() {
        tooltipInitAttempts++;
        console.log(`[IncomeIQ] Tooltip init attempt ${tooltipInitAttempts}`);
        console.log("[IncomeIQ] window.initializeTooltips exists:", typeof window.initializeTooltips);
        
        if (typeof window.initializeTooltips === 'function') {
            console.log('[IncomeIQ] Initializing tooltips...');
            try {
                window.initializeTooltips(document);
                console.log('[IncomeIQ] Tooltips initialized successfully');
            } catch (error) {
                console.error('[IncomeIQ] Error initializing tooltips:', error);
            }
        } else if (tooltipInitAttempts < maxAttempts) {
            console.warn('[IncomeIQ] initializeTooltips not available, retrying in 100ms...');
            setTimeout(initTooltips, 100);
        } else {
            console.error('[IncomeIQ] Failed to initialize tooltips after maximum attempts');
        }
    }

    // Wait for DOM and modules to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[IncomeIQ] DOM loaded, starting initialization...');
            // Give modules a moment to load
            setTimeout(() => {
                initFrequencyDropdowns();
                initTooltips();
            }, 50);
        });
    } else {
        // DOM already loaded, try immediately with delay for modules
        console.log('[IncomeIQ] DOM already loaded, starting initialization...');
        setTimeout(function() {
            initFrequencyDropdowns();
            initTooltips();
        }, 100);
    }
})();
</script>