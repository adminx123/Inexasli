<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IncomeIQ™ Analysis Results</title>
  
  <!-- Preconnect and font links -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles/outputstyles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Chart.js CDN for interactive charts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  
  <style>
    /* Using device-container, output-wrapper and api-output styles from outputstyles.css */
    
    .income-display {
      font-family: "Inter", sans-serif;
      font-size: 16px;
      line-height: 1.6;
      white-space: normal;
    }
    
    .income-header {
      text-align: center;
      margin-bottom: 25px;
    }
    
    /* Professional Financial Report Styling */
    .summary-container, .summary-container1 {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Chart-specific utility styles */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .chart-container {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
      position: relative;
      height: 400px;
    }
    
    .chart-container.small {
      height: 300px;
    }
    
    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }
    
    /* Dashboard Grid Layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    /* Modern Card-Based UI */
    .dashboard-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
    }
    
    .dashboard-card h3 {
      margin: 0 0 15px 0;
      color: #1f2937;
      font-size: 1.1em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Financial Metric Cards */
    .metric-card {
      background: #f8fafc;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      border-left: 4px solid;
      margin-bottom: 12px;
    }
    
    .metric-card.positive {
      border-left-color: #10b981;
      background: linear-gradient(135deg, #ecfdf5, #f0fdf4);
    }
    
    .metric-card.warning {
      border-left-color: #f59e0b;
      background: linear-gradient(135deg, #fffbeb, #fef3c7);
    }
    
    .metric-card.negative {
      border-left-color: #ef4444;
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
    }
    
    .metric-value {
      font-size: 1.5em;
      font-weight: 700;
      margin: 8px 0 4px 0;
    }
    
    .metric-label {
      font-size: 0.9em;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
    }
    
    .metric-description {
      font-size: 0.8em;
      margin-top: 4px;
      opacity: 0.7;
    }
    
    /* Progress Indicators */
    .progress-container {
      margin: 16px 0;
    }
    
    .progress-bar {
      width: 100%;
      height: 24px;
      background: #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      border-radius: 12px;
      transition: width 1s ease-out;
      position: relative;
    }
    
    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.85em;
      font-weight: 600;
      color: #1f2937;
      z-index: 1;
    }
    
    /* Interactive Controls */
    .controls-section {
      background: #f9fafb;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid #e5e7eb;
    }
    
    .control-group {
      margin-bottom: 20px;
    }
    
    .control-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }
    
    .range-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #e5e7eb;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .range-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #4f46e5;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .range-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #4f46e5;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .range-value {
      display: inline-block;
      padding: 4px 8px;
      background: #4f46e5;
      color: white;
      border-radius: 4px;
      font-size: 0.9em;
      font-weight: 500;
      margin-left: 8px;
    }
    
    /* Health Score Visualization */
    .health-score-container {
      text-align: center;
      padding: 20px;
    }
    
    .health-score-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      font-weight: 700;
      color: white;
      background: conic-gradient(from 0deg, #ef4444 0deg 36deg, #f59e0b 36deg 72deg, #10b981 72deg 360deg);
      position: relative;
    }
    
    .health-score-inner {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1f2937;
    }
    
    /* Mobile Responsive Design */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .chart-container {
        height: 300px;
        padding: 16px;
      }
      
      .chart-container.small {
        height: 250px;
      }
      
      .dashboard-card {
        padding: 16px;
      }
      
      .metric-value {
        font-size: 1.3em;
      }
      
      .health-score-circle {
        width: 100px;
        height: 100px;
        font-size: 1.6em;
      }
      
      .health-score-inner {
        width: 75px;
        height: 75px;
      }
    }
    
    @media (max-width: 480px) {
      .dashboard-grid {
        gap: 12px;
      }
      
      .dashboard-card {
        padding: 12px;
      }
      
      .chart-container {
        height: 250px;
        padding: 12px;
      }
      
      .metric-card {
        padding: 12px;
      }
      
      .controls-section {
        padding: 16px;
      }
    }
    
    .summary-container details, .summary-container1 details {
      margin: 0;
    }
    
    .summary-container summary, .summary-container1 summary {
      padding: 15px 20px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      background: #f8f9fa;
      border-radius: 8px 8px 0 0;
      font-weight: 600;
      transition: background-color 0.2s ease;
    }
    
    .summary-container summary:hover, .summary-container1 summary:hover {
      background: #e9ecef;
    }
    
    .summary-container details[open] summary, .summary-container1 details[open] summary {
      border-radius: 8px 8px 0 0;
      border-bottom: 1px solid #ddd;
    }
    
    .summary-container h2, .summary-container1 h2 {
      margin: 0;
      font-size: 18px;
      color: #2c3e50;
      display: flex;
      align-items: center;
    }
    
    /* Subsection styling */
    .summary-container details details summary,
    .summary-container1 details details summary {
      padding: 10px 15px;
      background: #f1f3f4;
      border-radius: 4px;
      margin: 5px 0;
      font-size: 14px;
      font-weight: 500;
    }
    
    .summary-container details details summary:hover,
    .summary-container1 details details summary:hover {
      background: #e8eaed;
    }
    
    /* Content areas */
    .summary-container div[style*="margin-left: 21px"],
    .summary-container1 div[style*="margin-left: 21px"],
    .summary-container div[style*="margin-left: 34px"],
    .summary-container1 div[style*="margin-left: 34px"] {
      padding: 15px 20px;
    }
    
    /* Financial metrics styling */
    .financial-metric {
      background: white;
      color: #2c5530;
      border: 2px solid #4a7c59;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 2px 8px rgba(74, 124, 89, 0.15);
    }
    
    /* Recommendation cards */
    .recommendation-highlight {
      background: linear-gradient(135deg, #fff9e6 0%, #fef3cd 100%);
      border-left: 5px solid #ffc107;
      padding: 20px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
      box-shadow: 0 2px 6px rgba(255, 193, 7, 0.2);
    }
    
    .ai-insight {
      background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
      border-left: 5px solid #007bff;
      padding: 20px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
      box-shadow: 0 2px 6px rgba(0, 123, 255, 0.2);
    }
    
    .action-item {
      background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
      border-left: 5px solid #28a745;
      padding: 20px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
      box-shadow: 0 2px 6px rgba(40, 167, 69, 0.2);
    }
    
    /* Icon styling */
    .section-icon {
      font-size: 1.2em;
      margin-right: 10px;
      color: #4a7c59;
    }
    
    /* Methodology section */
    .methodology-content {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 20px;
      font-size: 0.9em;
      line-height: 1.6;
      color: #6c757d;
    }
    
    /* Professional typography */
    h2 {
      font-family: "Playfair Display", serif;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    h3 {
      font-family: "Inter", sans-serif;
      font-weight: 500;
    }
    
    p {
      font-family: "Inter", sans-serif;
      line-height: 1.6;
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
      .summary-container summary, .summary-container1 summary {
        padding: 12px 15px;
      }
      
      .summary-container h2, .summary-container1 h2 {
        font-size: 16px;
      }
      
      .recommendation-highlight,
      .ai-insight,
      .action-item {
        padding: 15px;
        margin: 10px 0;
      }
    }
   
  </style>
</head>
<body>
  <!-- Main content container with ID for accessibility -->
  <div id="main-content" class="device-container income-container">
    <div class="output-wrapper">
      <div id="output-span" class="api-output"></div>
    </div>
  </div>

<script>
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

(function() {
    console.log('IncomeIQ API Output script running');

    // Get the parameters from the URL if this is standalone, or check local storage
    const params = new URLSearchParams(window.location.search);
    const inputData = params.get('input');
    const outputData = params.get('output');

    // Import utility functions
    function getCurrentCurrencySymbol() {
        try {
            const symbol = localStorage.getItem('currencySymbol');
            return symbol || '$';
        } catch (error) {
            console.error('Error getting currency symbol:', error);
            return '$';
        }
    }
    
    function getLocal(key) {
        try {
            return localStorage.getItem(key);
        } catch (error) {
            console.error('Error accessing localStorage:', error);
            return null;
        }
    }

    // Financial Health Scoring System
    function calculateFinancialHealthScore(metrics, netCashFlow, savingsRate) {
        let score = 0;
        
        // Net Cash Flow (25 points)
        if (netCashFlow > metrics.annualIncome * 0.2) score += 25;
        else if (netCashFlow > metrics.annualIncome * 0.1) score += 20;
        else if (netCashFlow > 0) score += 15;
        else if (netCashFlow > -metrics.annualIncome * 0.05) score += 10;
        else score += 0;
        
        // Debt to Income Ratio (20 points)
        if (metrics.debtToIncome < 0.15) score += 20;
        else if (metrics.debtToIncome < 0.25) score += 15;
        else if (metrics.debtToIncome < 0.36) score += 10;
        else if (metrics.debtToIncome < 0.50) score += 5;
        else score += 0;
        
        // Emergency Fund / Savings Rate (20 points)
        if (savingsRate > 0.20) score += 20;
        else if (savingsRate > 0.15) score += 15;
        else if (savingsRate > 0.10) score += 10;
        else if (savingsRate > 0.05) score += 5;
        else score += 0;
        
        // Net Worth Position (15 points)
        if (metrics.netWorth > metrics.annualIncome * 2) score += 15;
        else if (metrics.netWorth > metrics.annualIncome) score += 12;
        else if (metrics.netWorth > 0) score += 8;
        else if (metrics.netWorth > -metrics.annualIncome * 0.5) score += 4;
        else score += 0;
        
        // Housing to Income (10 points)
        if (metrics.housingToIncome < 0.25) score += 10;
        else if (metrics.housingToIncome < 0.30) score += 8;
        else if (metrics.housingToIncome < 0.35) score += 5;
        else score += 0;
        
        // FIRE Progress (10 points)
        if (metrics.fireRatio >= 1.0) score += 10;
        else if (metrics.fireRatio >= 0.5) score += 8;
        else if (metrics.fireRatio >= 0.25) score += 5;
        else if (metrics.fireRatio >= 0.1) score += 3;
        else score += 0;
        
        return Math.min(100, Math.max(0, score));
    }

    function getHealthScoreDescription(score) {
        if (score >= 85) return "Excellent financial health with strong savings and low debt burden.";
        if (score >= 70) return "Good financial position with room for minor improvements.";
        if (score >= 55) return "Fair financial health with some areas needing attention.";
        if (score >= 40) return "Below average financial health requiring strategic improvements.";
        return "Poor financial health requiring immediate attention and planning.";
    }

    function getFireTimelineEstimate(fireRatio, savingsRate) {
        if (fireRatio >= 1.0) return "Financially independent now!";
        if (savingsRate <= 0) return "Unable to calculate - negative savings rate";
        
        const targetMultiple = 25; // 25x annual expenses for FIRE
        const currentMultiple = fireRatio * targetMultiple;
        const yearsToFire = (targetMultiple - currentMultiple) / (savingsRate * targetMultiple);
        
        if (yearsToFire <= 0) return "Financially independent now!";
        if (yearsToFire > 50) return "50+ years at current savings rate";
        
        return `Approximately ${Math.round(yearsToFire)} years at current savings rate`;
    }

    function getExpenseBreakdown() {
        // This would typically come from user input data
        // For now, we'll return a sample breakdown
        return {
            housing: 35,
            transportation: 15,
            food: 12,
            healthcare: 8,
            entertainment: 8,
            utilities: 6,
            insurance: 5,
            other: 11
        };
    }

    // Global chart management with robust destruction
    let chartInitializationInProgress = false;
    let chartInitializationPending = false;
    let chartInitTimeout = null;
    let activeChartInstances = {
        cashFlow: null,
        expense: null,
        netWorth: null
    };

    function destroyAllCharts() {
        console.log('[Charts] Starting chart destruction...');
        let destroyedCount = 0;
        
        // Destroy tracked instances first
        if (activeChartInstances.cashFlow) {
            try {
                activeChartInstances.cashFlow.destroy();
                activeChartInstances.cashFlow = null;
                destroyedCount++;
                console.log('[Charts] Destroyed tracked cash flow chart');
            } catch (error) {
                console.warn('[Charts] Error destroying tracked cash flow chart:', error);
            }
        }
        
        if (activeChartInstances.expense) {
            try {
                activeChartInstances.expense.destroy();
                activeChartInstances.expense = null;
                destroyedCount++;
                console.log('[Charts] Destroyed tracked expense chart');
            } catch (error) {
                console.warn('[Charts] Error destroying tracked expense chart:', error);
            }
        }
        
        if (activeChartInstances.netWorth) {
            try {
                activeChartInstances.netWorth.destroy();
                activeChartInstances.netWorth = null;
                destroyedCount++;
                console.log('[Charts] Destroyed tracked net worth chart');
            } catch (error) {
                console.warn('[Charts] Error destroying tracked net worth chart:', error);
            }
        }
        
        // Also destroy any charts Chart.js might be tracking
        try {
            const cashFlowChart = Chart.getChart('cashFlowChart');
            const expenseChart = Chart.getChart('expenseChart');
            const netWorthChart = Chart.getChart('netWorthChart');
            
            if (cashFlowChart && cashFlowChart !== activeChartInstances.cashFlow) {
                cashFlowChart.destroy();
                destroyedCount++;
                console.log('[Charts] Destroyed untracked cash flow chart');
            }
            
            if (expenseChart && expenseChart !== activeChartInstances.expense) {
                expenseChart.destroy();
                destroyedCount++;
                console.log('[Charts] Destroyed untracked expense chart');
            }
            
            if (netWorthChart && netWorthChart !== activeChartInstances.netWorth) {
                netWorthChart.destroy();
                destroyedCount++;
                console.log('[Charts] Destroyed untracked net worth chart');
            }
        } catch (error) {
            console.warn('[Charts] Error during Chart.js cleanup:', error);
        }
        
        console.log(`[Charts] Chart destruction complete. Destroyed ${destroyedCount} charts.`);
        return destroyedCount;
    }

    function initializeFinancialCharts(metrics, expenseData, currency) {
        // Clear any pending timeout
        if (chartInitTimeout) {
            clearTimeout(chartInitTimeout);
            chartInitTimeout = null;
        }
        
        // Debounce rapid calls with longer delay
        chartInitTimeout = setTimeout(() => {
            initializeFinancialChartsInternal(metrics, expenseData, currency);
        }, 200); // Increased debounce time
    }

    function initializeFinancialChartsInternal(metrics, expenseData, currency) {
        // Prevent multiple simultaneous initializations
        if (chartInitializationInProgress) {
            console.log('[Charts] Initialization already in progress, marking as pending...');
            chartInitializationPending = true;
            return;
        }

        chartInitializationInProgress = true;
        console.log('[Charts] Starting chart initialization...');
        
        // Check if Chart.js is available
        if (typeof Chart === 'undefined') {
            console.warn('[Charts] Chart.js not loaded yet, retrying in 200ms...');
            chartInitializationInProgress = false;
            setTimeout(() => initializeFinancialChartsInternal(metrics, expenseData, currency), 200);
            return;
        }

        // Check if required canvas elements exist
        const cashFlowCanvas = document.getElementById('cashFlowChart');
        const expenseCanvas = document.getElementById('expenseChart');
        const netWorthCanvas = document.getElementById('netWorthChart');
        
        if (!cashFlowCanvas || !expenseCanvas || !netWorthCanvas) {
            console.warn('[Charts] Canvas elements not ready yet, retrying in 100ms...');
            chartInitializationInProgress = false;
            setTimeout(() => initializeFinancialChartsInternal(metrics, expenseData, currency), 100);
            return;
        }

        // Destroy existing charts with proper delay
        const destroyedCount = destroyAllCharts();
        
        // Wait longer before creating new charts to ensure destruction is complete
        const delay = destroyedCount > 0 ? 150 : 50;
        setTimeout(() => {
            createCharts(metrics, expenseData, currency);
        }, delay);
    }

    function createCharts(metrics, expenseData, currency) {
        console.log('[Charts] Creating new charts...');
        const cashFlowCanvas = document.getElementById('cashFlowChart');
        const expenseCanvas = document.getElementById('expenseChart');
        const netWorthCanvas = document.getElementById('netWorthChart');

        // Verify canvas elements are still available and clean
        if (!cashFlowCanvas || !expenseCanvas || !netWorthCanvas) {
            console.error('[Charts] Canvas elements missing during creation');
            chartInitializationInProgress = false;
            return;
        }

        // Clear any existing 2D contexts
        try {
            cashFlowCanvas.getContext('2d').clearRect(0, 0, cashFlowCanvas.width, cashFlowCanvas.height);
            expenseCanvas.getContext('2d').clearRect(0, 0, expenseCanvas.width, expenseCanvas.height);
            netWorthCanvas.getContext('2d').clearRect(0, 0, netWorthCanvas.width, netWorthCanvas.height);
        } catch (error) {
            console.warn('[Charts] Error clearing canvas contexts:', error);
        }

        // Cash Flow Waterfall Chart
        const cashFlowCtx = cashFlowCanvas.getContext('2d');
        if (cashFlowCtx) {
            try {
                activeChartInstances.cashFlow = new Chart(cashFlowCtx, {
                type: 'bar',
                data: {
                    labels: ['Gross Income', 'Taxes', 'Contributions', 'Expenses', 'Net Cash Flow'],
                    datasets: [{
                        label: 'Cash Flow Analysis',
                        data: [
                            metrics.annualIncome,
                            -metrics.totalTaxes,
                            -metrics.totalContributions,
                            -metrics.annualExpenses,
                            metrics.annualIncome - metrics.totalTaxes - metrics.totalContributions - metrics.annualExpenses
                        ],
                        backgroundColor: [
                            '#10b981',
                            '#ef4444',
                            '#f59e0b',
                            '#ef4444',
                            metrics.annualIncome - metrics.totalTaxes - metrics.totalContributions - metrics.annualExpenses >= 0 ? '#10b981' : '#ef4444'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cash Flow Waterfall Analysis'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return currency + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            console.log('[Charts] ✅ Cash flow chart created successfully');
            } catch (error) {
                console.error('[Charts] ❌ Error creating cash flow chart:', error);
                activeChartInstances.cashFlow = null;
            }
        }

        // Expense Breakdown Pie Chart
        const expenseCtx = expenseCanvas.getContext('2d');
        if (expenseCtx) {
            try {
                activeChartInstances.expense = new Chart(expenseCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expenseData).map(key => key.charAt(0).toUpperCase() + key.slice(1)),
                    datasets: [{
                        data: Object.values(expenseData),
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#10b981', '#3b82f6',
                            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Expense Breakdown by Category'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            console.log('[Charts] ✅ Expense chart created successfully');
            } catch (error) {
                console.error('[Charts] ❌ Error creating expense chart:', error);
                activeChartInstances.expense = null;
            }
        }

        // Net Worth Composition Chart
        const netWorthCtx = netWorthCanvas.getContext('2d');
        if (netWorthCtx) {
            try {
                activeChartInstances.netWorth = new Chart(netWorthCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Assets', 'Liabilities'],
                    datasets: [{
                        data: [metrics.assets, metrics.liabilities],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Net Worth Composition'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            console.log('[Charts] ✅ Net worth chart created successfully');
            } catch (error) {
                console.error('[Charts] ❌ Error creating net worth chart:', error);
                activeChartInstances.netWorth = null;
            }
        }
        
        // Mark initialization as complete
        chartInitializationInProgress = false;
        console.log('[Charts] Chart initialization completed successfully');
        
        // Check if we need to reinitialize due to pending requests
        if (chartInitializationPending) {
            chartInitializationPending = false;
            console.log('[Charts] Reinitializing charts due to pending request...');
            setTimeout(() => initializeFinancialChartsInternal(metrics, expenseData, currency), 300);
        }
    }

    function setupInteractiveControls(metrics, currency) {
        const incomeSlider = document.getElementById('incomeSlider');
        const expenseSlider = document.getElementById('expenseSlider');
        const incomeValue = document.getElementById('incomeValue');
        const expenseValue = document.getElementById('expenseValue');
        const newNetCashFlow = document.getElementById('newNetCashFlow');
        const newSavingsRate = document.getElementById('newSavingsRate');

        if (incomeSlider && expenseSlider) {
            function updateScenario() {
                const incomeMultiplier = parseFloat(incomeSlider.value) / 100;
                const expenseMultiplier = parseFloat(expenseSlider.value) / 100;
                
                const adjustedIncome = metrics.annualIncome * incomeMultiplier;
                const adjustedExpenses = metrics.annualExpenses * expenseMultiplier;
                const adjustedNetCashFlow = adjustedIncome - adjustedExpenses - metrics.totalTaxes - metrics.totalContributions;
                const adjustedSavingsRate = adjustedIncome > 0 ? (adjustedNetCashFlow / adjustedIncome) * 100 : 0;
                
                incomeValue.textContent = `${(incomeMultiplier * 100 - 100).toFixed(0)}%`;
                expenseValue.textContent = `${(expenseMultiplier * 100 - 100).toFixed(0)}%`;
                newNetCashFlow.textContent = `${currency}${adjustedNetCashFlow.toLocaleString()}`;
                newSavingsRate.textContent = `${adjustedSavingsRate.toFixed(1)}%`;
                
                // Update color based on result
                newNetCashFlow.style.color = adjustedNetCashFlow >= 0 ? '#10b981' : '#ef4444';
            }
            
            incomeSlider.addEventListener('input', updateScenario);
            expenseSlider.addEventListener('input', updateScenario);
            
            // Initialize
            updateScenario();
        }
    }

    // Load data and display
    if (outputData) {
        try {
            const incomeAnalysis = JSON.parse(decodeURIComponent(outputData));
            const outputSpan = document.getElementById('output-span');
            outputSpan.innerHTML = '';
            displayEnhancedIncomeAnalysis(incomeAnalysis, outputSpan);
        } catch (error) {
            console.error('Error parsing output data:', error);
            const outputSpan = document.getElementById('output-span');
            outputSpan.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Error loading income analysis. Please try again.</div>';
        }
    } else {
        // Get data from localStorage using the FormPersistence pattern
        const responseKey = 'incomeIqResponse';
        const storedResponse = getLocal(responseKey);
        if (storedResponse) {
            try {
                let responseData = JSON.parse(storedResponse);
                
                // Handle the worker response format - check if it's nested in a response object
                if (responseData && responseData.message === 'Success' && responseData.data) {
                    responseData = responseData.data;
                }
                
                console.log('Found stored income response:', responseData);
                
                // Create a mock incomeAnalysis object from the worker response data
                const incomeAnalysis = {
                    summary: responseData.calculation_summary || "Financial analysis completed",
                    financial_summary: responseData.calculation_summary,
                    total_taxes_calculated: responseData.total_taxes || 0,
                    total_contributions_calculated: responseData.total_contributions || 0,
                    tax_treatment_details: responseData.tax_treatment_details || {},
                    assumptions_made: responseData.assumptions_made || [],
                    taxable_income_total: responseData.taxable_income_total || 0,
                    recommendations: "Based on your income and tax situation, consider consulting with a financial advisor for personalized recommendations.",
                    insights: "Your tax calculations have been completed. Review the financial metrics below for a comprehensive overview of your financial health."
                };
                
                const outputSpan = document.getElementById('output-span');
                outputSpan.innerHTML = '';
                displayEnhancedIncomeAnalysis(incomeAnalysis, outputSpan);
            } catch (error) {
                console.error('Error parsing stored response:', error);
                const outputSpan = document.getElementById('output-span');
                outputSpan.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Error loading stored income data. Please try again.</div>';
            }
        } else {
            // No data found, show empty content for dataout.js to handle
            const outputSpan = document.getElementById('output-span');
            outputSpan.innerHTML = '';
        }
    }

    function displayEnhancedIncomeAnalysis(incomeData, outputElement) {
      outputElement.innerHTML = '';
      outputElement.classList.add('income-display');
      
      const container = document.createElement('div');
      container.style.cssText = 'max-width: 1200px; margin: 0 auto; font-family: "Inter", sans-serif; padding: 20px;';
      
      // Load all data from localStorage and perform calculations
      const currencySymbol = getCurrentCurrencySymbol();
      
      // Load normalized income and expenses data
      const storedIncomeData = JSON.parse(getLocal('incomeIqinput1') || '{}');
      const expenseData = JSON.parse(getLocal('incomeIqInput2') || '{}');
      const assetsData = JSON.parse(getLocal('incomeIqAssets') || '{}');
      const liabilitiesData = JSON.parse(getLocal('incomeIqLiabilities') || '{}');
      
      // Debug logging
      console.log('Debug - localStorage data:');
      console.log('storedIncomeData:', storedIncomeData);
      console.log('expenseData:', expenseData);
      console.log('assetsData:', assetsData);
      console.log('liabilitiesData:', liabilitiesData);
      
      // Calculate totals from normalized data
      const normalizedIncome = storedIncomeData.incomeData || {};
      const normalizedExpenses = expenseData.expenseData || {};
      
      console.log('normalizedIncome:', normalizedIncome);
      console.log('normalizedExpenses:', normalizedExpenses);
      
      const totalAnnualIncome = Object.values(normalizedIncome).reduce((sum, value) => sum + (parseFloat(value) || 0), 0);
      const totalAnnualExpenses = Object.values(normalizedExpenses).reduce((sum, value) => sum + (parseFloat(value) || 0), 0);
      const totalAssets = Object.values(assetsData).reduce((sum, value) => sum + (parseFloat(value) || 0), 0);
      const totalLiabilities = Object.values(liabilitiesData).reduce((sum, value) => sum + (parseFloat(value) || 0), 0);
      
      // Fallback to legacy localStorage keys if new keys are empty
      let finalAnnualExpenses = totalAnnualExpenses;
      if (totalAnnualExpenses === 0) {
        const legacyExpenses = JSON.parse(getLocal('incomeIqExpense') || '{}');
        finalAnnualExpenses = Object.values(legacyExpenses).reduce((sum, value) => sum + (parseFloat(value) || 0), 0);
        console.log('Using legacy expenses:', legacyExpenses, 'Total:', finalAnnualExpenses);
      }
      
      // Get taxes and contributions from worker response
      const workerResponse = JSON.parse(getLocal('incomeIqResponse') || '{}');
      let totalTaxes = 0;
      let totalContributions = 0;
      
      if (workerResponse && workerResponse.message === 'Success' && workerResponse.data) {
        totalTaxes = workerResponse.data.total_taxes || 0;
        totalContributions = workerResponse.data.total_contributions || 0;
      } else if (workerResponse && workerResponse.total_taxes) {
        // Direct format
        totalTaxes = workerResponse.total_taxes || 0;
        totalContributions = workerResponse.total_contributions || 0;
      }
      
      // Also check incomeData parameter for backward compatibility
      if (incomeData && incomeData.total_taxes_calculated) {
        totalTaxes = incomeData.total_taxes_calculated;
        totalContributions = incomeData.total_contributions_calculated || 0;
      }
      
      console.log('Calculated totals:');
      console.log('totalAnnualIncome:', totalAnnualIncome);
      console.log('finalAnnualExpenses:', finalAnnualExpenses);
      console.log('totalAssets:', totalAssets);
      console.log('totalLiabilities:', totalLiabilities);
      console.log('totalTaxes:', totalTaxes);
      console.log('totalContributions:', totalContributions);
      console.log('netCashFlow calculation:', totalAnnualIncome, '-', totalTaxes, '-', totalContributions, '-', finalAnnualExpenses, '=', (totalAnnualIncome - totalTaxes - totalContributions - finalAnnualExpenses));
      console.log('netWorth calculation:', totalAssets, '-', totalLiabilities, '=', (totalAssets - totalLiabilities));
      
      // Calculate net cash flow: income - taxes - contributions - expenses
      const netCashFlow = totalAnnualIncome - totalTaxes - totalContributions - finalAnnualExpenses;
      const netWorth = totalAssets - totalLiabilities;
      
      // Calculate key ratios
      const debtToIncome = totalAnnualIncome > 0 ? totalLiabilities / totalAnnualIncome : 0;
      const savingsRate = totalAnnualIncome > 0 ? netCashFlow / totalAnnualIncome : 0;
      const fireTarget = finalAnnualExpenses * 25; // 4% rule
      const fireRatio = fireTarget > 0 ? totalAssets / fireTarget : 0;
      
      // Calculate housing expenses for housing-to-income ratio
      const normalizedExpensesForHousing = finalAnnualExpenses > 0 ? normalizedExpenses : JSON.parse(getLocal('incomeIqExpense') || '{}');
      const housingExpenses = Object.entries(normalizedExpensesForHousing)
        .filter(([key]) => key.includes('housing'))
        .reduce((sum, [, value]) => sum + (parseFloat(value) || 0), 0);
      const housingToIncome = totalAnnualIncome > 0 ? housingExpenses / totalAnnualIncome : 0;
      
      // Calculate savings to debt ratio
      const savingsToDebt = totalLiabilities > 0 ? totalAssets / totalLiabilities : (totalAssets > 0 ? 999 : 0);
      
      const financialMetrics = {
        totalTaxes,
        totalContributions,
        annualIncome: totalAnnualIncome,
        annualExpenses: finalAnnualExpenses,
        netCashFlow,
        assets: totalAssets,
        liabilities: totalLiabilities,
        netWorth,
        debtToIncome,
        fireRatio,
        housingToIncome,
        savingsRate,
        savingsToDebt
      };
      
      console.log('Calculated financial metrics:', financialMetrics);
      
      // Calculate additional metrics
      const healthScore = calculateFinancialHealthScore(financialMetrics, netCashFlow, savingsRate);
      
      // Header with AI branding
      const header = document.createElement('div');
      header.innerHTML = `
        <div style="text-align: center; margin-bottom: 30px;">
          <h1 style="font-size: 2.5em; color: #1f2937; margin-bottom: 10px; font-weight: 700;">
            <i class="fas fa-brain" style="margin-right: 12px; color: #4f46e5;"></i>
            IncomeIQ™ Financial Dashboard
          </h1>
          <div style="font-size: 1.1em; color: #6b7280; margin-bottom: 20px;">
            AI-powered financial analysis and insights
          </div>
          <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 12px 24px; border-radius: 8px; display: inline-block; font-size: 0.9em;">
            <i class="fas fa-shield-alt" style="margin-right: 8px;"></i>
            Educational purposes only • Consult professionals for major decisions
          </div>
        </div>
      `;
      container.appendChild(header);

      // Financial Health Score Section
      const healthContainer = document.createElement('div');
      healthContainer.className = 'dashboard-card';
      healthContainer.style.cssText = 'margin-bottom: 30px; text-align: center; background: linear-gradient(135deg, #f8fafc, #e2e8f0);';
      
      healthContainer.innerHTML = `
        <h3><i class="fas fa-heartbeat"></i>Financial Health Score</h3>
        <div class="health-score-container">
          <div class="health-score-circle">
            <div class="health-score-inner">
              ${healthScore}
            </div>
          </div>
          <div style="font-size: 1.1em; color: #374151; margin-bottom: 8px; font-weight: 500;">
            ${healthScore >= 85 ? 'Excellent' : healthScore >= 70 ? 'Good' : healthScore >= 55 ? 'Fair' : healthScore >= 40 ? 'Below Average' : 'Poor'}
          </div>
          <div style="font-size: 0.9em; color: #6b7280; max-width: 300px; margin: 0 auto;">
            ${getHealthScoreDescription(healthScore)}
          </div>
        </div>
      `;
      container.appendChild(healthContainer);

      // Key Metrics Dashboard Grid
      const metricsGrid = document.createElement('div');
      metricsGrid.className = 'dashboard-grid';
      metricsGrid.style.cssText = 'margin-bottom: 30px;';
      
      // Add calculated tax data if available
      const taxesCalculated = totalTaxes;
      const contributionsCalculated = totalContributions;
      const adjustedNetCashFlow = netCashFlow; // netCashFlow already has taxes and contributions subtracted
      
      metricsGrid.innerHTML = `
        <div class="dashboard-card">
          <h3><i class="fas fa-dollar-sign"></i>Annual Income</h3>
          <div class="metric-card positive">
            <div class="metric-label">Gross Income</div>
            <div class="metric-value">${currencySymbol}${financialMetrics.annualIncome.toLocaleString()}</div>
          </div>
        </div>
        
        <div class="dashboard-card">
          <h3><i class="fas fa-receipt"></i>Calculated Taxes</h3>
          <div class="metric-card ${taxesCalculated > 0 ? 'negative' : 'warning'}">
            <div class="metric-label">AI Estimated Taxes</div>
            <div class="metric-value">${currencySymbol}${taxesCalculated.toLocaleString()}</div>
            <div class="metric-description">Educational estimate only</div>
          </div>
        </div>
        
        <div class="dashboard-card">
          <h3><i class="fas fa-hands-helping"></i>Contributions</h3>
          <div class="metric-card ${contributionsCalculated > 0 ? 'warning' : 'positive'}">
            <div class="metric-label">Social Security & Benefits</div>
            <div class="metric-value">${currencySymbol}${contributionsCalculated.toLocaleString()}</div>
            <div class="metric-description">Mandatory contributions</div>
          </div>
        </div>
        
        <div class="dashboard-card">
          <h3><i class="fas fa-shopping-cart"></i>Annual Expenses</h3>
          <div class="metric-card negative">
            <div class="metric-label">Total Expenses</div>
            <div class="metric-value">${currencySymbol}${financialMetrics.annualExpenses.toLocaleString()}</div>
          </div>
        </div>
        
        <div class="dashboard-card">
          <h3><i class="fas fa-chart-line"></i>Net Cash Flow</h3>
          <div class="metric-card ${adjustedNetCashFlow >= 0 ? 'positive' : 'negative'}">
            <div class="metric-label">After taxes & expenses</div>
            <div class="metric-value">${currencySymbol}${adjustedNetCashFlow.toLocaleString()}</div>
            <div class="metric-description">${adjustedNetCashFlow >= 0 ? 'Surplus' : 'Deficit'}</div>
          </div>
        </div>
        
        <div class="dashboard-card">
          <h3><i class="fas fa-piggy-bank"></i>Savings Rate</h3>
          <div class="metric-card ${savingsRate >= 0.15 ? 'positive' : savingsRate >= 0.05 ? 'warning' : 'negative'}">
            <div class="metric-label">Annual Savings</div>
            <div class="metric-value">${(savingsRate * 100).toFixed(1)}%</div>
            <div class="metric-description">
              ${savingsRate >= 0.20 ? 'Excellent' : savingsRate >= 0.15 ? 'Great' : savingsRate >= 0.10 ? 'Good' : savingsRate >= 0.05 ? 'Fair' : 'Low'}
            </div>
          </div>
        </div>
        
        <div class="dashboard-card">
          <h3><i class="fas fa-balance-scale"></i>Net Worth</h3>
          <div class="metric-card ${financialMetrics.netWorth >= 0 ? 'positive' : 'negative'}">
            <div class="metric-label">Assets - Liabilities</div>
            <div class="metric-value">${currencySymbol}${financialMetrics.netWorth.toLocaleString()}</div>
            <div class="metric-description">
              Assets: ${currencySymbol}${financialMetrics.assets.toLocaleString()}<br>
              Liabilities: ${currencySymbol}${financialMetrics.liabilities.toLocaleString()}
            </div>
          </div>
        </div>
        
        <div class="dashboard-card">
          <h3><i class="fas fa-fire"></i>FIRE Progress</h3>
          <div class="metric-card ${financialMetrics.fireRatio >= 0.25 ? 'positive' : financialMetrics.fireRatio >= 0.1 ? 'warning' : 'negative'}">
            <div class="metric-label">Financial Independence</div>
            <div class="metric-value">${(financialMetrics.fireRatio * 100).toFixed(1)}%</div>
            <div class="progress-container">
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${Math.min(100, financialMetrics.fireRatio * 100)}%"></div>
                <div class="progress-text">${Math.min(100, financialMetrics.fireRatio * 100).toFixed(0)}%</div>
              </div>
            </div>
            <div class="metric-description" style="margin-top: 8px; font-size: 0.8em;">
              ${getFireTimelineEstimate(financialMetrics.fireRatio, savingsRate)}
            </div>
          </div>
        </div>
      `;
      container.appendChild(metricsGrid);

      // Interactive Charts Section
      const chartsSection = document.createElement('div');
      chartsSection.innerHTML = `
        <h2 style="text-align: center; margin: 40px 0 30px 0; color: #1f2937; font-size: 1.8em;">
          <i class="fas fa-chart-bar" style="margin-right: 12px; color: #4f46e5;"></i>
          Interactive Financial Analysis
        </h2>
        
        <div class="chart-grid">
          <div class="chart-container">
            <canvas id="cashFlowChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="expenseChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="netWorthChart"></canvas>
          </div>
        </div>
      `;
      container.appendChild(chartsSection);

      // What-If Scenario Modeling
      const scenarioSection = document.createElement('div');
      scenarioSection.innerHTML = `
        <h2 style="text-align: center; margin: 40px 0 30px 0; color: #1f2937; font-size: 1.8em;">
          <i class="fas fa-sliders-h" style="margin-right: 12px; color: #4f46e5;"></i>
          What-If Scenario Modeling
        </h2>
        
        <div class="controls-section">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
            <div class="control-group">
              <label class="control-label">
                <i class="fas fa-arrow-up" style="color: #10b981; margin-right: 8px;"></i>
                Income Adjustment: <span id="incomeValue" class="range-value">0%</span>
              </label>
              <input type="range" id="incomeSlider" class="range-slider" min="50" max="150" value="100" step="5">
              <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #6b7280; margin-top: 4px;">
                <span>-50%</span>
                <span>+50%</span>
              </div>
            </div>
            
            <div class="control-group">
              <label class="control-label">
                <i class="fas fa-arrow-down" style="color: #ef4444; margin-right: 8px;"></i>
                Expense Adjustment: <span id="expenseValue" class="range-value">0%</span>
              </label>
              <input type="range" id="expenseSlider" class="range-slider" min="50" max="150" value="100" step="5">
              <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #6b7280; margin-top: 4px;">
                <span>-50%</span>
                <span>+50%</span>
              </div>
            </div>
          </div>
          
          <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
            <h4 style="margin: 0 0 16px 0; color: #1f2937; font-size: 1.2em;">
              <i class="fas fa-calculator" style="margin-right: 8px; color: #4f46e5;"></i>
              Projected Results
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
              <div style="text-align: center;">
                <div style="font-size: 0.9em; color: #6b7280; margin-bottom: 4px;">New Net Cash Flow</div>
                <div id="newNetCashFlow" style="font-size: 1.4em; font-weight: 700;">${currencySymbol}${netCashFlow.toLocaleString()}</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 0.9em; color: #6b7280; margin-bottom: 4px;">New Savings Rate</div>
                <div id="newSavingsRate" style="font-size: 1.4em; font-weight: 700; color: #4f46e5;">${(savingsRate * 100).toFixed(1)}%</div>
              </div>
            </div>
          </div>
        </div>
      `;
      container.appendChild(scenarioSection);

      // Financial Ratios Analysis
      const ratiosSection = document.createElement('div');
      ratiosSection.innerHTML = `
        <h2 style="text-align: center; margin: 40px 0 30px 0; color: #1f2937; font-size: 1.8em;">
          <i class="fas fa-calculator" style="margin-right: 12px; color: #4f46e5;"></i>
          Financial Ratios Analysis
        </h2>
        
        <div class="dashboard-grid">
          <div class="dashboard-card">
            <h3><i class="fas fa-percentage"></i>Debt to Income</h3>
            <div class="metric-card ${financialMetrics.debtToIncome <= 0.20 ? 'positive' : financialMetrics.debtToIncome <= 0.36 ? 'warning' : 'negative'}">
              <div class="metric-label">Monthly Debt / Monthly Income</div>
              <div class="metric-value">${(financialMetrics.debtToIncome * 100).toFixed(1)}%</div>
              <div class="metric-description">
                ${financialMetrics.debtToIncome <= 0.20 ? 'Excellent - Low risk' : 
                  financialMetrics.debtToIncome <= 0.36 ? 'Acceptable - Monitor' : 
                  'High risk - Action needed'}
              </div>
            </div>
          </div>
          
          <div class="dashboard-card">
            <h3><i class="fas fa-home"></i>Housing Ratio</h3>
            <div class="metric-card ${financialMetrics.housingToIncome <= 0.28 ? 'positive' : financialMetrics.housingToIncome <= 0.35 ? 'warning' : 'negative'}">
              <div class="metric-label">Housing Costs / Income</div>
              <div class="metric-value">${(financialMetrics.housingToIncome * 100).toFixed(1)}%</div>
              <div class="metric-description">
                ${financialMetrics.housingToIncome <= 0.28 ? 'Affordable' : 
                  financialMetrics.housingToIncome <= 0.35 ? 'Manageable' : 
                  'Housing burden high'}
              </div>
            </div>
          </div>
          
          <div class="dashboard-card">
            <h3><i class="fas fa-shield-alt"></i>Savings to Debt</h3>
            <div class="metric-card ${financialMetrics.savingsToDebt >= 2.0 ? 'positive' : financialMetrics.savingsToDebt >= 1.0 ? 'warning' : 'negative'}">
              <div class="metric-label">Savings / Total Debt</div>
              <div class="metric-value">${financialMetrics.savingsToDebt.toFixed(2)}</div>
              <div class="metric-description">
                ${financialMetrics.savingsToDebt >= 2.0 ? 'Strong buffer' : 
                  financialMetrics.savingsToDebt >= 1.0 ? 'Adequate coverage' : 
                  'Build emergency fund'}
              </div>
            </div>
          </div>
        </div>
      `;
      container.appendChild(ratiosSection);

      // AI Analysis Sections
      if (incomeData.summary || incomeData.financial_summary) {
        const summarySection = document.createElement('div');
        summarySection.className = 'dashboard-card';
        summarySection.style.cssText = 'margin: 30px 0; background: linear-gradient(135deg, #ecfdf5, #f0fdf4);';
        
        summarySection.innerHTML = `
          <h3><i class="fas fa-robot"></i>AI Financial Summary</h3>
          <div style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #10b981;">
            <p style="margin: 0; line-height: 1.8; font-size: 1.05em; color: #374151;">
              ${incomeData.summary || incomeData.financial_summary}
            </p>
          </div>
        `;
        container.appendChild(summarySection);
      }

      // Tax Treatment Transparency Section
      if (incomeData.tax_treatment_details || incomeData.assumptions_made || incomeData.taxable_income_total) {
        const transparencySection = document.createElement('div');
        transparencySection.className = 'dashboard-card';
        transparencySection.style.cssText = 'margin: 30px 0; background: linear-gradient(135deg, #f0f9ff, #e0f2fe);';
        
        let transparencyContent = `
          <h3><i class="fas fa-eye"></i>Tax Calculation Transparency</h3>
          <div style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #3b82f6;">
        `;
        
        // Taxable Income Total
        if (incomeData.taxable_income_total > 0) {
          transparencyContent += `
            <div style="margin-bottom: 15px;">
              <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 1.1em;">
                <i class="fas fa-calculator" style="margin-right: 8px; color: #3b82f6;"></i>
                Taxable Income Used
              </h4>
              <p style="margin: 0; color: #4b5563; font-size: 1.05em;">
                <strong>${currencySymbol}${incomeData.taxable_income_total.toLocaleString()}</strong> 
                (This is the amount used for tax calculations)
              </p>
            </div>
          `;
        }
        
        // Tax Treatment Details
        if (incomeData.tax_treatment_details && Object.keys(incomeData.tax_treatment_details).length > 0) {
          transparencyContent += `
            <div style="margin-bottom: 15px;">
              <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 1.1em;">
                <i class="fas fa-list-ul" style="margin-right: 8px; color: #3b82f6;"></i>
                Special Income Treatment
              </h4>
          `;
          
          Object.entries(incomeData.tax_treatment_details).forEach(([key, value]) => {
            transparencyContent += `
              <p style="margin: 8px 0; color: #4b5563; font-size: 0.95em; line-height: 1.6;">
                <strong>${key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ')}:</strong> ${value}
              </p>
            `;
          });
          
          transparencyContent += `</div>`;
        }
        
        // Assumptions Made
        if (incomeData.assumptions_made && incomeData.assumptions_made.length > 0) {
          transparencyContent += `
            <div>
              <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 1.1em;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 8px; color: #f59e0b;"></i>
                Key Assumptions Made
              </h4>
              <ul style="margin: 0; padding-left: 20px; color: #4b5563;">
          `;
          
          incomeData.assumptions_made.forEach(assumption => {
            transparencyContent += `<li style="margin: 4px 0; line-height: 1.6;">${assumption}</li>`;
          });
          
          transparencyContent += `
              </ul>
            </div>
          `;
        }
        
        transparencyContent += `
          </div>
        `;
        
        transparencySection.innerHTML = transparencyContent;
        container.appendChild(transparencySection);
      }

      // Recommendations Section
      if (incomeData.recommendations || incomeData.advice) {
        const recommendationsSection = document.createElement('div');
        recommendationsSection.className = 'dashboard-card';
        recommendationsSection.style.cssText = 'margin: 30px 0; background: linear-gradient(135deg, #fffbeb, #fef3c7);';
        
        recommendationsSection.innerHTML = `
          <h3><i class="fas fa-lightbulb"></i>AI Recommendations</h3>
          <div style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <p style="margin: 0; line-height: 1.8; font-size: 1.05em; color: #374151;">
              ${incomeData.recommendations || incomeData.advice}
            </p>
          </div>
        `;
        container.appendChild(recommendationsSection);
      }

      // Additional Analysis Sections
      const analysisData = [
        { key: 'income_analysis', title: 'Income Analysis', icon: 'fas fa-money-bill-wave', color: '#10b981' },
        { key: 'expense_analysis', title: 'Expense Analysis', icon: 'fas fa-shopping-cart', color: '#ef4444' },
        { key: 'networth_analysis', title: 'Net Worth Analysis', icon: 'fas fa-chart-pie', color: '#3b82f6' },
        { key: 'insights', title: 'Key Insights', icon: 'fas fa-eye', color: '#8b5cf6' },
        { key: 'action_items', title: 'Action Items', icon: 'fas fa-tasks', color: '#06b6d4' }
      ];

      analysisData.forEach(section => {
        if (incomeData[section.key]) {
          const sectionElement = document.createElement('div');
          sectionElement.className = 'dashboard-card';
          sectionElement.style.cssText = 'margin: 20px 0;';
          
          sectionElement.innerHTML = `
            <h3><i class="${section.icon}" style="color: ${section.color};"></i>${section.title}</h3>
            <div style="padding: 20px; background: #f8fafc; border-radius: 8px; border-left: 4px solid ${section.color};">
              <p style="margin: 0; line-height: 1.8; font-size: 1.05em; color: #374151;">
                ${incomeData[section.key]}
              </p>
            </div>
          `;
          container.appendChild(sectionElement);
        }
      });

      // Footer with methodology
      const footer = document.createElement('div');
      footer.innerHTML = `
        <div style="margin: 40px 0 20px 0; padding: 20px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;">
          <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 1.1em;">
            <i class="fas fa-info-circle" style="margin-right: 8px; color: #6b7280;"></i>
            Analysis Methodology
          </h4>
          <p style="margin: 0; color: #6b7280; font-size: 0.95em; line-height: 1.6;">
            This analysis uses advanced AI algorithms and industry-standard financial metrics to evaluate your financial health. 
            The health score considers cash flow, debt ratios, savings rate, net worth, and FIRE progress. All recommendations 
            are for educational purposes and should not replace professional financial advice.
          </p>
        </div>
      `;
      container.appendChild(footer);
      
      outputElement.appendChild(container);
      
      // Initialize charts and controls after DOM is ready
      setTimeout(() => {
        const expenseData = getExpenseBreakdown();
        initializeFinancialCharts(financialMetrics, expenseData, currencySymbol);
        setupInteractiveControls(financialMetrics, currencySymbol);
      }, 100);
    }

    // Listen for dashboard update events from the form
    document.addEventListener('dashboard-update-needed', function(event) {
        const updateAllMetrics = event.detail.updateAllMetrics;
        console.log('[IncomeOutput] Dashboard update requested, updateAllMetrics:', updateAllMetrics);
        
        // Force destroy any existing charts before refreshing dashboard
        console.log('[IncomeOutput] Destroying charts for dashboard refresh...');
        destroyAllCharts();
        
        // Re-run the display function to refresh the dashboard
        const outputSpan = document.getElementById('output-span');
        if (outputSpan) {
            // Get fresh data from localStorage
            const responseKey = 'incomeIqResponse';
            const storedResponse = getLocal(responseKey);
            
            if (storedResponse) {
                try {
                    let responseData = JSON.parse(storedResponse);
                    
                    // Handle the worker response format
                    if (responseData && responseData.message === 'Success' && responseData.data) {
                        responseData = responseData.data;
                    }
                    
                    // Create analysis object
                    const incomeAnalysis = {
                        summary: responseData.calculation_summary || "Financial analysis completed",
                        financial_summary: responseData.calculation_summary,
                        total_taxes_calculated: responseData.total_taxes || 0,
                        total_contributions_calculated: responseData.total_contributions || 0,
                        tax_treatment_details: responseData.tax_treatment_details || {},
                        assumptions_made: responseData.assumptions_made || [],
                        taxable_income_total: responseData.taxable_income_total || 0,
                        recommendations: "Based on your income and tax situation, consider consulting with a financial advisor for personalized recommendations.",
                        insights: "Your tax calculations have been completed. Review the financial metrics below for a comprehensive overview of your financial health."
                    };
                    
                    outputSpan.innerHTML = '';
                    displayEnhancedIncomeAnalysis(incomeAnalysis, outputSpan);
                    
                } catch (error) {
                    console.error('Error refreshing dashboard:', error);
                }
            }
        }
    });

    // Check if tax calculations are stale on load
    function checkTaxCalculationsStale() {
        const isStale = localStorage.getItem('taxCalculationsStale') === 'true';
        const staleTimestamp = localStorage.getItem('taxCalculationsStaleTimestamp');
        
        if (isStale && staleTimestamp) {
            // Check if there's an existing AI response - only show warning if user has already completed the form
            const existingResponse = localStorage.getItem('incomeIqResponse');
            if (!existingResponse) {
                console.log(`[IncomeOutput] ℹ️ No existing AI response found, skipping stale tax calculations warning`);
                return;
            }
            
            const staleTime = new Date(parseInt(staleTimestamp));
            const now = new Date();
            const minutesStale = Math.floor((now - staleTime) / (1000 * 60));
            
            console.log(`[IncomeOutput] Tax calculations are ${minutesStale} minutes stale`);
            showStaleWarning(minutesStale);
        }
    }

    function showStaleWarning(minutesStale) {
        // Add a warning banner to the dashboard
        const outputSpan = document.getElementById('output-span');
        if (outputSpan && outputSpan.querySelector('.stale-warning') === null) {
            const warningBanner = document.createElement('div');
            warningBanner.className = 'stale-warning';
            warningBanner.style.cssText = `
                background: linear-gradient(135deg, #fef3c7, #fcd34d);
                border: 2px solid #f59e0b;
                border-radius: 12px;
                padding: 15px 20px;
                margin: 20px 0;
                text-align: center;
                font-family: "Inter", sans-serif;
            `;
            
            warningBanner.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 1.5em;"></i>
                    <div>
                        <h4 style="margin: 0; color: #92400e; font-size: 1.1em;">Tax Calculations May Be Outdated</h4>
                        <p style="margin: 5px 0 0 0; color: #92400e; font-size: 0.95em;">
                            Income or tax residency changed ${minutesStale} minute${minutesStale !== 1 ? 's' : ''} ago. 
                            <strong>Generate the IncomeIQ report again to refresh tax calculations.</strong>
                        </p>
                    </div>
                </div>
            `;
            
            outputSpan.insertBefore(warningBanner, outputSpan.firstChild);
        }
    }

    // Check for stale calculations when dashboard loads
    setTimeout(checkTaxCalculationsStale, 500);
    
})();
</script>
</body>
</html>
