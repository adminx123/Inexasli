<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Enneagram Analysis - INEXASLI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles/outputstyles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="../../utility/enhancedUI.js"></script>
  <style>
    /* Using standard device-container from outputstyles.css as .enneagram-container */
    
    .enneagram-header {
      font-size: 22px;
      font-weight: 600;
      margin: 0;
      color: #222;
      font-family: "Playfair Display", serif;
      padding: 20px 15px;
      border-bottom: 1px solid #eee;
      text-align: center;
      width: 100%;
      box-sizing: border-box;
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    /* Custom styles for enneagram output */
    .api-output {
      white-space: normal;
      background-color: #f9f9f9;
      padding: 0;
    }
    
    .enneagram-content {
      padding: 15px;
    }
    
    /* Card styles */
    .enneagram-card {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      overflow: hidden;
      transform: translateY(0);
      transition: all 0.3s ease;
      animation: fadeInUp 0.6s ease forwards;
    }
    
    .enneagram-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    
    .card-header {
      padding: 15px 20px;
      background: linear-gradient(135deg, #6e8efb, #a777e3);
      color: #fff;
    }
    
    .card-body {
      padding: 20px;
    }
    
    .card-title {
      font-family: "Playfair Display", serif;
      font-size: 20px;
      font-weight: 600;
      margin: 0;
      color: #fff;
    }
    
    .card-subtitle {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 5px;
      color: #fff;
    }
    
    /* Type number badge */
    .type-badge {
      display: inline-block;
      background-color: rgba(255,255,255,0.25);
      color: #fff;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    /* Lists */
    .traits-list {
      margin: 15px 0;
      padding-left: 0;
      list-style: none;
    }
    
    .traits-list li {
      padding: 10px 15px;
      margin-bottom: 8px;
      background-color: #f8f9fa;
      border-left: 3px solid #6e8efb;
      border-radius: 4px;
      font-size: 15px;
      line-height: 1.5;
    }
    
    /* Sections */
    .section-title {
      font-family: "Playfair Display", serif;
      font-size: 18px;
      color: #333;
      margin: 25px 0 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }
    
    .section-content {
      line-height: 1.6;
    }
    
    /* Growth opportunities */
    .growth-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .growth-item-icon {
      flex: 0 0 30px;
      height: 30px;
      background-color: #a777e3;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-weight: bold;
    }
    
    .growth-item-content {
      flex: 1;
    }
    
    /* Type-specific color schemes */
    .type-1 .card-header { background: linear-gradient(135deg, #FF5E62, #FF9966); }
    .type-2 .card-header { background: linear-gradient(135deg, #FC5C7D, #6A82FB); }
    .type-3 .card-header { background: linear-gradient(135deg, #FFCC70, #C850C0); }
    .type-4 .card-header { background: linear-gradient(135deg, #00B09B, #96C93D); }
    .type-5 .card-header { background: linear-gradient(135deg, #4568DC, #B06AB3); }
    .type-6 .card-header { background: linear-gradient(135deg, #3A1C71, #D76D77); }
    .type-7 .card-header { background: linear-gradient(135deg, #FDC830, #F37335); }
    .type-8 .card-header { background: linear-gradient(135deg, #ED213A, #93291E); }
    .type-9 .card-header { background: linear-gradient(135deg, #1A2980, #26D0CE); }
    
    /* Animation */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
    .delay-4 { animation-delay: 0.4s; }
    .delay-5 { animation-delay: 0.5s; }
    
    /* Footer */
    .enneagram-footer {
      text-align: center;
      margin-top: 30px;
      padding: 15px;
      font-size: 13px;
      color: #888;
    }
    
    /* Share button */
    .share-button {
      display: inline-block;
      background-color: #6e8efb;
      color: white;
      border: none;
      border-radius: 30px;
      padding: 10px 24px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(110,142,251,0.3);
      transition: all 0.3s ease;
      margin-top: 20px;
    }
    
    .share-button:hover {
      background-color: #5d7dea;
      box-shadow: 0 6px 12px rgba(110,142,251,0.4);
      transform: translateY(-2px);
    }
    
    /* Progress indicator */
    .progress-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 0%;
      height: 3px;
      background: linear-gradient(90deg, #6e8efb, #a777e3);
      z-index: 1000;
      transition: width 0.3s ease;
    }
    
    /* Floating action button */
    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #6e8efb, #a777e3);
      border-radius: 50%;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(110,142,251,0.4);
      transition: all 0.3s ease;
      z-index: 999;
    }
    
    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(110,142,251,0.6);
    }
    
    /* Tooltip styles */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 0;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    /* Enhanced card interactions */
    .enneagram-card.expanded {
      position: relative;
      z-index: 10;
    }
    
    /* Enhanced mobile optimizations */
    @media (max-width: 768px) {
      .enneagram-header h1 {
        font-size: 18px;
      }
      
      .card-title {
        font-size: 18px;
      }
      
      .section-title {
        font-size: 16px;
      }
      
      .share-button {
        padding: 8px 16px;
        font-size: 13px;
        margin: 5px;
        width: calc(50% - 10px);
        display: inline-block;
      }
      
      .fab {
        width: 48px;
        height: 48px;
        bottom: 16px;
        right: 16px;
        font-size: 18px;
      }
      
      .enneagram-card {
        margin-bottom: 15px;
        border-radius: 8px;
      }
      
      .card-body {
        padding: 15px;
      }
      
      .traits-list li {
        padding: 8px 12px;
        font-size: 14px;
      }
      
      .growth-item-icon {
        width: 25px;
        height: 25px;
        font-size: 12px;
      }
      
      .tooltip .tooltiptext {
        width: 80px;
        margin-left: -40px;
        font-size: 11px;
      }
    }
    
    @media (max-width: 480px) {
      .enneagram-content {
        padding: 10px;
      }
      
      .share-button {
        width: 100%;
        margin: 5px 0;
      }
      
      .card-header {
        padding: 12px 15px;
      }
      
      .type-badge {
        font-size: 12px;
        padding: 3px 10px;
      }
    }
    
    /* Print styles */
    @media print {
      .fab,
      .progress-bar,
      .skip-link {
        display: none !important;
      }
      
      .enneagram-card {
        break-inside: avoid;
        page-break-inside: avoid;
        margin-bottom: 15px;
        box-shadow: none;
        border: 1px solid #ddd;
      }
      
      .card-header {
        background: #f5f5f5 !important;
        color: #333 !important;
      }
      
      .share-button {
        display: none !important;
      }
    }
    
    /* Accessibility improvements */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: #000;
      color: #fff;
      padding: 8px;
      text-decoration: none;
      border-radius: 4px;
      z-index: 1002;
      font-size: 14px;
      transition: top 0.3s ease;
    }
    
    .skip-link:focus {
      top: 6px;
    }
    
    /* Enhanced focus styles for better accessibility */
    .enneagram-card:focus {
      outline: 2px solid #6e8efb;
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(110, 142, 251, 0.2);
    }
    
    .share-button:focus,
    .fab:focus {
      outline: 2px solid #fff;
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(110, 142, 251, 0.3);
    }
    
    /* Reduce motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {
      .enneagram-card {
        animation: none;
        transition: none;
      }
      
      .fab,
      .share-button {
        transition: none;
      }
      
      .progress-bar {
        transition: none;
      }
    }
    
    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .enneagram-card {
        border: 2px solid;
      }
      
      .card-header {
        background: #000 !important;
        color: #fff !important;
      }
    }
    
    /* Type-specific accent colors for elements */
    .type-1 .traits-list li { border-left-color: #FF5E62; }
    .type-2 .traits-list li { border-left-color: #FC5C7D; }
    .type-3 .traits-list li { border-left-color: #FFCC70; }
    .type-4 .traits-list li { border-left-color: #00B09B; }
    .type-5 .traits-list li { border-left-color: #4568DC; }
    .type-6 .traits-list li { border-left-color: #3A1C71; }
    .type-7 .traits-list li { border-left-color: #FDC830; }
    .type-8 .traits-list li { border-left-color: #ED213A; }
    .type-9 .traits-list li { border-left-color: #1A2980; }
    
    
    /* Success animation */
    .success-checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: block;
      stroke-width: 2;
      stroke: #4caf50;
      stroke-miterlimit: 10;
      margin: 10px auto;
      box-shadow: inset 0px 0px 0px #4caf50;
      animation: fill 0.4s ease-in-out 0.4s forwards, scale 0.3s ease-in-out 0.9s both;
    }
    
    .success-checkmark__circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 2;
      stroke-miterlimit: 10;
      stroke: #4caf50;
      fill: none;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    
    .success-checkmark__check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }
    
    @keyframes stroke {
      100% { stroke-dashoffset: 0; }
    }
    
    @keyframes scale {
      0%, 100% { transform: none; }
      50% { transform: scale3d(1.1, 1.1, 1); }
    }
    
    @keyframes fill {
      100% { box-shadow: inset 0px 0px 0px 30px #4caf50; }
    }

    /* Accessibility improvements */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: #000;
      color: #fff;
      padding: 8px;
      text-decoration: none;
      border-radius: 4px;
      z-index: 1002;
      font-size: 14px;
      transition: top 0.3s ease;
    }
    
    .skip-link:focus {
      top: 6px;
    }
    
    /* Enhanced focus styles for better accessibility */
    .enneagram-card:focus {
      outline: 2px solid #6e8efb;
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(110, 142, 251, 0.2);
    }
    
    .share-button:focus,
    .fab:focus {
      outline: 2px solid #fff;
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(110, 142, 251, 0.3);
    }
    
    /* Reduce motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {
      .enneagram-card {
        animation: none;
        transition: none;
      }
      
      .fab,
      .share-button {
        transition: none;
      }
      
      .progress-bar {
        transition: none;
      }
    }
    
    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .enneagram-card {
        border: 2px solid;
      }
      
      .card-header {
        background: #000 !important;
        color: #fff !important;
      }
    }
    
    /* Type-specific accent colors for elements */
    .type-1 .traits-list li { border-left-color: #FF5E62; }
    .type-2 .traits-list li { border-left-color: #FC5C7D; }
    .type-3 .traits-list li { border-left-color: #FFCC70; }
    .type-4 .traits-list li { border-left-color: #00B09B; }
    .type-5 .traits-list li { border-left-color: #4568DC; }
    .type-6 .traits-list li { border-left-color: #3A1C71; }
    .type-7 .traits-list li { border-left-color: #FDC830; }
    .type-8 .traits-list li { border-left-color: #ED213A; }
    .type-9 .traits-list li { border-left-color: #1A2980; }
    
    
    /* Success animation */
    .success-checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: block;
      stroke-width: 2;
      stroke: #4caf50;
      stroke-miterlimit: 10;
      margin: 10px auto;
      box-shadow: inset 0px 0px 0px #4caf50;
      animation: fill 0.4s ease-in-out 0.4s forwards, scale 0.3s ease-in-out 0.9s both;
    }
    
    .success-checkmark__circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 2;
      stroke-miterlimit: 10;
      stroke: #4caf50;
      fill: none;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    
    .success-checkmark__check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }
    
    @keyframes stroke {
      100% { stroke-dashoffset: 0; }
    }
    
    @keyframes scale {
      0%, 100% { transform: none; }
      50% { transform: scale3d(1.1, 1.1, 1); }
    }
    
    @keyframes fill {
      100% { box-shadow: inset 0px 0px 0px 30px #4caf50; }
    }

    /* Accessibility improvements */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: #000;
      color: #fff;
      padding: 8px;
      text-decoration: none;
      border-radius: 4px;
      z-index: 1002;
      font-size: 14px;
      transition: top 0.3s ease;
    }
    
    .skip-link:focus {
      top: 6px;
    }
    
    /* Enhanced focus styles for better accessibility */
    .enneagram-card:focus {
      outline: 2px solid #6e8efb;
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(110, 142, 251, 0.2);
    }
    
    .share-button:focus,
    .fab:focus {
      outline: 2px solid #fff;
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(110, 142, 251, 0.3);
    }
    
    /* Reduce motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {
      .enneagram-card {
        animation: none;
        transition: none;
      }
      
      .fab,
      .share-button {
        transition: none;
      }
      
      .progress-bar {
        transition: none;
      }
    }
    
    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .enneagram-card {
        border: 2px solid;
      }
      
      .card-header {
        background: #000 !important;
        color: #fff !important;
      }
    }
    
    /* Type-specific accent colors for elements */
    .type-1 .traits-list li { border-left-color: #FF5E62; }
    .type-2 .traits-list li { border-left-color: #FC5C7D; }
    .type-3 .traits-list li { border-left-color: #FFCC70; }
    .type-4 .traits-list li { border-left-color: #00B09B; }
    .type-5 .traits-list li { border-left-color: #4568DC; }
    .type-6 .traits-list li { border-left-color: #3A1C71; }
    .type-7 .traits-list li { border-left-color: #FDC830; }
    .type-8 .traits-list li { border-left-color: #ED213A; }
    .type-9 .traits-list li { border-left-color: #1A2980; }
  </style>
</head>
<body>
  <div class="device-container">
    <div class="output-wrapper">
      <div id="output-span" class="api-output"></div>
    </div>

  <!-- Copy utility is already included in the head -->
  
  <script>
    // Run immediately without waiting for DOMContentLoaded
    (function() {
      console.log('Enneagram API Output script running');
     
      const getLocal = window.getLocal || function(key) {
        try {
          const value = localStorage.getItem(key);
          return value ? decodeURIComponent(value) : null;
        } catch (e) {
          console.error('Error getting local value:', e);
          return null;
        }
      };
      
      const getJSON = window.getJSON || function(key) {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : null;
        } catch (e) {
          console.error('Error parsing JSON:', e);
          return null;
        }
      };
      
      // Helper function to extract type number from string (e.g., "Type 6" -> 6)
      function extractTypeNumber(typeString) {
        if (!typeString) return null;
        const match = typeString.match(/\d+/);
        return match ? match[0] : null;
      }
      
      // Create a card element
      function createCard(title, subtitle, content, className = '', delay = 0) {
        const card = document.createElement('div');
        card.className = `enneagram-card ${className} delay-${delay}`;
        card.setAttribute('role', 'article');
        card.setAttribute('tabindex', '0');
        card.setAttribute('aria-label', `${title}: ${subtitle}`);
        
        const header = document.createElement('div');
        header.className = 'card-header';
        
        const titleEl = document.createElement('h2');
        titleEl.className = 'card-title';
        titleEl.textContent = title;
        titleEl.setAttribute('id', `card-title-${delay}`);
        
        const subtitleEl = document.createElement('div');
        subtitleEl.className = 'card-subtitle';
        subtitleEl.textContent = subtitle || '';
        subtitleEl.setAttribute('aria-describedby', `card-title-${delay}`);
        
        header.appendChild(titleEl);
        if (subtitle) header.appendChild(subtitleEl);
        
        const body = document.createElement('div');
        body.className = 'card-body';
        body.innerHTML = content;
        body.setAttribute('role', 'region');
        body.setAttribute('aria-labelledby', `card-title-${delay}`);
        
        card.appendChild(header);
        card.appendChild(body);
        
        // Add keyboard navigation
        card.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        });
        
        return card;
      }
      
      // Format the Enneagram analysis content
      function formatEnneagramAnalysis(data) {
        if (!data || !data.enneagramAnalysis) {
          return '<p>Invalid Enneagram analysis data.</p>';
        }
        
        const analysis = data.enneagramAnalysis;
        const mainEl = document.createElement('div');
        mainEl.className = 'enneagram-content';
        
        // Extract the type number for color theming
        const typeNumber = extractTypeNumber(analysis.coreTypeProfile?.typeNumber);
        
        // 1. Introduction Section
        const introEl = document.createElement('div');
        introEl.innerHTML = `
          <div class="enneagram-header">
            <h1><i class="fas fa-star" style="margin-right: 8px; color: #6e8efb;"></i>Your Enneagram Analysis</h1>
            <p style="font-size: 14px; margin-top: 5px; color: #666;">
              Generated on ${new Date(data.generatedDate).toLocaleDateString()}
            </p>
          </div>
          <p style="padding: 15px; line-height: 1.6;">${analysis.introduction}</p>
        `;
        mainEl.appendChild(introEl);
        
        // 2. Core Type Profile Card
        if (analysis.coreTypeProfile) {
          const core = analysis.coreTypeProfile;
          let coreContent = '';
          
          if (core.typeNumber) {
            coreContent += `<span class="type-badge">${core.typeNumber}</span>`;
          }
          
          coreContent += `
            <p><i class="fas fa-fire" style="color: #6e8efb; margin-right: 8px;"></i> <strong>Core Motivation:</strong> ${core.coreMotivation}</p>
            <p><i class="fas fa-exclamation-triangle" style="color: #ff7676; margin-right: 8px;"></i> <strong>Core Fear:</strong> ${core.coreFear}</p>
          `;
          
          if (core.keyCharacteristics && core.keyCharacteristics.length) {
            coreContent += '<h3 class="section-title"><i class="fas fa-fingerprint" style="margin-right: 8px;"></i>Key Characteristics</h3>';
            coreContent += '<ul class="traits-list">';
            core.keyCharacteristics.forEach(trait => {
              coreContent += `<li>${trait}</li>`;
            });
            coreContent += '</ul>';
          }
          
          if (core.personalizedReflection) {
            coreContent += `
              <h3 class="section-title"><i class="fas fa-comment-dots" style="margin-right: 8px;"></i>Personal Reflection</h3>
              <div class="section-content">${core.personalizedReflection}</div>
            `;
          }
          
          const coreCard = createCard(
            `${core.typeName || core.typeNumber}`, 
            'Your Core Enneagram Type',
            coreContent,
            `type-${typeNumber}`,
            1
          );
          mainEl.appendChild(coreCard);
        }
        
        // 3. Wing Influence Card
        if (analysis.wingInfluence && analysis.wingInfluence.wingTypeNumber) {
          const wing = analysis.wingInfluence;
          const wingContent = `
            <p><i class="fas fa-feather" style="color: #6e8efb; margin-right: 8px;"></i>Your wing adds additional qualities that complement your core type.</p>
            <div class="section-content" style="margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #6e8efb;">${wing.howWingInfluencesCore}</div>
          `;
          
          const wingTypeNum = extractTypeNumber(wing.wingTypeNumber);
          const wingCard = createCard(
            `🪶 ${wing.wingTypeName || wing.wingTypeNumber}`,
            'Your Wing Influence',
            wingContent,
            `type-${wingTypeNum}`,
            2
          );
          mainEl.appendChild(wingCard);
        }
        
        // 4. Integration & Disintegration Paths
        if (analysis.integrationDisintegrationPaths) {
          const paths = analysis.integrationDisintegrationPaths;
          let pathsContent = '';
          
          if (paths.integrationPoint && paths.integrationPoint.typeNumber) {
            pathsContent += `
              <h3 class="section-title"><i class="fas fa-arrow-up" style="margin-right: 8px; color: #4caf50;"></i>Growth Direction (${paths.integrationPoint.typeNumber})</h3>
              <div class="section-content">${paths.integrationPoint.description}</div>
            `;
          }
          
          if (paths.disintegrationPoint && paths.disintegrationPoint.typeNumber) {
            pathsContent += `
              <h3 class="section-title"><i class="fas fa-arrow-down" style="margin-right: 8px; color: #ff5252;"></i>Stress Direction (${paths.disintegrationPoint.typeNumber})</h3>
              <div class="section-content">${paths.disintegrationPoint.description}</div>
            `;
          }
          
          const pathsCard = createCard(
            '↕️ Integration & Stress Patterns',
            'How you move between types under different conditions',
            pathsContent,
            '',
            3
          );
          mainEl.appendChild(pathsCard);
        }
        
        // 5. Tritype & Instincts
        if (analysis.tritypeAndInstincts) {
          const tri = analysis.tritypeAndInstincts;
          let triContent = '';
          
          if (tri.tritypeInterpretation) {
            triContent += `
              <h3 class="section-title"><i class="fas fa-sitemap" style="margin-right: 8px;"></i>Tritype Analysis</h3>
              <div class="section-content">${tri.tritypeInterpretation}</div>
            `;
          }
          
          if (tri.instinctualVariantStack) {
            triContent += `
              <h3 class="section-title"><i class="fas fa-layer-group" style="margin-right: 8px;"></i>Instinctual Stack</h3>
              <p>${tri.instinctualVariantStack}</p>
            `;
          }
          
          if (tri.dominantInstinctFocus) {
            triContent += `
              <h3 class="section-title"><i class="fas fa-compass" style="margin-right: 8px;"></i>Dominant Instinct</h3>
              <div class="section-content">${tri.dominantInstinctFocus}</div>
            `;
          }
          
          if (triContent) {
            const triCard = createCard(
              '🔗 Tritype & Instinctual Variants',
              'Additional layers of your personality pattern',
              triContent,
              '',
              4
            );
            mainEl.appendChild(triCard);
          }
        }
        
        // 6. Growth Opportunities
        if (analysis.addressingUserFocus) {
          const focus = analysis.addressingUserFocus;
          let focusContent = '';
          
          if (focus.insightsOnQuestions) {
            focusContent += `
              <h3 class="section-title"><i class="fas fa-lightbulb" style="margin-right: 8px; color: #ffc107;"></i>Insights on Your Questions</h3>
              <div class="section-content">${focus.insightsOnQuestions}</div>
            `;
          }
          
          if (focus.growthOpportunities && focus.growthOpportunities.length) {
            focusContent += '<h3 class="section-title"><i class="fas fa-seedling" style="margin-right: 8px; color: #4caf50;"></i>Growth Opportunities</h3>';
            
            focus.growthOpportunities.forEach((opportunity, index) => {
              focusContent += `
                <div class="growth-item">
                  <div class="growth-item-icon">${index + 1}</div>
                  <div class="growth-item-content">${opportunity}</div>
                </div>
              `;
            });
          }
          
          const focusCard = createCard(
            '🌱 Personal Development',
            'Addressing your questions and growth paths',
            focusContent,
            '',
            5
          );
          mainEl.appendChild(focusCard);
        }
        
        // 7. Summary
        if (analysis.summaryAndNextSteps) {
          const summaryContent = `
            <div class="section-content">${analysis.summaryAndNextSteps}</div>
          `;
          
          const summaryCard = createCard(
            '📋 Summary & Next Steps',
            'Your path forward on the Enneagram journey',
            summaryContent,
            '',
            6
          );
          mainEl.appendChild(summaryCard);
        }
        
        // Footer
        const footerEl = document.createElement('div');
        footerEl.className = 'enneagram-footer';
        footerEl.innerHTML = `
          <p>✨ Enneagram analysis by <strong>INEXASLI</strong> ✨</p>
          <p style="font-size: 11px; margin-top: 5px; color: #aaa;">Discover your authentic self through ancient wisdom</p>
        `;
        mainEl.appendChild(footerEl);
        
        return mainEl;
      }

      // Progress bar functionality (kept separate as requested)
      function updateProgressBar() {
        const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        
        let progressBar = document.querySelector('.progress-bar');
        if (!progressBar) {
          progressBar = document.createElement('div');
          progressBar.className = 'progress-bar';
          document.body.appendChild(progressBar);
        }
        progressBar.style.width = scrolled + '%';
      }

      // Initialize enhanced UI system (replaces old addEnhancedUI function)
      function initEnhancedUISystem() {
        // Wait a bit to ensure DOM and containers are ready
        setTimeout(() => {
          // Initialize the enhanced UI with embed detection
          if (window.enhancedUI) {
            window.enhancedUI.init({
              containerId: 'main-content',
              scrollToTop: true,
              embedEnforcement: true,
              accessibility: true
            });
          } else {
            console.warn('Enhanced UI system not loaded');
          }
        }, 100);
      }

      function updateOutput() {
        const outputSpan = document.getElementById('output-span');
        if (!outputSpan) {
          console.log('Output span not found, will retry');
          setTimeout(updateOutput, 100);
          return;
        }
        
        const responseKey = 'enneagramIqResponse';
        console.log('Looking for data with key:', responseKey);
        let data;
        
        try {
          data = getJSON(responseKey);
          // Patch: unwrap nested structure if present
          if (data && data.data && data.data.enneagramIqResponse && data.data.enneagramIqResponse.enneagramAnalysis) {
            data = data.data.enneagramIqResponse;
          }
          if (data) {
            // Validate data structure - checking for the new cleaner structure
            if (!data.enneagramAnalysis) {
              throw new Error('Invalid data structure: missing enneagramAnalysis');
            }
            // Format the data directly since it now has the clean structure
            const formattedContent = formatEnneagramAnalysis(data);
            outputSpan.innerHTML = '';
            outputSpan.appendChild(formattedContent);
            // Add enhanced UI elements after content is loaded
            setTimeout(() => {
              // Initialize enhanced UI system
              initEnhancedUISystem();
              // Set up progress bar separately (as requested)
              window.addEventListener('scroll', updateProgressBar);
              // Add main content landmark for accessibility
              const mainContent = document.querySelector('.enneagram-content');
              if (mainContent) {
                mainContent.setAttribute('id', 'main-content');
                mainContent.setAttribute('role', 'main');
                mainContent.setAttribute('aria-label', 'Enneagram analysis results');
              }
              // Trigger staggered card animations
              const cards = document.querySelectorAll('.enneagram-card');
              cards.forEach((card, index) => {
                setTimeout(() => {
                  card.style.opacity = '1';
                  card.style.transform = 'translateY(0)';
                }, index * 150);
              });
              // Success toast removed per user request
            }, 100);
            console.log('Data displayed successfully');
          } else {
            outputSpan.innerHTML = '';
            console.log('No data found for key: enneagramIqResponse');
          }
        } catch (err) {
          console.error('Error processing data:', err);
          outputSpan.innerHTML = '';
        }
      }
      
      // Helper function to navigate to Enneagram test
      window.goToEnneagramTest = function() {
        window.location.href = './enneagramiq.html';
      };

      // Initialize copy button functionality after content is loaded
      function initializeCopyButton() {
        if (window.copyUtil && window.copyUtil.init) {
          try {
            console.log('Initializing copy button for enneagram output...');
            window.copyUtil.init({
              containerId: 'output-span'
            });
            console.log('Copy button initialized successfully');
          } catch (err) {
            console.error('Error initializing copy button:', err);
          }
        } else {
          console.log('Copy utility not available yet, retrying...');
          // Retry after a short delay if copy.js hasn't loaded yet
          setTimeout(initializeCopyButton, 500);
        }
      }

      setTimeout(updateOutput, 100);

      // Initialize copy button after a short delay to ensure copy.js is loaded
      setTimeout(initializeCopyButton, 1000);
    })();
  </script>
  <script src="../../utility/copy.js"></script>
  <style>
    /* Additional styles for loading and empty state */
    /* Card animation setup */
    .quote-card {
      opacity: 0;
      transform: translateY(20px);
    }
  </style>
