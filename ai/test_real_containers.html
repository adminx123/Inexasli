<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Container Test - Fixed Cookie Logic</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            min-height: 100vh;
        }
        .test-panel {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        
        .container-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .container-status {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .cookie-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Mock grid for testing */
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .grid-item {
            padding: 15px;
            background: #e9ecef;
            border: 2px solid #6c757d;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .grid-item:hover {
            background: #dee2e6;
        }
        .grid-item.selected {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>üß™ Real Container Test - Fixed Cookie Logic</h1>
    
    <div class="status info">
        <strong>Test Objective:</strong> Verify that datain and dataout containers are now visible after consent completion, 
        even when a fresh "prompt" cookie exists (which was previously blocking initialization).
    </div>

    <div class="test-panel">
        <h2>üéÆ Test Controls</h2>
        <button class="btn-danger" onclick="clearAllCookies()">Clear All Cookies</button>
        <button class="btn-primary" onclick="simulateConsentCompletion()">‚úÖ Complete Consent (Set Cookies)</button>
        <button class="btn-warning" onclick="setProblematicCookie()">‚ö†Ô∏è Set Problematic Prompt Cookie</button>
        <button class="btn-success" onclick="checkContainerStatus()">üîç Check Container Status</button>
        <button class="btn-primary" onclick="testContainerInteraction()">üéØ Test Container Interaction</button>
    </div>

    <div class="container-info">
        <div class="container-status">
            <h3>üì• Data In Container</h3>
            <div id="datain-status">Checking...</div>
            <small id="datain-details"></small>
        </div>
        <div class="container-status">
            <h3>üì§ Data Out Container</h3>
            <div id="dataout-status">Checking...</div>
            <small id="dataout-details"></small>
        </div>
    </div>

    <div class="test-panel">
        <h2>üç™ Current Cookies</h2>
        <div id="cookie-display" class="cookie-display">Loading...</div>
    </div>

    <div class="test-panel">
        <h2>üß™ Test Grid (for Container Interaction)</h2>
        <div class="test-grid" id="test-grid">
            <div class="grid-item" data-value="fitness">Fitness</div>
            <div class="grid-item" data-value="nutrition">Nutrition</div>
            <div class="grid-item" data-value="health">Health</div>
            <div class="grid-item" data-value="wellness">Wellness</div>
        </div>
    </div>

    <div class="test-panel">
        <h2>üìã Test Results</h2>
        <div id="test-results"></div>
    </div>

    <!-- Load the actual fixed JavaScript files -->
    <script src="/ai/datain.js" type="module"></script>
    <script src="/ai/dataout.js" type="module"></script>

    <script>
        function logResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            resultsDiv.appendChild(statusDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            console.log(`[Test] ${message}`);
        }

        function displayCookies() {
            const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                const [key, value] = cookie.trim().split('=');
                if (key) acc[key] = value || '';
                return acc;
            }, {});
            
            const cookieDisplay = document.getElementById('cookie-display');
            if (Object.keys(cookies).length === 0) {
                cookieDisplay.textContent = 'No cookies set';
            } else {
                cookieDisplay.innerHTML = Object.entries(cookies)
                    .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                    .join('<br>');
            }
        }

        function clearAllCookies() {
            logResult('üßπ Clearing all cookies...', 'info');
            
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i];
                const eqPos = cookie.indexOf("=");
                const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
                
                // Don't clear the important cookies that should be preserved
                if (!name.includes('stripe') && 
                    !name.includes('payment') && 
                    name !== 'terms_accepted' && 
                    name !== 'data_storage_consent') {
                    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                }
            }
            
            logResult('‚úÖ Cookies cleared (preserved important ones)', 'success');
            setTimeout(() => {
                displayCookies();
                checkContainerStatus();
            }, 500);
        }

        function simulateConsentCompletion() {
            logResult('‚úÖ Simulating successful consent modal completion...', 'info');
            
            // Set the consent cookies that would be set after completing modals
            document.cookie = "data_storage_consent=accepted;path=/;max-age=31536000";
            document.cookie = "terms_accepted=true;path=/;max-age=31536000";
            
            logResult('‚úÖ Consent cookies set: data_storage_consent=accepted, terms_accepted=true', 'success');
            
            setTimeout(() => {
                displayCookies();
                checkContainerStatus();
            }, 500);
        }

        function setProblematicCookie() {
            logResult('‚ö†Ô∏è Setting the problematic "prompt" cookie that previously blocked containers...', 'info');
            
            // This is the cookie that was causing the issue
            document.cookie = "prompt=fresh;path=/;max-age=3600";
            
            logResult('‚ö†Ô∏è Prompt cookie set. In the old code, this would prevent containers from showing.', 'error');
            logResult('‚úÖ With the fix, containers should still be visible!', 'success');
            
            setTimeout(() => {
                displayCookies();
                checkContainerStatus();
            }, 500);
        }

        function checkContainerStatus() {
            logResult('üîç Checking container status...', 'info');
            
            // Wait a moment for any async initialization
            setTimeout(() => {
                const datainContainer = document.querySelector('.data-container-left');
                const dataoutContainer = document.querySelector('.data-container-right');
                
                // Update status displays
                updateContainerDisplay(datainContainer, 'datain');
                updateContainerDisplay(dataoutContainer, 'dataout');
                
                // Log findings
                if (datainContainer && dataoutContainer) {
                    logResult('‚úÖ SUCCESS: Both containers are present in DOM!', 'success');
                    logResult(`üì• DataIn state: ${datainContainer.dataset.state || 'unknown'}`, 'info');
                    logResult(`üì§ DataOut state: ${dataoutContainer.dataset.state || 'unknown'}`, 'info');
                } else if (datainContainer || dataoutContainer) {
                    logResult(`‚ö†Ô∏è PARTIAL: Only ${datainContainer ? 'DataIn' : 'DataOut'} container found`, 'error');
                } else {
                    logResult('‚ùå FAILURE: No containers found in DOM', 'error');
                    logResult('This might indicate the scripts are not loading properly', 'info');
                }
                
                // Check cookie state
                const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                    const [key, value] = cookie.trim().split('=');
                    if (key) acc[key] = value;
                    return acc;
                }, {});
                
                const hasConsent = cookies.data_storage_consent === 'accepted';
                const hasTerms = cookies.terms_accepted === 'true';
                const hasPromptCookie = cookies.prompt === 'fresh';
                
                if (hasPromptCookie) {
                    logResult('üéØ KEY TEST: Found problematic prompt cookie', 'info');
                    if (datainContainer && dataoutContainer) {
                        logResult('‚úÖ SUCCESS: Containers visible despite prompt cookie! Fix is working!', 'success');
                    } else {
                        logResult('‚ùå ISSUE: Containers not visible with prompt cookie', 'error');
                    }
                }
                
                if (hasConsent && hasTerms) {
                    logResult('‚úÖ User consent status: Complete', 'success');
                } else {
                    logResult('‚ö†Ô∏è User consent status: Incomplete', 'error');
                }
                
            }, 1000);
        }

        function updateContainerDisplay(container, type) {
            const statusId = `${type}-status`;
            const detailsId = `${type}-details`;
            
            if (container) {
                const state = container.dataset.state || 'unknown';
                const className = container.className;
                const isVisible = container.style.display !== 'none' && 
                                 !container.classList.contains('hidden');
                
                document.getElementById(statusId).innerHTML = 
                    `<span style="color: green;">‚úÖ Present & ${isVisible ? 'Visible' : 'Hidden'}</span>`;
                document.getElementById(detailsId).innerHTML = 
                    `State: ${state}<br>Classes: ${className}`;
            } else {
                document.getElementById(statusId).innerHTML = 
                    `<span style="color: red;">‚ùå Not Found</span>`;
                document.getElementById(detailsId).innerHTML = 'Container not in DOM';
            }
        }

        function testContainerInteraction() {
            logResult('üéØ Testing container interaction...', 'info');
            
            const datainContainer = document.querySelector('.data-container-left');
            const dataoutContainer = document.querySelector('.data-container-right');
            
            if (!datainContainer || !dataoutContainer) {
                logResult('‚ùå Cannot test interaction: Containers not found', 'error');
                return;
            }
            
            // Test clicking on datain container
            logResult('üñ±Ô∏è Simulating click on DataIn container...', 'info');
            datainContainer.click();
            
            setTimeout(() => {
                const datainState = datainContainer.dataset.state;
                logResult(`üì• DataIn clicked - new state: ${datainState}`, 'info');
                
                // Test clicking on dataout container
                logResult('üñ±Ô∏è Simulating click on DataOut container...', 'info');
                dataoutContainer.click();
                
                setTimeout(() => {
                    const dataoutState = dataoutContainer.dataset.state;
                    logResult(`üì§ DataOut clicked - new state: ${dataoutState}`, 'info');
                    logResult('‚úÖ Container interaction test completed', 'success');
                }, 500);
            }, 500);
        }

        // Initialize test grid functionality
        function initializeTestGrid() {
            const gridItems = document.querySelectorAll('#test-grid .grid-item');
            gridItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Toggle selection
                    this.classList.toggle('selected');
                    
                    // Dispatch event that datain.js listens for
                    const event = new CustomEvent('promptGridItemSelected', {
                        detail: {
                            url: `/ai/test/${this.dataset.value}.html`,
                            value: this.dataset.value
                        }
                    });
                    document.dispatchEvent(event);
                    
                    logResult(`üéØ Grid item selected: ${this.dataset.value}`, 'info');
                });
            });
        }

        // Auto-refresh functions
        function startAutoUpdate() {
            setInterval(() => {
                displayCookies();
                // Update container status without logging
                const datainContainer = document.querySelector('.data-container-left');
                const dataoutContainer = document.querySelector('.data-container-right');
                updateContainerDisplay(datainContainer, 'datain');
                updateContainerDisplay(dataoutContainer, 'dataout');
            }, 2000);
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            logResult('üöÄ Test page loaded successfully', 'success');
            logResult('üìã Testing the fixed cookie logic in datain.js and dataout.js', 'info');
            
            initializeTestGrid();
            displayCookies();
            
            // Initial check after a delay to allow scripts to load
            setTimeout(() => {
                checkContainerStatus();
                startAutoUpdate();
            }, 2000);
        });

        // Listen for container state changes
        document.addEventListener('datain-state-changed', function(e) {
            logResult(`üì• DataIn state changed to: ${e.detail.state}`, 'info');
        });

        document.addEventListener('dataout-state-changed', function(e) {
            logResult(`üì§ DataOut state changed to: ${e.detail.state}`, 'info');
        });
    </script>
</body>
</html>
