<!--
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
-->

<script src="../../payment/paymentform.js"></script>

<div class="device-container">

<div class="row1 product-description-container">
    <h2 class="product-description-heading">Plan Your Perfect Event, Effortlessly!</h2>
    <p class="product-description-text">
        Organizing an event, big or small? EventIQ™ helps you streamline the planning process. By answering some key questions about your event's goals, budget, and preferences, you'll enable our AI to provide tailored suggestions, checklists, and ideas. This helps you stay organized, consider all angles, and create a memorable occasion.
    </p>
    <p class="product-description-final">
        Let's start planning your successful event!
    </p>
    <p class="product-description-disclaimer">
        <em>AI can make mistakes, consult a professional.</em>
    </p>
</div>

<div class="premium-blur">

        <div class="row1">
            <h3 class="tooltip1" data-tooltip="Select the type of event you're planning to receive tailored suggestions and planning advice.">
                Event Type<span class="tooltip1-content"></span>
            </h3>
            <div class="grid-container" id="event-types">
                <div class="grid-item" data-value="Birthday">Birthday</div>
                <div class="grid-item" data-value="Wedding">Wedding</div>
                <div class="grid-item" data-value="House Party">House Party</div>
                <div class="grid-item" data-value="Corporate Event">Corporate Event</div>
                <div class="grid-item" data-value="Family Reunion">Family Reunion</div>
                <div class="grid-item" data-value="Concert">Concert</div>
                <div class="grid-item" data-value="Graduation">Graduation</div>
                <div class="grid-item" data-value="Festival">Festival</div>
                <div class="grid-item" data-value="Charity Event">Charity Event</div>
                <div class="grid-item" data-value="Community Gathering">Community Gathering</div>
            </div>

                    <label class="category-label">Event Elements</label>
            <div class="grid-container" id="event-elements">
                <div class="grid-item" data-value="Food">Food</div>
                <div class="grid-item" data-value="Drinks">Drinks</div>
                <div class="grid-item" data-value="Alcoholic Drinks">Alcoholic Drinks</div>
                <div class="grid-item" data-value="Photography">Photography</div>
                <div class="grid-item" data-value="Games">Games</div>
                <div class="grid-item" data-value="Live Entertainment">Live Entertainment</div>
                <div class="grid-item" data-value="Decorations">Decorations</div>
                <div class="grid-item" data-value="Music">Music</div>
                <div class="grid-item" data-value="Invitations">Invitations</div>
                <div class="grid-item" data-value="Gift Bags">Gift Bags</div>
            </div>
        </div>
      

        <div class="row1">

   <h3 class="tooltip1" data-tooltip="Indicate whether you already have a venue secured or need help finding one.">
                Venue Status<span class="tooltip1-content"></span>
            </h3>
            <select id="event-venue">
                <option value="" disabled selected>Select Venue Status</option>
                <option value="Venue Secured">Venue Secured</option>
                <option value="Venue Needed">Venue Needed</option>
            </select>

            
            <h3 class="tooltip1" data-tooltip="Choose whether your event will be held indoors or outdoors to get appropriate planning recommendations.">
                Location Type<span class="tooltip1-content"></span>
            </h3>
            <select id="event-location">
                <option value="" disabled selected>Select Location Type</option>
                <option value="indoors">Indoors</option>
                <option value="outdoors">Outdoors</option>
            </select>

             <label class="category-label">Event Location</label>
            <textarea id="event-specific-location" rows="1" placeholder="123 Main St, New York"></textarea>
        </div>


        <div class="row1" id="event-requirements">
            <h3 class="tooltip1" data-tooltip="Select all the equipment, services, and setup requirements needed for your event.">
                Requirements<span class="tooltip1-content"></span>
            </h3>
            <div class="grid-container" id="event-setup">
                <div class="grid-item" data-value="Seating">Seating</div>
                <div class="grid-item" data-value="Lighting">Lighting</div>
                <div class="grid-item" data-value="Decor">Decor</div>
                <div class="grid-item" data-value="Catering">Catering</div>
                <div class="grid-item" data-value="Microphone">Microphone</div>
                <div class="grid-item" data-value="Wi-Fi">Wi-Fi</div>
                <div class="grid-item" data-value="Sound Equipment">Sound Equipment</div>
                <div class="grid-item" data-value="Restrooms">Restrooms</div>
                <div class="grid-item" data-value="Registration">Registration Desk</div>
                <div class="grid-item" data-value="Security">Security</div>
                <div class="grid-item" data-value="Tent">Tent</div>
                <div class="grid-item" data-value="BackupPlan">Backup Plan</div>
                <div class="grid-item" data-value="Heaters">Heaters</div>
            </div>
        </div>
      
    
    
        <div class="row1">

  <label class="category-label">Event Time</label>
            <label for="event-start">Start:</label>
            <input type="time" id="event-start" name="event-start">
            <label for="event-end">End:</label>
            <input type="time" id="event-end" name="event-end">

<label class="category-label">Attendance & Budget</label>
            <input type="number" id="event-guests" placeholder="50" min="1">
            <input type="number" id="event-budget" placeholder="5000">

            <label class="category-label">Additional Context</label>
            <textarea id="event-specific-context" rows="3" placeholder="Majority of attendees have an Italian background
Most individuals between 5-10 yrs old
Need accommodations for 3 wheelchair users"></textarea>
       
            <button class="generate-btn" id="generate-event-btn">Generate EventIQ™ Plan</button>
        </div>
  

<script type="module">
/*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
*/

// Import rate limiting utilities
import { getFingerprintForWorker, incrementRequestCount, isRateLimited, handleRateLimitResponse } from '/utility/rateLimiter.js';

(function() {
    console.log("EventIQ script initializing");

    // Initialize FormPersistence for eventiq module
    const fields = [
        { id: 'event-types', type: 'grid' },
        { id: 'event-venue', type: 'dropdown' },
        { id: 'event-location', type: 'dropdown' },
        { id: 'event-setup', type: 'grid' },
        { id: 'event-elements', type: 'grid' },
        { id: 'event-guests', type: 'input' },
        { id: 'event-budget', type: 'input' },
        { id: 'event-start', type: 'input' },
        { id: 'event-end', type: 'input' },
        { id: 'event-specific-location', type: 'textarea' },
        { id: 'event-specific-context', type: 'textarea' }
    ];

    // FormPersistence will be initialized by datain.js as window.eventFormPersistence
    // No need to create a new instance here

    // Listen for grid-item-toggled event from datain.js
    function handleGridItemToggled(event) {
        console.log('[EventIQ] Grid item toggled event received');
        // UI behavior only - persistence handled centrally
    }

    // Handle the generate button click
    async function handleGenerateEventIq() {
        console.log('[EventIQ] Generate button clicked.');
        
        const formData = window.eventFormPersistence.getSavedFormData();
        if (!formData) {
            console.error('[EventIQ] No input data found in localStorage.');
            alert('Please complete the form before generating an event plan.');
            return;
        }

        // Check rate limiting before proceeding
        if (isRateLimited('event', 8, 60 * 60 * 1000)) { // 8 requests per hour (as per rate-limiter config)
            alert('You have exceeded the request limit for event planning. Please try again later.');
            return;
        }

        // Get fingerprint data for rate limiting
        const fingerprintData = getFingerprintForWorker();
        
        // Create combined payload with both form data and fingerprint
        const workerPayload = {
            module: 'event',
            formData: formData,
            fingerprint: fingerprintData
        };
        
        const dataContainer = document.querySelector('.device-container') || document.body;
        let backendResponse = null;
        
        try {
            const result = await window.enhancedLoading(
                'generate-event-btn',
                'event',
                async () => {
                    // Send data to worker
                    const apiUrl = 'https://inexasli.com/api/generate';
                    
                    console.log('[EventIQ] Sending eventIqInput to worker');
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(workerPayload)
                    });
                    
                    let responseData;
                    try {
                        responseData = await response.json();
                    } catch (e) {
                        responseData = { error: 'Invalid JSON', message: 'Invalid response from server.' };
                    }
                    
                    // Store backend response for error handling
                    backendResponse = responseData;
                    
                    // Always call handleRateLimitResponse with backend response
                    handleRateLimitResponse(dataContainer, responseData, !response.ok, 'EventIQ');
                    
                    if (!response.ok) {
                        throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
                    }
                    
                    if (responseData.message !== 'Success') {
                        throw new Error(`An error occurred: ${responseData.message || responseData.error || ''}`);
                    }
                    
                    // Store the response
                    window.eventFormPersistence.saveResponseData(responseData);
                    
                    // Dispatch an event to notify dataout.js that a response was received
                    const event = new CustomEvent('api-response-received', {
                        detail: {
                            module: 'eventiq',
                            type: 'worker-response',
                            timestamp: Date.now()
                        }
                    });
                    document.dispatchEvent(event);
                    console.log('[EventIQ] Dispatched api-response-received event');
                    
                    return responseData;
                }
            );
            
            // Increment request count after successful response
            incrementRequestCount('event');
            
            // Enhanced loading either returns result or throws error - no need to check result.success
            console.log('[EventIQ] Event plan generated successfully');
        } catch (error) {
            // If backendResponse is available, update rate limit display and show error
            if (backendResponse && dataContainer) {
                handleRateLimitResponse(dataContainer, backendResponse, true, 'EventIQ');
            }
            // Optionally, show a toast/modal here for generic errors
            console.error('[EventIQ] Error:', error);
        }
    }

    // Initialization
    document.addEventListener('grid-item-toggled', handleGridItemToggled);
    document.getElementById('generate-event-btn').addEventListener('click', handleGenerateEventIq);

    // Guided forms integration
    if (typeof GuidedForms !== 'undefined' && GuidedForms.eventiq) {
        new GuidedForms.eventiq();
    }
})();
</script>
</div>
</div>
