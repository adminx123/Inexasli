<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation Test</title>
</head>
<body>
    <h1>INEXASLI Validation Test</h1>
    
    <div class="device-container">
        <h2>Calorie Module Test</h2>
        <input id="calorie-age" type="text" placeholder="Age" value="25">
        <input id="calorie-height" type="text" placeholder="Height" value="5'10">
        <input id="calorie-weight" type="text" placeholder="Weight" value="70 kg">
        <select id="calorie-sex">
            <option value="" disabled>Select Gender</option>
            <option value="man" selected>Man</option>
            <option value="woman">Woman</option>
        </select>
        <textarea id="calorie-activity-level" placeholder="Activity level">I go to the gym 3 times a week and run on weekends.</textarea>
        <button id="generate-calorie-btn">Generate Calorie Plan</button>
    </div>

    <div id="test-results">
        <h3>Test Results:</h3>
        <div id="validation-log"></div>
    </div>

    <script type="module">
        import { validateModuleData, ValidationError } from '/utility/inputValidation.js';
        import { FormPersistence } from '/utility/formPersistence.js';
        
        console.log('Test page loaded');
        
        // Initialize FormPersistence for testing
        const testFormPersistence = FormPersistence.getInstance('calorie', {
            singleSelection: ['calorie-sex'],
            multiSelection: []
        });
        testFormPersistence.init({ moduleName: 'calorie' });
        window.calorieFormPersistence = testFormPersistence;
        
        // Test validation directly
        function testValidation() {
            const testData = {
                'calorie-age': '25',
                'calorie-height': "5'10",
                'calorie-weight': '70 kg',
                'calorie-sex': 'man',
                'calorie-activity-level': 'I go to the gym 3 times a week and run on weekends.'
            };
            
            console.log('Testing validation with data:', testData);
            
            try {
                const validated = validateModuleData('calorie', testData);
                console.log('Validation passed:', validated);
                
                document.getElementById('validation-log').innerHTML += 
                    '<p style="color: green;">✓ Validation passed for calorie module</p>';
                    
                return true;
            } catch (error) {
                console.error('Validation failed:', error);
                
                document.getElementById('validation-log').innerHTML += 
                    '<p style="color: red;">✗ Validation failed: ' + error.message + '</p>';
                    
                return false;
            }
        }
        
        // Test XSS detection
        function testXSSDetection() {
            const maliciousData = {
                'calorie-activity-level': '<script>alert("XSS")</script>I exercise regularly'
            };
            
            console.log('Testing XSS detection with data:', maliciousData);
            
            try {
                const validated = validateModuleData('calorie', maliciousData);
                console.log('XSS test result:', validated);
                
                if (validated['calorie-activity-level'].includes('<script>')) {
                    document.getElementById('validation-log').innerHTML += 
                        '<p style="color: red;">✗ XSS detection failed - script tags not removed</p>';
                    return false;
                } else {
                    document.getElementById('validation-log').innerHTML += 
                        '<p style="color: green;">✓ XSS detection passed - script tags removed</p>';
                    return true;
                }
            } catch (error) {
                if (error.message.includes('harmful content')) {
                    document.getElementById('validation-log').innerHTML += 
                        '<p style="color: green;">✓ XSS detection passed - blocked harmful content</p>';
                    return true;
                } else {
                    document.getElementById('validation-log').innerHTML += 
                        '<p style="color: red;">✗ XSS test failed: ' + error.message + '</p>';
                    return false;
                }
            }
        }
        
        // Mock generate button handler
        function mockGenerateHandler() {
            console.log('Mock generate handler called');
            
            const formData = testFormPersistence.getSavedFormData() || {
                'calorie-age': document.getElementById('calorie-age').value,
                'calorie-height': document.getElementById('calorie-height').value,
                'calorie-weight': document.getElementById('calorie-weight').value,
                'calorie-sex': document.getElementById('calorie-sex').value,
                'calorie-activity-level': document.getElementById('calorie-activity-level').value
            };
            
            console.log('Form data for generation:', formData);
            
            // This would normally be handled by datain.js validation wrapper
            try {
                const validated = validateModuleData('calorie', formData);
                document.getElementById('validation-log').innerHTML += 
                    '<p style="color: blue;">→ Generate button validation passed</p>';
                console.log('Generate button validation passed:', validated);
            } catch (error) {
                document.getElementById('validation-log').innerHTML += 
                    '<p style="color: red;">→ Generate button validation failed: ' + error.message + '</p>';
                console.error('Generate button validation failed:', error);
            }
        }
        
        // Run tests
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Running validation tests...');
            
            testValidation();
            testXSSDetection();
            
            // Attach mock handler to generate button
            document.getElementById('generate-calorie-btn').addEventListener('click', mockGenerateHandler);
            
            document.getElementById('validation-log').innerHTML += 
                '<p style="color: blue;">→ Tests completed. Click generate button to test form validation.</p>';
        });
    </script>
</body>
</html>
