<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

<div class="device-container" id="fishingiq-device-container" >
  <div class="row1">
    <div class="product-card">
      <div class="product-icon-container">
        <i class="bx bx-fish product-icon"></i>
      </div>
  <div class="product-headline">Fishing Regulator</div>
      <p class="product-description-text">
        This tool helps anglers understand BC Canada fishing regulations by providing species identification, seasonal information, size limits, and location-specific rules. Upload photos of caught fish or specify target species to get accurate regulatory guidance.
      </p>
      <div class="product-divider"></div>
      <p class="product-description-final">
        Ready to check fishing regulations!
      </p>
      <p class="product-description-disclaimer">
        <em>This is an informational tool only. All content is generated by third-party AI systems and is for educational and informational purposes. This is not legal advice. Fishing regulations can change - always verify with official sources. AI can make mistakes and generate inaccurate information. For official fishing regulations, consult provincial authorities.</em>
      </p>
    </div>
  </div>

  <!-- Stage 2: Intent Selection -->
  <div class="row1">
    <label class="category-label">What would you like to do?</label>
    <div class="grid-container" id="fishing-intent" data-single-select>
      <div class="grid-item" data-value="planning">I'm going fishing</div>
      <div class="grid-item" data-value="caught">I caught a fish</div>
    </div>
  </div>

  <!-- Stage 3: Location Input -->
  <div class="row1">
    <input id="fishing-location" type="text" placeholder="Fishing Location (e.g., Fraser River, Vancouver Island)">
  </div>

  <!-- Stage 4: Conditional Content -->
  <div id="conditional-stage" class="row1" style="display: none;">
    <div id="fishing-planning-stage" style="display: none;">
      <label class="category-label">What fish are you trying to catch?</label>
      <input id="target-species" type="text" placeholder="Target species (e.g., salmon, trout, bass)">
    </div>

    <div id="fishing-caught-stage" style="display: none;">
      <label class="category-label">Upload a photo of your catch</label>
      <div id="fish-image-upload-container" class="image-upload-container" data-image-upload data-module="fishing" data-max-images="1"></div>
    </div>

    <button class="generate-btn" id="generate-fishing-btn" disabled style="margin-top: 15px;">Generate Analysis</button>
  </div>

  </div>

<script type="module">
// Handle intent selection changes
console.log('[FishingIQ] Script executing');
document.getElementById('fishing-intent').addEventListener('click', function(e) {
  console.log('[FishingIQ] Intent clicked, target:', e.target);
  if (e.target.classList.contains('grid-item')) {
    console.log('[FishingIQ] Grid item clicked, calling updateConditionalContent');
    updateConditionalContent();
  }
});

// Use MutationObserver to watch for 'selected' class changes on grid-items
const observer = new MutationObserver(function(mutations) {
  mutations.forEach(function(mutation) {
    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
      const target = mutation.target;
      if (target.classList.contains('grid-item') && target.classList.contains('selected')) {
        console.log('[FishingIQ] Grid item selected via observer, calling updateConditionalContent');
        updateConditionalContent();
      }
    }
  });
});

const gridContainer = document.getElementById('fishing-intent');
if (gridContainer) {
  observer.observe(gridContainer, {
    attributes: true,
    subtree: true,
    attributeFilter: ['class']
  });
  console.log('[FishingIQ] MutationObserver set up for grid-container');
}

function updateConditionalContent() {
  console.log('[FishingIQ] updateConditionalContent called');
  const selectedIntent = document.querySelector('#fishing-intent .grid-item.selected');
  console.log('[FishingIQ] selectedIntent:', selectedIntent);
  const conditionalStage = document.getElementById('conditional-stage');
  const planningStage = document.getElementById('fishing-planning-stage');
  const caughtStage = document.getElementById('fishing-caught-stage');

  if (selectedIntent) {
    console.log('[FishingIQ] Showing conditional stage');
    conditionalStage.style.display = 'block'; // Show the conditional stage
    const intent = selectedIntent.getAttribute('data-value');
    console.log('[FishingIQ] Intent value:', intent);
    if (intent === 'planning') {
      planningStage.style.display = 'block';
      caughtStage.style.display = 'none';
    } else if (intent === 'caught') {
      planningStage.style.display = 'none';
      caughtStage.style.display = 'block';
      // Initialize image upload for caught fish
      if (typeof window.initializeImageUpload === 'function') {
        window.initializeImageUpload();
      }
    }
    // Update button state when conditional stage is shown
    updateButtonState();
  } else {
    console.log('[FishingIQ] No selected intent, hiding conditional stage');
    // No intent selected, hide conditional stage
    conditionalStage.style.display = 'none';
  }
}

// Button state management
function updateButtonState() {
  const generateBtn = document.getElementById('generate-fishing-btn');
  if (!generateBtn) {
    console.log('[FishingIQ] Generate button not found');
    return;
  }
  
  // Check if FormPersistence is ready
  if (!window.fishingFormPersistence) {
    console.log('[FishingIQ] FormPersistence not ready yet');
    // Try again in a moment
    setTimeout(updateButtonState, 100);
    return;
  }
  
  const formData = window.fishingFormPersistence.getSavedFormData();
  console.log('[FishingIQ] Form data for button state:', formData);
  let isComplete = false;

  if (formData && formData['fishing-location']) {
    if (formData['fishing-intent'] === 'planning' && formData['target-species']) {
      isComplete = true;
    } else if (formData['fishing-intent'] === 'caught' && formData.images && formData.images.length > 0) {
      isComplete = true;
    }
  }

  console.log('[FishingIQ] Form complete:', isComplete);
  if (isComplete) {
    generateBtn.disabled = false;
    generateBtn.style.display = 'block';
    console.log('[FishingIQ] Button enabled and visible');
  } else {
    generateBtn.disabled = true;
    generateBtn.style.display = 'block'; // Keep visible but disabled
    console.log('[FishingIQ] Button disabled but visible');
  }
}

// Generate button handler
(function() {
  async function handleGenerateFishingIq() {
    console.log('[FishingIQ] Generate button clicked - handler called');
    try {
      console.log('[FishingIQ DEBUG] Starting generation...');
      
      const formData = window.fishingFormPersistence.getSavedFormData();
      if (!formData) {
        alert('Please complete the form before generating fishing regulations.');
        return;
      }

      // For caught fish, check if image is uploaded
      if (formData['fishing-intent'] === 'caught') {
        const dataUrlImages = formData.images || [];
        console.log('[FishingIQ DEBUG] Images from FormPersistence:', dataUrlImages.length);
        
        if (dataUrlImages.length === 0) {
          console.log('[FishingIQ DEBUG] No images found in saved data - showing alert');
          alert('Please upload a photo of your catch before generating analysis.');
          return;
        }
      }

      // Create custom form data for fishing module
      const fishingFormData = {
        ...formData,
        images: formData.images || [] // Include images for caught fish
      };

      // Use centralized handler with custom form data
      await window.handleGenerateRequest('fishing', {
        customFormData: fishingFormData,
        alertMessage: 'Please complete the form before generating fishing regulations.'
      });
      
    } catch (error) {
      console.error('[FishingIQ] Error in fishing generation:', error);
    }
  }

  // Initialize button
  const generateFishingBtn = document.getElementById('generate-fishing-btn');
  console.log('[FishingIQ] Looking for generate button:', generateFishingBtn);
  if (generateFishingBtn) {
    console.log('[FishingIQ] Attaching click event listener to button');
    generateFishingBtn.addEventListener('click', handleGenerateFishingIq);
    generateFishingBtn.dataset.handlerAttached = 'true';
  } else {
    console.error('[FishingIQ] Generate button not found!');
  }

  // Listen for changes to update button state
  document.addEventListener('imageUploadChanged', updateButtonState);
  document.addEventListener('formpersistence:repopulated', updateButtonState);
  document.addEventListener('input', updateButtonState);
  document.addEventListener('change', updateButtonState);
  
  // Initial check
  console.log('[FishingIQ] Running initial button state check');
  updateButtonState();

  // Export for external access
  window.fishingIq = { 
    getFormData: () => window.fishingFormPersistence ? window.fishingFormPersistence.getSavedFormData() : null,
    saveFormData: () => window.fishingFormPersistence ? window.fishingFormPersistence.saveFormData() : null,
    updateButtonState: updateButtonState
  };

})();
</script>
