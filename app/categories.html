
<style>
/* Make premium-tag match datain.js payment button styling */
.premium-tag {
    font-size: 14px !important;
    font-weight: bold !important;
    float: right !important;
    margin-left: auto !important;
}


.product-icon {
    font-size: 24px;
    color: #4a90e2;
    margin-right: 12px;
    flex-shrink: 0; /* Prevent icon from shrinking */
}

/* Product description center alignment */
.product-description {
    text-align: center;
    flex: 1; /* Take remaining space and center within it */
    margin-right: 12px; /* Balance space for icon on left */
}


/* Removed legacy responsive CSS for old grid classes. Use grid-items1/grid-items2 for layout and responsiveness. */

.favorite-icon {
    position: absolute;
    top: 50%;
    right: 8px;
    transform: translateY(-50%);
    font-size: 20px;
    cursor: pointer;
    color: #ccc;
}

.favorite-icon.favorited {
    color: #4a90e2;
}

/* Add space for the favorite icon on product items */


/* Mobile-specific adjustments for favorite star and premium tag spacing */
@media (max-width: 480px) {

    
    .favorite-icon {
        top: 50%;
        right: 6px;
        transform: translateY(-50%);
        font-size: 18px;
        /* Expand touch area on mobile */
        padding: 8px;
        margin: -8px;
        min-width: 34px;
        min-height: 34px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .premium-tag {
        margin-right: 25px;
    }
}

@media (max-width: 375px) {

    
    .premium-tag {
        margin-right: 28px;
    }
    
    .favorite-icon {
        top: 50%;
        right: 6px;
        transform: translateY(-50%);
        /* Ensure expanded touch area on smaller screens */
        padding: 10px;
        margin: -10px;
        min-width: 38px;
        min-height: 38px;
    }
}


#favorites-container h3 {
    text-align: center;
    margin-bottom: 10px;
    font-size: 1.2em;
    color: #333;
}

/* Favorites grid custom layout */
#favorites-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    justify-content: flex-start;
    align-items: center;
    padding: 8px;
    margin-bottom: 16px;
}

/* Product items - copy of grid-item styles but without :active state to prevent unwanted activation when favoriting */
.product-item {
  background-color: rgba(2, 2, 2, 0.95);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  color: #fff;
  padding: 1rem;
  border-radius: 16px;
  border: 1px solid rgba(255, 255, 255, 0.05);
  border-top: 1px solid rgba(255, 255, 255, 0.08);
  border-bottom: 1px solid rgba(0, 0, 0, 0.3);
  box-shadow: 
    inset 0 1px 0 rgba(255, 255, 255, 0.1),
    inset 0 -1px 0 rgba(0, 0, 0, 0.2),
    0 4px 16px rgba(0, 0, 0, 0.2), 
    0 2px 8px rgba(0, 0, 0, 0.1), 
    0 1px 3px rgba(0, 0, 0, 0.05);
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: "Inter", sans-serif;
  box-sizing: border-box;
  overflow-wrap: break-word;
  white-space: normal;
  width: 100%;
  position: relative; /* For absolute positioning of favorite icon */
  display: flex;
  align-items: center;
  justify-content: center;
}

.product-item:hover {
  transform: translateY(-2px);
  background-color: rgba(5, 5, 5, 0.98);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-top: 1px solid rgba(255, 255, 255, 0.12);
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  box-shadow: 
    inset 0 1px 0 rgba(255, 255, 255, 0.15),
    inset 0 -1px 0 rgba(0, 0, 0, 0.3),
    0 6px 24px rgba(0, 0, 0, 0.3), 
    0 3px 12px rgba(0, 0, 0, 0.2), 
    0 1px 4px rgba(0, 0, 0, 0.1);
  color: #fff;
}

/* No :active state to prevent activation when favoriting */

.product-item.selected {
  background-color: rgba(1, 1, 1, 0.98);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  color: #fff;
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-top: 1px solid rgba(255, 255, 255, 0.15);
  border-bottom: 1px solid rgba(0, 0, 0, 0.5);
  box-shadow:
    inset 0 1px 0 rgba(255, 255, 255, 0.2),
    inset 0 -1px 0 rgba(0, 0, 0, 0.4),
    0 6px 24px rgba(0, 0, 0, 0.4),
    0 3px 12px rgba(0, 0, 0, 0.3),
    0 1px 4px rgba(0, 0, 0, 0.2);
}

</style>

<div class="device-container">
    

<div class="row1" data-step-label="Select Category">



    <div id="favorites-grid"></div>


<div class="grid-items1" id="category-all">
    <div class="grid-item category-selector" data-value="all" style="font-weight: bold;">ALL PRODUCTS</div>
</div>

<div class="grid-items2" id="category-selection">
    <div class="grid-item category-selector" data-value="health">HEALTH</div>
    <div class="grid-item category-selector" data-value="business">BUSINESS</div>
    <div class="grid-item category-selector" data-value="finance">FINANCE</div>
    <div class="grid-item category-selector" data-value="lifestyle">LIFESTYLE</div>
    <div class="grid-item category-selector" data-value="learning">LEARNING</div>
    <div class="grid-item category-selector" data-value="productivity">PRODUCTIVITY</div>
</div>
</div>


<div class="row1" data-step-label="Products">
    <div class="grid-items1">
        <!-- Health Products -->
        <div class="product-item" data-category="health" data-value="/app/calorie/calorieiq.html">
            <i class="bx bx-calculator product-icon"></i>
            <span class="product-description">Personal nutrition educational tool</span>
        </div>
        
        <!-- Business Products -->
        <div class="product-item" data-category="business,productivity" data-value="/app/decision/decisioniq.html">
            <i class="bx bx-brain product-icon"></i>
            <span class="product-description">Decision-making informational tool</span>
        </div>

        <div class="product-item" data-category="business,lifestyle" data-value="/app/shop/shopiq.html">
            <i class="bx bx-search-alt product-icon"></i>
            <span class="product-description">Product research informational tool</span>
        </div>
        
        <!-- Finance Products -->
        <div class="product-item" data-category="finance" data-value="/app/income/incomeiq.html">
            <i class="bx bx-dollar-circle product-icon"></i>
            <span class="product-description">Personal finance informational tool</span>
        </div>
        
        <!-- Lifestyle Products -->
        <div class="product-item" data-category="lifestyle" data-value="/app/event/eventiq.html">
            <i class="bx bx-calendar-event product-icon"></i>
            <span class="product-description">Event planning informational tool</span>
        </div>
        <div class="product-item" data-category="lifestyle" data-value="/app/fashion/fashioniq.html">
            <i class="bx bx-closet product-icon"></i>
            <span class="product-description">Style informational tool</span>
        </div>
        <div class="product-item" data-category="lifestyle,learning" data-value="/app/philosophy/philosophyiq.html">
            <i class="bx bx-book-open product-icon"></i>
            <span class="product-description">Philosophy exploration tool</span>
        </div>
        <div class="product-item" data-category="lifestyle" data-value="/app/enneagram/enneagramiq.html">
            <i class="bx bx-user-circle product-icon"></i>
            <span class="product-description">Personality educational tool</span>
        </div>
        <div class="product-item" data-category="lifestyle" data-value="/app/fishing/fishingiq.html">
            <i class="bx bx-water product-icon"></i>
            <span class="product-description">Fishing regulations informational tool</span>
        </div>
        
        <!-- Learning Products -->
        <div class="product-item" data-category="learning" data-value="/app/quiz/quiziq.html">
            <i class="bx bx-question-mark product-icon"></i>
            <span class="product-description">Learning quiz tool</span>
        </div>
    </div>
</div>
</div>


<script type="module">
// Execute immediately instead of waiting for DOMContentLoaded since this is dynamically loaded
// Utility functions are now available via window from datain.js
// No direct imports needed

console.log('[Categories] Script executing immediately');

const favoritesGrid = document.getElementById('favorites-grid');
const productsGrid = document.querySelector('.row1[data-step-label="Products"] .grid-items1');
const deviceContainer = document.querySelector('.device-container');

function getFavorites() {
    // Use the imported function directly with error handling
    try {
        if (typeof window.getJSON === 'function') {
            return window.getJSON('favoriteProducts', []);
        } else {
            console.warn('[Categories] window.getJSON not available, returning empty array');
            return [];
        }
    } catch (error) {
        console.error('[Categories] Error getting favorites:', error);
        return [];
    }
}

function saveFavorites(favorites) {
    // Use the imported function directly
    window.setJSON('favoriteProducts', favorites);
}

function renderFavorites() {
    // Check if favoritesGrid exists
    if (!favoritesGrid) {
        console.warn('[Categories] favoritesGrid element not found, skipping render');
        return;
    }

    const favorites = getFavorites();
    favoritesGrid.innerHTML = '';

    // Add null check to prevent errors
    if (!favorites || !Array.isArray(favorites)) {
        console.warn('[Categories] Favorites data is null or not an array, skipping render');
        return;
    }

    if (favorites.length === 0) {
        return;
    }

    const allProducts = Array.from(productsGrid.children);
    favorites.forEach(url => {
        const product = allProducts.find(p => p.dataset.value === url);
        if (product) {
            // Get the icon from the original product
            const originalIcon = product.querySelector('.product-icon');
            if (originalIcon) {
                // Create a new icon element (not wrapped in grid-item)
                const iconClone = originalIcon.cloneNode(true);
                iconClone.style.cursor = 'pointer';
                iconClone.style.margin = '4px';
                iconClone.style.fontSize = '24px';
                iconClone.dataset.value = url; // Store the URL for clicking
                iconClone.classList.add('favorite-clickable-icon');
                favoritesGrid.appendChild(iconClone);
            }
        }
    });
}

function toggleFavorite(url) {
    let favorites = getFavorites();
    const index = favorites.indexOf(url);
    if (index > -1) {
        favorites.splice(index, 1);
    } else {
        favorites.push(url);
    }
    saveFavorites(favorites);
    renderFavorites();
    updateFavoriteIcons();
}

function updateFavoriteIcons() {
    const favorites = getFavorites();
    // Ensure favorites is always an array to prevent null reference errors
    const safeFavorites = Array.isArray(favorites) ? favorites : [];
    // This will update icons in both the main grid and the favorites grid
    document.querySelectorAll('.product-item[data-value]').forEach(item => {
        const icon = item.querySelector('.favorite-icon');
        if (icon) {
            if (safeFavorites.includes(item.dataset.value)) {
                icon.classList.add('favorited');
            } else {
                icon.classList.remove('favorited');
            }
        }
    });
}

function addFavoriteIcons() {
    document.querySelectorAll('.product-item[data-category]').forEach(product => {
        if (product.querySelector('.favorite-icon')) return; // Don't add twice
        const icon = document.createElement('span');
        icon.className = 'favorite-icon';
        icon.innerHTML = '★';
        // Listener is handled by event delegation on the container
        product.appendChild(icon);
    });
}

// Function to filter products using DIRECT INLINE STYLES (bypasses all CSS)
function filterProducts(selectedCategory) {
    const products = document.querySelectorAll('.product-item[data-category]');
    console.log('[Categories] filterProducts called with:', selectedCategory, 'Found products:', products.length);
    
    products.forEach(product => {
        const categories = product.getAttribute('data-category').split(',');
        
        if (selectedCategory === 'all' || categories.includes(selectedCategory)) {
            product.style.display = 'flex';
        } else {
            product.style.display = 'none';
        }
    });
    
    localStorage.setItem('categoriesPageSelection', selectedCategory);
    console.log('[Categories] Category filtered:', selectedCategory);
}

// Wait a bit for DOM to be ready, then initialize
setTimeout(function() {
    addFavoriteIcons();
    renderFavorites();
    updateFavoriteIcons();
    
    // Handle both category containers
    const categoryContainer = document.getElementById('category-selection');
    const categoryAllContainer = document.getElementById('category-all');
    
    [categoryContainer, categoryAllContainer].forEach(container => {
        if (container) {
            container.addEventListener('click', function(e) {
                if (e.target.classList.contains('category-selector')) {
                    const selectedCategory = e.target.getAttribute('data-value');
                    e.stopPropagation();
                    
                    // Remove active from ALL category selectors
                    document.querySelectorAll('.category-selector').forEach(item => {
                        item.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    filterProducts(selectedCategory);
                    
                    if (window.guidedForms && typeof window.guidedForms.showStep === 'function') {
                        window.guidedForms.showStep(1);
                    }
                }
            });
        }
    });
        
    console.log('[Categories] Initializing - hiding all products first');
    document.querySelectorAll('.product-item[data-category]').forEach(product => {
        product.style.display = 'none';
    });

    setTimeout(() => {
        filterProducts('all');
        const allCategoriesItem = document.querySelector('#category-all .category-selector[data-value="all"]');
        if (allCategoriesItem) {
            allCategoriesItem.classList.add('active');
        }
    }, 100);
}, 100);

// Consolidated event listener for both product selection and favorite toggling
if (deviceContainer) {
    deviceContainer.addEventListener('click', function(e) {
        // Handle favorite clickable icons (not in grid items)
        if (e.target.classList.contains('favorite-clickable-icon')) {
            e.stopPropagation();
            const url = e.target.dataset.value;
            if (url) {
                // Set lastGridItemUrl so datain.js can remember the selection
                localStorage.setItem('lastGridItemUrl', url);

                // Check if we are inside the datain.js container
                const datainContainer = e.target.closest('#data-in-container');
                const eventDetail = { detail: { url: url } };
                if (datainContainer) {
                    console.log('[Categories] Dispatching event for datain.js from favorite icon');
                    const gridItemEvent = new CustomEvent('promptGridItemSelected', eventDetail);
                    datainContainer.dispatchEvent(gridItemEvent);
                } else {
                    console.log('[Categories] Dispatching event globally from favorite icon');
                    const gridItemEvent = new CustomEvent('promptGridItemSelected', eventDetail);
                    document.dispatchEvent(gridItemEvent);
                }
            }
            return;
        }

        const gridItem = e.target.closest('.grid-item, .product-item');
        if (!gridItem || !gridItem.dataset.value) return;

        // Handle favorite icon clicks
        if (e.target.classList.contains('favorite-icon')) {
            e.stopPropagation(); // Prevent product selection from firing
            toggleFavorite(gridItem.dataset.value);
            return;
        }

        // Handle product selection clicks (if it's a product URL)
        if (gridItem.dataset.value.startsWith('/app/')) {
            e.stopPropagation(); // Stop the event from bubbling up to datain.js modal handlers
            // Set lastGridItemUrl so datain.js can remember the selection
            localStorage.setItem('lastGridItemUrl', gridItem.dataset.value);

            // NEW: Check if we are inside the datain.js container
            const datainContainer = gridItem.closest('#data-in-container');
            const eventDetail = { detail: { url: gridItem.dataset.value } };
            if (datainContainer) {
                // If inside datain, dispatch the event directly on the container
                // so only datain.js handles it.
                console.log('[Categories] Dispatching event for datain.js and stopping propagation.');
                const gridItemEvent = new CustomEvent('promptGridItemSelected', eventDetail);
                datainContainer.dispatchEvent(gridItemEvent);
            } else {
                // Otherwise, dispatch globally as before (for when categories is the main page)
                console.log('[Categories] Dispatching event globally');
                const gridItemEvent = new CustomEvent('promptGridItemSelected', eventDetail);
                document.dispatchEvent(gridItemEvent);
            }
        }
    });
}
</script>

<script>
// Only enable autoAdvance for categories.html
  // Wait for guidedForms to be loaded by datain.js
  function initGuidedFormsForCategories() {
    if (window.GuidedFormSystem) {
      const guidedForms = new GuidedFormSystem({
        autoAdvance: true,
        showProgressIndicator: true,
        smoothTransitions: true
      });
      guidedForms.init('device-container');
    } else {
      // Retry after a short delay if not loaded yet
      setTimeout(initGuidedFormsForCategories, 100);
    }
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGuidedFormsForCategories);
  } else {
    initGuidedFormsForCategories();
  }
</script>