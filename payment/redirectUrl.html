<!-- /*
 * Copyright (c) 2025 INEXASLI. All rights reserved.
 * This code is protected under Canadian and international copyright laws.
 * Unauthorized use, reproduction, distribution, or modification of this code 
 * without explicit written permission via email from info@inexasli.com 
 * is strictly prohibited. Violators will be pursued and prosecuted to the 
 * fullest extent of the law in British Columbia, Canada, and applicable 
 * jurisdictions worldwide.
 */ -->

 <!DOCTYPE html>
 <html lang="en">
   <head>
     <meta charset="UTF-8" />
     <meta name="viewport" content="width=device-width, initial-scale=1.0" />
     <title>please wait</title>
     
     <!-- this is an extended list of places icon could be needed -->
     <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
     <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
     <link rel="shortcut icon" href="/images/favicon.ico" />
     <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />
     <link rel="manifest" href="/manifest.json">
 
     <link rel="stylesheet" href="/ai/styles/incomestyles.css">
   </head>
 
   <body style="background: #000; margin: 0; height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center;">
     <div class="container" style="display: flex; align-items: center; justify-content: center; height: 100vh; width: 100vw; background: #000;">
       <img src="/images/apple-touch-icon.png" alt="App Logo" style="width: 80px; height: 80px; object-fit: contain; display: block; margin: 0 auto;" />
     </div>
 
     <script type="module">
// Minimal localStorage helpers for this page
function setLocal(name, value) {
    localStorage.setItem(name, encodeURIComponent(value));
}
function getLocal(name) {
    const value = localStorage.getItem(name);
    return value !== null ? decodeURIComponent(value) : '';
}

// Payment redirect logic
const urlParams = new URLSearchParams(window.location.search);
const sessionId = urlParams.get("session_id");
const container = document.querySelector(".container");
const paymentEndpoint = "https://stripeintegration.4hm7q4q75z.workers.dev/";

document.addEventListener("DOMContentLoaded", async () => {
  const paid = getLocal("authenticated");
  const redirectToLanding = () => {
    window.location.href = "/ai/landing/landing.html";
  };
  if (paid === "paid") {
    redirectToLanding();
  } else {
    if (sessionId) {
      try {
        const res = await fetch(paymentEndpoint, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({ task: "checkPayment", sessionId: sessionId }),
          mode: "cors"
        });
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Payment verification failed: ${res.status} ${errorText}`);
        }
        const data = await res.json();
        if (data.paymentStatus) {
          if (data.paymentStatus === "paid" || data.paymentStatus === "no_payment_required") {
            setLocal("authenticated", "paid");
            
            // Get fingerprint data for linking
            const fingerprintData = getLocal("fingerprintData");
            
            if (fingerprintData && data.customerEmail && data.customerId) {
              try {
                // Parse fingerprint data
                const fingerprint = JSON.parse(fingerprintData);
                
                // Link payment to fingerprint in backend KV
                const linkResponse = await fetch(paymentEndpoint, {
                  method: "POST",
                  headers: { 
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                  },
                  body: JSON.stringify({
                    task: "linkPaymentToFingerprint",
                    email: data.customerEmail,
                    fingerprint: fingerprint,
                    customerId: data.customerId
                  }),
                  mode: "cors"
                });
                
                if (linkResponse.ok) {
                  const linkData = await linkResponse.json();
                  console.log("Payment linked to fingerprint:", linkData);
                  
                  // Store email for future device recovery
                  setLocal("userEmail", data.customerEmail);
                  
                  // OPERATION RATEPAY: Refresh rate limit status immediately after payment
                  try {
                    const rateLimitEndpoint = "https://ratelimit.4hm7q4q75z.workers.dev/";
                    const rateLimitResponse = await fetch(rateLimitEndpoint, {
                      method: "POST",
                      headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                      },
                      body: JSON.stringify({
                        task: "checkPaymentAndLimits",
                        fingerprint: fingerprint,
                        email: data.customerEmail,
                        module: "payment" // Generic module for status check
                      }),
                      mode: "cors"
                    });
                    
                    if (rateLimitResponse.ok) {
                      const rateLimitData = await rateLimitResponse.json();
                      
                      // Update rateLimitStatus in localStorage immediately
                      const rateLimitStatus = {
                        allowed: rateLimitData.allowed,
                        isPaid: rateLimitData.isPaid,
                        limits: rateLimitData.limits,
                        remaining: rateLimitData.remaining,
                        email: rateLimitData.email,
                        lastUpdated: Date.now()
                      };
                      
                      setLocal("rateLimitStatus", JSON.stringify(rateLimitStatus));
                      console.log("Rate limit status updated after payment:", rateLimitStatus);
                      
                      // Update container with success message showing new limits
                      const limitsText = rateLimitData.isPaid ? "unlimited" : `${rateLimitData.remaining?.perDay || 0} remaining today`;
                      container.innerHTML = `Payment successful! You now have ${limitsText} generations. Redirecting...`;
                    } else {
                      console.warn("Failed to refresh rate limit status after payment");
                      container.innerHTML = "Payment successful! Redirecting...";
                    }
                  } catch (rateLimitError) {
                    console.warn("Error refreshing rate limit status:", rateLimitError);
                    container.innerHTML = "Payment successful! Redirecting...";
                  }
                } else {
                  console.warn("Failed to link payment to fingerprint");
                  container.innerHTML = "Payment successful! Redirecting...";
                }
                
              } catch (linkError) {
                console.warn("Error linking payment:", linkError);
                container.innerHTML = "Payment successful! Redirecting...";
              }
            } else {
              container.innerHTML = "Payment successful! Redirecting...";
            }
            
            setTimeout(redirectToLanding, 2000);
          }
        } else if (data.error) {
          container.innerHTML = `
            <h1 style="text-transform: capitalize;">Payment Failed</h1>
            <p>Sorry, your payment attempt failed</p>
            <p>${data.error || ""}</p>
            <a href="mailto:support@inexasli.com" class="contact-support">Something's wrong? Contact support</a>
          `;
        } else {
          container.innerHTML = `
            <h1 style="text-transform: capitalize;">Payment Failed</h1>
            <p>Sorry, your payment attempt failed</p>
            <a href="mailto:support@inexasli.com" class="contact-support">Something's wrong? Contact support</a>
          `;
        }
      } catch (error) {
        container.innerHTML = `
          <h1 style="text-transform: capitalize;">Something Went Wrong</h1>
          <p>${error.message}</p>
          <p>Please try again later or contact support.</p>
          <a href="mailto:support@inexasli.com" class="contact-support">Contact Support</a>`;
      }
    } else {
      container.innerHTML = "No or invalid session ID";
      redirectToLanding();
    }
  }
});
     </script>

   </body>
 </html>