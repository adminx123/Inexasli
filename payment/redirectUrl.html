<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Processing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #000000;
        }
        .container {
            text-align: center;
            background: rgba(20, 20, 20, 0.95);
            color: #ffffff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 20px rgba(255,255,255,0.1);
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success {
            color: #4ade80;
        }
        .error {
            color: #f87171;
        }
        .debug {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: left;
            display: none; /* Hide debug info for seamless experience */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        <h2 id="status">Processing your payment...</h2>
        <p id="message">Please wait while we verify your payment and update your account.</p>
        <div id="debug" class="debug" style="display: none;"></div>
    </div>

    <script>
        // Debug logging
        function log(message) {
            console.log('[RedirectUrl]', message);
            // Remove debug display for seamless user experience
            // const debugDiv = document.getElementById('debug');
            // debugDiv.style.display = 'block';
            // debugDiv.innerHTML += '<div>' + new Date().toISOString() + ': ' + message + '</div>';
        }

        // Update UI
        function updateUI(status, message, isError = false) {
            document.getElementById('spinner').style.display = isError ? 'none' : 'block';
            document.getElementById('status').textContent = status;
            document.getElementById('status').className = isError ? 'error' : 'success';
            document.getElementById('message').textContent = message;
        }

        // Generate device fingerprint (matching rateLimiter.js)
        function generateDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Fingerprint test', 2, 2);
            const canvasFingerprint = canvas.toDataURL();
            
            const fingerprint = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                screen.colorDepth,
                new Date().getTimezoneOffset(),
                navigator.platform,
                navigator.cookieEnabled,
                canvasFingerprint.slice(-50) // Last 50 chars of canvas fingerprint
            ].join('|');
            
            // Simple hash function
            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            
            return Math.abs(hash).toString(36);
        }

        // Generate session ID
        function generateSessionId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Get or create fingerprint (matching rateLimiter.js structure)
        function getFingerprint() {
            const FINGERPRINT_KEY = '_userFingerprint';
            
            try {
                const stored = localStorage.getItem(FINGERPRINT_KEY);
                let fingerprintData;
                
                if (stored) {
                    try {
                        fingerprintData = JSON.parse(stored);
                        // Check if session expired (24 hours)
                        const sessionAge = Date.now() - fingerprintData.sessionCreated;
                        if (sessionAge > 24 * 60 * 60 * 1000) {
                            // Create new session but keep device ID
                            fingerprintData.sessionId = generateSessionId();
                            fingerprintData.sessionCreated = Date.now();
                            fingerprintData.requestCounts = {};
                            fingerprintData.lastRequestTimes = [];
                        }
                    } catch (e) {
                        fingerprintData = null;
                    }
                }
                
                if (!fingerprintData || !fingerprintData.deviceId) {
                    fingerprintData = {
                        deviceId: generateDeviceFingerprint(),
                        sessionId: generateSessionId(),
                        sessionCreated: Date.now(),
                        requestCounts: {},
                        lastRequestTimes: [],
                        rateLimitStatus: {}
                    };
                    log('Created new fingerprint: deviceId=' + fingerprintData.deviceId + ', sessionId=' + fingerprintData.sessionId);
                } else {
                    log('Using existing fingerprint: deviceId=' + fingerprintData.deviceId + ', sessionId=' + fingerprintData.sessionId);
                }
                
                // Save updated fingerprint
                localStorage.setItem(FINGERPRINT_KEY, JSON.stringify(fingerprintData));
                return fingerprintData;
                
            } catch (error) {
                log('Error getting fingerprint: ' + error.message);
                // Return minimal fingerprint if storage fails
                return {
                    deviceId: generateDeviceFingerprint(),
                    sessionId: generateSessionId(),
                    sessionCreated: Date.now(),
                    requestCounts: {},
                    lastRequestTimes: [],
                    rateLimitStatus: {}
                };
            }
        }

        // Main processing function
        async function processPayment() {
            try {
                // Get session ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('session_id');
                
                log('Session ID from URL: ' + (sessionId || 'NOT FOUND'));
                
                if (!sessionId) {
                    throw new Error('No session ID found in URL');
                }

                // Get or create fingerprint
                const fingerprint = getFingerprint();
                
                // Step 1: Verify payment with backend
                log('Calling checkPayment API...');
                const checkResponse = await fetch('https://stripeintegration.4hm7q4q75z.workers.dev/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        task: 'checkPayment',
                        sessionId: sessionId,
                        fingerprint: fingerprint
                    })
                });

                if (!checkResponse.ok) {
                    throw new Error('Payment verification failed: ' + checkResponse.status);
                }

                const checkData = await checkResponse.json();
                log('checkPayment response: ' + JSON.stringify(checkData));

                if (checkData.paymentStatus !== 'paid') {
                    throw new Error('Payment not completed: ' + (checkData.message || checkData.paymentStatus || 'Unknown error'));
                }

                // Step 2: Link payment to fingerprint in KV
                log('Calling linkPaymentToFingerprint API...');
                const linkResponse = await fetch('https://stripeintegration.4hm7q4q75z.workers.dev/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        task: 'linkPaymentToFingerprint',
                        username: checkData.username,
                        email: checkData.customerEmail,
                        customerId: checkData.customerId,
                        fingerprint: fingerprint,
                        tier: checkData.tier || 'BASIC'
                    })
                });

                if (!linkResponse.ok) {
                    throw new Error('Failed to link payment: ' + linkResponse.status);
                }

                const linkData = await linkResponse.json();
                log('linkPaymentToFingerprint response: ' + JSON.stringify(linkData));

                if (!linkData.success) {
                    throw new Error('Failed to link payment: ' + (linkData.message || 'Unknown error'));
                }

                // Update localStorage
                localStorage.setItem('authenticated', 'paid');
                log('Updated localStorage.authenticated to "paid"');

                // Create rateLimitStatus from linkData response (no additional API call needed)
                if (linkData.rateLimitStatus) {
                    // Use the rateLimitStatus from the backend response (includes email)
                    localStorage.setItem('rateLimitStatus', JSON.stringify(linkData.rateLimitStatus));
                    log('Rate limit status created from backend rateLimitStatus: ' + JSON.stringify(linkData.rateLimitStatus));
                } else if (linkData.limits && linkData.remaining) {
                    // Fallback: create rateLimitStatus manually
                    const rateLimitStatus = {
                        allowed: linkData.allowed,
                        isPaid: linkData.isPaid,
                        limits: linkData.limits,
                        remaining: linkData.remaining,
                        username: linkData.username,
                        lastUpdated: Date.now()
                    };
                    
                    localStorage.setItem('rateLimitStatus', JSON.stringify(rateLimitStatus));
                    log('Rate limit status created manually (fallback): ' + JSON.stringify(rateLimitStatus));
                } else {
                    log('No rate limit data in linkData response - will be set on first AI generation');
                }

                // Success!
                document.getElementById('spinner').style.display = 'none';
                updateUI('Payment Successful!', 'Redirecting you to the application...', false);
                
                // Immediate redirect for seamless experience
                setTimeout(() => {
                    log('Redirecting to main application...');
                    window.location.href = '/ai/landing/landing.html';
                }, 500); // Very short delay to ensure UI updates

            } catch (error) {
                log('ERROR: ' + error.message);
                updateUI('Payment Processing Failed', error.message, true);
            }
        }

        // Start processing when page loads
        document.addEventListener('DOMContentLoaded', processPayment);
    </script>
</body>
</html>
