compatibility_date = "2025-07-22"
account_id = "b70c309587ed8ba2bfa06320792ea457"
workers_dev = true

# --- X Poster Worker (Standalone) ---
[env.x]
name = "x-worker"
main = "./business/x.js"

[env.x.triggers]
crons = ["11 19 * * *"]

# --- OAuth Worker (User Connection Handler) ---
[env.oauth]
name = "oauth"
main = "./business/oauth.js"

# KV namespace for storing client OAuth tokens
[[env.oauth.kv_namespaces]]
binding = "CLIENT_TOKENS"
id = "f1fb28cb03b04ed2abcea8c88c0b9587"
preview_id = "f1fb28cb03b04ed2abcea8c88c0b9587"

# --- Master Social Worker (Central Token/Secret Manager) ---
[env.mastersocial]
name = "mastersocial"
main = "./business/clients/masterSocial.js"

[env.mastersocial.triggers]
crons = ["11 19 * * *"]

# Service binding to INEXASLI worker
[[env.mastersocial.services]]
binding = "INEXASLI"
service = "prompt-inexasli"

# KV namespace for storing client OAuth tokens
[[env.mastersocial.kv_namespaces]]
binding = "CLIENT_TOKENS"
id = "f1fb28cb03b04ed2abcea8c88c0b9587"
preview_id = "f1fb28cb03b04ed2abcea8c88c0b9587"

# --- Business Worker Template ---
[env.businesstemplate]
name = "businesstemplate"
main = "./business/businessTemplate.js"

# Optional cron triggers for scheduled posting
[env.businesstemplate.triggers]
crons = ["0 9,13,17 * * *"]  # Post at 9am, 1pm, 5pm UTC

# --- INEXASLI Client Worker ---
[env.inexasli]
name = "prompt-inexasli"
main = "./business/clients/prompt-inexasli.js"

# INEXASLI posting schedule
[env.inexasli.triggers]
crons = ["0 9,13,17 * * *"]  # Post at 9am, 1pm, 5pm UTC

# CENTRALIZED MASTER WORKER ARCHITECTURE
# This project uses a master worker that imports all individual modules.
# Individual modules (calorie.js, event.js, etc.) are NOT standalone workers - 
# they export configuration and prompt generation functions to the master.
#
# DEPLOYMENT SEQUENCE:
# 1. Deploy rate limiter first (required dependency):
#    npx wrangler deploy --env ratelimit
#
# 2. Deploy master worker (includes all 11 modules from workers.txt):
#    npx wrangler deploy --env master
#
# The master worker automatically includes all modules listed in workers.txt:
# - calorie/calorie.js, decision/decision.js, enneagram/enneagram.js
# - event/event.js, fashion/fashion.js, income/income.js  
# - philosophy/philosophy.js, quiz/quiz.js, period/period.js
#
# NO individual worker deployments needed - master handles everything!


# Global build configuration that applies to all workers
[build]
command = ""
watch_dir = "build/worker"

# --- Worker Environments ---

# --- Rate Limiter Worker (CRITICAL - Deploy First) ---
[env.ratelimit]
name = "ratelimit"
main = "./ai/rate-limiter/rateLimit.js"

# KV namespace for rate limiting data storage
[[env.ratelimit.kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "2da5e6f46847458a9aa83ffe54dea66e"
preview_id = "2da5e6f46847458a9aa83ffe54dea66e"

# No admin access required for user-facing application

# --- Master Worker (Centralized - Includes All Modules) ---
[env.master]
name = "master"
main = "./ai/master.js"

# Routes for the master worker
routes = [
  { pattern = "*inexasli.com/api/*", zone_name = "inexasli.com" }
]

# Variables for VirusTotal integration (API key set as secret in Cloudflare dashboard)
# VT_API_KEY is configured as a secret environment variable

# KV namespace for storing analysis facts and data
[[env.master.kv_namespaces]]
binding = "FACT_STORE"
id = "285495ae3e0f468a86f47bdd056ecfc3"
preview_id = "02f5fab88e5143a5aa52c315fde404d1"

# Service bindings for external dependencies
[[env.master.services]]
binding = "rateLimit_binding"
service = "ratelimit"

# --- Stripe Payment Worker ---
[env.stripeintegration]
name = "stripeintegration"
main = "./payment/stripeintegration.js"

# Variables for Stripe integration
[env.stripeintegration.vars]
DOMAIN_URL = "https://inexasli.com"  # Updated for production deployment
PRICE_ID_ENTERPRISE = "price_1RxFAMILSdrwu9bgxmQHeqhp"
PRICE_ID_ENTERPRISE_MONTHLY = "price_1S2HdCILSdrwu9bg0iC1tjGJ"
PRICE_ID_PROFESSIONAL_MONTHLY = "price_1S2HdTILSdrwu9bgr9DIDU48"
PRICE_ID_STARTER_MONTHLY = "price_1S2HdoILSdrwu9bg2c0KcPcA"
PRICE_ID_USER_CONTENT_AUTOMATION = "price_1S2IMxILSdrwu9bgNMXhQXbu"
PRICE_ID_EXTRA_PHOTOS_10 = "price_1S2IU4ILSdrwu9bgDlolRQKg"
PRICE_ID_HYBRID_CONTENT_MODE = "price_1S1bi2ILSdrwu9bgOI7nS2Iq"
PRICE_ID_EXTRA_ITERATIONS = "price_1S1bgVILSdrwu9bgiQ1jd33Z"
PRICE_ID_EXTRA_VIDEOS_5 = "price_1RxFDkILSdrwu9bgOjwrtNaN"
COUPON_USER_CONTENT_ONLY = "jst21IVY"
COUPON_BASIC_SCHEDULING = "FR8M8OyC"
COUPON_REDUCED_FREQUENCY = "zk3QtCEk"

# KV namespace for payment data storage  
[[env.stripeintegration.kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "2da5e6f46847458a9aa83ffe54dea66e"
preview_id = "2da5e6f46847458a9aa83ffe54dea66e"

# Service binding for rate limit integration
[[env.stripeintegration.services]]
binding = "rateLimit_binding"
service = "ratelimit"

# --- Fact Generator Worker ---
[env.fact-generator]
name = "fact-generator"
main = "./ai/fact-generator/fact-generator.js"

[[env.fact-generator.kv_namespaces]]
binding = "FACT_STORE"
id = "285495ae3e0f468a86f47bdd056ecfc3"
preview_id = "285495ae3e0f468a86f47bdd056ecfc3"