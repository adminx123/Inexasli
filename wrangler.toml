compatibility_date = "2025-07-22"

# --- X Poster Worker (Standalone) ---
[env.x]
name = "x-worker"
main = "./ai/x.js"

[env.x.triggers]
crons = ["11 18 * * *"]

# CENTRALIZED MASTER WORKER ARCHITECTURE
# This project uses a master worker that imports all individual modules.
# Individual modules (calorie.js, event.js, etc.) are NOT standalone workers - 
# they export configuration and prompt generation functions to the master.
#
# DEPLOYMENT SEQUENCE:
# 1. Deploy rate limiter first (required dependency):
#    npx wrangler deploy --env ratelimit
#
# 2. Deploy master worker (includes all 11 modules from workers.txt):
#    npx wrangler deploy --env master
#
# The master worker automatically includes all modules listed in workers.txt:
# - calorie/calorie.js, decision/decision.js, enneagram/enneagram.js
# - event/event.js, fashion/fashion.js, income/income.js  
# - philosophy/philosophy.js, quiz/quiz.js, period/period.js
#
# NO individual worker deployments needed - master handles everything!


account_id = "b70c309587ed8ba2bfa06320792ea457"
workers_dev = true

# Global build configuration that applies to all workers
[build]
command = ""
watch_dir = "build/worker"

# --- Worker Environments ---

# --- Rate Limiter Worker (CRITICAL - Deploy First) ---
[env.ratelimit]
name = "ratelimit"
main = "./ai/rate-limiter/rateLimit.js"

# KV namespace for rate limiting data storage
[[env.ratelimit.kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "2da5e6f46847458a9aa83ffe54dea66e"
preview_id = "2da5e6f46847458a9aa83ffe54dea66e"

# No admin access required for user-facing application

# --- Master Worker (Centralized - Includes All Modules) ---
[env.master]
name = "master"
main = "./ai/master.js"

# Routes for the master worker
routes = [
  { pattern = "*inexasli.com/api/*", zone_name = "inexasli.com" }
]

# Variables for VirusTotal integration (API key set as secret in Cloudflare dashboard)
# VT_API_KEY is configured as a secret environment variable

# KV namespace for storing analysis facts and data
[[env.master.kv_namespaces]]
binding = "FACT_STORE"
id = "285495ae3e0f468a86f47bdd056ecfc3"
preview_id = "02f5fab88e5143a5aa52c315fde404d1"

# Service bindings for external dependencies
[[env.master.services]]
binding = "rateLimit_binding"
service = "ratelimit"

# --- Stripe Payment Worker ---
[env.stripeintegration]
name = "stripeintegration"
main = "./payment/stripeintegration.js"

# Variables for Stripe integration
[env.stripeintegration.vars]
DOMAIN_URL = "https://inexasli.com"  # Updated for production deployment
PRICE_ID_PREMIUM = "price_1R9egnILSdrwu9bgKFghOlih"

# KV namespace for payment data storage  
[[env.stripeintegration.kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "2da5e6f46847458a9aa83ffe54dea66e"
preview_id = "2da5e6f46847458a9aa83ffe54dea66e"

# Service binding for rate limit integration
[[env.stripeintegration.services]]
binding = "rateLimit_binding"
service = "ratelimit"

# --- Fact Generator Worker ---
[env.fact-generator]
name = "fact-generator"
main = "./ai/fact-generator/fact-generator.js"

[[env.fact-generator.kv_namespaces]]
binding = "FACT_STORE"
id = "2da5e6f46847458a9aa83ffe54dea66e"
preview_id = "2da5e6f46847458a9aa83ffe54dea66e"