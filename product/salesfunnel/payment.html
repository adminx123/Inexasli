<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - INEXASLI Social Media Automation</title>
    <link rel="stylesheet" href="salesflow.css">
    <link rel="icon" href="../../images/favicon.ico" type="image/x-icon">
    <style>
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .progress-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 4px;
            animation: progressLoad 1s ease-out;
        }
        
        @keyframes progressLoad {
            from { width: 80%; }
            to { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="splash-container" id="splashContainer" style="padding-top: 40px; position: absolute; top: 0; left: 0; width: 100%; z-index: 2;">
        <img src="../../images/favicon.svg" alt="INEXASLI Logo" class="splash-logo" style="margin-top: 20px;">
    </div>

    <div class="device-container" id="mainContent" style="opacity: 0; display: block; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; z-index: 1;">
            <!-- Step Indicator -->
            <div class="step-indicator-placeholder"></div>
                <div class="step">
                    <div class="step-number">6</div>
                    <span>Link</span>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>

            <!-- Payment Section -->
            <div class="quote-results-container" id="paymentSection">
                <div class="quote-header">
                    <h1 class="quote-title">Complete Your Order</h1>
                    <p class="quote-subtitle">Secure payment processing powered by Stripe</p>
                </div>
                
                <!-- Order Summary -->
                <div class="quote-box" id="orderSummary">
                    <h3 class="quote-box-title">Order Summary</h3>
                    <!-- Order details will be populated by JavaScript -->
                </div>

                <!-- Customer Information -->
                <div class="form-section" style="max-width: 500px; margin: 30px auto;">
                    <h3>Billing Information</h3>
                    <form id="paymentForm">
                        <div class="form-fields">
                            <input type="email" id="email" placeholder="Email Address" required>
                            <input type="text" id="fullName" placeholder="Full Name" required>
                            <input type="text" id="company" placeholder="Company Name (Optional)">
                        </div>
                    </form>
                </div>
                
                <!-- Payment Disclaimer -->
                <div class="payment-disclaimer">
                    <strong>Secure payment by Stripe</strong> • SSL encrypted<br>
                    You will receive an email confirmation with your order details and Stripe receipt
                </div>
                
                <!-- Buttons -->
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin: 10px 0;">
                    <button id="submit-payment" class="proceed-button">
                        Complete Payment
                    </button>
                    <button onclick="goBack()" class="btn-back">
                        ← Back to Quote
                    </button>
                </div>
                
                </div>
            </div>
        </div>
    </div>
    
    <!-- Legal Footer -->
    <div style="text-align: center; margin: 5px 0 20px 0; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <p style="color: #ccc; font-size: 12px; margin: 0;">
            <a href="#" onclick="showSocialTerms(); return false;" style="color: #4CAF50; text-decoration: none;">Terms of Service</a>
            • 
            <a href="#" onclick="showSocialPrivacy(); return false;" style="color: #4CAF50; text-decoration: none;">Privacy Policy</a>
            • Contact: support@inexasli.com
        </p>
    </div>

    <script>
        // Splash screen transition
        const splash = document.getElementById('splashContainer');
        const main = document.getElementById('mainContent');
        
        // Start main content fade-in immediately
        main.style.transition = 'opacity 1.2s ease-in';
        
        setTimeout(() => {
            // Start crossfade
            main.style.opacity = '1';
            splash.style.opacity = '0';
            splash.style.transition = 'opacity 1.2s ease-out';
            
            setTimeout(() => {
                splash.style.display = 'none';
                main.style.position = 'static';
            }, 1200);
        }, 1500);

        // Load order data from localStorage
        function loadOrderData() {
            const orderData = localStorage.getItem('orderData');
            if (!orderData) {
                // Redirect back to packages if no order data
                window.location.href = 'packages.html';
                return null;
            }
            return JSON.parse(orderData);
        }

        // Display order summary
        function displayOrderSummary(orderData) {
            const summaryContainer = document.getElementById('orderSummary');
            const { package: selectedPackage, addons: selectedAddons = [], total } = orderData;
            
            // Filter out base package from addons (defensive programming for old data)
            const filteredAddons = selectedAddons.filter(addon => 
                addon.id !== 'base-package' && 
                addon.name !== 'Starter Social Media Automation' &&
                addon.name !== `${selectedPackage.name} Monthly`
            );
            
            // Retrieve customization data
            const customizationData = getJSON('customizationData', {});
            
            let summaryHTML = `
                <h3 class="quote-box-title">${selectedPackage.name}</h3>
                <div style="margin-bottom: 20px; text-align: left; color: white;">
                    <strong>Base Package:</strong><br>
                    • ${selectedPackage.features.join('<br>• ')}<br><br>
                    <strong>Selected Platforms:</strong><br>
                    • ${selectedPackage.platforms.join('<br>• ')}
                </div>
                
                <!-- One-Time Fees Section -->
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 10px;">
                    <h4 style="color: #10b981; margin-bottom: 10px;">One-Time Setup</h4>
                    <div class="quote-line">
                        <span class="quote-line-label">${selectedPackage.name} Setup</span>
                        <span class="quote-line-amount">$${selectedPackage.price}</span>
                    </div>
                </div>
                
                <!-- Monthly Fees Section -->
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 10px;">
                    <h4 style="color: #10b981; margin-bottom: 10px;">Monthly Subscription</h4>
                    <div class="quote-line">
                        <span class="quote-line-label">${selectedPackage.name} Monthly</span>
                        <span class="quote-line-amount">$${selectedPackage.monthlyPrice || 127}/month</span>
                    </div>
            `;
            
            // Add selected addons to monthly section
            filteredAddons.forEach(addon => {
                // Display add-on price with correct sign
                const priceDisplay = addon.price >= 0 
                    ? `+$${addon.price}/month` 
                    : `-$${Math.abs(addon.price)}/month`;
                
                summaryHTML += `
                    <div class="quote-line">
                        <span class="quote-line-label">${addon.name}</span>
                        <span class="quote-line-amount">${priceDisplay}</span>
                    </div>
                `;
            });
            
            summaryHTML += `
                </div>
                
                <!-- Overall Total -->
                <div class="quote-total">
                    <span class="quote-total-label">Total Due Today</span>
                    <span class="quote-total-amount">$${selectedPackage.price + (selectedPackage.monthlyPrice || 127) + filteredAddons.reduce((sum, addon) => sum + addon.price, 0)}</span>
                </div>
            `;
            
            // Add customization summary
            if (customizationData.industry) {
                summaryHTML += `
                    <div style="margin-top: 20px; text-align: left; color: white; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                        <strong>Customization Details:</strong><br>
                        • Industry: ${customizationData.industry}<br>
                        • Tone: ${customizationData.tone}<br>
                        • Frequency: ${customizationData.frequency}<br>
                        • Content Focus: ${Array.isArray(customizationData.content) ? customizationData.content.join(', ') : customizationData.content}<br>
                        ${customizationData.audience ? `• Target Audience: ${customizationData.audience}<br>` : ''}
                        ${customizationData.avoid ? `• Topics to Avoid: ${customizationData.avoid}<br>` : ''}
                        ${customizationData.additional ? `• Additional Notes: ${customizationData.additional}` : ''}
                    </div>
                `;
            }
            
            summaryContainer.innerHTML = summaryHTML;
        }

        // Create Stripe checkout session via backend
        async function createCheckoutSession(orderData) {
            const { package: selectedPackage, addons: selectedAddons = [] } = orderData;
            
            // Filter out base package from addons (defensive programming)
            const filteredAddons = selectedAddons.filter(addon => 
                addon.id !== 'base-package' && 
                addon.name !== 'Starter Social Media Automation' &&
                addon.name !== `${selectedPackage.name} Monthly`
            );
            
            // Retrieve customization data
            const customizationData = getJSON('customizationData', {});
            
            try {
                // Call backend to create checkout session
                const response = await fetch('https://stripeintegration.4hm7q4q75z.workers.dev/package-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        packageType: selectedPackage.type,
                        platforms: selectedPackage.platforms,
                        addons: filteredAddons.map(a => a.id),
                        customerEmail: document.getElementById('email').value,
                        customization: customizationData,
                        flow_type: "service"
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create checkout session');
                }
                
                const result = await response.json();
                
                if (result.success && result.url) {
                    // Redirect to Stripe checkout
                    window.location.href = result.url;
                } else {
                    throw new Error('Invalid response from server');
                }
                
            } catch (err) {
                console.error('Checkout error:', err);
                alert('Unable to process payment. Please try again.');
            }
        }

        // Handle payment submission
        document.getElementById('submit-payment').addEventListener('click', function() {
            const email = document.getElementById('email').value;
            const fullName = document.getElementById('fullName').value;
            
            if (!email || !fullName) {
                alert('Please fill in all required fields.');
                return;
            }
            
            const orderData = loadOrderData();
            if (orderData) {
                createCheckoutSession(orderData);
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const orderData = loadOrderData();
            if (orderData) {
                displayOrderSummary(orderData);
                
                // Pre-fill customer info if available
                if (orderData.customerInfo) {
                    document.getElementById('email').value = orderData.customerInfo.email || '';
                    document.getElementById('fullName').value = orderData.customerInfo.name || '';
                    document.getElementById('company').value = orderData.customerInfo.company || '';
                }
            }
        });
        
        function goBack() {
            window.location.href = 'quote.html';
        }
    </script>
    
    <!-- Splash Screen Transition Script -->
    <script>
        // Splash screen transition
        document.addEventListener('DOMContentLoaded', function() {
            const splash = document.getElementById('splashContainer');
            const main = document.getElementById('mainContent');
            
            // Start main content fade-in immediately
            main.style.transition = 'opacity 1.2s ease-in';
            
            setTimeout(() => {
                // Start crossfade
                main.style.opacity = '1';
                splash.style.opacity = '0';
                splash.style.transition = 'opacity 1.2s ease-out';
                
                setTimeout(() => {
                    splash.style.display = 'none';
                    main.style.position = 'static';
                    main.style.left = 'auto';
                    main.style.transform = 'none';
                }, 1200);
            }, 1500); // Show splash for 1.5 seconds
        });
    </script>
    
    <script src="/utility/modal.js"></script>
    <script src="../legal/legalSocial.js"></script>
    <script src="step-indicator.js"></script>
    
    <script type="module">
        import { getJSON } from '../../utility/getJSON.js';
        import { BusinessFormPersistence } from './businessFormPersistence.js';
        
        // Make getJSON available globally for the payment functions
        window.getJSON = getJSON;
        
        // Initialize form persistence for payment form
        const paymentFormPersistence = new BusinessFormPersistence('paymentForm', 'payment-form-data');
        paymentFormPersistence.init();
    </script>
</body>
</html>
